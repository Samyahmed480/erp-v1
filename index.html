<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WEBMAX-ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }

        .currency {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
        }

        .section-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        /* Toast & Modal */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 300px;
            justify-content: center;
            font-size: 0.9rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(-10px);
        }

        .toast.success i {
            color: #34d399;
        }

        .toast.error i {
            color: #f87171;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 500px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        /* Tree Indentation */
        .level-1 {
            font-weight: 800;
            background-color: #e2e8f0;
        }

        .level-2 {
            font-weight: 700;
            padding-right: 20px !important;
        }

        .level-3 {
            font-weight: 600;
            padding-right: 35px !important;
            color: #334155;
        }

        /* Simple Bar Chart */
        .chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            padding-top: 20px;
        }

        .chart-bar {
            width: 12%;
            background: #3b82f6;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.5s;
            min-height: 2px;
        }

        .chart-bar:hover {
            background: #2563eb;
        }

        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #64748b;
            width: 100%;
            text-align: center;
        }

        .chart-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #334155;
        }

        /* Print */
        @media print {
            body * {
                visibility: hidden;
            }

            #print-area,
            #print-area * {
                visibility: visible;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                min-height: 100%;
                background: white;
                padding: 0;
                direction: rtl;
                color: black;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex overflow-hidden bg-slate-50">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">تسجيل الدخول</h2>
                <p class="text-slate-500 text-sm mt-1">WEBMAX-ERP</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">اسم المستخدم</label><input type="text"
                        id="login-user" class="w-full p-3 border rounded-lg focus:border-blue-500 outline-none"
                        placeholder="admin"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">كلمة المرور</label><input
                        type="password" id="login-pass"
                        class="w-full p-3 border rounded-lg focus:border-blue-500 outline-none" placeholder="123"></div>
                <button type="submit"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">دخول</button>
                <p id="login-error" class="text-red-500 text-xs text-center hidden"><i
                        class="fas fa-exclamation-circle"></i> بيانات الدخول غير صحيحة</p>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>
    <div id="print-area" class="hidden p-8"></div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity opacity-0"></div>

    <!-- Invoice Details Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-lg">تفاصيل الفاتورة</h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-red-500"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="invoice-modal-body" class="p-6"></div>
            <div class="p-4 border-t bg-slate-50 rounded-b-xl flex justify-end gap-2">
                <button onclick="printCurrentModalInvoice()"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"><i
                        class="fas fa-print"></i> طباعة</button>
                <button onclick="closeModal()"
                    class="bg-slate-200 text-slate-700 px-4 py-2 rounded hover:bg-slate-300">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- القائمة الجانبية -->
    <aside id="sidebar"
        class="fixed inset-y-0 right-0 z-40 w-72 bg-slate-900 text-white flex flex-col shadow-2xl transform translate-x-full md:translate-x-0 md:static md:w-64 transition-transform duration-300 no-print">
        <div class="p-6 border-b border-slate-700 flex flex-col items-center bg-slate-950">
            <div
                class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-2xl mb-3 shadow-lg overflow-hidden relative">
                <i class="fas fa-cubes text-white" id="default-logo-icon"></i>
                <img id="sidebar-logo-img" src="" class="w-full h-full object-cover hidden absolute inset-0">
            </div>
            <h1 class="text-lg font-bold text-white tracking-wide">نظام ERP المتكامل</h1>
            <span class="text-[10px] text-slate-400 mt-1 bg-slate-800 px-2 py-0.5 rounded-full">V10.0 Pro</span>
        </div>

        <nav class="flex-1 p-3 space-y-0.5 overflow-y-auto text-sm" id="sidebar-nav">
            <button onclick="showSection('dashboard')"
                class="nav-btn w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="dashboard">
                <i class="fas fa-chart-pie w-7 text-center"></i> لوحة القيادة</button>

            <!-- نقطة البيع -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-calculator w-7 text-center"></i> نقطة البيع</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('pos')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="pos"><i class="fas fa-cash-register w-5 text-center"></i> بدء البيع</button>
                    <button onclick="showSection('pos_products')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="pos_products"><i class="fas fa-box w-5 text-center"></i> المنتجات والأسعار</button>
                    <button onclick="showSection('barcode')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="barcode"><i class="fas fa-barcode w-5 text-center"></i> إصدار باركود</button>
                </div>
            </div>

            <!-- الفواتير -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-file-invoice w-7 text-center"></i> الفواتير</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('invoices')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="invoices"><i class="fas fa-th-large w-5 text-center"></i> نظرة عامة</button>
                    <button onclick="showSection('inv_sales')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inv_sales"><i class="fas fa-file-alt w-5 text-center"></i> فواتير المبيعات</button>
                    <button onclick="showSection('inv_purchases')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inv_purchases"><i class="fas fa-file-import w-5 text-center"></i> فواتير
                        المشتريات</button>
                    <button onclick="showSection('inv_services')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inv_services"><i class="fas fa-file-medical w-5 text-center"></i> فواتير
                        الخدمات</button>
                    <button onclick="showSection('inv_installments')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inv_installments"><i class="fas fa-file-contract w-5 text-center"></i> فواتير
                        التقسيط</button>
                </div>
            </div>

            <!-- المبيعات والعملاء -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-shopping-bag w-7 text-center"></i> المبيعات والعملاء</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('sales')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="sales"><i class="fas fa-cash-register w-5 text-center"></i> فاتورة مبيعات</button>
                    <button onclick="showSection('customers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="customers"><i class="fas fa-users w-5 text-center"></i> العملاء</button>
                    <button onclick="showSection('cust_statement')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="cust_statement"><i class="fas fa-file-invoice-dollar w-5 text-center"></i> كشف حساب
                        العملاء</button>
                </div>
            </div>

            <!-- المشتريات والموردين -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-shopping-cart w-7 text-center"></i> المشتريات والموردين</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('purchases')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="purchases"><i class="fas fa-shopping-cart w-5 text-center"></i> فاتورة
                        مشتريات</button>
                    <button onclick="showSection('suppliers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="suppliers"><i class="fas fa-truck w-5 text-center"></i> الموردين</button>
                    <button onclick="showSection('supp_statement')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="supp_statement"><i class="fas fa-file-invoice w-5 text-center"></i> كشف حساب
                        الموردين</button>
                </div>
            </div>

            <!-- الخدمات -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-tools w-7 text-center"></i> الخدمات</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('services')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="services"><i class="fas fa-tools w-5 text-center"></i> إنشاء فاتورة خدمة</button>
                    <button onclick="showSection('svc_statement')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="svc_statement"><i class="fas fa-file-alt w-5 text-center"></i> كشف حساب
                        الخدمات</button>
                </div>
            </div>

            <!-- المخزون -->
            <button onclick="showSection('inventory')"
                class="nav-btn w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="inventory">
                <i class="fas fa-boxes w-7 text-center"></i> إدارة المخزون</button>

            <!-- التقسيط -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-calendar-alt w-7 text-center"></i> التقسيط</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('installments')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="installments"><i class="fas fa-file-contract w-5 text-center"></i> إنشاء عقد
                        تقسيط</button>
                    <button onclick="showSection('installment_customers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="installment_customers"><i class="fas fa-user-plus w-5 text-center"></i> عملاء
                        التقسيط</button>
                    <button onclick="showSection('inst_collection')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inst_collection"><i class="fas fa-hand-holding-usd w-5 text-center"></i> الأقساط
                        والتحصيل</button>
                </div>
            </div>

            <!-- المصروفات -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-money-bill-wave w-7 text-center"></i> المصروفات</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('expenses')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="expenses"><i class="fas fa-money-bill-wave w-5 text-center"></i> تسجيل
                        مصروف</button>
                    <button onclick="showSection('expense_vouchers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="expense_vouchers"><i class="fas fa-receipt w-5 text-center"></i> سندات
                        الصرف</button>
                </div>
            </div>

            <!-- الموارد البشرية -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-user-tie w-7 text-center"></i> الموارد البشرية</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('hr')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="hr"><i class="fas fa-user-tie w-5 text-center"></i> نظرة عامة</button>
                    <button onclick="showSection('hr_employees')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="hr_employees"><i class="fas fa-id-card w-5 text-center"></i> إدارة
                        الموظفين</button>
                    <button onclick="showSection('hr_actions')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="hr_actions"><i class="fas fa-clipboard-list w-5 text-center"></i>
                        الإجراءات</button>
                    <button onclick="showSection('hr_list')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="hr_list"><i class="fas fa-list-ul w-5 text-center"></i> الموظفين</button>
                    <button onclick="showSection('hr_payroll')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="hr_payroll"><i class="fas fa-money-check-alt w-5 text-center"></i> كشف
                        رواتب</button>
                </div>
            </div>

            <div class="my-2 border-t border-slate-700"></div>

            <!-- المحاسبة -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-book w-7 text-center"></i> المحاسبة</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('journal')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="journal"><i class="fas fa-book w-5 text-center"></i> القيود اليومية</button>
                    <button onclick="showSection('accounts_tree')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="accounts_tree"><i class="fas fa-sitemap w-5 text-center"></i> شجرة
                        الحسابات</button>
                </div>
            </div>

            <!-- التقارير -->
            <div class="sidebar-group">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-chart-bar w-7 text-center"></i> التقارير</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('reports')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="reports"><i class="fas fa-th-large w-5 text-center"></i> نظرة عامة</button>
                    <button onclick="showSection('rpt_pos')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_pos"><i class="fas fa-cash-register w-5 text-center"></i> نقاط البيع</button>
                    <button onclick="showSection('rpt_sales')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_sales"><i class="fas fa-chart-line w-5 text-center"></i> المبيعات</button>
                    <button onclick="showSection('rpt_customers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_customers"><i class="fas fa-users w-5 text-center"></i> العملاء</button>
                    <button onclick="showSection('rpt_purchases')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_purchases"><i class="fas fa-shopping-cart w-5 text-center"></i>
                        المشتريات</button>
                    <button onclick="showSection('rpt_suppliers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_suppliers"><i class="fas fa-truck w-5 text-center"></i> الموردين</button>
                    <button onclick="showSection('rpt_employees')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_employees"><i class="fas fa-user-tie w-5 text-center"></i> الموظفين</button>
                    <button onclick="showSection('rpt_inventory')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_inventory"><i class="fas fa-boxes w-5 text-center"></i> المخزون</button>
                    <button onclick="showSection('rpt_services')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_services"><i class="fas fa-tools w-5 text-center"></i> الخدمات</button>
                    <button onclick="showSection('rpt_installments')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_installments"><i class="fas fa-calendar-alt w-5 text-center"></i>
                        التقسيط</button>
                    <button onclick="showSection('rpt_inst_customers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_inst_customers"><i class="fas fa-user-tag w-5 text-center"></i> عملاء
                        التقسيط</button>
                    <button onclick="showSection('rpt_expenses')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_expenses"><i class="fas fa-money-bill-wave w-5 text-center"></i>
                        المصروفات</button>
                    <button onclick="showSection('rpt_revenue')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_revenue"><i class="fas fa-coins w-5 text-center"></i> الإيرادات</button>
                    <button onclick="showSection('rpt_treasury')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_treasury"><i class="fas fa-vault w-5 text-center"></i> الخزينة</button>
                    <button onclick="showSection('rpt_profits')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_profits"><i class="fas fa-chart-pie w-5 text-center"></i> الأرباح</button>
                </div>
            </div>

            <div class="my-2 border-t border-slate-700"></div>

            <button onclick="showSection('users')"
                class="nav-btn w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="users">
                <i class="fas fa-users-cog w-7 text-center"></i> المستخدمين</button>
            <button onclick="showSection('settings')"
                class="nav-btn w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="settings">
                <i class="fas fa-cogs w-7 text-center"></i> الإعدادات</button>
        </nav>
    </aside>

    <!-- المحتوى -->
    <main class="flex-1 flex flex-col w-full overflow-hidden no-print relative">
        <!-- الهيدر -->
        <header class="bg-white shadow-sm h-16 flex justify-between items-center px-4 z-20 border-b">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()"
                    class="md:hidden text-slate-600 hover:text-blue-600 p-2 rounded-full hover:bg-slate-100 transition"><i
                        class="fas fa-bars text-xl"></i></button>
                <h2 id="page-title" class="text-lg font-bold text-slate-800 hidden md:block">لوحة القيادة</h2>
            </div>

            <div class="flex items-center gap-4">
                <!-- اختيار المستخدم الحالي -->
                <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200">
                    <i class="fas fa-user-circle text-slate-500"></i>
                    <select id="current-user-select" onchange="switchUser(this.value)"
                        class="bg-transparent border-none text-xs font-bold text-slate-700 outline-none cursor-pointer">
                        <!-- Users loaded here -->
                    </select>
                </div>

                <div class="hidden md:flex flex-col items-end border-r pr-4 border-slate-200">
                    <span class="text-xs font-bold text-slate-800" id="header-company-name">اسم الشركة</span>
                    <span class="text-[10px] text-slate-500 font-mono" id="header-date">--/--/----</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50 relative">

            <!-- 1. Dashboard -->
            <section id="dashboard" class="section-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-emerald-500">
                        <div class="text-xs text-slate-500 mb-1">الخزينة (النقدية)</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-cash">0.00</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-blue-500">
                        <div class="text-xs text-slate-500 mb-1">المبيعات</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-sales">0.00</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-red-500">
                        <div class="text-xs text-slate-500 mb-1">المصروفات</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-expenses">0.00</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-purple-500">
                        <div class="text-xs text-slate-500 mb-1">صافي الربح</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-net-profit">0.00</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-4 border-b pb-3"><i
                                class="fas fa-chart-bar text-blue-500 me-2"></i>المبيعات (آخر 7 أيام)</h3>
                        <div class="chart-container" id="sales-chart">
                            <!-- Bars will be injected here -->
                            <p class="text-sm text-slate-400 self-center">جاري تحميل البيانات...</p>
                        </div>
                    </div>

                    <!-- Recent Journal -->
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-4 border-b pb-3 flex justify-between items-center">
                            <span><i class="fas fa-history text-blue-500 me-2"></i>آخر العمليات</span>
                            <button onclick="showSection('journal')"
                                class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100">عرض
                                الكل</button>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-50 text-slate-600">
                                    <tr>
                                        <th class="p-2">#</th>
                                        <th class="p-2">التاريخ</th>
                                        <th class="p-2">البيان</th>
                                        <th class="p-2">القيمة</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-journal-list" class="divide-y text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- POS (Kiosk) -->
            <section id="pos" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-120px)]">
                    <!-- Products Grid -->
                    <div class="lg:col-span-2 flex flex-col">
                        <!-- Barcode Scanner + Search -->
                        <div class="flex gap-2 mb-3">
                            <div class="relative flex-1">
                                <i class="fas fa-barcode absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="pos-barcode-input"
                                    placeholder="امسح الباركود أو اكتب كود المنتج ثم Enter..."
                                    class="w-full p-2.5 pr-10 border-2 border-blue-200 rounded-lg text-sm outline-none focus:border-blue-500 bg-blue-50 font-mono"
                                    onkeydown="if(event.key==='Enter'){addByBarcode(this.value);this.value='';}"
                                    autofocus>
                            </div>
                            <input type="text" placeholder="بحث بالاسم..."
                                class="w-40 p-2.5 border rounded-lg text-sm outline-none focus:border-blue-500"
                                onkeyup="renderPOSProducts(this.value)">
                            <button onclick="showSection('pos_products')"
                                class="bg-indigo-600 text-white px-3 rounded-lg hover:bg-indigo-500 text-xs whitespace-nowrap"
                                title="إدارة المنتجات والأسعار">
                                <i class="fas fa-cog me-1"></i>المنتجات
                            </button>
                        </div>
                        <div id="pos-grid"
                            class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 content-start">
                            <!-- Products rendered by JS -->
                        </div>
                    </div>

                    <!-- Cart -->
                    <div class="bg-white rounded-xl shadow-sm flex flex-col p-4">
                        <h3 class="font-bold text-slate-800 mb-3 border-b pb-2"><i
                                class="fas fa-shopping-basket text-blue-500 me-2"></i>السلة</h3>

                        <!-- Customer -->
                        <div class="flex items-center gap-2 mb-3 text-xs">
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" id="pos-walkin" checked onchange="togglePOSCustomer()">
                                <span>عميل نقدي</span>
                            </label>
                            <select id="pos-customer"
                                class="hidden flex-1 p-1.5 border rounded text-xs outline-none"></select>
                        </div>

                        <!-- Cart Items -->
                        <div class="flex-1 overflow-y-auto border rounded mb-3">
                            <table class="w-full text-xs text-right">
                                <thead class="bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="p-2">الصنف</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">المبلغ</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="pos-cart-body"></tbody>
                            </table>
                        </div>

                        <!-- Discount -->
                        <div class="flex items-center gap-2 mb-2 text-xs">
                            <span class="text-slate-500">خصم:</span>
                            <input type="number" id="pos-discount" value="0" min="0"
                                class="w-20 p-1 border rounded text-center text-xs" onchange="renderPOSCart()">
                        </div>

                        <!-- Totals -->
                        <div class="bg-slate-900 text-white p-3 rounded-lg mb-3">
                            <div class="flex justify-between text-xs text-slate-400 mb-1">
                                <span>المجموع:</span><span id="pos-subtotal">0.00</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold text-emerald-400">
                                <span>الإجمالي:</span><span id="pos-total">0.00</span>
                            </div>
                        </div>

                        <!-- Payment Buttons -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button onclick="checkoutPOS('Cash')"
                                class="bg-emerald-600 text-white py-2.5 rounded-lg font-bold hover:bg-emerald-500 shadow text-sm">
                                <i class="fas fa-money-bill-wave me-1"></i> كاش
                            </button>
                            <button onclick="checkoutPOS('Bank')"
                                class="bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-500 shadow text-sm">
                                <i class="fas fa-credit-card me-1"></i> بنك
                            </button>
                        </div>
                        <div id="pos-other-methods" class="grid grid-cols-2 gap-2 mb-2"></div>
                        <button onclick="clearPOSCart()"
                            class="w-full bg-red-100 text-red-600 py-1.5 rounded text-xs font-bold hover:bg-red-200">
                            <i class="fas fa-trash me-1"></i> مسح السلة
                        </button>
                    </div>
                </div>
            </section>

            <!-- POS Products Management Sub-Module -->
            <section id="pos_products" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-box text-blue-500 me-2"></i>إضافة منتج سريع</h3>
                        <form onsubmit="savePOSProduct(event)" class="space-y-3">
                            <input type="hidden" id="pos-prod-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم المنتج *</label>
                                <input type="text" id="pos-prod-name" required
                                    class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">كود المنتج / الباركود</label>
                                <input type="text" id="pos-prod-barcode"
                                    class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500 font-mono"
                                    dir="ltr" placeholder="مثال: 6281001234567">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="block text-xs text-slate-500 mb-1">سعر البيع *</label>
                                    <input type="number" id="pos-prod-price" required step="0.01"
                                        class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                                </div>
                                <div><label class="block text-xs text-slate-500 mb-1">التكلفة</label>
                                    <input type="number" id="pos-prod-cost" step="0.01"
                                        class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="block text-xs text-slate-500 mb-1">المخزون</label>
                                    <input type="number" id="pos-prod-stock" value="0"
                                        class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                                </div>
                                <div><label class="block text-xs text-slate-500 mb-1">الفئة</label>
                                    <input type="text" id="pos-prod-category" placeholder="عام"
                                        class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow"><i
                                        class="fas fa-save me-1"></i>حفظ</button>
                                <button type="button" onclick="resetPOSProductForm()"
                                    class="bg-slate-200 text-slate-600 px-4 py-2.5 rounded-lg hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة المنتجات والأسعار</h3>
                            <div class="flex gap-2">
                                <input type="text" placeholder="بحث..."
                                    class="p-2 border rounded text-sm w-48 outline-none"
                                    onkeyup="filterPOSProductsList(this.value)">
                                <button onclick="exportTableToCSV('pos-products-table','المنتجات_والأسعار')"
                                    class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                        class="fas fa-file-excel me-1"></i>Excel</button>
                                <button onclick="printSection('pos-products-body')"
                                    class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                        class="fas fa-print me-1"></i>طباعة</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                            <table id="pos-products-table" class="w-full text-sm text-right">
                                <thead class="bg-slate-800 text-white sticky top-0">
                                    <tr>
                                        <th class="p-2.5">الباركود</th>
                                        <th class="p-2.5">المنتج</th>
                                        <th class="p-2.5">الفئة</th>
                                        <th class="p-2.5">سعر البيع</th>
                                        <th class="p-2.5">التكلفة</th>
                                        <th class="p-2.5">المخزون</th>
                                        <th class="p-2.5">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="pos-products-body" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- POS Barcode Sub-Module -->
            <section id="barcode" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-barcode text-indigo-500 me-2"></i>إصدار باركود للمنتجات</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث عن منتج..."
                                class="p-2 border rounded text-sm outline-none w-48"
                                onkeyup="filterBarcodeList(this.value)">
                            <button onclick="printAllBarcodes()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-500"><i
                                    class="fas fa-print me-1"></i>طباعة الكل</button>
                        </div>
                    </div>
                    <div id="barcode-products-list" class="max-h-[500px] overflow-y-auto border rounded-lg"></div>
                </div>
            </section>

            <!-- 2. Users Management -->
            <section id="users" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-user-plus text-blue-500 me-2"></i><span id="user-form-title">إضافة
                                مستخدم</span></h3>
                        <form onsubmit="saveUser(event)" class="space-y-4">
                            <input type="hidden" id="user-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم المستخدم</label><input type="text"
                                    id="user-name" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">الدور (الصلاحية)</label>
                                <select id="user-role"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none bg-white">
                                    <option value="admin">مدير (كامل الصلاحيات)</option>
                                    <option value="cashier">كاشير (مبيعات فقط)</option>
                                    <option value="accountant">محاسب</option>
                                </select>
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="user-phone"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">حفظ</button>
                                <button type="button" onclick="resetUserForm()"
                                    class="bg-slate-200 text-slate-600 px-4 rounded hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800"><i
                                    class="fas fa-users text-blue-500 me-2"></i>قائمة المستخدمين</h3>
                            <input type="text" placeholder="بحث عن مستخدم..."
                                class="p-2 border rounded text-sm w-48 focus:border-blue-500 outline-none"
                                onkeyup="filterUsers(this.value)">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-50 text-slate-700">
                                    <tr>
                                        <th class="p-3 rounded-tr-lg">الاسم</th>
                                        <th class="p-3">الدور</th>
                                        <th class="p-3">الهاتف</th>
                                        <th class="p-3 rounded-tl-lg">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="users-list" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Settings -->
            <section id="settings" class="section-content">
                <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex items-center gap-3 border-b pb-4 mb-6">
                        <div
                            class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-600">
                            <i class="fas fa-sliders-h"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-slate-800">إعدادات النظام</h3>
                            <p class="text-xs text-slate-500">تحكم في بيانات الشركة والنسخ الاحتياطي</p>
                        </div>
                    </div>

                    <form onsubmit="saveSettings(event)" class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">اسم الشركة</label><input
                                type="text" id="set-name"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">رقم الهاتف</label><input
                                type="text" id="set-phone"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div class="md:col-span-2"><label
                                class="text-xs font-bold text-slate-600 mb-1 block">العنوان</label><input type="text"
                                id="set-address"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">الرقم الضريبي</label><input
                                type="text" id="set-vat-no"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">رابط شعار الشركة
                                (URL)</label><input type="text" id="set-logo-url"
                                placeholder="https://example.com/logo.png"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none"
                                dir="ltr"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">الضريبة %</label><input
                                    type="number" id="set-vat-rate"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                            </div>
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">العملة</label><input
                                    type="text" id="set-currency"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                            </div>
                        </div>
                        <div class="md:col-span-2 mt-4 border-t pt-4">
                            <h4 class="font-bold text-slate-700 mb-2 text-sm">طرق الدفع</h4>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="new-pay-method"
                                    placeholder="اسم طريقة الدفع (مثلاً: فودافون كاش)"
                                    class="flex-1 p-2 border rounded text-sm outline-none bg-slate-50 focus:bg-white transition">
                                <button type="button" onclick="addPaymentMethod()"
                                    class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 text-sm">إضافة</button>
                            </div>
                            <div id="payment-methods-list" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="md:col-span-2 text-left pt-2">
                            <button type="submit"
                                class="bg-slate-800 text-white px-8 py-2.5 rounded-lg hover:bg-slate-700 transition shadow-lg font-bold text-sm">حفظ
                                التغييرات</button>
                        </div>
                    </form>

                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <h4 class="font-bold text-slate-700 mb-4 text-sm">إدارة البيانات والنسخ الاحتياطي</h4>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="exportData()"
                                class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-100 transition text-sm flex items-center gap-2"><i
                                    class="fas fa-download"></i> تصدير Backup</button>

                            <div class="relative">
                                <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                                <button onclick="document.getElementById('import-file').click()"
                                    class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-100 transition text-sm flex items-center gap-2"><i
                                        class="fas fa-upload"></i> استعادة Backup</button>
                            </div>

                            <button onclick="resetData()"
                                class="bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition text-sm flex items-center gap-2 mr-auto"><i
                                    class="fas fa-trash-alt"></i> تصفير النظام</button>
                        </div>
                    </div>

                    <!-- ضبط الفواتير -->
                    <div class="bg-white p-5 rounded-xl shadow-sm mt-6">
                        <h4 class="font-bold text-slate-700 mb-4 text-sm"><i
                                class="fas fa-file-invoice text-blue-500 me-2"></i>ضبط الفواتير والإيصالات</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- فاتورة المبيعات -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">فاتورة المبيعات</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sales-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sales-vat" checked> إظهار الضريبة</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sales-notes"> ملاحظات</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sales-sign"> التوقيع</label>
                                <input type="text" id="inv-sales-footer" placeholder="رسالة أسفل الفاتورة"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                            <!-- فاتورة المشتريات -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">فاتورة المشتريات</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pur-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pur-vat" checked> إظهار الضريبة</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pur-notes"> ملاحظات</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pur-sign"> التوقيع</label>
                                <input type="text" id="inv-pur-footer" placeholder="رسالة أسفل الفاتورة"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                            <!-- فاتورة التقسيط -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">فاتورة التقسيط</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-inst-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-inst-vat" checked> إظهار الضريبة</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-inst-notes"> ملاحظات</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-inst-sign"> التوقيع</label>
                                <input type="text" id="inv-inst-footer" placeholder="رسالة أسفل الفاتورة"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                            <!-- جدول الأقساط -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">جدول الأقساط</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sched-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sched-notes"> ملاحظات</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sched-sign"> التوقيع</label>
                                <input type="text" id="inv-sched-footer" placeholder="رسالة أسفل الجدول"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                            <!-- ريسيت POS -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">إيصال نقطة البيع (POS)</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pos-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pos-vat" checked> إظهار الضريبة</label>
                                <input type="text" id="inv-pos-footer" placeholder="رسالة أسفل الإيصال (شكراً لزيارتكم)"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. Sales & POS -->
            <section id="sales" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                    <!-- الفاتورة -->
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <span id="sale-title">فاتورة مبيعات</span>
                                <span id="sale-mode-badge"
                                    class="hidden text-xs bg-red-100 text-red-800 px-2 py-1 rounded border border-red-200">مرتجع</span>
                            </h3>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer text-sm select-none">
                                    <input type="checkbox" id="is-return-sale"
                                        class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                                        onchange="toggleSaleMode()">
                                    <span>وضع المرتجع</span>
                                </label>
                                <div
                                    class="text-xs font-mono bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100">
                                    INV-<span id="inv-num">Auto</span></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <select id="sale-customer"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"></select>
                            <select id="sale-account"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"></select>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <select id="sale-product"
                                class="flex-1 p-2.5 border rounded-lg text-sm bg-white outline-none shadow-sm"></select>
                            <input type="number" id="sale-qty" value="1"
                                class="w-20 p-2.5 border rounded-lg text-center outline-none" min="1">
                            <button onclick="addToCart()"
                                class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 transition shadow"><i
                                    class="fas fa-plus"></i></button>
                        </div>

                        <!-- جدول السلة -->
                        <div class="flex-1 border rounded-lg overflow-y-auto mb-3 bg-slate-50">
                            <table class="w-full text-sm text-center relative">
                                <thead class="bg-slate-200 text-slate-700 sticky top-0">
                                    <tr>
                                        <th class="p-2">الصنف</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">السعر</th>
                                        <th class="p-2">الإجمالي</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="cart-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                            <div id="cart-empty" class="text-center text-slate-400 py-10 text-sm">ابدأ بإضافة المنتجات
                            </div>
                        </div>

                        <div class="bg-slate-900 text-white p-4 rounded-xl shadow-lg">
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>المجموع:</span><span
                                    id="cart-subtotal">0.00</span></div>
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>الضريبة (<span
                                        id="cart-vat-rate">15</span>%):</span><span id="cart-vat">0.00</span></div>

                            <!-- الخصم المسموح به -->
                            <div class="flex items-center gap-2 mb-1 text-xs text-slate-400">
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" id="sale-disc-toggle"
                                        onchange="document.getElementById('sale-disc-area').classList.toggle('hidden');renderCart()">
                                    <span>الخصم المسموح به</span>
                                </label>
                            </div>
                            <div id="sale-disc-area" class="hidden mb-2 flex gap-1 items-center">
                                <select id="sale-disc-type" class="p-1 text-black rounded text-[10px] w-16"
                                    onchange="renderCart()">
                                    <option value="amount">مبلغ</option>
                                    <option value="percent">نسبة%</option>
                                </select>
                                <input type="number" id="sale-discount"
                                    class="w-16 p-1 text-black rounded text-center text-xs font-bold" value="0" min="0"
                                    onchange="renderCart()">
                            </div>

                            <div class="flex justify-between items-center border-t border-slate-700 pt-2 mb-2">
                                <span class="text-slate-400 text-xs">الإجمالي:</span>
                                <div class="text-xl font-bold text-emerald-400" id="cart-total">0.00</div>
                            </div>

                            <!-- نوع الدفع -->
                            <div class="flex gap-2 mb-2">
                                <button type="button" onclick="setSalePayType('cash')" id="sale-pay-cash-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white">كاش</button>
                                <button type="button" onclick="setSalePayType('credit')" id="sale-pay-credit-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300">آجل</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="text-[10px] text-slate-400 block mb-1">طريقة الدفع</label>
                                    <select id="sale-method" class="w-full p-1.5 text-black rounded text-sm"></select>
                                </div>
                                <div id="sale-credit-area" class="hidden">
                                    <label class="text-[10px] text-slate-400 block mb-1">المدفوع</label>
                                    <input type="number" id="sale-paid"
                                        class="w-full p-1.5 text-black rounded text-sm font-bold" placeholder="0.00"
                                        oninput="calcSaleRemaining()">
                                </div>
                            </div>
                            <div id="sale-remaining-row"
                                class="hidden flex justify-between text-xs text-yellow-400 mb-2">
                                <span>المتبقي على العميل:</span><span id="sale-remaining">0.00</span>
                            </div>
                            <!-- أزرار الإجراءات المنفصلة -->
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="postSale()"
                                    class="bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg font-bold shadow transition active:scale-95 text-sm">
                                    <i class="fas fa-save me-1"></i>حفظ الفاتورة
                                </button>
                                <button onclick="printLastSaleInvoice()"
                                    class="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold shadow transition active:scale-95 text-sm">
                                    <i class="fas fa-print me-1"></i>طباعة آخر فاتورة
                                </button>
                                <button onclick="exportLastSalePDF()"
                                    class="bg-red-600 hover:bg-red-500 text-white py-1.5 rounded-lg font-bold text-xs">
                                    <i class="fas fa-file-pdf me-1"></i>تصدير PDF
                                </button>
                                <button onclick="exportTableToCSV('recent-inv-table','فواتير_المبيعات')"
                                    class="bg-green-700 hover:bg-green-600 text-white py-1.5 rounded-lg font-bold text-xs">
                                    <i class="fas fa-file-excel me-1"></i>تصدير Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- الشريط الجانبي: فواتير + كشف حساب عملاء -->
                    <div class="lg:col-span-1 flex flex-col gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-file-alt text-blue-500 me-1"></i>سجل الفواتير</h3>
                                <div class="flex gap-1">
                                    <input type="text" placeholder="بحث..."
                                        class="p-1 border rounded text-[10px] w-24 outline-none"
                                        onkeyup="filterSalesInvoiceList(this.value)">
                                    <button onclick="exportTableToCSV('recent-inv-table','فواتير_المبيعات')"
                                        class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('recent-inv-body')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <div class="overflow-y-auto max-h-[250px] border rounded bg-slate-50">
                                <table id="recent-inv-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-slate-800 text-white sticky top-0">
                                        <tr>
                                            <th class="p-1.5">#</th>
                                            <th class="p-1.5">التاريخ</th>
                                            <th class="p-1.5">العميل</th>
                                            <th class="p-1.5">الإجمالي</th>
                                            <th class="p-1.5">الحالة</th>
                                            <th class="p-1.5"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-inv-body" class="bg-white divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-file-invoice-dollar text-blue-500 me-1"></i>كشف حساب العملاء</h3>
                                <div class="flex gap-1">
                                    <button onclick="exportTableToCSV('cust-statement-table','كشف_حساب_العملاء')"
                                        class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('cust-statement-body')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <input type="text" placeholder="بحث بالكود أو الاسم..."
                                class="w-full p-1.5 border rounded text-xs mb-2 outline-none"
                                onkeyup="filterCustStatement(this.value)">
                            <div class="overflow-y-auto max-h-[200px] border rounded bg-slate-50">
                                <table id="cust-statement-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-slate-200 sticky top-0">
                                        <tr>
                                            <th class="p-1.5">الكود</th>
                                            <th class="p-1.5">العميل</th>
                                            <th class="p-1.5">الإجمالي</th>
                                            <th class="p-1.5">المدفوع</th>
                                            <th class="p-1.5 text-red-600">المتبقي</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cust-statement-body" class="bg-white divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. Journal (Entries) -->
            <section id="journal" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">قيد يومية يدوي</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
                        <div class="md:col-span-3">
                            <input type="text" id="manual-desc" placeholder="شرح القيد (البيان)"
                                class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <input type="date" id="manual-date"
                                class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
                        <div class="grid grid-cols-12 gap-2 text-xs font-bold text-slate-500 mb-2 px-2">
                            <div class="col-span-6">الحساب</div>
                            <div class="col-span-2">مدين</div>
                            <div class="col-span-2">دائن</div>
                            <div class="col-span-2"></div>
                        </div>
                        <div id="journal-lines" class="space-y-2"></div>
                        <button onclick="addJournalLineRow()"
                            class="mt-4 text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full hover:bg-blue-100 font-bold transition flex items-center gap-1 w-fit"><i
                                class="fas fa-plus"></i> طرف جديد</button>
                    </div>

                    <div class="flex justify-between items-center bg-slate-100 p-3 rounded-lg border border-slate-200">
                        <div class="flex gap-4 text-sm font-mono font-bold">
                            <span class="text-emerald-600">مدين: <span id="total-dr">0.00</span></span>
                            <span class="text-slate-300">|</span>
                            <span class="text-red-600">دائن: <span id="total-cr">0.00</span></span>
                            <span id="unbalanced-msg"
                                class="text-red-500 bg-red-50 px-2 rounded text-xs hidden flex items-center gap-1"><i
                                    class="fas fa-exclamation-circle"></i> غير متزن</span>
                        </div>
                        <button onclick="saveManualJournal()"
                            class="bg-slate-800 text-white px-6 py-2 rounded-lg text-sm hover:bg-slate-700 font-bold shadow">ترحيل
                            القيد</button>
                    </div>
                </div>
            </section>

            <!-- 9. Purchases (New) -->
            <section id="purchases" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <span id="pur-title">فاتورة مشتريات</span>
                                <span id="pur-mode-badge"
                                    class="hidden text-xs bg-red-100 text-red-800 px-2 py-1 rounded border border-red-200">مرتجع</span>
                            </h3>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer text-sm select-none">
                                    <input type="checkbox" id="is-return-pur"
                                        class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                                        onchange="togglePurMode()">
                                    <span>وضع المرتجع</span>
                                </label>
                                <div
                                    class="text-xs font-mono bg-orange-50 text-orange-700 px-2 py-1 rounded border border-orange-100">
                                    PUR-<span id="pur-num">Auto</span></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <select id="pur-supplier"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"></select>
                            <input type="date" id="pur-date"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none">
                        </div>
                        <div class="flex gap-2 mb-3">
                            <select id="pur-product"
                                class="flex-1 p-2.5 border rounded-lg text-sm bg-white outline-none shadow-sm"
                                onchange="updatePurCost(this)"></select>
                            <input type="number" id="pur-cost" placeholder="التكلفة"
                                class="w-24 p-2.5 border rounded-lg text-center outline-none">
                            <input type="number" id="pur-qty" value="1"
                                class="w-20 p-2.5 border rounded-lg text-center outline-none" min="1">
                            <button onclick="addToPurCart()"
                                class="bg-orange-600 text-white px-4 rounded-lg hover:bg-orange-700 transition shadow"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div class="flex-1 border rounded-lg overflow-y-auto mb-3 bg-slate-50">
                            <table class="w-full text-sm text-center relative">
                                <thead class="bg-slate-200 text-slate-700 sticky top-0">
                                    <tr>
                                        <th class="p-2">الصنف</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">التكلفة</th>
                                        <th class="p-2">الإجمالي</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="pur-cart-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                        <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg">
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>المجموع:</span><span
                                    id="pur-subtotal">0.00</span></div>
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>الضريبة
                                    (15%):</span><span id="pur-vat">0.00</span></div>

                            <!-- الخصم المكتسب -->
                            <div class="flex items-center gap-2 mb-1 text-xs text-slate-400">
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" id="pur-disc-toggle"
                                        onchange="document.getElementById('pur-disc-area').classList.toggle('hidden');renderPurCart()">
                                    <span>الخصم المكتسب</span>
                                </label>
                            </div>
                            <div id="pur-disc-area" class="hidden mb-2 flex gap-1 items-center">
                                <select id="pur-disc-type" class="p-1 text-black rounded text-[10px] w-16"
                                    onchange="renderPurCart()">
                                    <option value="amount">مبلغ</option>
                                    <option value="percent">نسبة%</option>
                                </select>
                                <input type="number" id="pur-discount"
                                    class="w-16 p-1 text-black rounded text-center text-xs font-bold" value="0" min="0"
                                    onchange="renderPurCart()">
                            </div>

                            <div class="flex justify-between items-center border-t border-slate-700 pt-2 mb-2">
                                <span class="text-slate-400 text-xs">الإجمالي:</span>
                                <div class="text-xl font-bold text-orange-400" id="pur-total">0.00</div>
                            </div>

                            <!-- نوع الدفع -->
                            <div class="flex gap-2 mb-2">
                                <button type="button" onclick="setPurPayType('cash')" id="pur-pay-cash-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-orange-600 text-white">كاش</button>
                                <button type="button" onclick="setPurPayType('credit')" id="pur-pay-credit-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300">آجل</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="text-[10px] text-slate-400 block mb-1">طريقة الدفع</label>
                                    <select id="pur-method" class="w-full p-1.5 text-black rounded text-sm"></select>
                                </div>
                                <div id="pur-credit-area" class="hidden">
                                    <label class="text-[10px] text-slate-400 block mb-1">المدفوع</label>
                                    <input type="number" id="pur-paid"
                                        class="w-full p-1.5 text-black rounded text-sm font-bold" placeholder="0.00"
                                        oninput="calcPurRemaining()">
                                </div>
                            </div>
                            <div id="pur-remaining-row"
                                class="hidden flex justify-between text-xs text-yellow-400 mb-2">
                                <span>المتبقي للمورد:</span><span id="pur-remaining">0.00</span>
                            </div>
                            <button onclick="postPurchase()"
                                class="w-full bg-orange-600 hover:bg-orange-500 text-white py-2 rounded-lg font-bold shadow-lg transition">حفظ
                                الفاتورة</button>
                        </div>
                    </div>
                    <!-- الشريط الجانبي: مشتريات + كشف حساب موردين -->
                    <div class="lg:col-span-1 flex flex-col gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm text-slate-800">آخر المشتريات</h3>
                                <div class="flex gap-1">
                                    <button onclick="exportTableToCSV('recent-pur-table','فواتير_المشتريات')"
                                        class="text-[10px] bg-orange-50 text-orange-600 px-2 py-1 rounded hover:bg-orange-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('recent-purchases')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <div id="recent-purchases" class="overflow-y-auto max-h-[200px] space-y-2 pr-1"></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-file-invoice text-orange-500 me-1"></i>كشف حساب الموردين</h3>
                                <div class="flex gap-1">
                                    <button onclick="exportTableToCSV('supp-statement-table','كشف_حساب_الموردين')"
                                        class="text-[10px] bg-orange-50 text-orange-600 px-2 py-1 rounded hover:bg-orange-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('supp-statement-body')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <input type="text" placeholder="بحث بالكود أو الاسم..."
                                class="w-full p-1.5 border rounded text-xs mb-2 outline-none"
                                onkeyup="filterSuppStatement(this.value)">
                            <div class="overflow-y-auto max-h-[200px] border rounded bg-slate-50">
                                <table id="supp-statement-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-slate-200 sticky top-0">
                                        <tr>
                                            <th class="p-1.5">الكود</th>
                                            <th class="p-1.5">المورد</th>
                                            <th class="p-1.5">الإجمالي</th>
                                            <th class="p-1.5">المدفوع</th>
                                            <th class="p-1.5 text-red-600">المتبقي</th>
                                        </tr>
                                    </thead>
                                    <tbody id="supp-statement-body" class="bg-white divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 10. Suppliers (New) -->
            <section id="suppliers" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4">إضافة مورد</h3>
                        <form onsubmit="saveSupplier(event)" class="space-y-4">
                            <input type="hidden" id="supp-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم المورد</label><input type="text"
                                    id="supp-name" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">اسم الشركة</label><input type="text"
                                    id="supp-company"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">العنوان</label><input type="text"
                                    id="supp-address"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="supp-phone"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">الرقم الضريبي (اختياري)</label><input
                                    type="text" id="supp-vat"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">حفظ</button>
                                <button type="button" onclick="resetSupplierForm()"
                                    class="bg-slate-200 text-slate-600 px-4 rounded hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة الموردين</h3>
                            <button onclick="exportTableToCSV('suppliers-table', 'suppliers_list')"
                                class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs shadow flex items-center gap-1"><i
                                    class="fas fa-file-excel"></i> تصدير</button>
                        </div>
                        <table id="suppliers-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-50 text-slate-700">
                                <tr>
                                    <th class="p-3">الاسم</th>
                                    <th class="p-3">الهاتف</th>
                                    <th class="p-3">الضريبي</th>
                                    <th class="p-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="suppliers-list" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 14. Services Module (New) -->
            <section id="services" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Service Management -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">إدارة الخدمات</h3>
                            <button
                                onclick="document.getElementById('serv-id').value='';document.getElementById('serv-form').reset();"
                                class="text-blue-600 text-xs"><i class="fas fa-plus"></i> جديد</button>
                        </div>
                        <form id="serv-form" onsubmit="saveService(event)" class="space-y-3 mb-6">
                            <input type="hidden" id="serv-id">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">اسم الخدمة</label><input
                                    type="text" id="serv-name" required class="w-full p-2 border rounded outline-none">
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">السعر</label><input
                                    type="number" id="serv-price" required
                                    class="w-full p-2 border rounded outline-none"></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">الوصف</label><input
                                    type="text" id="serv-desc" class="w-full p-2 border rounded outline-none"></div>
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 shadow">حفظ
                                الخدمة</button>
                        </form>
                        <div class="border-t pt-4">
                            <h4 class="font-bold text-sm text-slate-700 mb-2">قائمة الخدمات</h4>
                            <div class="overflow-y-auto max-h-[300px] border rounded bg-slate-50">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-indigo-50 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">الخدمة</th>
                                            <th class="p-2">السعر</th>
                                            <th class="p-2">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="services-list" class="divide-y divide-slate-200 bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Service Invoice -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">فاتورة خدمات</h3>
                            <div
                                class="text-xs font-mono bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-100">
                                SRV-<span id="srv-num">Auto</span></div>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <select id="srv-list"
                                class="flex-1 p-2 border rounded outline-none bg-slate-50 focus:bg-white"></select>
                            <button onclick="addToServiceCart()"
                                class="bg-purple-600 text-white px-4 rounded hover:bg-purple-700"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto border rounded-lg bg-slate-50 mb-3">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-100 font-bold sticky top-0">
                                    <tr>
                                        <th class="p-2">الخدمة</th>
                                        <th class="p-2">السعر</th>
                                        <th class="p-2">حذف</th>
                                    </tr>
                                </thead>
                                <tbody id="srv-cart-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                        <div class="border-t pt-3 space-y-2">
                            <div class="flex justify-between items-center font-bold text-lg"><span>الإجمالي</span><span
                                    id="srv-total" class="text-purple-700">0.00</span></div>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="srv-method" class="p-2 border rounded outline-none bg-slate-50"></select>
                                <button onclick="postServiceBill()"
                                    class="bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 shadow">حفظ
                                    الفاتورة</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            </section>

            <!-- 15. Expenses Module (New) -->
            <section id="expenses" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Add Expense -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">تسجيل مصروف جديد</h3>
                        <form onsubmit="postExpense(event)" class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">بيان المصروف</label><input
                                    type="text" id="exp-desc" required
                                    class="w-full p-2.5 border rounded-lg outline-none"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">المبلغ</label><input
                                        type="number" id="exp-amount" required step="0.01"
                                        class="w-full p-2.5 border rounded-lg outline-none"></div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">التصنيف</label>
                                    <select id="exp-cat"
                                        class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white">
                                        <!-- Categories -->
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">طريقة الدفع</label>
                                <select id="exp-method"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <button type="submit"
                                class="w-full bg-red-600 text-white py-2 rounded font-bold hover:bg-red-700 shadow">تسجيل
                                المصروف</button>
                        </form>
                    </div>

                    <!-- Expenses List -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">سجل المصروفات</h3>
                            <div class="text-xs bg-red-50 text-red-700 px-2 py-1 rounded">الإجمالي: <span
                                    id="exp-list-total" class="font-bold">0.00</span></div>
                        </div>
                        <div class="flex-1 overflow-y-auto border rounded-lg bg-slate-50 mb-3">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-100 font-bold sticky top-0">
                                    <tr>
                                        <th class="p-2">التاريخ</th>
                                        <th class="p-2">البيان</th>
                                        <th class="p-2">المبلغ</th>
                                        <th class="p-2">التصنيف</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-list" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 17. HR Module (New) -->
            <section id="hr" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Employee Management -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">إدارة الموظفين</h3>
                            <button
                                onclick="document.getElementById('emp-id').value='';document.getElementById('emp-form').reset();document.getElementById('emp-photo-preview').classList.add('hidden');"
                                class="text-blue-600 text-xs"><i class="fas fa-plus"></i> جديد</button>
                        </div>
                        <form id="emp-form" onsubmit="saveEmployee(event)" class="space-y-3 mb-6">
                            <input type="hidden" id="emp-id">
                            <div class="flex gap-4">
                                <div class="w-24 h-24 bg-slate-100 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center relative overflow-hidden cursor-pointer"
                                    onclick="document.getElementById('emp-photo').click()">
                                    <img id="emp-photo-preview"
                                        class="absolute inset-0 w-full h-full object-cover hidden">
                                    <i class="fas fa-camera text-slate-400"></i>
                                    <input type="file" id="emp-photo" class="hidden" accept="image/*"
                                        onchange="previewEmpPhoto(this)">
                                </div>
                                <div class="flex-1 space-y-2">
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">الاسم</label><input
                                            type="text" id="emp-name" required
                                            class="w-full p-2 border rounded outline-none"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">الوظيفة /
                                            الرتبة</label><input type="text" id="emp-role" required
                                            class="w-full p-2 border rounded outline-none"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">الراتب
                                        الأساسي</label><input type="number" id="emp-salary" required
                                        class="w-full p-2 border rounded outline-none"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">الهاتف</label><input
                                        type="text" id="emp-phone" class="w-full p-2 border rounded outline-none"></div>
                            </div>
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 shadow">حفظ
                                بيانات الموظف</button>
                        </form>

                        <div class="border-t pt-4">
                            <h4 class="font-bold text-sm text-slate-700 mb-2">قائمة الموظفين</h4>
                            <div class="overflow-y-auto max-h-[250px] border rounded bg-slate-50">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-indigo-50 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">موظف</th>
                                            <th class="p-2">الوظيفة</th>
                                            <th class="p-2">الراتب</th>
                                            <th class="p-2">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employees-list" class="divide-y divide-slate-200 bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Actions & Payroll -->
                    <div class="flex flex-col gap-6 h-full">
                        <!-- Actions -->
                        <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                            <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">الإجراءات (خصم / مكافأة)
                            </h3>
                            <form onsubmit="postPayrollAction(event)" class="grid grid-cols-2 gap-3 mb-4">
                                <select id="act-emp" class="col-span-2 p-2 border rounded outline-none bg-slate-50"
                                    required></select>
                                <select id="act-type" class="p-2 border rounded outline-none bg-slate-50" required>
                                    <option value="bonus">مكافأة / عمولة (+)</option>
                                    <option value="deduction">خصم / جزاء (-)</option>
                                </select>
                                <input type="number" id="act-amount" placeholder="المبلغ" required
                                    class="p-2 border rounded outline-none">
                                <input type="text" id="act-desc" placeholder="السبب" required
                                    class="col-span-2 p-2 border rounded outline-none">
                                <button type="submit"
                                    class="col-span-2 bg-slate-800 text-white py-2 rounded font-bold hover:bg-slate-700">تسجيل
                                    الإجراء</button>
                            </form>
                            <div class="overflow-y-auto max-h-[150px] border rounded bg-slate-50">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-slate-100 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">الاسم</th>
                                            <th class="p-2">النوع</th>
                                            <th class="p-2">المبلغ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="actions-list" class="divide-y bg-white"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Payroll Run -->
                        <div class="bg-white p-6 rounded-xl shadow-sm flex-1">
                            <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">كشف الرواتب</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="month" id="payroll-month" class="flex-1 p-2 border rounded outline-none">
                                <button onclick="generatePayrollPreview()"
                                    class="bg-emerald-600 text-white px-4 rounded font-bold hover:bg-emerald-700">إعداد
                                    الكشف</button>
                            </div>
                            <div id="payroll-preview" class="hidden">
                                <div class="overflow-y-auto max-h-[200px] border rounded mb-3">
                                    <table class="w-full text-xs text-right bg-white">
                                        <thead class="bg-slate-100 font-bold sticky top-0">
                                            <tr>
                                                <th class="p-2">الموظف</th>
                                                <th class="p-2">الراتب</th>
                                                <th class="p-2 text-green-600">(+)</th>
                                                <th class="p-2 text-red-600">(-)</th>
                                                <th class="p-2 font-bold">الصافي</th>
                                            </tr>
                                        </thead>
                                        <tbody id="payroll-table" class="divide-y"></tbody>
                                    </table>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t">
                                    <div class="font-bold text-lg">إجمالي الرواتب: <span id="payroll-total"
                                            class="text-emerald-700">0.00</span></div>
                                    <button onclick="postPayroll()"
                                        class="bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700 shadow">اعتماد
                                        وصرف الرواتب</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 13. Installment Management (New) -->
            <section id="installments" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- New Installment Invoice -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">إنشاء فاتورة تقسيط</h3>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">العميل</label><select
                                    id="inst-customer"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">المنتج</label>
                                <select id="inst-product"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"
                                    onchange="updateInstPrice(this)"></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">سعر البيع (يتضمن
                                        الفائدة)</label><input type="number" id="inst-price"
                                        class="w-full p-2.5 border rounded-lg outline-none" onkeyup="calcInst()"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">الدفعة
                                        المقدمة</label><input type="number" id="inst-down"
                                        class="w-full p-2.5 border rounded-lg outline-none" onkeyup="calcInst()"
                                        placeholder="0"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">عدد الأقساط
                                        (شهر)</label><input type="number" id="inst-count"
                                        class="w-full p-2.5 border rounded-lg outline-none" value="12"
                                        onkeyup="calcInst()"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">قيمة القسط
                                        الشهري</label><input type="number" id="inst-monthly"
                                        class="w-full p-2.5 border rounded-lg bg-slate-100 font-bold text-blue-600 outline-none"
                                        readonly></div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">طريقة دفع المقدم</label>
                                <select id="inst-method"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <button onclick="createInstallmentPlan()"
                                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-lg mt-2 transition transform active:scale-95">إنشاء
                                عقد التقسيط</button>
                        </div>
                    </div>

                    <!-- Upcoming Installments -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col h-[600px]">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">الأقساط والتحصيل</h3>
                            <div class="flex gap-2">
                                <button onclick="renderInstallments()"
                                    class="bg-slate-100 text-slate-600 px-3 py-1 rounded hover:bg-slate-200 text-xs"><i
                                        class="fas fa-sync"></i> تحديث</button>
                                <button onclick="exportTableToCSV('installments-table', 'installments_list')"
                                    class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs shadow flex items-center gap-1"><i
                                        class="fas fa-file-excel"></i> تصدير</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="text" placeholder="بحث باسم العميل..."
                                class="p-2 border rounded text-sm w-full focus:border-blue-500 outline-none bg-slate-50"
                                onkeyup="filterInstallments(this.value)">
                        </div>
                        <div class="flex-1 overflow-y-auto border rounded-lg bg-slate-50">
                            <table id="installments-table" class="w-full text-sm text-right relative border-collapse">
                                <thead class="bg-indigo-100 text-indigo-900 sticky top-0 font-bold">
                                    <tr>
                                        <th class="p-3">العميل</th>
                                        <th class="p-3">المبلغ</th>
                                        <th class="p-3">تاريخ الاستحقاق</th>
                                        <th class="p-3 text-center">الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="installments-list" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Installment Customers Sub-Module -->
            <section id="installment_customers" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-user-plus text-indigo-500 me-2"></i>تسجيل عميل تقسيط</h3>
                        <form onsubmit="saveInstCustomer(event)" class="space-y-3">
                            <input type="hidden" id="inst-cust-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم العميل</label><input type="text"
                                    id="inst-cust-name" required class="w-full p-2 border rounded outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="inst-cust-phone" class="w-full p-2 border rounded outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">العنوان</label><input type="text"
                                    id="inst-cust-address" class="w-full p-2 border rounded outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهوية</label><input type="text"
                                    id="inst-cust-nid" class="w-full p-2 border rounded outline-none"></div>
                            <button type="submit"
                                class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">حفظ
                                العميل</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة عملاء التقسيط</h3>
                            <div class="flex gap-2">
                                <input type="text" placeholder="بحث بالكود أو الاسم..."
                                    class="p-2 border rounded text-sm w-48 outline-none"
                                    onkeyup="filterInstCust(this.value)">
                                <button onclick="exportTableToCSV('inst-cust-table','عملاء_التقسيط')"
                                    class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                        class="fas fa-file-excel me-1"></i>Excel</button>
                                <button onclick="printSection('inst-cust-list')"
                                    class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                        class="fas fa-print me-1"></i>طباعة</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto border rounded">
                            <table id="inst-cust-table" class="w-full text-sm text-right">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-2">الكود</th>
                                        <th class="p-2">الاسم</th>
                                        <th class="p-2">الهاتف</th>
                                        <th class="p-2">الهوية</th>
                                        <th class="p-2">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="inst-cust-list" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Installment Payment Statement Sub-Module -->
            <section id="installment_payments" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-receipt text-purple-500 me-2"></i>كشف حساب الدفعات</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInstPayments(this.value)">
                            <button onclick="exportTableToCSV('inst-pay-table','كشف_حساب_الدفعات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inst-pay-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded">
                        <table id="inst-pay-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white">
                                <tr>
                                    <th class="p-3">الكود</th>
                                    <th class="p-3">العميل</th>
                                    <th class="p-3">إجمالي العقد</th>
                                    <th class="p-3 text-emerald-400">المدفوع</th>
                                    <th class="p-3 text-yellow-400">المستحق</th>
                                    <th class="p-3 text-red-400">المتأخر</th>
                                    <th class="p-3">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="inst-pay-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 12. Customers (New) -->
            <section id="customers" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4">إضافة عميل</h3>
                        <form onsubmit="saveCustomer(event)" class="space-y-4">
                            <input type="hidden" id="cust-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم العميل</label><input type="text"
                                    id="cust-name" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">اسم الشركة</label><input type="text"
                                    id="cust-company"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">العنوان</label><input type="text"
                                    id="cust-address"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="cust-phone"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">الرقم الضريبي (اختياري)</label><input
                                    type="text" id="cust-vat"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">حفظ</button>
                                <button type="button" onclick="resetCustomerForm()"
                                    class="bg-slate-200 text-slate-600 px-4 rounded hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة العملاء</h3>
                            <button onclick="exportTableToCSV('customers-table', 'customers_list')"
                                class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs shadow flex items-center gap-1"><i
                                    class="fas fa-file-excel"></i> تصدير</button>
                        </div>
                        <table id="customers-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-50 text-slate-700">
                                <tr>
                                    <th class="p-3">الاسم</th>
                                    <th class="p-3">الشركة</th>
                                    <th class="p-3">الهاتف</th>
                                    <th class="p-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="customers-list" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 11. Salaries (New) -->
            <section id="salaries" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- نموذج صرف الراتب -->
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2"><i
                                class="fas fa-money-check-alt text-emerald-500 me-2"></i>صرف راتب</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">الموظف</label>
                                <select id="sal-employee"
                                    class="w-full p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"
                                    onchange="loadEmployeeSalary()">
                                    <option value="">-- اختر موظف --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">الشهر</label>
                                <input type="month" id="sal-month"
                                    class="w-full p-2.5 border rounded-lg text-sm bg-slate-50 outline-none">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 mb-1">الراتب الأساسي</label>
                                    <input type="number" id="sal-basic"
                                        class="w-full p-2 border rounded-lg text-sm outline-none" step="0.01">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 mb-1">البدلات</label>
                                    <input type="number" id="sal-allowance" value="0"
                                        class="w-full p-2 border rounded-lg text-sm outline-none" step="0.01">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 mb-1">الخصومات</label>
                                    <input type="number" id="sal-deduction" value="0"
                                        class="w-full p-2 border rounded-lg text-sm outline-none" step="0.01">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 mb-1">الحوافز (بونص)</label>
                                    <input type="number" id="sal-bonus" value="0"
                                        class="w-full p-2 border rounded-lg text-sm outline-none" step="0.01">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">سبب الخصم (اختياري)</label>
                                <input type="text" id="sal-deduction-reason" placeholder="مثال: غياب يومين..."
                                    class="w-full p-2 border rounded-lg text-sm outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">طريقة الصرف</label>
                                <select id="sal-method"
                                    class="w-full p-2.5 border rounded-lg text-sm bg-slate-50 outline-none">
                                    <option value="1101">نقدي (الخزينة)</option>
                                    <option value="1102">تحويل بنكي</option>
                                </select>
                            </div>

                            <!-- ملخص الصافي -->
                            <div class="bg-slate-900 text-white p-3 rounded-lg">
                                <div class="flex justify-between text-xs text-slate-400 mb-1"><span>الأساسي +
                                        البدلات:</span><span id="sal-gross">0.00</span></div>
                                <div class="flex justify-between text-xs text-red-400 mb-1"><span>-
                                        الخصومات:</span><span id="sal-ded-display">0.00</span></div>
                                <div class="flex justify-between text-xs text-emerald-400 mb-1"><span>+
                                        الحوافز:</span><span id="sal-bonus-display">0.00</span></div>
                                <div
                                    class="flex justify-between text-sm font-bold text-emerald-400 border-t border-slate-700 pt-1">
                                    <span>صافي الراتب:</span><span id="sal-net">0.00</span>
                                </div>
                            </div>

                            <button onclick="paySalary()"
                                class="w-full bg-emerald-600 text-white py-2.5 rounded-lg font-bold hover:bg-emerald-500 shadow transition active:scale-95">
                                <i class="fas fa-paper-plane me-1"></i> تسجيل صرف الراتب
                            </button>
                        </div>
                    </div>

                    <!-- سجل الرواتب -->
                    <div class="lg:col-span-2 flex flex-col gap-4">
                        <!-- إحصائيات سريعة -->
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                                <div class="text-2xl font-bold text-emerald-600" id="sal-stat-total">0.00</div>
                                <div class="text-xs text-slate-500">إجمالي الرواتب المصروفة</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                                <div class="text-2xl font-bold text-blue-600" id="sal-stat-count">0</div>
                                <div class="text-xs text-slate-500">عدد عمليات الصرف</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm text-center">
                                <div class="text-2xl font-bold text-orange-600" id="sal-stat-avg">0.00</div>
                                <div class="text-xs text-slate-500">متوسط الراتب</div>
                            </div>
                        </div>

                        <!-- جدول سجل الرواتب -->
                        <div class="bg-white p-5 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-history text-blue-500 me-1"></i>سجل صرف الرواتب</h3>
                                <div class="flex gap-2">
                                    <input type="text" placeholder="بحث..."
                                        class="p-1.5 border rounded text-xs w-36 outline-none"
                                        onkeyup="filterSalaryHistory(this.value)">
                                    <input type="month" id="sal-filter-month"
                                        class="p-1.5 border rounded text-xs outline-none"
                                        onchange="filterSalaryByMonth()">
                                    <button onclick="exportTableToCSV('salary-history-table','سجل_الرواتب')"
                                        class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('salary-history-body')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <div class="overflow-x-auto border rounded-lg max-h-[400px] overflow-y-auto">
                                <table id="salary-history-table" class="w-full text-xs text-right">
                                    <thead class="bg-slate-800 text-white sticky top-0">
                                        <tr>
                                            <th class="p-2.5">#</th>
                                            <th class="p-2.5">التاريخ</th>
                                            <th class="p-2.5">الشهر</th>
                                            <th class="p-2.5">الموظف</th>
                                            <th class="p-2.5">الأساسي</th>
                                            <th class="p-2.5">البدلات</th>
                                            <th class="p-2.5 text-red-400">الخصومات</th>
                                            <th class="p-2.5 text-emerald-400">الحوافز</th>
                                            <th class="p-2.5 text-yellow-400 font-bold">الصافي</th>
                                            <th class="p-2.5">طريقة الصرف</th>
                                            <th class="p-2.5">ملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salary-history-body" class="divide-y bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 6. Accounts Tree -->
            <section id="accounts_tree" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800">الدليل المحاسبي</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث..."
                                class="p-1.5 border rounded text-xs w-32 focus:border-blue-500 outline-none"
                                onkeyup="filterAccounts(this.value)">
                            <button onclick="alert('لإضافة حساب، يرجى التواصل مع الدعم الفني')"
                                class="bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs hover:bg-slate-200"><i
                                    class="fas fa-lock"></i></button>
                        </div>
                    </div>
                    <div class="overflow-y-auto flex-1 border rounded-lg bg-white">
                        <table class="w-full text-sm border-collapse">
                            <thead class="bg-slate-800 text-white sticky top-0 z-10">
                                <tr>
                                    <th class="p-3 text-right w-32 font-mono">الكود</th>
                                    <th class="p-3 text-right">اسم الحساب</th>
                                    <th class="p-3 text-right w-24">النوع</th>
                                    <th class="p-3 text-right w-32">الرصيد</th>
                                </tr>
                            </thead>
                            <tbody id="coa-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 7. Inventory -->
            <section id="inventory" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <h3 class="font-bold text-lg text-slate-800 mb-4"><span id="prod-form-title">إضافة صنف جديد</span>
                    </h3>
                    <form onsubmit="saveProduct(event)" class="flex flex-wrap gap-3 items-end">
                        <input type="hidden" id="prod-id">
                        <div class="flex-1 min-w-[200px]">
                            <label class="text-xs text-slate-500 mb-1 block">اسم المنتج</label>
                            <input type="text" id="new-prod-name" required
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-slate-500 mb-1 block">سعر البيع</label>
                            <input type="number" id="new-prod-price" required step="0.01"
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-slate-500 mb-1 block">التكلفة</label>
                            <input type="number" id="new-prod-cost" step="0.01"
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-slate-500 mb-1 block">الرصيد</label>
                            <input type="number" id="new-prod-stock"
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="flex gap-1">
                            <button type="submit"
                                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 h-[42px] mb-[1px] shadow">حفظ</button>
                            <button type="button" onclick="resetProductForm()"
                                class="bg-slate-200 text-slate-600 px-3 py-2 rounded hover:bg-slate-300 h-[42px] mb-[1px]">إلغاء</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">قائمة الأصناف</h3>
                        <input type="text" placeholder="بحث عن منتج..."
                            class="p-2 border rounded text-sm w-48 focus:border-blue-500 outline-none"
                            onkeyup="filterInventory(this.value)">
                    </div>
                    <table class="w-full text-sm text-right">
                        <thead class="bg-slate-50 text-slate-700">
                            <tr>
                                <th class="p-3 rounded-tr-lg">المنتج</th>
                                <th class="p-3">سعر البيع</th>
                                <th class="p-3">التكلفة</th>
                                <th class="p-3">الرصيد</th>
                                <th class="p-3 rounded-tl-lg">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- 8. Reports -->
            <section id="reports" class="section-content">
                <div class="max-w-6xl mx-auto">
                    <!-- Filters -->
                    <div
                        class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-wrap gap-4 items-end border border-slate-200">
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">من تاريخ</label>
                            <input type="date" id="rpt-start-date"
                                class="p-2 border rounded text-sm outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">إلى تاريخ</label>
                            <input type="date" id="rpt-end-date"
                                class="p-2 border rounded text-sm outline-none focus:border-blue-500">
                        </div>
                        <button onclick="renderReports()"
                            class="bg-slate-800 text-white px-6 py-2 rounded text-sm hover:bg-slate-700 shadow">تحديث
                            التقرير</button>
                    </div>

                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 col-span-1 md:col-span-2 mb-6">
                        <h3 class="font-bold text-center border-b pb-3 mb-4 text-slate-800 text-lg">ملخص العمليات</h3>
                        <div class="grid grid-cols-3 gap-4 text-center text-sm">
                            <div class="bg-blue-50 p-3 rounded"><strong>إجمالي المبيعات</strong>
                                <div id="rpt-sales-total" class="text-lg text-blue-700 mt-1">0.00</div>
                            </div>
                            <div class="bg-orange-50 p-3 rounded"><strong>إجمالي المشتريات</strong>
                                <div id="rpt-pur-total" class="text-lg text-orange-700 mt-1">0.00</div>
                            </div>
                            <div class="bg-red-50 p-3 rounded"><strong>إجمالي المصروفات</strong>
                                <div id="rpt-exp-total" class="text-lg text-red-700 mt-1">0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-center border-b pb-3 mb-4 text-slate-800 text-lg">قائمة الدخل</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between font-bold text-blue-700 bg-blue-50 p-2 rounded">
                                    <span>إيرادات النشاط</span><span id="is-rev">0.00</span>
                                </div>
                                <div class="flex justify-between text-red-500 px-2"><span>(-) تكلفة النشاط</span><span
                                        id="is-cogs">0.00</span></div>
                                <div class="flex justify-between font-bold border-t pt-2 px-2"><span>مجمل
                                        الربح</span><span id="is-gross">0.00</span></div>
                                <div class="flex justify-between text-red-500 px-2"><span>(-) المصروفات
                                        العمومية</span><span id="is-exp">0.00</span></div>
                                <div
                                    class="bg-slate-900 text-white p-3 rounded-lg flex justify-between text-lg font-bold mt-4">
                                    <span>صافي الربح</span><span id="is-net">0.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-[500px] flex flex-col">
                            <h3 class="font-bold text-center border-b pb-3 mb-4 text-slate-800 text-lg">ميزان المراجعة
                                (تراكمي)</h3>
                            <div class="overflow-y-auto flex-1">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-slate-100 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">الحساب</th>
                                            <th class="p-2">مدين</th>
                                            <th class="p-2">دائن</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trial-balance-body" class="divide-y"></tbody>
                                </table>
                            </div>
                            <div class="bg-slate-100 p-2 rounded font-bold text-xs flex justify-between mt-2">
                                <span>الإجمالي</span>
                                <span class="text-emerald-600" id="tb-total-dr">0.00</span>
                                <span class="text-red-600" id="tb-total-cr">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>


            <!-- ===== INVOICES MODULE ===== -->
            <section id="invoices" class="section-content">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center cursor-pointer hover:shadow-md transition"
                        onclick="showSection('inv_pos')">
                        <i class="fas fa-cash-register text-3xl text-purple-500 mb-2"></i>
                        <div class="text-2xl font-bold text-purple-600" id="inv-count-pos">0</div>
                        <div class="text-xs text-slate-500">فواتير نقاط البيع</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center cursor-pointer hover:shadow-md transition"
                        onclick="showSection('inv_sales')">
                        <i class="fas fa-file-alt text-3xl text-blue-500 mb-2"></i>
                        <div class="text-2xl font-bold text-blue-600" id="inv-count-sales">0</div>
                        <div class="text-xs text-slate-500">فواتير المبيعات</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center cursor-pointer hover:shadow-md transition"
                        onclick="showSection('inv_purchases')">
                        <i class="fas fa-file-import text-3xl text-orange-500 mb-2"></i>
                        <div class="text-2xl font-bold text-orange-600" id="inv-count-pur">0</div>
                        <div class="text-xs text-slate-500">فواتير المشتريات</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center cursor-pointer hover:shadow-md transition"
                        onclick="showSection('inv_services')">
                        <i class="fas fa-file-medical text-3xl text-teal-500 mb-2"></i>
                        <div class="text-2xl font-bold text-teal-600" id="inv-count-svc">0</div>
                        <div class="text-xs text-slate-500">فواتير الخدمات</div>
                    </div>
                </div>
            </section>

            <!-- فواتير نقاط البيع -->
            <!-- inv_pos hidden - merged into inv_sales -->
            <section id="inv_pos" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm text-center text-slate-400"><i
                        class="fas fa-info-circle me-2"></i>تم دمج فواتير نقاط البيع مع فواتير المبيعات <button
                        onclick="showSection('inv_sales')" class="text-blue-500 underline">عرض فواتير المبيعات</button>
                </div>
            </section>

            <!-- ===== فواتير المبيعات (Enhanced) ===== -->
            <section id="inv_sales" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-alt text-blue-500 me-2"></i>فواتير المبيعات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="inv-sales-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvSales()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="inv-sales-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvSales()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-sales-body',this.value)">
                            <button onclick="exportTableToCSV('inv-sales-table','فواتير_المبيعات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-sales-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="inv-sales-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="inv-sales-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-sales-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-sales-rem">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-sales-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-sales-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== فواتير المشتريات (Enhanced) ===== -->
            <section id="inv_purchases" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-import text-orange-500 me-2"></i>فواتير المشتريات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="inv-pur-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvPurchases()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="inv-pur-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvPurchases()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-pur-body',this.value)">
                            <button onclick="exportTableToCSV('inv-pur-table','فواتير_المشتريات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-pur-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-orange-600" id="inv-pur-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="inv-pur-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-pur-paid">0.00</div>
                            <div class="text-xs text-slate-500">المدفوع</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-pur-rem">0.00</div>
                            <div class="text-xs text-slate-500">المستحق علينا</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-pur-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">المورد</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-pur-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== فواتير الخدمات (Enhanced) ===== -->
            <section id="inv_services" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-medical text-teal-500 me-2"></i>فواتير الخدمات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="inv-svc-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvServices()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="inv-svc-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvServices()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-svc-body',this.value)">
                            <button onclick="exportTableToCSV('inv-svc-table','فواتير_الخدمات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-svc-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-teal-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-teal-600" id="inv-svc-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-cyan-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-cyan-600" id="inv-svc-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-svc-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-svc-rem">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-svc-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-svc-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== فواتير التقسيط (Enhanced) ===== -->
            <section id="inv_installments" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-contract text-indigo-500 me-2"></i>فواتير التقسيط</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-inst-body',this.value)">
                            <button onclick="exportTableToCSV('inv-inst-table','فواتير_التقسيط')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-inst-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="inv-inst-count">0</div>
                            <div class="text-xs text-slate-500">عدد العقود</div>
                        </div>
                        <div class="bg-violet-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-violet-600" id="inv-inst-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-inst-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-inst-rem">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-inst-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم العقد</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المقدم</th>
                                    <th class="p-2.5">المحصّل</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-inst-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== كشف حساب العملاء (مستقل) ===== -->
            <section id="cust_statement" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-invoice-dollar text-blue-500 me-2"></i>كشف حساب العملاء</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <select id="cust-stmt-filter" class="p-2 border rounded text-sm outline-none"
                                onchange="renderCustStatementFull()">
                                <option value="">كل العملاء</option>
                            </select>
                            <label class="text-xs text-slate-500">من</label><input type="date" id="cust-stmt-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderCustStatementFull()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="cust-stmt-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderCustStatementFull()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('cust-stmt-body',this.value)">
                            <button onclick="exportTableToCSV('cust-stmt-table','كشف_حساب_العملاء')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('cust-stmt-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[550px] overflow-y-auto">
                        <table id="cust-stmt-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">النوع</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">إجمالي الفاتورة</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="cust-stmt-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 bg-slate-100 p-4 rounded-lg grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-lg font-bold text-indigo-600" id="cust-stmt-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-blue-600" id="cust-stmt-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الفواتير</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-emerald-600" id="cust-stmt-paid">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المدفوع</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-red-600" id="cust-stmt-remaining">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المتبقي</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== كشف حساب الموردين (مستقل) ===== -->
            <section id="supp_statement" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-invoice text-orange-500 me-2"></i>كشف حساب الموردين</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <select id="supp-stmt-filter" class="p-2 border rounded text-sm outline-none"
                                onchange="renderSuppStatementFull()">
                                <option value="">كل الموردين</option>
                            </select>
                            <label class="text-xs text-slate-500">من</label><input type="date" id="supp-stmt-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderSuppStatementFull()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="supp-stmt-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderSuppStatementFull()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('supp-stmt-body',this.value)">
                            <button onclick="exportTableToCSV('supp-stmt-table','كشف_حساب_الموردين')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('supp-stmt-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[550px] overflow-y-auto">
                        <table id="supp-stmt-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">المورد</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">إجمالي الفاتورة</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="supp-stmt-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 bg-slate-100 p-4 rounded-lg grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-lg font-bold text-indigo-600" id="supp-stmt-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-orange-600" id="supp-stmt-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الفواتير</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-emerald-600" id="supp-stmt-paid">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المدفوع</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-red-600" id="supp-stmt-remaining">0.00</div>
                            <div class="text-xs text-slate-500">المستحق علينا</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== كشف حساب الخدمات ===== -->
            <section id="svc_statement" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-alt text-teal-500 me-2"></i>كشف حساب الخدمات</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('svc-stmt-body',this.value)">
                            <button onclick="exportTableToCSV('svc-stmt-table','كشف_حساب_الخدمات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('svc-stmt-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="svc-stmt-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5"></th>
                                </tr>
                            </thead>
                            <tbody id="svc-stmt-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== الأقساط والتحصيل ===== -->
            <section id="inst_collection" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-hand-holding-usd text-indigo-500 me-2"></i>الأقساط والتحصيل</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث باسم العميل أو رقم التلفون..."
                                class="p-2 border rounded text-sm w-56 outline-none"
                                onkeyup="filterInvTable('inst-collect-body',this.value)">
                            <button onclick="exportTableToCSV('inst-collect-table','الأقساط_والتحصيل')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inst-collect-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[550px] overflow-y-auto">
                        <table id="inst-collect-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">التلفون</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">إجمالي العقد</th>
                                    <th class="p-2.5">عدد الأقساط</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">القسط القادم</th>
                                    <th class="p-2.5"></th>
                                </tr>
                            </thead>
                            <tbody id="inst-collect-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== سندات الصرف ===== -->
            <section id="expense_vouchers" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-receipt text-red-500 me-2"></i>سندات الصرف</h3>
                        <div class="flex gap-2">
                            <input type="date" id="exp-voucher-from" class="p-2 border rounded text-xs outline-none"
                                onchange="renderExpenseVouchers()">
                            <input type="date" id="exp-voucher-to" class="p-2 border rounded text-xs outline-none"
                                onchange="renderExpenseVouchers()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-36 outline-none"
                                onkeyup="filterInvTable('exp-voucher-body',this.value)">
                            <button onclick="exportTableToCSV('exp-voucher-table','سندات_الصرف')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('exp-voucher-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="exp-voucher-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">#</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">البيان</th>
                                    <th class="p-2.5">الفئة</th>
                                    <th class="p-2.5">المبلغ</th>
                                    <th class="p-2.5">طريقة الصرف</th>
                                </tr>
                            </thead>
                            <tbody id="exp-voucher-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 bg-red-50 p-3 rounded-lg text-center">
                        <span class="text-sm text-slate-600">إجمالي المصروفات: </span>
                        <span class="text-xl font-bold text-red-600" id="exp-voucher-total">0.00</span>
                    </div>
                </div>
            </section>

            <!-- ===== HR: إدارة الموظفين ===== -->
            <section id="hr_employees" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-id-card text-blue-500 me-2"></i>إضافة / تعديل موظف</h3>
                        <form onsubmit="saveHREmployee(event)" class="space-y-3">
                            <input type="hidden" id="hr-emp-id">
                            <div><label class="text-xs text-slate-500 mb-1 block">الاسم الكامل *</label><input
                                    type="text" id="hr-emp-name" required
                                    class="w-full p-2.5 border rounded-lg outline-none"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-500 mb-1 block">الهاتف</label><input type="text"
                                        id="hr-emp-phone" class="w-full p-2.5 border rounded-lg outline-none"></div>
                                <div><label class="text-xs text-slate-500 mb-1 block">الوظيفة</label><input type="text"
                                        id="hr-emp-position" class="w-full p-2.5 border rounded-lg outline-none"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-500 mb-1 block">الراتب الأساسي</label><input
                                        type="number" id="hr-emp-salary" step="0.01"
                                        class="w-full p-2.5 border rounded-lg outline-none"></div>
                                <div><label class="text-xs text-slate-500 mb-1 block">تاريخ التعيين</label><input
                                        type="date" id="hr-emp-hiredate"
                                        class="w-full p-2.5 border rounded-lg outline-none"></div>
                            </div>
                            <div class="flex gap-2"><button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700"><i
                                        class="fas fa-save me-1"></i>حفظ</button><button type="button"
                                    onclick="resetHREmployeeForm()"
                                    class="bg-slate-200 text-slate-600 px-4 py-2.5 rounded-lg">إلغاء</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">الموظفين</h3><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('hr-emp-body',this.value)">
                        </div>
                        <div class="overflow-x-auto border rounded-lg max-h-[400px] overflow-y-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-800 text-white sticky top-0">
                                    <tr>
                                        <th class="p-2.5">الاسم</th>
                                        <th class="p-2.5">الوظيفة</th>
                                        <th class="p-2.5">الهاتف</th>
                                        <th class="p-2.5">الراتب</th>
                                        <th class="p-2.5">تاريخ التعيين</th>
                                        <th class="p-2.5"></th>
                                    </tr>
                                </thead>
                                <tbody id="hr-emp-body" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== HR: الإجراءات ===== -->
            <section id="hr_actions" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-clipboard-list text-amber-500 me-2"></i>تسجيل إجراء</h3>
                        <div class="space-y-3">
                            <div><label class="text-xs text-slate-500 mb-1 block">الموظف</label><select
                                    id="hr-action-emp" class="w-full p-2.5 border rounded-lg outline-none"></select>
                            </div>
                            <div><label class="text-xs text-slate-500 mb-1 block">نوع الإجراء</label>
                                <select id="hr-action-type" class="w-full p-2.5 border rounded-lg outline-none">
                                    <option value="bonus">مكافأة</option>
                                    <option value="deduction">خصم</option>
                                    <option value="warning">إنذار</option>
                                    <option value="leave">إجازة</option>
                                    <option value="promotion">ترقية</option>
                                </select>
                            </div>
                            <div><label class="text-xs text-slate-500 mb-1 block">المبلغ (إن وجد)</label><input
                                    type="number" id="hr-action-amount" step="0.01"
                                    class="w-full p-2.5 border rounded-lg outline-none"></div>
                            <div><label class="text-xs text-slate-500 mb-1 block">السبب / الملاحظات</label><input
                                    type="text" id="hr-action-reason"
                                    class="w-full p-2.5 border rounded-lg outline-none"></div>
                            <button onclick="saveHRAction()"
                                class="w-full bg-amber-600 text-white py-2.5 rounded-lg font-bold hover:bg-amber-500"><i
                                    class="fas fa-save me-1"></i>تسجيل</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">سجل الإجراءات</h3>
                            <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                    class="p-2 border rounded text-sm w-36 outline-none"
                                    onkeyup="filterInvTable('hr-action-body',this.value)"><button
                                    onclick="exportTableToCSV('hr-action-table','الإجراءات')"
                                    class="text-xs bg-emerald-50 text-emerald-600 px-2 py-1 rounded"><i
                                        class="fas fa-file-excel"></i></button><button
                                    onclick="printSection('hr-action-body')"
                                    class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded"><i
                                        class="fas fa-print"></i></button></div>
                        </div>
                        <div class="overflow-x-auto border rounded-lg max-h-[400px] overflow-y-auto">
                            <table id="hr-action-table" class="w-full text-sm text-right">
                                <thead class="bg-slate-800 text-white sticky top-0">
                                    <tr>
                                        <th class="p-2.5">التاريخ</th>
                                        <th class="p-2.5">الموظف</th>
                                        <th class="p-2.5">النوع</th>
                                        <th class="p-2.5">المبلغ</th>
                                        <th class="p-2.5">السبب</th>
                                    </tr>
                                </thead>
                                <tbody id="hr-action-body" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== HR: قائمة الموظفين ===== -->
            <section id="hr_list" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-list-ul text-blue-500 me-2"></i>قائمة الموظفين</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('hr-list-body',this.value)"><button
                                onclick="exportTableToCSV('hr-list-table','الموظفين')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('hr-list-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="hr-list-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">#</th>
                                    <th class="p-2.5">الاسم</th>
                                    <th class="p-2.5">الوظيفة</th>
                                    <th class="p-2.5">الهاتف</th>
                                    <th class="p-2.5">الراتب</th>
                                    <th class="p-2.5">تاريخ التعيين</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="hr-list-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== HR: كشف رواتب ===== -->
            <section id="hr_payroll" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-money-check-alt text-emerald-500 me-2"></i>صرف راتب</h3>
                        <div class="space-y-3">
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">الموظف</label><select
                                    id="payroll-emp" class="w-full p-2.5 border rounded-lg text-sm outline-none"
                                    onchange="loadPayrollSalary()">
                                    <option value="">-- اختر --</option>
                                </select></div>
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">الشهر</label><input
                                    type="month" id="payroll-month"
                                    class="w-full p-2.5 border rounded-lg text-sm outline-none"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-600 mb-1 block">الأساسي</label><input
                                        type="number" id="payroll-basic"
                                        class="w-full p-2 border rounded-lg text-sm outline-none"
                                        oninput="calcPayrollNet()"></div>
                                <div><label class="text-xs text-slate-600 mb-1 block">البدلات</label><input
                                        type="number" id="payroll-allowance" value="0"
                                        class="w-full p-2 border rounded-lg text-sm outline-none"
                                        oninput="calcPayrollNet()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-600 mb-1 block">الخصومات</label><input
                                        type="number" id="payroll-deduction" value="0"
                                        class="w-full p-2 border rounded-lg text-sm outline-none"
                                        oninput="calcPayrollNet()"></div>
                                <div><label class="text-xs text-slate-600 mb-1 block">الحوافز</label><input
                                        type="number" id="payroll-bonus" value="0"
                                        class="w-full p-2 border rounded-lg text-sm outline-none"
                                        oninput="calcPayrollNet()"></div>
                            </div>
                            <div><label class="text-xs text-slate-600 mb-1 block">ملاحظات</label><input type="text"
                                    id="payroll-notes" class="w-full p-2 border rounded-lg text-sm outline-none"></div>
                            <div><label class="text-xs text-slate-600 mb-1 block">طريقة الصرف</label><select
                                    id="payroll-method" class="w-full p-2.5 border rounded-lg text-sm outline-none">
                                    <option value="1101">نقدي</option>
                                    <option value="1102">بنك</option>
                                </select></div>
                            <div class="bg-slate-900 text-white p-3 rounded-lg">
                                <div class="flex justify-between text-xs text-slate-400 mb-1">
                                    <span>الإجمالي:</span><span id="payroll-gross">0.00</span>
                                </div>
                                <div class="flex justify-between text-xs text-red-400 mb-1"><span>- خصومات:</span><span
                                        id="payroll-ded-show">0.00</span></div>
                                <div
                                    class="flex justify-between text-sm font-bold text-emerald-400 border-t border-slate-700 pt-1">
                                    <span>الصافي:</span><span id="payroll-net">0.00</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="processPayroll()"
                                    class="bg-emerald-600 text-white py-2.5 rounded-lg font-bold hover:bg-emerald-500 text-sm"><i
                                        class="fas fa-save me-1"></i>حفظ</button>
                                <button onclick="printLastPayroll()"
                                    class="bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-500 text-sm"><i
                                        class="fas fa-print me-1"></i>طباعة</button>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-sm text-slate-800"><i
                                    class="fas fa-history text-blue-500 me-1"></i>سجل الرواتب</h3>
                            <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                    class="p-1.5 border rounded text-xs w-36 outline-none"
                                    onkeyup="filterInvTable('payroll-body',this.value)"><input type="month"
                                    id="payroll-filter-month" class="p-1.5 border rounded text-xs outline-none"
                                    onchange="filterPayrollByMonth()"><button
                                    onclick="exportTableToCSV('payroll-table','كشف_رواتب')"
                                    class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded"><i
                                        class="fas fa-file-excel"></i></button><button
                                    onclick="printSection('payroll-body')"
                                    class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded"><i
                                        class="fas fa-print"></i></button></div>
                        </div>
                        <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                            <table id="payroll-table" class="w-full text-xs text-right">
                                <thead class="bg-slate-800 text-white sticky top-0">
                                    <tr>
                                        <th class="p-2">#</th>
                                        <th class="p-2">التاريخ</th>
                                        <th class="p-2">الشهر</th>
                                        <th class="p-2">الموظف</th>
                                        <th class="p-2">الأساسي</th>
                                        <th class="p-2">البدلات</th>
                                        <th class="p-2 text-red-400">الخصومات</th>
                                        <th class="p-2 text-emerald-400">الحوافز</th>
                                        <th class="p-2 text-yellow-400 font-bold">الصافي</th>
                                        <th class="p-2">الصرف</th>
                                        <th class="p-2">ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody id="payroll-body" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>


            <!-- ===== تقارير نقاط البيع ===== -->
            <section id="rpt_pos" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-cash-register text-purple-500 me-2"></i>تقرير نقاط البيع</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-pos-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptPOS()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-pos-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptPOS()">
                            <button onclick="exportTableToCSV('rpt-pos-table','تقرير_نقاط_البيع')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-pos-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-purple-600" id="rpt-pos-count">0</div>
                            <div class="text-xs text-slate-500">عدد الإيصالات</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-pos-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المبيعات</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-pos-items">0</div>
                            <div class="text-xs text-slate-500">عدد الأصناف المباعة</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-pos-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الإيصال</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">الوقت</th>
                                    <th class="p-2.5">عدد الأصناف</th>
                                    <th class="p-2.5">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-pos-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير المبيعات ===== -->
            <section id="rpt_sales" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-chart-line text-blue-500 me-2"></i>تقرير المبيعات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-sales-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptSales()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-sales-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptSales()">
                            <button onclick="exportTableToCSV('rpt-sales-table','تقرير_المبيعات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-sales-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-sales-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-sales-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المبيعات</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-green-600" id="rpt-sales-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-sales-remaining">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-sales-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-sales-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير العملاء ===== -->
            <section id="rpt_customers" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-users text-indigo-500 me-2"></i>تقرير العملاء</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-customers-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-customers-table','تقرير_العملاء')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-customers-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="rpt-cust-count">0</div>
                            <div class="text-xs text-slate-500">عدد العملاء</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-cust-total-sales">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المبيعات</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-cust-total-due">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المستحق</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-customers-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الهاتف</th>
                                    <th class="p-2.5">عدد الفواتير</th>
                                    <th class="p-2.5">إجمالي المشتريات</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المستحق</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-customers-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير المشتريات ===== -->
            <section id="rpt_purchases" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-shopping-cart text-orange-500 me-2"></i>تقرير المشتريات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-pur-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptPurchases()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-pur-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptPurchases()">
                            <button onclick="exportTableToCSV('rpt-pur-table','تقرير_المشتريات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-pur-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-orange-600" id="rpt-pur-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-pur-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المشتريات</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-pur-paid">0.00</div>
                            <div class="text-xs text-slate-500">المدفوع</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="rpt-pur-remaining">0.00</div>
                            <div class="text-xs text-slate-500">المستحق علينا</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-pur-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">المورد</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-pur-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الموردين ===== -->
            <section id="rpt_suppliers" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-truck text-amber-500 me-2"></i>تقرير الموردين</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-supp-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-supp-table','تقرير_الموردين')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-supp-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="rpt-supp-count">0</div>
                            <div class="text-xs text-slate-500">عدد الموردين</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-orange-600" id="rpt-supp-total-pur">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المشتريات</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-supp-total-due">0.00</div>
                            <div class="text-xs text-slate-500">المستحق علينا</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-supp-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">المورد</th>
                                    <th class="p-2.5">الهاتف</th>
                                    <th class="p-2.5">عدد الفواتير</th>
                                    <th class="p-2.5">إجمالي المشتريات</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المستحق</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-supp-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الموظفين ===== -->
            <section id="rpt_employees" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-user-tie text-blue-500 me-2"></i>تقرير الموظفين</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-emp-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-emp-table','تقرير_الموظفين')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-emp-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-emp-count">0</div>
                            <div class="text-xs text-slate-500">عدد الموظفين</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-emp-total-salary">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الرواتب الشهري</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="rpt-emp-total-paid">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المصروف</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-emp-actions">0</div>
                            <div class="text-xs text-slate-500">عدد الإجراءات</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-emp-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">الاسم</th>
                                    <th class="p-2.5">الوظيفة</th>
                                    <th class="p-2.5">الراتب</th>
                                    <th class="p-2.5">عدد المرتبات</th>
                                    <th class="p-2.5">إجمالي المصروف</th>
                                    <th class="p-2.5">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-emp-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير المخزون ===== -->
            <section id="rpt_inventory" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-boxes text-teal-500 me-2"></i>تقرير المخزون</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-inv-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-inv-table','تقرير_المخزون')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-inv-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-teal-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-teal-600" id="rpt-inv-count">0</div>
                            <div class="text-xs text-slate-500">عدد الأصناف</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-inv-total-stock">0</div>
                            <div class="text-xs text-slate-500">إجمالي المخزون</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-inv-total-value">0.00</div>
                            <div class="text-xs text-slate-500">قيمة المخزون (بيع)</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-inv-low">0</div>
                            <div class="text-xs text-slate-500">أصناف منخفضة</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-inv-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">الكود</th>
                                    <th class="p-2.5">الصنف</th>
                                    <th class="p-2.5">الفئة</th>
                                    <th class="p-2.5">سعر البيع</th>
                                    <th class="p-2.5">التكلفة</th>
                                    <th class="p-2.5">المخزون</th>
                                    <th class="p-2.5">قيمة المخزون</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-inv-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الخدمات ===== -->
            <section id="rpt_services" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-tools text-cyan-500 me-2"></i>تقرير الخدمات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-svc-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptServices()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-svc-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptServices()">
                            <button onclick="exportTableToCSV('rpt-svc-table','تقرير_الخدمات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-svc-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-cyan-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-cyan-600" id="rpt-svc-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-svc-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-green-600" id="rpt-svc-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-svc-remaining">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-svc-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5">المتبقي</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-svc-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير التقسيط ===== -->
            <section id="rpt_installments" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-calendar-alt text-indigo-500 me-2"></i>تقرير التقسيط</h3>
                        <div class="flex gap-2"><button onclick="exportTableToCSV('rpt-inst-table','تقرير_التقسيط')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-inst-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="rpt-inst-count">0</div>
                            <div class="text-xs text-slate-500">عدد العقود</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-inst-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي العقود</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-inst-collected">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-inst-pending">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-inst-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المقدم</th>
                                    <th class="p-2.5">الأقساط</th>
                                    <th class="p-2.5">المحصّل</th>
                                    <th class="p-2.5">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-inst-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير عملاء التقسيط ===== -->
            <section id="rpt_inst_customers" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-user-tag text-violet-500 me-2"></i>تقرير عملاء التقسيط</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-instcust-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-instcust-table','تقرير_عملاء_التقسيط')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-instcust-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="rpt-instcust-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الهاتف</th>
                                    <th class="p-2.5">العنوان</th>
                                    <th class="p-2.5">عدد العقود</th>
                                    <th class="p-2.5">إجمالي المبلغ</th>
                                    <th class="p-2.5">المحصّل</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-instcust-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير المصروفات ===== -->
            <section id="rpt_expenses" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-money-bill-wave text-red-500 me-2"></i>تقرير المصروفات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-exp-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptExpenses()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-exp-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptExpenses()">
                            <button onclick="exportTableToCSV('rpt-exp-table','تقرير_المصروفات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-exp-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-exp-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المصروفات</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-orange-600" id="rpt-exp-count">0</div>
                            <div class="text-xs text-slate-500">عدد السندات</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="rpt-exp-avg">0.00</div>
                            <div class="text-xs text-slate-500">المتوسط لكل سند</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-exp-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">#</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">البيان</th>
                                    <th class="p-2.5">الفئة</th>
                                    <th class="p-2.5">المبلغ</th>
                                    <th class="p-2.5">الطريقة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-exp-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الإيرادات ===== -->
            <section id="rpt_revenue" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-coins text-yellow-500 me-2"></i>تقرير الإيرادات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-rev-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptRevenue()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-rev-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptRevenue()">
                            <button onclick="exportTableToCSV('rpt-rev-table','تقرير_الإيرادات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-rev-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-yellow-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-yellow-600" id="rpt-rev-sales">0.00</div>
                            <div class="text-xs text-slate-500">إيرادات المبيعات</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-purple-600" id="rpt-rev-pos">0.00</div>
                            <div class="text-xs text-slate-500">إيرادات POS</div>
                        </div>
                        <div class="bg-teal-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-teal-600" id="rpt-rev-svc">0.00</div>
                            <div class="text-xs text-slate-500">إيرادات الخدمات</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-rev-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الإيرادات</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-rev-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">المصدر</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">البيان</th>
                                    <th class="p-2.5">المبلغ</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-rev-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الخزينة ===== -->
            <section id="rpt_treasury" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-vault text-slate-600 me-2"></i>تقرير الخزينة</h3>
                        <div class="flex gap-2"><button onclick="exportTableToCSV('rpt-treasury-table','تقرير_الخزينة')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-treasury-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-trs-in">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الوارد</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-trs-out">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الصادر</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-trs-cash">0.00</div>
                            <div class="text-xs text-slate-500">رصيد الصندوق</div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="rpt-trs-bank">0.00</div>
                            <div class="text-xs text-slate-500">رصيد البنك</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-treasury-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">البيان</th>
                                    <th class="p-2.5 text-emerald-400">وارد</th>
                                    <th class="p-2.5 text-red-400">صادر</th>
                                    <th class="p-2.5">الرصيد</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-treasury-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الأرباح ===== -->
            <section id="rpt_profits" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-chart-pie text-green-500 me-2"></i>تقرير الأرباح</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-profit-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptProfits()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-profit-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptProfits()">
                            <button onclick="printSection('rpt-profit-summary')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div id="rpt-profit-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-emerald-100 p-4 rounded-xl text-center border-2 border-emerald-300">
                            <div class="text-2xl font-bold text-emerald-700" id="rpt-pft-revenue">0.00</div>
                            <div class="text-xs text-emerald-600 font-bold">إجمالي الإيرادات</div>
                        </div>
                        <div class="bg-red-100 p-4 rounded-xl text-center border-2 border-red-300">
                            <div class="text-2xl font-bold text-red-700" id="rpt-pft-cost">0.00</div>
                            <div class="text-xs text-red-600 font-bold">تكلفة البضاعة المباعة</div>
                        </div>
                        <div class="bg-amber-100 p-4 rounded-xl text-center border-2 border-amber-300">
                            <div class="text-2xl font-bold text-amber-700" id="rpt-pft-expenses">0.00</div>
                            <div class="text-xs text-amber-600 font-bold">المصروفات + الرواتب</div>
                        </div>
                        <div class="bg-green-100 p-4 rounded-xl text-center border-2 border-green-400">
                            <div class="text-3xl font-bold" id="rpt-pft-net">0.00</div>
                            <div class="text-xs font-bold" id="rpt-pft-label">صافي الربح</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">تفاصيل الإيرادات</h4>
                            <div id="rpt-pft-rev-details" class="space-y-1 text-xs"></div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">تفاصيل التكاليف</h4>
                            <div id="rpt-pft-cost-details" class="space-y-1 text-xs"></div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">تفاصيل المصروفات</h4>
                            <div id="rpt-pft-exp-details" class="space-y-1 text-xs"></div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // --- 0. Firebase Config & Login ---
        const firebaseConfig = {
            apiKey: "AIzaSyB6if5oe1FBqJlp-glu2AmRaGKODRo14ck",
            authDomain: "erm1-92e4f.firebaseapp.com",
            projectId: "erm1-92e4f",
            storageBucket: "erm1-92e4f.firebasestorage.app",
            messagingSenderId: "868668789906",
            appId: "1:868668789906:web:a56f9a9c441c66c008024b",
            measurementId: "G-JJ2MHMPX22"
        };
        firebase.initializeApp(firebaseConfig);
        const dbFirestore = firebase.firestore();

        // --- 1. Data Structure ---
        let db = {
            settings: {
                companyName: 'شركتي', logo: '',
                vatRate: 15,
                currency: 'SAR',
                phone: '', address: '', vatNumber: '',
                paymentMethods: ['Cash', 'Bank', 'Wallet', 'InstaPay']
            },
            services: [{ id: 1, name: 'خدمة تركيب', price: 150, description: 'تركيب وصيانة' }],
            expensesCategories: [
                { id: '5201', name: 'مصروفات تشغيلية' },
                { id: '5202', name: 'رواتب وأجور' }, // We'll use this for HR later
                { id: '5203', name: 'مصروفات أخرى (طارئة)' }
            ],
            expenses: [],

            employees: [
                { id: 1, name: 'موظف تجريبي', role: 'مبيعات', salary: 3000, phone: '0500000000', photo: '' }
            ],
            payrollActions: [],
            payrollRuns: [],

            users: [
                { id: 1, name: 'المدير العام', role: 'admin', phone: '0000' }
            ],
            currentUser: 1,
            chartOfAccounts: [
                { code: '1', name: 'الأصول', type: 'asset', level: 1, balance: 0, isGroup: true },
                { code: '11', name: 'أصول متداولة', type: 'asset', level: 2, parent: '1', balance: 0, isGroup: true },
                { code: '1101', name: 'الخزينة الرئيسية', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1102', name: 'البنك ', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1103', name: 'العملاء', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1104', name: 'المخزون', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '2', name: 'الالتزامات', type: 'liability', level: 1, balance: 0, isGroup: true },
                { code: '2101', name: 'الموردين (الدائنون)', type: 'liability', level: 3, parent: '2', balance: 0 },
                { code: '2102', name: 'ضريبة القيمة المضافة', type: 'liability', level: 3, parent: '2', balance: 0 },
                { code: '3', name: 'حقوق الملكية', type: 'equity', level: 1, balance: 0, isGroup: true },
                { code: '3101', name: 'رأس المال', type: 'equity', level: 3, parent: '3', balance: 0 },
                { code: '4', name: 'الإيرادات', type: 'revenue', level: 1, balance: 0, isGroup: true },
                { code: '4101', name: 'إيرادات المبيعات', type: 'revenue', level: 3, parent: '4', balance: 0 },
                { code: '5', name: 'المصروفات', type: 'expense', level: 1, balance: 0, isGroup: true },
                { code: '5101', name: 'تكلفة المبيعات', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5201', name: 'مصروفات تشغيلية', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5202', name: 'الرواتب والأجور', type: 'expense', level: 3, parent: '5', balance: 0 }
            ],
            journal: [],
            products: [{ id: 1, name: 'منتج تجريبي', price: 100, cost: 80, stock: 10 }],
            customers: [{ id: 1, name: 'عميل نقدي', phone: '', address: '', company: '', vat: '' }],
            suppliers: [{ id: 1, name: 'مورد عام', phone: '', address: '', company: '', vat: '' }],
            installments: [],
            returns: [],
            sales: [],
            purchases: []
        };

        let currentCart = [];
        let currentPurCart = [];
        let currentInvoiceToPrint = null;

        // --- 2. Initialization ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            if (u === 'admin' && p === '123') {
                document.getElementById('login-modal').classList.add('hidden');
                init();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        async function init() {
            showSection('dashboard');
            showToast('جاري تحميل البيانات من السيرفر...', 'info');
            try {
                const doc = await dbFirestore.collection('app_data').doc('main_db').get();
                if (doc.exists) {
                    db = doc.data();
                    // Ensure structure integrity if fields are missing
                    if (!db.users) db.users = [{ id: 1, name: 'Admin', role: 'admin' }];
                    if (!db.suppliers) db.suppliers = [{ id: 1, name: 'مورد عام' }];
                    if (!db.products) db.products = [];
                    if (!db.chartOfAccounts) db.chartOfAccounts = []; // Should ideally be full chart, but empty prevents crash
                    if (!db.purchases) db.purchases = [];
                    if (!db.settings.paymentMethods) db.settings.paymentMethods = ['Cash', 'Bank', 'Wallet', 'InstaPay'];
                    if (!db.installments) db.installments = [];
                    if (!db.returns) db.returns = [];
                    if (!db.settings.logo) db.settings.logo = '';
                    if (!db.services) db.services = [];
                    // Structural updates
                    db.customers.forEach(c => { if (c.address === undefined) c.address = ''; if (c.company === undefined) c.company = ''; if (c.vat === undefined) c.vat = ''; });
                    db.suppliers.forEach(s => { if (s.address === undefined) s.address = ''; if (s.company === undefined) s.company = ''; });
                    showToast('تم تحميل البيانات بنجاح');
                } else {
                    // Initialize default data if new
                    addJournalEntry(new Date().toISOString().split('T')[0], 'قيد افتتاحي: رأس المال', [
                        { code: '1101', dr: 50000, cr: 0 },
                        { code: '3101', dr: 0, cr: 50000 }
                    ]);
                    save(); // Save initial state to Firebase
                }
            } catch (error) {
                console.error("Error loading data:", error);
                showToast('خطأ في الاتصال بقاعدة البيانات', 'error');
                // Fallback to local if needed, or just stay empty
            }

            // Set Default Dates for Reports (This Month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            if (document.getElementById('rpt-start-date')) document.getElementById('rpt-start-date').valueAsDate = firstDay;
            if (document.getElementById('rpt-end-date')) document.getElementById('rpt-end-date').valueAsDate = today;
            if (document.getElementById('pur-date')) document.getElementById('pur-date').valueAsDate = today;

            try { loadSettingsToForm(); } catch (e) { console.error('Error loading settings', e); }
            try { populateSelects(); } catch (e) { console.error('Error populating selects', e); }
            try { renderUsersTable(); } catch (e) { console.error('Error rendering users', e); }
            try { renderSuppliersTable(); } catch (e) { console.error('Error rendering suppliers', e); }
            try { renderCustomersTable(); } catch (e) { console.error('Error rendering customers', e); }
            try { updateLogoView(); } catch (e) { console.error('Error updating logo', e); }
            renderAll();

            document.getElementById('journal-lines').innerHTML = '';
            addJournalLineRow(); addJournalLineRow();

            document.getElementById('header-date').innerText = new Date().toLocaleDateString('ar-EG');
            showSection('dashboard');
        }

        async function save() {
            // Save to Firestore
            // localStorage.setItem('erp_pro_v10', JSON.stringify(db)); // Backup local
            await dbFirestore.collection('app_data').doc('main_db').set(db).catch(e => console.error(e));
            renderAll();
        }

        // --- 3. User Management ---
        function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const name = document.getElementById('user-name').value;
            const role = document.getElementById('user-role').value;
            const phone = document.getElementById('user-phone').value;

            if (id) { // Edit
                const user = db.users.find(u => u.id == id);
                if (user) { user.name = name; user.role = role; user.phone = phone; }
                showToast('تم تعديل المستخدم');
            } else { // New
                db.users.push({ id: Date.now(), name, role, phone });
                showToast('تم إضافة المستخدم');
            }
            save(); renderUsersTable(); populateSelects(); resetUserForm();
        }

        function deleteUser(id) {
            if (confirm('حذف المستخدم؟')) {
                db.users = db.users.filter(u => u.id !== id);
                save(); renderUsersTable(); populateSelects();
            }
        }

        function editUser(id) {
            const user = db.users.find(u => u.id == id);
            if (user) {
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-name').value = user.name;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-phone').value = user.phone || '';
                document.getElementById('user-form-title').innerText = 'تعديل مستخدم';
            }
        }

        function resetUserForm() {
            document.getElementById('user-id').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-phone').value = '';
            document.getElementById('user-form-title').innerText = 'إضافة مستخدم';
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = db.users.map(u => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-3 font-bold">${u.name}</td>
                    <td class="p-3"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">${u.role === 'admin' ? 'مدير' : 'موظف'}</span></td>
                    <td class="p-3 text-slate-500 text-xs">${u.phone || '-'}</td>
                    <td class="p-3 flex gap-2">
                        <button onclick="editUser(${u.id})" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteUser(${u.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            const userSelect = document.getElementById('current-user-select');
            userSelect.innerHTML = db.users.map(u => `<option value="${u.id}" ${u.id == db.currentUser ? 'selected' : ''}>${u.name}</option>`).join('');
        }

        function filterUsers(query) {
            const rows = document.querySelectorAll('#users-list tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function switchUser(id) {
            db.currentUser = parseInt(id);
            save();
            showToast(`مرحباً, ${db.users.find(u => u.id == id).name}`);
        }

        // --- 4. Product Management (With Edit) ---
        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('prod-id').value;
            const name = document.getElementById('new-prod-name').value;
            const price = parseFloat(document.getElementById('new-prod-price').value);
            const cost = parseFloat(document.getElementById('new-prod-cost').value) || 0;
            const stock = parseFloat(document.getElementById('new-prod-stock').value) || 0;

            if (id) {
                const prod = db.products.find(p => p.id == id);
                if (prod) { prod.name = name; prod.price = price; prod.cost = cost; prod.stock = stock; }
                showToast('تم تعديل المنتج');
            } else {
                const newId = Date.now();
                db.products.push({ id: newId, name, price, cost, stock });
                if (stock > 0) {
                    addJournalEntry(new Date().toISOString().split('T')[0], `رصيد افتتاحي: ${name}`, [
                        { code: '1104', dr: stock * cost, cr: 0 }, { code: '3101', dr: 0, cr: stock * cost }
                    ]);
                }
                showToast('تم إضافة المنتج');
            }
            save(); populateSelects(); resetProductForm();
        }

        function editProduct(id) {
            const prod = db.products.find(p => p.id == id);
            if (prod) {
                document.getElementById('prod-id').value = prod.id;
                document.getElementById('new-prod-name').value = prod.name;
                document.getElementById('new-prod-price').value = prod.price;
                document.getElementById('new-prod-cost').value = prod.cost;
                document.getElementById('new-prod-stock').value = prod.stock;
                document.getElementById('prod-form-title').innerText = 'تعديل صنف';
            }
        }

        function deleteProduct(id) {
            if (confirm('حذف المنتج؟')) {
                db.products = db.products.filter(p => p.id !== id);
                save(); populateSelects();
            }
        }

        function resetProductForm() {
            document.getElementById('prod-id').value = '';
            document.getElementById('new-prod-name').value = '';
            document.getElementById('new-prod-price').value = '';
            document.getElementById('new-prod-cost').value = '';
            document.getElementById('new-prod-stock').value = '';
            document.getElementById('prod-form-title').innerText = 'إضافة صنف جديد';
        }

        function filterInventory(query) {
            const rows = document.querySelectorAll('#inventory-list tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // --- 5. Invoice Modal & View ---
        function viewInvoice(id) {
            const inv = db.sales.find(s => s.id == id);
            if (!inv) return;
            currentInvoiceToPrint = inv;

            const modal = document.getElementById('invoice-modal');
            const body = document.getElementById('invoice-modal-body');

            body.innerHTML = `
                <div class="text-center mb-4">
                    <h2 class="font-bold text-xl text-slate-800">${db.settings.companyName}</h2>
                    <p class="text-sm text-slate-500">فاتورة #${inv.id}</p>
                    ${db.settings.logo ? `<img src="${db.settings.logo}" class="h-16 mx-auto my-2">` : ''}
                    <p class="text-xs text-slate-400">${inv.date}</p>
                </div>
                <div class="mb-4 text-sm">
                    <p><strong>العميل:</strong> ${inv.customer}</p>
                    <p><strong>الموظف:</strong> ${db.users.find(u => u.id == inv.by)?.name || 'غير معروف'}</p>
                </div>
                <table class="w-full text-sm border-collapse mb-4">
                    <thead class="bg-slate-100"><tr><th class="p-2 text-right">الصنف</th><th class="p-2 text-center">الكمية</th><th class="p-2 text-center">السعر</th><th class="p-2 text-center">الإجمالي</th></tr></thead>
                    <tbody class="divide-y">
                        ${inv.items.map(i => `<tr><td class="p-2">${i.name}</td><td class="p-2 text-center">${i.qty}</td><td class="p-2 text-center">${i.price}</td><td class="p-2 text-center">${i.total.toFixed(2)}</td></tr>`).join('')}
                    </tbody>
                </table>
                <div class="flex justify-between items-center font-bold text-lg border-t pt-2">
                    <span>الإجمالي النهائي:</span>
                    <span>${inv.total.toFixed(2)} ${db.settings.currency}</span>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('invoice-modal').classList.remove('active');
        }

        function printCurrentModalInvoice() {
            if (currentInvoiceToPrint) printInvoice(currentInvoiceToPrint);
        }

        // --- 6. Accounting Engine ---
        function getAccountBalance(code) {
            const acc = db.chartOfAccounts.find(a => a.code === code);
            if (!acc) return 0;
            if (!acc.isGroup) return acc.balance;
            const children = db.chartOfAccounts.filter(a => a.parent === code);
            return children.reduce((sum, child) => sum + getAccountBalance(child.code), 0);
        }

        function addJournalEntry(date, desc, lines) {
            const totalDr = lines.reduce((s, l) => s + (l.dr || 0), 0);
            const totalCr = lines.reduce((s, l) => s + (l.cr || 0), 0);

            if (Math.abs(totalDr - totalCr) > 0.01) {
                showToast(`خطأ: القيد غير متزن`, 'error');
                return false;
            }

            const entryId = db.journal.length + 1;
            const userName = db.users.find(u => u.id == db.currentUser)?.name || 'System';

            db.journal.push({ id: entryId, date, desc: desc + ` (بواسطة: ${userName})`, lines });

            lines.forEach(line => {
                const acc = db.chartOfAccounts.find(a => a.code === line.code);
                if (acc && !acc.isGroup) {
                    if (acc.type === 'asset' || acc.type === 'expense') acc.balance += ((line.dr || 0) - (line.cr || 0));
                    else acc.balance += ((line.cr || 0) - (line.dr || 0));
                }
            });

            save();
            return true;
        }

        // --- 7. Operations ---
        function populateSelects() {
            const accounts = db.chartOfAccounts.filter(a => !a.isGroup);
            const salesAccs = accounts.filter(a => ['1101', '1102'].includes(a.code) || a.parent === '11').map(a => `<option value="${a.code}">${a.name}</option>`).join('');
            document.getElementById('sale-account').innerHTML = salesAccs;
            document.getElementById('sale-method').innerHTML = (db.settings.paymentMethods || ['Cash']).map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('pur-method').innerHTML = (db.settings.paymentMethods || ['Cash']).map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('sale-product').innerHTML = '<option value="">اختر منتج...</option>' + db.products.map(p => `<option value="${p.id}">${p.name} (${p.price})</option>`).join('');
            document.getElementById('sale-customer').innerHTML = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('inst-product').innerHTML = '<option value="">اختر منتج...</option>' + db.products.map(p => `<option value="${p.id}">${p.name} (${p.price})</option>`).join('');
            document.getElementById('inst-customer').innerHTML = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('inst-method').innerHTML = (db.settings.paymentMethods || ['Cash']).map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('pur-supplier').innerHTML = db.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('pur-product').innerHTML = '<option value="">اختر منتج...</option>' + db.products.map(p => `<option value="${p.id}" data-cost="${p.cost}">${p.name}</option>`).join('');
        }

        function addToCart() {
            const prodId = document.getElementById('sale-product').value;
            const qty = parseInt(document.getElementById('sale-qty').value);
            const prod = db.products.find(p => p.id == prodId);

            if (!prod) return showToast('اختر منتجاً', 'error');
            if (prod.stock < qty) return showToast('الرصيد غير كافٍ', 'error');

            const item = { ...prod, qty, total: prod.price * qty };
            currentCart.push(item);
            renderCart();
        }

        function renderCart() {
            const tbody = document.getElementById('cart-body');
            tbody.innerHTML = '';
            let subtotal = 0;
            currentCart.forEach((item, idx) => {
                subtotal += item.total;
                tbody.innerHTML += `
                    <tr class="bg-white"><td class="p-2">${item.name}</td><td class="p-2 font-bold">${item.qty}</td><td class="p-2">${item.price}</td><td class="p-2">${item.total}</td>
                    <td class="p-2"><button onclick="currentCart.splice(${idx},1);renderCart()" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
            });

            if (currentCart.length > 0) document.getElementById('cart-empty').classList.add('hidden');
            else document.getElementById('cart-empty').classList.remove('hidden');

            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const net = Math.max(0, subtotal - discount);
            const vat = net * (db.settings.vatRate / 100);
            const total = net + vat;

            document.getElementById('cart-subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('cart-vat').innerText = vat.toFixed(2);
            document.getElementById('cart-total').innerText = total.toFixed(2);

            if (!document.getElementById('sale-paid').value && total > 0) document.getElementById('sale-paid').value = total.toFixed(2);
        }

        // --- Returns Logic ---
        function toggleSaleMode() {
            const isRet = document.getElementById('is-return-sale').checked;
            document.getElementById('sale-title').innerText = isRet ? 'مرتجع مبيعات' : 'فاتورة مبيعات';
            document.getElementById('sale-mode-badge').classList.toggle('hidden', !isRet);
            document.getElementById('sale-header-sec').classList.toggle('bg-red-50', isRet);
        }
        function togglePurMode() {
            const isRet = document.getElementById('is-return-pur').checked;
            document.getElementById('pur-title').innerText = isRet ? 'مرتجع مشتريات' : 'فاتورة مشتريات';
            document.getElementById('pur-mode-badge').classList.toggle('hidden', !isRet);
        }

        // Updated postSale to handle Returns
        function postSale() {
            if (currentCart.length === 0) return showToast('السلة فارغة', 'error');

            const custId = document.getElementById('sale-customer').value;
            const customer = db.customers.find(c => c.id == custId);
            const date = new Date().toISOString().split('T')[0];
            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const paid = parseFloat(document.getElementById('sale-paid').value) || 0;
            const method = document.getElementById('sale-method').value;
            const isReturn = document.getElementById('is-return-sale').checked;

            let totalSale = 0, totalCost = 0;
            currentCart.forEach(i => { totalSale += i.total; totalCost += (i.cost * i.qty); });

            const netSale = totalSale - discount; // Logic for return? Discount usually 0 in return or proportional.
            const vatAmount = netSale * (db.settings.vatRate / 100);
            const grandTotal = netSale + vatAmount;

            const lines = [];

            if (isReturn) {
                // Return Logic
                // Dr Sales Return / Inventory / VAT
                // Cr Cash / Customer / COGS

                // 1. Refund Cash/Credit Customer
                if (paid > 0) lines.push({ code: method || '1101', dr: 0, cr: paid }); // Cash Cr
                const remaining = grandTotal - paid; // Remaining to credit to customer account
                if (remaining > 0.01) lines.push({ code: '1103', dr: 0, cr: remaining }); // Customer Cr

                // 2. Debit Sales Return & VAT
                lines.push({ code: '4101', dr: netSale, cr: 0 }); // Sales Dr (Contra)
                lines.push({ code: '2102', dr: vatAmount, cr: 0 }); // VAT Dr

                // 3. Inventory & COGS
                lines.push({ code: '1104', dr: totalCost, cr: 0 }); // Inventory Dr (Stock Up)
                lines.push({ code: '5101', dr: 0, cr: totalCost }); // COGS Cr (Expense Down)

                if (addJournalEntry(date, `مرتجع مبيعات - ${customer.name}`, lines)) {
                    currentCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) p.stock += i.qty; }); // Increase Stock
                    db.returns.push({ id: Date.now(), date, type: 'sale', customer: customer.name, total: grandTotal, items: [...currentCart] });
                    showToast('تم حفظ المرتجع');
                }
            } else {
                // ... Existing Sale Logic ...
                const remaining = grandTotal - paid;
                // Assuming '1101' is Cash if method not found
                lines.push({ code: '1101', dr: paid, cr: 0 });

                if (remaining > 0.01) lines.push({ code: '1103', dr: remaining, cr: 0 }); // Customer Account
                if (discount > 0) lines.push({ code: '5201', dr: discount, cr: 0 }); // Discount Allowed
                lines.push({ code: '5101', dr: totalCost, cr: 0 });

                lines.push({ code: '4101', dr: 0, cr: totalSale });
                lines.push({ code: '2102', dr: 0, cr: vatAmount });
                lines.push({ code: '1104', dr: 0, cr: totalCost });

                if (addJournalEntry(date, `فاتورة - ${customer.name}`, lines)) {
                    currentCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) p.stock -= i.qty; });
                    const saleId = 'INV-' + String(db.sales.length + 1).padStart(4, '0');
                    db.sales.push({ id: Date.now(), invoiceNo: saleId, date, customer: customer.name, total: grandTotal, paid, discount, remaining, method, by: db.currentUser, items: [...currentCart], payType: salePayType });
                    showToast('تم حفظ الفاتورة بنجاح ✅');
                    renderSalesInvoices();
                }
            }
            // Reset
            currentCart = []; renderCart();
            document.getElementById('sale-discount').value = 0;
            document.getElementById('sale-paid').value = '';
            // Don't uncheck return mode automatically? Maybe better to keep it unchecked for safety.
            document.getElementById('is-return-sale').checked = false; toggleSaleMode();
        }

        // Updated postPurchase to handle Returns
        function postPurchase() {
            if (currentPurCart.length === 0) return showToast('السلة فارغة', 'error');

            const suppId = document.getElementById('pur-supplier').value;
            const supplier = db.suppliers.find(s => s.id == suppId);
            const date = document.getElementById('pur-date').value;
            const discount = parseFloat(document.getElementById('pur-discount').value) || 0;
            const method = document.getElementById('pur-method').value;
            const paid = parseFloat(document.getElementById('pur-paid').value) || 0;
            const isReturn = document.getElementById('is-return-pur').checked;

            let totalCost = 0;
            currentPurCart.forEach(i => totalCost += i.total);
            const netCost = totalCost - discount;
            const vatAmount = netCost * 0.15;
            const grandTotal = netCost + vatAmount;

            const lines = [];

            if (isReturn) {
                // Return Logic: Dr Cash/Supplier, Cr Inventory/VAT
                const remaining = grandTotal - paid;
                if (paid > 0) lines.push({ code: '1101', dr: paid, cr: 0 }); // Cash Dr (Refund)
                if (remaining > 0.01) lines.push({ code: '2101', dr: remaining, cr: 0 }); // Supplier Dr (Debit Note)

                lines.push({ code: '1104', dr: 0, cr: totalCost }); // Inventory Cr (Stock Down)
                lines.push({ code: '2102', dr: 0, cr: vatAmount }); // VAT Cr (Liability Up? No, Purchase VAT is Asset. Credit reduces Asset. Correct.)
                // Wait, if VAT Input is Asset (1xxx), Credit reduces it. If 2102 is Liability, Debit reduces it.
                // We used 2102 for Output VAT (Liability).
                // And for Purchase, we Debit 2102 (Reducing Liability... or treating as asset).
                // If we treat 2102 as "Net VAT Liability":
                // Sale: Credit 2102 (Increase Liability).
                // Purchase: Debit 2102 (Decrease Liability).
                // Purchase Return: Credit 2102 (Increase Liability/Reverse Debit). Correct.

                if (addJournalEntry(date, `مرتجع مشتريات - ${supplier.name}`, lines)) {
                    currentPurCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) { p.stock -= i.qty; } });
                    db.returns.push({ id: Date.now(), date, type: 'purchase', supplier: supplier.name, total: grandTotal, items: [...currentPurCart] });
                    showToast('تم حفظ المرتجع');
                }
            } else {
                const remaining = grandTotal - paid;
                lines.push({ code: '1104', dr: totalCost, cr: 0 });
                lines.push({ code: '2102', dr: vatAmount, cr: 0 });

                if (discount > 0) lines.push({ code: '5201', dr: 0, cr: discount });
                if (paid > 0) lines.push({ code: '1101', dr: 0, cr: paid });
                if (remaining > 0.01) lines.push({ code: '2101', dr: 0, cr: remaining });

                if (addJournalEntry(date, `فاتورة مشتريات - ${supplier.name} (${method})`, lines)) {
                    currentPurCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) { p.stock += i.qty; p.cost = i.cost; } });
                    db.purchases.push({ id: Date.now(), date, supplier: supplier.name, total: grandTotal, paid, discount, remaining, method, items: [...currentPurCart] });
                    showToast('تم حفظ المشتريات');
                }
            }

            currentPurCart = []; renderPurCart();
            document.getElementById('pur-paid').value = '';
            document.getElementById('pur-discount').value = '0';
            document.getElementById('is-return-pur').checked = false; togglePurMode();
            renderAll();
        }

        function printInvoice(inv) {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div class="text-center mb-6">
                    ${db.settings.logo ? `<img src="${db.settings.logo}" style="height: 80px; margin: 0 auto 10px auto; display: block;">` : ''}
                    <h1 class="text-2xl font-bold">${db.settings.companyName}</h1>
                    <p class="text-sm">${db.settings.address} - ${db.settings.phone}</p>
                    <p class="text-sm">الرقم الضريبي: ${db.settings.vatNumber}</p>
                </div>
                <div class="flex justify-between border-b pb-4 mb-4">
                    <div class="text-right">
                        <p><strong>فاتورة ضريبية</strong></p>
                        <p>العميل: ${inv.customer}</p>
                    </div>
                    <div class="text-left">
                        <p>التاريخ: ${inv.date}</p>
                        <p>رقم: #${inv.id}</p>
                    </div>
                </div>
                <table class="w-full text-sm mb-6 border-collapse border border-black">
                    <thead><tr class="bg-gray-100"><th class="border border-black p-2">الصنف</th><th class="border border-black p-2">الكمية</th><th class="border border-black p-2">السعر</th><th class="border border-black p-2">الإجمالي</th></tr></thead>
                    <tbody>
                        ${inv.items.map(i => `<tr><td class="border border-black p-2">${i.name}</td><td class="border border-black p-2">${i.qty}</td><td class="border border-black p-2">${i.price}</td><td class="border border-black p-2">${i.total.toFixed(2)}</td></tr>`).join('')}
                    </tbody>
                </table>
                <div class="text-left font-bold text-lg">الإجمالي: ${inv.total.toFixed(2)} ${db.settings.currency}</div>
            `;
            window.print();
        }

        // --- 7.1 Purchases Logic ---
        function updatePurCost(select) {
            const opt = select.options[select.selectedIndex];
            if (opt && opt.dataset.cost) document.getElementById('pur-cost').value = opt.dataset.cost;
        }

        function addToPurCart() {
            const prodId = document.getElementById('pur-product').value;
            const qty = parseFloat(document.getElementById('pur-qty').value);
            const cost = parseFloat(document.getElementById('pur-cost').value);
            const prod = db.products.find(p => p.id == prodId);

            if (!prod || !qty || !cost) return showToast('بيانات ناقصة', 'error');

            const item = { ...prod, qty, cost, total: cost * qty };
            currentPurCart.push(item);
            renderPurCart();
        }

        function renderPurCart() {
            const tbody = document.getElementById('pur-cart-body');
            tbody.innerHTML = '';
            let subtotal = 0;
            currentPurCart.forEach((item, idx) => {
                subtotal += item.total;
                tbody.innerHTML += `
                    <tr class="bg-white"><td class="p-2">${item.name}</td><td class="p-2 font-bold">${item.qty}</td><td class="p-2">${item.cost}</td><td class="p-2">${item.total.toFixed(2)}</td>
                    <td class="p-2"><button onclick="currentPurCart.splice(${idx},1);renderPurCart()" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
            });
            const discount = parseFloat(document.getElementById('pur-discount').value) || 0;
            const net = Math.max(0, subtotal - discount);
            const vat = net * 0.15;
            const total = net + vat;

            document.getElementById('pur-subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('pur-vat').innerText = vat.toFixed(2);
            document.getElementById('pur-total').innerText = total.toFixed(2);

            if (!document.getElementById('pur-paid').value && total > 0) document.getElementById('pur-paid').value = total.toFixed(2);
        }







        // --- 7.1 Inventory Logic ---
        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('prod-id').value;
            const name = document.getElementById('new-prod-name').value;
            const price = parseFloat(document.getElementById('new-prod-price').value);
            const cost = parseFloat(document.getElementById('new-prod-cost').value) || 0;
            const stock = parseFloat(document.getElementById('new-prod-stock').value) || 0;

            if (id) {
                const p = db.products.find(x => x.id == id);
                if (p) { p.name = name; p.price = price; p.cost = cost; p.stock = stock; }
            } else {
                db.products.push({ id: Date.now(), name, price, cost, stock });
            }
            save(); filterInventory(''); resetProductForm(); showToast('تم حفظ المنتج');
        }

        function filterInventory(q) {
            const list = document.getElementById('inventory-list');
            if (!list) return;
            const filtered = db.products.filter(p => p.name.includes(q));
            list.innerHTML = filtered.map(p => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 font-bold">${p.name}</td><td class="p-3 text-emerald-600">${p.price}</td><td class="p-3 text-slate-500">${p.cost}</td><td class="p-3 font-bold">${p.stock}</td>
                    <td class="p-3 flex gap-2"><button onclick="editProduct(${p.id})" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="deleteProduct(${p.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }

        function editProduct(id) {
            const p = db.products.find(x => x.id == id);
            if (p) {
                document.getElementById('prod-id').value = p.id;
                document.getElementById('new-prod-name').value = p.name;
                document.getElementById('new-prod-price').value = p.price;
                document.getElementById('new-prod-cost').value = p.cost;
                document.getElementById('new-prod-stock').value = p.stock;
                document.getElementById('prod-form-title').innerText = 'تعديل منتج';
            }
        }

        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                db.products = db.products.filter(x => x.id != id);
                save(); filterInventory(''); showToast('تم حذف المنتج');
            }
        }

        function resetProductForm() {
            document.getElementById('prod-id').value = '';
            document.getElementById('new-prod-name').value = '';
            document.getElementById('new-prod-price').value = '';
            document.getElementById('new-prod-cost').value = '';
            document.getElementById('new-prod-stock').value = '';
            document.getElementById('prod-form-title').innerText = 'إضافة صنف جديد';
        }

        // --- 7.2 Suppliers Logic ---
        function saveSupplier(e) {
            e.preventDefault();
            const name = document.getElementById('supp-name').value;
            const company = document.getElementById('supp-company').value;
            const address = document.getElementById('supp-address').value;
            const phone = document.getElementById('supp-phone').value;
            const vat = document.getElementById('supp-vat').value;

            if (id) {
                const s = db.suppliers.find(x => x.id == id);
                if (s) { s.name = name; s.company = company; s.address = address; s.phone = phone; s.vat = vat; }
            } else {
                db.suppliers.push({ id: Date.now(), name, company, address, phone, vat });
            }
            save(); renderSuppliersTable(); populateSelects(); resetSupplierForm();
        }
        function renderSuppliersTable() {
            document.getElementById('suppliers-list').innerHTML = db.suppliers.map(s => `
                <tr class="hover:bg-slate-50 border-b"><td class="p-3 font-bold">${s.name}</td><td class="p-3 text-sm text-slate-500">${s.company || '-'}</td><td class="p-3 text-sm">${s.phone || '-'}</td>
                <td class="p-3"><button onclick="editSupplier(${s.id})" class="text-blue-500 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition"><i class="fas fa-edit"></i></button></td></tr>
            `).join('');
        }
        function editSupplier(id) {
            const s = db.suppliers.find(x => x.id == id);
            if (s) {
                document.getElementById('supp-id').value = s.id;
                document.getElementById('supp-name').value = s.name;
                document.getElementById('supp-company').value = s.company || '';
                document.getElementById('supp-address').value = s.address || '';
                document.getElementById('supp-phone').value = s.phone || '';
                document.getElementById('supp-vat').value = s.vat || '';
            }
        }
        function resetSupplierForm() {
            document.getElementById('supp-id').value = '';
            document.getElementById('supp-name').value = '';
            document.getElementById('supp-company').value = '';
            document.getElementById('supp-address').value = '';
            document.getElementById('supp-phone').value = '';
            document.getElementById('supp-vat').value = '';
        }

        // --- 7.4 Customers Logic (New) ---
        function saveCustomer(e) {
            e.preventDefault();
            const id = document.getElementById('cust-id').value;
            const name = document.getElementById('cust-name').value;
            const company = document.getElementById('cust-company').value;
            const address = document.getElementById('cust-address').value;
            const phone = document.getElementById('cust-phone').value;
            const vat = document.getElementById('cust-vat').value;

            if (id) {
                const c = db.customers.find(x => x.id == id);
                if (c) { c.name = name; c.company = company; c.address = address; c.phone = phone; c.vat = vat; }
                showToast('تم تعديل العميل');
            } else {
                db.customers.push({ id: Date.now(), name, company, address, phone, vat });
                showToast('تم إضافة العميل');
            }
            save(); renderCustomersTable(); populateSelects(); resetCustomerForm();
        }

        function renderCustomersTable() {
            document.getElementById('customers-list').innerHTML = db.customers.map(c => `
                <tr class="hover:bg-slate-50 border-b"><td class="p-3 font-bold">${c.name}</td><td class="p-3 text-sm text-slate-500">${c.company || '-'}</td><td class="p-3 text-sm">${c.phone || '-'}</td>
                <td class="p-3"><button onclick="editCustomer(${c.id})" class="text-blue-500 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition"><i class="fas fa-edit"></i></button></td></tr>
            `).join('');
        }

        function editCustomer(id) {
            const c = db.customers.find(x => x.id == id);
            if (c) {
                document.getElementById('cust-id').value = c.id;
                document.getElementById('cust-name').value = c.name;
                document.getElementById('cust-company').value = c.company || '';
                document.getElementById('cust-address').value = c.address || '';
                document.getElementById('cust-phone').value = c.phone || '';
                document.getElementById('cust-vat').value = c.vat || '';
            }
        }

        function resetCustomerForm() {
            document.getElementById('cust-id').value = '';
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-company').value = '';
            document.getElementById('cust-address').value = '';
            document.getElementById('cust-phone').value = '';
            document.getElementById('cust-vat').value = '';
        }

        // --- 7.3 Salaries Logic ---
        function paySalary() {
            const empSelect = document.getElementById('sal-employee');
            const empName = empSelect.options[empSelect.selectedIndex]?.text;
            const empId = empSelect.value;
            const month = document.getElementById('sal-month').value;
            const basic = parseFloat(document.getElementById('sal-basic').value) || 0;
            const allowance = parseFloat(document.getElementById('sal-allowance').value) || 0;
            const deduction = parseFloat(document.getElementById('sal-deduction').value) || 0;
            const bonus = parseFloat(document.getElementById('sal-bonus').value) || 0;
            const method = document.getElementById('sal-method').value;
            const reason = document.getElementById('sal-deduction-reason').value;

            if (!empId || basic <= 0) return showToast('اختر الموظف وأدخل الراتب', 'error');
            if (!month) return showToast('حدد الشهر', 'error');

            const net = basic + allowance - deduction + bonus;
            if (net <= 0) return showToast('صافي الراتب يجب أن يكون أكبر من صفر', 'error');

            const lines = [
                { code: '5202', dr: net, cr: 0 },
                { code: method, dr: 0, cr: net }
            ];
            const date = new Date().toISOString().split('T')[0];
            if (addJournalEntry(date, `صرف راتب: ${empName} - شهر ${month}`, lines)) {
                if (!db.salaryHistory) db.salaryHistory = [];
                db.salaryHistory.push({
                    id: Date.now(), date, month, empId, empName, basic, allowance, deduction, bonus, net,
                    method: method === '1101' ? 'نقدي' : 'بنك', notes: reason
                });
                // Reset form
                document.getElementById('sal-basic').value = '';
                document.getElementById('sal-allowance').value = '0';
                document.getElementById('sal-deduction').value = '0';
                document.getElementById('sal-bonus').value = '0';
                document.getElementById('sal-deduction-reason').value = '';
                showToast('تم صرف الراتب بنجاح ✅');
                renderSalaryHistory();
                save();
            }
        }

        // Populate employee dropdown from HR
        function populateSalaryEmployees() {
            const sel = document.getElementById('sal-employee');
            if (!sel || !db.employees) return;
            sel.innerHTML = '<option value="">-- اختر موظف --</option>' +
                db.employees.map(e => `<option value="${e.id}" data-salary="${e.salary || 0}">${e.name}</option>`).join('');
        }

        function loadEmployeeSalary() {
            const sel = document.getElementById('sal-employee');
            const opt = sel.options[sel.selectedIndex];
            if (opt && opt.dataset.salary) {
                document.getElementById('sal-basic').value = opt.dataset.salary;
                calcSalaryNet();
            }
        }

        // Live salary net calculation
        function calcSalaryNet() {
            const basic = parseFloat(document.getElementById('sal-basic')?.value) || 0;
            const allowance = parseFloat(document.getElementById('sal-allowance')?.value) || 0;
            const deduction = parseFloat(document.getElementById('sal-deduction')?.value) || 0;
            const bonus = parseFloat(document.getElementById('sal-bonus')?.value) || 0;
            const gross = basic + allowance;
            const net = gross - deduction + bonus;
            if (document.getElementById('sal-gross')) document.getElementById('sal-gross').innerText = gross.toFixed(2);
            if (document.getElementById('sal-ded-display')) document.getElementById('sal-ded-display').innerText = deduction.toFixed(2);
            if (document.getElementById('sal-bonus-display')) document.getElementById('sal-bonus-display').innerText = bonus.toFixed(2);
            if (document.getElementById('sal-net')) document.getElementById('sal-net').innerText = net.toFixed(2);
        }

        // Add live calc listeners
        document.addEventListener('DOMContentLoaded', () => {
            ['sal-basic', 'sal-allowance', 'sal-deduction', 'sal-bonus'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', calcSalaryNet);
            });
            // Set default month
            const monthEl = document.getElementById('sal-month');
            if (monthEl) monthEl.value = new Date().toISOString().slice(0, 7);
        });

        // Render salary history table
        function renderSalaryHistory() {
            if (!db.salaryHistory) db.salaryHistory = [];
            const tbody = document.getElementById('salary-history-body');
            if (!tbody) return;

            const records = [...db.salaryHistory].reverse();
            tbody.innerHTML = records.length ? records.map((r, i) => `
                <tr class="hover:bg-blue-50 ${i % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                    <td class="p-2 text-center font-mono text-slate-400">${records.length - i}</td>
                    <td class="p-2">${r.date}</td>
                    <td class="p-2 font-mono">${r.month}</td>
                    <td class="p-2 font-bold">${r.empName}</td>
                    <td class="p-2">${r.basic?.toFixed(2) || '0.00'}</td>
                    <td class="p-2 text-blue-600">${r.allowance?.toFixed(2) || '0.00'}</td>
                    <td class="p-2 text-red-500">${r.deduction?.toFixed(2) || '0.00'}</td>
                    <td class="p-2 text-emerald-600">${r.bonus?.toFixed(2) || '0.00'}</td>
                    <td class="p-2 font-bold text-yellow-600">${r.net?.toFixed(2) || '0.00'}</td>
                    <td class="p-2">${r.method || '-'}</td>
                    <td class="p-2 text-slate-400 truncate max-w-[100px]">${r.notes || '-'}</td>
                </tr>
            `).join('') : '<tr><td colspan="11" class="p-4 text-center text-slate-400">لم يتم صرف رواتب حتى الآن</td></tr>';

            // Update statistics
            const total = db.salaryHistory.reduce((s, r) => s + (r.net || 0), 0);
            const count = db.salaryHistory.length;
            const avg = count > 0 ? total / count : 0;
            if (document.getElementById('sal-stat-total')) document.getElementById('sal-stat-total').innerText = total.toFixed(2);
            if (document.getElementById('sal-stat-count')) document.getElementById('sal-stat-count').innerText = count;
            if (document.getElementById('sal-stat-avg')) document.getElementById('sal-stat-avg').innerText = avg.toFixed(2);
        }

        function filterSalaryHistory(q) {
            document.querySelectorAll('#salary-history-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        function filterSalaryByMonth() {
            const month = document.getElementById('sal-filter-month').value;
            if (!month) {
                document.querySelectorAll('#salary-history-body tr').forEach(r => r.style.display = '');
                return;
            }
            document.querySelectorAll('#salary-history-body tr').forEach(r => {
                const cells = r.querySelectorAll('td');
                if (cells.length >= 3) {
                    r.style.display = cells[2].innerText.includes(month) ? '' : 'none';
                }
            });
        }

        // --- 8. Charts & Reports ---
        function renderSalesChart() {
            // Simple bar chart for last 7 days sales
            const container = document.getElementById('sales-chart');
            container.innerHTML = '';
            const last7Days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toISOString().split('T')[0];
            }).reverse();

            const maxSale = Math.max(...last7Days.map(d => db.sales.filter(s => s.date === d).reduce((sum, s) => sum + s.total, 0))) || 100;

            last7Days.forEach(date => {
                const daySales = db.sales.filter(s => s.date === date).reduce((sum, s) => sum + s.total, 0);
                const height = (daySales / maxSale) * 100;

                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${height}%`;
                bar.innerHTML = `
                    <span class="chart-value">${daySales > 0 ? daySales : ''}</span>
                    <span class="chart-label">${date.slice(5)}</span>
                `;
                container.appendChild(bar);
            });
        }

        // --- 9. Manual Journal & Settings UI (Same as before) ---
        function addJournalLineRow() {
            const div = document.createElement('div'); div.className = 'grid grid-cols-12 gap-2 j-row mb-2';
            const opts = db.chartOfAccounts.filter(a => !a.isGroup).map(a => `<option value="${a.code}">${a.code} - ${a.name}</option>`).join('');
            div.innerHTML = `<div class="col-span-6"><select class="w-full p-2 border rounded text-sm j-code">${opts}</select></div><div class="col-span-2"><input type="number" class="w-full p-2 border rounded text-sm j-dr" placeholder="0" onchange="calcJTotals()"></div><div class="col-span-2"><input type="number" class="w-full p-2 border rounded text-sm j-cr" placeholder="0" onchange="calcJTotals()"></div><div class="col-span-2"><button onclick="this.parentElement.remove();calcJTotals()" class="text-red-500 w-full"><i class="fas fa-times"></i></button></div>`;
            document.getElementById('journal-lines').appendChild(div);
        }
        function calcJTotals() {
            let dr = 0, cr = 0; document.querySelectorAll('.j-dr').forEach(i => dr += parseFloat(i.value || 0)); document.querySelectorAll('.j-cr').forEach(i => cr += parseFloat(i.value || 0));
            document.getElementById('total-dr').innerText = dr.toFixed(2); document.getElementById('total-cr').innerText = cr.toFixed(2);
            document.getElementById('unbalanced-msg').classList.toggle('hidden', Math.abs(dr - cr) <= 0.01);
        }
        function saveManualJournal() {
            const desc = document.getElementById('manual-desc').value; const date = document.getElementById('manual-date').value;
            const lines = []; document.querySelectorAll('.j-row').forEach(row => { const c = row.querySelector('.j-code').value, d = parseFloat(row.querySelector('.j-dr').value || 0), r = parseFloat(row.querySelector('.j-cr').value || 0); if (d > 0 || r > 0) lines.push({ code: c, dr: d, cr: r }); });
            if (lines.length < 2 || !desc) return showToast('بيانات ناقصة', 'error');
            if (addJournalEntry(date, desc, lines)) { showToast('تم الترحيل'); document.getElementById('journal-lines').innerHTML = ''; addJournalLineRow(); addJournalLineRow(); document.getElementById('manual-desc').value = ''; calcJTotals(); }
        }

        function saveSettings(e) {
            e.preventDefault();
            db.settings.companyName = document.getElementById('set-name').value;
            db.settings.vatRate = parseFloat(document.getElementById('set-vat-rate').value);
            db.settings.currency = document.getElementById('set-currency').value;
            db.settings.phone = document.getElementById('set-phone').value;
            db.settings.address = document.getElementById('set-address').value;
            db.settings.vatNumber = document.getElementById('set-vat-no').value;
            db.settings.logo = document.getElementById('set-logo-url').value;

            save();
            loadSettingsToForm();
            updateLogoView();
            showToast('تم الحفظ');
        }

        function addPaymentMethod() {
            const val = document.getElementById('new-pay-method').value.trim();
            if (val && !db.settings.paymentMethods.includes(val)) {
                db.settings.paymentMethods.push(val);
                save(); renderPaymentMethods();
                document.getElementById('new-pay-method').value = '';
            }
        }

        function deletePaymentMethod(m) {
            if (confirm('حذف طريقة الدفع؟')) {
                db.settings.paymentMethods = db.settings.paymentMethods.filter(x => x !== m);
                save(); renderPaymentMethods();
            }
        }

        function renderPaymentMethods() {
            if (!db.settings.paymentMethods) db.settings.paymentMethods = ['Cash', 'Bank'];
            const list = document.getElementById('payment-methods-list');
            if (list) {
                list.innerHTML = db.settings.paymentMethods.map(m => `
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs flex items-center gap-1 font-bold">
                        ${m} <button onclick="deletePaymentMethod('${m}')" class="text-red-500 hover:text-red-700 ml-1 bg-white rounded-full w-4 h-4 flex items-center justify-center"><i class="fas fa-times text-[10px]"></i></button>
                    </span>
                `).join('');
            }
        }

        function loadSettingsToForm() { document.getElementById('set-name').value = db.settings.companyName; document.getElementById('set-vat-rate').value = db.settings.vatRate; document.getElementById('set-currency').value = db.settings.currency; document.getElementById('set-phone').value = db.settings.phone; document.getElementById('set-address').value = db.settings.address; document.getElementById('set-vat-no').value = db.settings.vatNumber; document.getElementById('set-logo-url').value = db.settings.logo || ''; document.getElementById('header-company-name').innerText = db.settings.companyName; document.querySelectorAll('.currency').forEach(el => el.setAttribute('data-curr', db.settings.currency)); document.getElementById('cart-vat-rate').innerText = db.settings.vatRate; renderPaymentMethods(); }
        function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); a.download = "erp_backup.json"; document.body.appendChild(a); a.click(); a.remove(); }
        function importData(inp) { const f = inp.files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { try { db = JSON.parse(e.target.result); save(); location.reload() } catch (x) { alert('خطأ') } }; r.readAsText(f); }
        function resetData() { if (confirm('تأكيد التصفير؟')) { localStorage.removeItem('erp_pro_v10'); location.reload(); } }

        function updateLogoView() {
            const logoImg = document.getElementById('sidebar-logo-img');
            const defIcon = document.getElementById('default-logo-icon');
            if (db.settings.logo) {
                logoImg.src = db.settings.logo;
                logoImg.classList.remove('hidden');
                defIcon.classList.add('hidden');
            } else {
                logoImg.classList.add('hidden');
                defIcon.classList.remove('hidden');
            }
        }

        // --- 10. Rendering ---
        function renderAll() {
            // Balances
            const getBal = code => getAccountBalance(code);
            document.getElementById('dash-cash').innerText = (getBal('1101') + getBal('1102')).toFixed(2);
            document.getElementById('dash-sales').innerText = getBal('4101').toFixed(2);
            const exp = getBal('5'), rev = getBal('4');
            document.getElementById('dash-expenses').innerText = exp.toFixed(2);
            document.getElementById('dash-net-profit').innerText = (rev - exp).toFixed(2);

            renderJournal();
            renderInstallments();
            renderInstallments();
            renderServices();
            renderExpenses();
            renderPOSProducts();
            renderEmployees();
            updateChart();
            document.getElementById('dash-net-profit').innerText = (rev - exp).toFixed(2);

            // Lists
            document.getElementById('dash-journal-list').innerHTML = db.journal.slice().reverse().slice(0, 5).map(e => `<tr><td class="p-2">#${e.id}</td><td class="p-2">${e.date}</td><td class="p-2">${e.desc}</td><td class="p-2 font-bold">${(e.lines[0].dr || e.lines[0].cr).toFixed(2)}</td></tr>`).join('');

            document.getElementById('inventory-list').innerHTML = db.products.map(p => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 font-bold">${p.name}</td><td class="p-3 text-emerald-600">${p.price}</td><td class="p-3 text-slate-500">${p.cost}</td><td class="p-3 font-bold">${p.stock}</td>
                    <td class="p-3 flex gap-2"><button onclick="editProduct(${p.id})" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="deleteProduct(${p.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');

            document.getElementById('recent-invoices').innerHTML = db.sales.slice().reverse().slice(0, 10).map(inv => `
                <div class="p-2 bg-slate-50 rounded border text-xs cursor-pointer hover:bg-blue-50" onclick="viewInvoice(${inv.id})">
                    <div class="flex justify-between font-bold"><span>#${inv.id}</span><span>${inv.total.toFixed(2)}</span></div>
                    <div class="text-slate-500">${inv.customer}</div>
                </div>`).join('');

            document.getElementById('recent-purchases').innerHTML = db.purchases.slice().reverse().slice(0, 10).map(p => `
                <div class="p-2 bg-slate-50 rounded border text-xs mb-2">
                    <div class="flex justify-between font-bold"><span>${p.supplier}</span><span>${p.total.toFixed(2)}</span></div>
                    <div class="text-slate-400 text-[10px]">${p.date}</div>
                </div>`).join('');

            document.getElementById('coa-body').innerHTML = db.chartOfAccounts.map(a => `<tr class="border-b"><td class="p-3 font-mono level-${a.level}">${a.code}</td><td class="p-3 level-${a.level}">${a.name}</td><td class="p-3 text-xs">${a.type}</td><td class="p-3 font-bold ${getAccountBalance(a.code) < 0 ? 'text-red-500' : 'text-emerald-600'}">${getAccountBalance(a.code).toFixed(2)}</td></tr>`).join('');

            renderSalesChart();
            renderReports(); // Initial render with date filter
        }

        function renderReports() {
            // Apply Date Filter logic here for reports (IS)
            const from = new Date(document.getElementById('rpt-start-date').value);
            const to = new Date(document.getElementById('rpt-end-date').value);
            to.setHours(23, 59, 59); // End of day

            // Filter journal entries by date
            const filteredJournal = db.journal.filter(e => {
                const d = new Date(e.date);
                return d >= from && d <= to;
            });

            // Calculate balances from filtered journal
            let tempBalances = {};
            db.chartOfAccounts.forEach(a => tempBalances[a.code] = 0);

            filteredJournal.forEach(e => {
                e.lines.forEach(l => {
                    const acc = db.chartOfAccounts.find(a => a.code === l.code);
                    if (acc) {
                        if (acc.type === 'asset' || acc.type === 'expense') tempBalances[l.code] += ((l.dr || 0) - (l.cr || 0));
                        else tempBalances[l.code] += ((l.cr || 0) - (l.dr || 0));
                    }
                });
            });

            // Aggregate Groups
            const getFilteredBal = (code) => {
                const acc = db.chartOfAccounts.find(a => a.code === code);
                if (!acc.isGroup) return tempBalances[code] || 0;
                const children = db.chartOfAccounts.filter(a => a.parent === code);
                return children.reduce((sum, child) => sum + getFilteredBal(child.code), 0);
            };

            const rev = getFilteredBal('4');
            const exp = getFilteredBal('5');
            const cogs = getFilteredBal('5101');

            document.getElementById('is-rev').innerText = rev.toFixed(2);
            document.getElementById('is-cogs').innerText = cogs.toFixed(2);
            document.getElementById('is-gross').innerText = (rev - cogs).toFixed(2);
            document.getElementById('is-exp').innerText = (exp - cogs).toFixed(2);
            document.getElementById('is-net').innerText = (rev - exp).toFixed(2);

            document.getElementById('rpt-sales-total').innerText = rev.toFixed(2);
            document.getElementById('rpt-pur-total').innerText = filteredJournal.reduce((sum, e) => sum + (e.desc.includes('فاتورة مشتريات') ? e.lines.find(l => l.code == '1104')?.dr || 0 : 0), 0).toFixed(2);
            document.getElementById('rpt-exp-total').innerText = (exp - cogs).toFixed(2);

            // TB (Cumulative always)
            let tbDr = 0, tbCr = 0;
            document.getElementById('trial-balance-body').innerHTML = db.chartOfAccounts.filter(a => !a.isGroup).map(a => {
                if (a.balance == 0) return '';
                let dr = 0, cr = 0;
                if (['asset', 'expense'].includes(a.type)) { if (a.balance > 0) dr = a.balance; else cr = -a.balance; }
                else { if (a.balance > 0) cr = a.balance; else dr = -a.balance; }
                tbDr += dr; tbCr += cr;
                return `<tr><td class="p-2 border-b">${a.name}</td><td class="p-2 border-b text-emerald-600">${dr ? dr.toFixed(2) : '-'}</td><td class="p-2 border-b text-red-600">${cr ? cr.toFixed(2) : '-'}</td></tr>`;
            }).join('');
            document.getElementById('tb-total-dr').innerText = tbDr.toFixed(2);
            document.getElementById('tb-total-cr').innerText = tbCr.toFixed(2);
        }


        function getAccountBalance(code) {
            const acc = db.chartOfAccounts.find(a => a.code === code);
            if (!acc) return 0;
            if (acc.isGroup) {
                return db.chartOfAccounts.filter(a => a.parent === code).reduce((sum, child) => sum + getAccountBalance(child.code), 0);
            }
            // Calc from Journal
            let bal = 0;
            db.journal.forEach(e => {
                e.lines.forEach(l => {
                    if (l.code === code) {
                        if (acc.type === 'asset' || acc.type === 'expense') bal += ((l.dr || 0) - (l.cr || 0));
                        else bal += ((l.cr || 0) - (l.dr || 0));
                    }
                });
            });
            return bal;
        }

        function renderAll() {
            // Dashboard Counters - always run these first
            try {
                const cash = getAccountBalance('1101') + getAccountBalance('1102');
                if (document.getElementById('dash-cash')) document.getElementById('dash-cash').innerText = cash.toFixed(2);
                const salesTotal = db.sales.reduce((sum, s) => sum + s.total, 0);
                if (document.getElementById('dash-sales')) document.getElementById('dash-sales').innerText = salesTotal.toFixed(2);
                const expTotal = getAccountBalance('5');
                if (document.getElementById('dash-expenses')) document.getElementById('dash-expenses').innerText = expTotal.toFixed(2);
                const income = getAccountBalance('4') - getAccountBalance('5');
                if (document.getElementById('dash-net-profit')) document.getElementById('dash-net-profit').innerText = income.toFixed(2);
            } catch (e) { console.error('Dashboard counter error:', e); }

            // Render each component independently
            try { renderUsersTable(); } catch (e) { console.error('renderUsersTable error:', e); }
            try { renderSuppliersTable(); } catch (e) { console.error('renderSuppliersTable error:', e); }
            try { renderCustomersTable(); } catch (e) { console.error('renderCustomersTable error:', e); }
            try { if (typeof updateLogoView === 'function') updateLogoView(); } catch (e) { console.error('updateLogoView error:', e); }
            try { renderSalesChart(); } catch (e) { console.error('renderSalesChart error:', e); }
            try { renderReports(); } catch (e) { console.error('renderReports error:', e); }
            try { if (typeof renderExpenses === 'function') renderExpenses(); } catch (e) { console.error('renderExpenses error:', e); }
            try { if (typeof filterInventory === 'function') filterInventory(''); } catch (e) { console.error('filterInventory error:', e); }
            try { if (typeof renderPOSProducts === 'function') renderPOSProducts(); } catch (e) { console.error('renderPOSProducts error:', e); }
            try { if (typeof renderServiceCart === 'function') renderServiceCart(); } catch (e) { console.error('renderServiceCart error:', e); }
            try { if (typeof renderServices === 'function') renderServices(); } catch (e) { console.error('renderServices error:', e); }
            try { if (typeof renderEmployees === 'function') renderEmployees(); } catch (e) { console.error('renderEmployees error:', e); }
            try { if (typeof renderPayrollHistory === 'function') renderPayrollHistory(); } catch (e) { console.error('renderPayrollHistory error:', e); }
            try { if (typeof renderInstallments === 'function') renderInstallments(); } catch (e) { console.error('renderInstallments error:', e); }
            try { if (typeof renderPaymentMethods === 'function') renderPaymentMethods(); } catch (e) { console.error('renderPaymentMethods error:', e); }

            // Update header
            try {
                if (document.getElementById('header-company-name')) document.getElementById('header-company-name').innerText = db.settings.companyName;
            } catch (e) { }
        }

        // --- Helpers ---
        function showToast(msg, type = 'success') {
            const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<i class="fas fa-${type == 'success' ? 'check' : 'times'}-circle"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300) }, 3000);
        }
        function toggleSidebar() {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay');
            if (sb.classList.contains('translate-x-full')) { sb.classList.remove('translate-x-full'); ov.classList.remove('hidden'); setTimeout(() => ov.classList.remove('opacity-0'), 10); }
            else { sb.classList.add('translate-x-full'); ov.classList.add('opacity-0'); setTimeout(() => ov.classList.add('hidden'), 300); }
        }
        function toggleSubMenu(btn) {
            const submenu = btn.nextElementSibling;
            const arrow = btn.querySelector('.submenu-arrow');
            if (submenu) {
                submenu.classList.toggle('hidden');
                if (arrow) arrow.style.transform = submenu.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            }
        }
        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(e => e.classList.remove('active'));
            const section = document.getElementById(id);
            if (!section) { console.error('Section not found:', id); return; }
            section.classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-blue-300'));
            const btn = document.querySelector(`button[data-target="${id}"]`); if (btn) btn.classList.add('text-blue-300');
            if (window.innerWidth < 768) toggleSidebar();

            // Trigger section-specific rendering
            try {
                if (id === 'pos') renderPOSProducts();
                if (id === 'accounts_tree') renderAccountsTree();
                if (id === 'reports') renderReports();
                if (id === 'inventory') filterInventory('');
            } catch (e) { console.error('Section render error:', e); }
        }

        function renderAccountsTree() {
            const tbody = document.getElementById('coa-body');
            if (!tbody || !db.chartOfAccounts) return;
            tbody.innerHTML = db.chartOfAccounts.map(a => {
                const bal = getAccountBalance(a.code);
                const isGroup = a.isGroup ? 'font-bold bg-slate-50' : '';
                const indent = (a.level || 0) * 20;
                return `<tr class="border-b hover:bg-blue-50 ${isGroup}">
                    <td class="p-3 font-mono text-xs">${a.code}</td>
                    <td class="p-3" style="padding-right:${indent + 12}px">${a.isGroup ? '<i class="fas fa-folder-open text-yellow-500 me-1"></i>' : '<i class="fas fa-file-alt text-slate-400 me-1"></i>'}${a.name}</td>
                    <td class="p-3 text-xs text-slate-500">${a.type || ''}</td>
                    <td class="p-3 font-bold font-mono ${bal < 0 ? 'text-red-500' : 'text-emerald-600'}">${bal.toFixed(2)}</td>
                </tr>`;
            }).join('');
        }

        function filterAccounts(q) {
            const rows = document.querySelectorAll('#coa-body tr');
            rows.forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;
            let csv = [];
            const rows = table.querySelectorAll('tr');
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
                csv.push(row.join(','));
            }
            const blob = new Blob(["\uFEFF" + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- 11. Installment Module Logic ---
        function updateInstPrice(sel) {
            const opt = sel.options[sel.selectedIndex];
            if (opt) {
                const prod = db.products.find(p => p.id == sel.value);
                if (prod) {
                    document.getElementById('inst-price').value = prod.price;
                    calcInst();
                }
            }
        }

        function calcInst() {
            const price = parseFloat(document.getElementById('inst-price').value) || 0;
            const down = parseFloat(document.getElementById('inst-down').value) || 0;
            const count = parseInt(document.getElementById('inst-count').value) || 1;

            const remaining = Math.max(0, price - down);
            const monthly = count > 0 ? remaining / count : 0;

            document.getElementById('inst-monthly').value = monthly.toFixed(2);
        }

        function createInstallmentPlan() {
            const custId = document.getElementById('inst-customer').value;
            const prodId = document.getElementById('inst-product').value;
            const price = parseFloat(document.getElementById('inst-price').value) || 0;
            const down = parseFloat(document.getElementById('inst-down').value) || 0;
            const count = parseInt(document.getElementById('inst-count').value) || 12;
            const method = document.getElementById('inst-method').value;

            if (!custId || !prodId || !price) return showToast('بيانات ناقصة', 'error');

            const customer = db.customers.find(c => c.id == custId);
            const product = db.products.find(p => p.id == prodId);
            const monthly = parseFloat(document.getElementById('inst-monthly').value);
            const date = new Date();

            // Assume Price is GROSS (Inclusive of VAT)
            const netSale = price / (1 + (db.settings.vatRate / 100));
            const vat = price - netSale;
            const formattedDate = date.toISOString().split('T')[0];
            const remaining = price - down;

            const lines = [];
            if (down > 0) lines.push({ code: method || '1101', dr: down, cr: 0 });
            if (remaining > 0) lines.push({ code: '1103', dr: remaining, cr: 0 });
            lines.push({ code: '4101', dr: 0, cr: netSale });
            lines.push({ code: '2102', dr: 0, cr: vat });
            lines.push({ code: '5101', dr: product.cost, cr: 0 });
            lines.push({ code: '1104', dr: 0, cr: product.cost });

            if (addJournalEntry(formattedDate, `عقد تقسيط - ${customer.name} (${product.name})`, lines)) {
                // Generate Installments
                const saleId = Date.now();
                for (let i = 0; i < count; i++) {
                    const d = new Date(date);
                    d.setMonth(d.getMonth() + i + 1); // Next month
                    db.installments.push({
                        id: Date.now() + i,
                        saleId,
                        customerId: custId,
                        customerName: customer.name,
                        amount: monthly,
                        dueDate: d.toISOString().split('T')[0],
                        status: 'pending'
                    });
                }

                // Reduce Stock
                product.stock -= 1;
                db.sales.push({ id: saleId, date: formattedDate, customer: customer.name, total: price, paid: down, remaining: remaining, type: 'installment', items: [{ ...product, qty: 1, price: price, total: price }] });

                showToast('تم إنشاء عقد التقسيط');
                save(); renderInstallments(); renderAll();
                document.getElementById('inst-price').value = '';
                document.getElementById('inst-down').value = '';
            }
        }

        function renderInstallments() {
            if (!db.installments) db.installments = [];
            const list = document.getElementById('installments-list');
            if (list) list.innerHTML = db.installments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)).map(inst => {
                const isLate = new Date(inst.dueDate) < new Date() && inst.status === 'pending';
                const statusClass = inst.status === 'paid' ? 'text-emerald-600 bg-emerald-50' : (isLate ? 'text-red-600 bg-red-50' : 'text-slate-600');
                const statusText = inst.status === 'paid' ? 'مدفوع' : (isLate ? 'متأخر' : 'مستحق');

                return `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-3 font-bold">${inst.customerName}</td>
                        <td class="p-3 font-mono">${inst.amount.toFixed(2)}</td>
                        <td class="p-3 ${isLate ? 'text-red-600 font-bold' : ''}">${inst.dueDate}</td>
                        <td class="p-3 text-center">
                            ${inst.status === 'pending' ?
                        `<button onclick="payInstallment(${inst.id})" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 shadow">تحصيل</button>` :
                        `<span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${statusText}</span>`
                    }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function payInstallment(id) {
            if (!confirm('تأكيد تحصيل القسط؟')) return;
            const inst = db.installments.find(i => i.id == id);
            if (inst && inst.status === 'pending') {
                const date = new Date().toISOString().split('T')[0];
                const lines = [
                    { code: '1101', dr: inst.amount, cr: 0 },
                    { code: '1103', dr: 0, cr: inst.amount }
                ];
                if (addJournalEntry(date, `تحصيل قسط - ${inst.customerName}`, lines)) {
                    inst.status = 'paid';
                    inst.paidDate = date;
                    save(); renderInstallments(); renderAll();
                    showToast('تم التحصيل');
                }
            }
        }

        function filterInstallments(q) {
            const rows = document.querySelectorAll('#installments-list tr');
            rows.forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- 12. Services Module Logic ---
        let currentSrvCart = [];

        function renderServices() {
            if (!db.services) db.services = [];
            const list = document.getElementById('services-list');
            if (list) list.innerHTML = db.services.map(s => `
                <tr class="hover:bg-slate-50">
                    <td class="p-2 font-bold">${s.name}</td>
                    <td class="p-2 font-mono text-emerald-600">${s.price}</td>
                    <td class="p-2"><button onclick="editService(${s.id})" class="text-blue-500"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');

            const sel = document.getElementById('srv-list');
            if (sel) sel.innerHTML = '<option value="">اختر خدمة...</option>' + db.services.map(s => `<option value="${s.id}">${s.name} (${s.price})</option>`).join('');

            const methodSel = document.getElementById('srv-method');
            if (methodSel && db.settings.paymentMethods) methodSel.innerHTML = db.settings.paymentMethods.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function saveService(e) {
            e.preventDefault();
            const id = document.getElementById('serv-id').value;
            const name = document.getElementById('serv-name').value;
            const price = parseFloat(document.getElementById('serv-price').value);
            const desc = document.getElementById('serv-desc').value;

            if (id) {
                const s = db.services.find(x => x.id == id);
                if (s) { s.name = name; s.price = price; s.description = desc; }
            } else {
                db.services.push({ id: Date.now(), name, price, description: desc });
            }
            save(); renderServices();
            document.getElementById('serv-id').value = '';
            document.getElementById('serv-form').reset();
            showToast('تم حفظ الخدمة');
        }

        function editService(id) {
            const s = db.services.find(x => x.id == id);
            if (s) {
                document.getElementById('serv-id').value = s.id;
                document.getElementById('serv-name').value = s.name;
                document.getElementById('serv-price').value = s.price;
                document.getElementById('serv-desc').value = s.description || '';
            }
        }

        function addToServiceCart() {
            const id = document.getElementById('srv-list').value;
            const serv = db.services.find(x => x.id == id);
            if (serv) {
                currentSrvCart.push({ ...serv });
                renderServiceCart();
            }
        }

        function renderServiceCart() {
            const tbody = document.getElementById('srv-cart-body');
            let total = 0;
            if (tbody) {
                tbody.innerHTML = currentSrvCart.map((item, idx) => {
                    total += item.price;
                    return `<tr><td class="p-2">${item.name}</td><td class="p-2 font-mono">${item.price}</td><td class="p-2"><button onclick="currentSrvCart.splice(${idx},1);renderServiceCart()" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
                }).join('');
                document.getElementById('srv-total').innerText = total.toFixed(2);
            }
        }

        function postServiceBill() {
            if (currentSrvCart.length === 0) return showToast('الفاتورة فارغة', 'error');
            const total = currentSrvCart.reduce((sum, item) => sum + item.price, 0);
            const method = document.getElementById('srv-method')?.value || '1101';
            const custName = document.getElementById('srv-customer')?.value || 'عميل خدمات';
            const paid = parseFloat(document.getElementById('srv-paid')?.value) || total;
            const remaining = total - paid;
            const date = new Date().toISOString().split('T')[0];
            const saleId = Date.now();
            const invoiceNo = 'SVC-' + String(saleId).slice(-6);

            const lines = [
                { code: method || '1101', dr: paid, cr: 0 },
                { code: '4101', dr: 0, cr: total }
            ];
            if (remaining > 0) lines.push({ code: '1201', dr: remaining, cr: 0 }); // Receivable

            if (addJournalEntry(date, `فاتورة خدمات - ${custName}`, lines)) {
                if (!db.serviceInvoices) db.serviceInvoices = [];
                const invObj = { id: saleId, invoiceNo, date, customer: custName, total, paid, remaining, method, type: 'service', items: [...currentSrvCart] };
                db.serviceInvoices.push(invObj);
                showToast('تم حفظ فاتورة الخدمة ✅');
                currentSrvCart = []; renderServiceCart(); save(); renderAll();
            }
        }

        // --- 13. Expenses Module Logic ---
        function renderExpenses() {
            if (!db.expensesCategories) db.expensesCategories = [
                { id: '5201', name: 'مصروفات تشغيلية' },
                { id: '5203', name: 'مصروفات أخرى (طارئة)' }
            ];

            const catSel = document.getElementById('exp-cat');
            if (catSel) catSel.innerHTML = db.expensesCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            const methodSel = document.getElementById('exp-method');
            if (methodSel && db.settings.paymentMethods) methodSel.innerHTML = db.settings.paymentMethods.map(m => `<option value="${m}">${m}</option>`).join('');

            if (!db.expenses) db.expenses = [];
            const list = document.getElementById('expenses-list');
            let total = 0;
            if (list) {
                list.innerHTML = db.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 50).map(e => {
                    total += parseFloat(e.amount);
                    return `<tr><td class="p-2 border-l">${e.date}</td><td class="p-2 border-l">${e.description}</td><td class="p-2 font-bold text-red-600 border-l">${parseFloat(e.amount).toFixed(2)}</td><td class="p-2 text-xs">${e.categoryName}</td></tr>`;
                }).join('');
                document.getElementById('exp-list-total').innerText = total.toFixed(2);
            }
        }

        function postExpense(e) {
            e.preventDefault();
            const desc = document.getElementById('exp-desc').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const catId = document.getElementById('exp-cat').value;
            const catName = db.expensesCategories.find(c => c.id == catId)?.name || 'مصروف';
            const method = document.getElementById('exp-method').value;
            const date = new Date().toISOString().split('T')[0];

            if (!amount || !desc) return showToast('بيانات ناقصة', 'error');

            const lines = [
                { code: catId, dr: amount, cr: 0 },
                { code: method || '1101', dr: 0, cr: amount }
            ];

            if (addJournalEntry(date, `مصروف - ${desc}`, lines)) {
                db.expenses.push({ id: Date.now(), date, description: desc, amount, categoryId: catId, categoryName: catName, method });
                showToast('تم تسجيل المصروف Successfully');
                document.getElementById('exp-desc').value = '';
                document.getElementById('exp-amount').value = '';
                save(); renderExpenses(); renderAll();
            }
        }

        // --- 14. POS Module Logic ---
        let posCart = [];

        function renderPOSProducts(q = '', cat = '') {
            const grid = document.getElementById('pos-grid');
            if (!grid) return;
            grid.innerHTML = db.products.filter(p => p.name.includes(q)).map(p => `
                <div class="bg-slate-50 border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition cursor-pointer group" onclick="addToPOSCart(${p.id})">
                    <div class="h-32 bg-slate-200 flex items-center justify-center relative">
                        ${p.image ? `<img src="${p.image}" class="w-full h-full object-cover">` : `<i class="fas fa-box text-4xl text-slate-400"></i>`}
                        <div class="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center text-white font-bold backdrop-blur-sm transition">إضافة للسلة</div>
                    </div>
                    <div class="p-3">
                        <div class="font-bold text-slate-800 text-sm truncate">${p.name}</div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-emerald-600 font-mono font-bold">${p.price}</span>
                            <span class="text-xs text-slate-500 bg-slate-200 px-1.5 py-0.5 rounded">مخزون: ${p.stock}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Populate Customers Select
            const custSel = document.getElementById('pos-customer');
            if (custSel && (!custSel.innerHTML || custSel.innerHTML.length < 10)) {
                custSel.innerHTML = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }

            // Render Other Methods
            const otherDiv = document.getElementById('pos-other-methods');
            if (otherDiv && db.settings.paymentMethods) {
                const others = db.settings.paymentMethods.filter(m => m !== 'Cash' && m !== 'Bank');
                otherDiv.innerHTML = others.map(m => `
                    <button onclick="checkoutPOS('${m}')" class="bg-slate-700 text-white py-2 rounded font-bold hover:bg-slate-600 text-xs shadow">${m}</button>
                `).join('');
            }
        }



        function addToPOSCart(id) {
            const p = db.products.find(x => x.id == id);
            if (!p) return;
            if (p.stock <= 0) return showToast('نافذ من المخزون', 'error');

            const exist = posCart.find(x => x.id == id);
            if (exist) {
                if (exist.qty < p.stock) exist.qty++;
            } else {
                posCart.push({ ...p, qty: 1, total: p.price });
            }
            renderPOSCart();
        }

        function renderPOSCart() {
            const tbody = document.getElementById('pos-cart-body');
            let sub = 0;
            posCart.forEach(i => { i.total = i.price * i.qty; sub += i.total; });

            tbody.innerHTML = posCart.map((i, idx) => `
                <tr class="border-b"><td class="p-2 text-xs font-bold">${i.name}</td>
                <td class="p-2 flex items-center gap-1">
                    <button onclick="updatePOSQty(${idx}, -1)" class="w-5 h-5 bg-red-100 text-red-600 rounded flex items-center justify-center hover:bg-red-200">-</button>
                    <span class="font-mono text-xs w-4 text-center">${i.qty}</span>
                    <button onclick="updatePOSQty(${idx}, 1)" class="w-5 h-5 bg-green-100 text-green-600 rounded flex items-center justify-center hover:bg-green-200">+</button>
                </td>
                <td class="p-2 font-mono text-xs">${i.total.toFixed(2)}</td>
                <td class="p-2"><button onclick="posCart.splice(${idx},1);renderPOSCart()" class="text-red-400 hover:text-red-500"><i class="fas fa-times"></i></button></td></tr>
            `).join('');

            const disc = parseFloat(document.getElementById('pos-discount').value) || 0;
            const final = Math.max(0, sub - disc);
            document.getElementById('pos-subtotal').innerText = sub.toFixed(2);
            document.getElementById('pos-total').innerText = final.toFixed(2);
        }

        function updatePOSQty(idx, change) {
            const item = posCart[idx];
            const p = db.products.find(x => x.id == item.id);
            if (change > 0 && item.qty >= p.stock) return showToast('الكمية غير متاحة', 'error');
            item.qty += change;
            if (item.qty <= 0) posCart.splice(idx, 1);
            renderPOSCart();
        }

        function clearPOSCart() { posCart = []; renderPOSCart(); }

        function checkoutPOS(method) {
            if (posCart.length === 0) return showToast('السلة فارغة', 'error');

            const isWalkIn = document.getElementById('pos-walkin').checked;
            const custId = document.getElementById('pos-customer').value;
            const custName = isWalkIn ? 'عميل نقدي (كاشير)' : (db.customers.find(c => c.id == custId)?.name || 'غير معروف');

            const total = parseFloat(document.getElementById('pos-total').innerText);
            const subtotal = parseFloat(document.getElementById('pos-subtotal').innerText);
            const discount = parseFloat(document.getElementById('pos-discount').value) || 0;

            // Logic similar to Sale
            const date = new Date().toISOString().split('T')[0];
            const saleId = Date.now();

            // Journal
            // Dr Cash/Bank, Dr COGS
            // Cr Sales Rev, Cr VAT, Cr Inventory, Dr Discount Exp

            const vat = total * (db.settings.vatRate / (100 + db.settings.vatRate)); // Inclusive VAT
            const netSale = total - vat;
            let totalCost = 0;
            posCart.forEach(i => { const p = db.products.find(x => x.id == i.id); totalCost += (p?.cost || 0) * i.qty; });

            const lines = [
                { code: method === 'Cash' ? '1101' : '1102', dr: total, cr: 0 }, // Asset Up
                { code: '5101', dr: totalCost, cr: 0 }, // COGS
                { code: '4101', dr: 0, cr: netSale }, // Revenue
                { code: '1104', dr: 0, cr: totalCost }, // Inventory Down
                { code: '2102', dr: 0, cr: vat } // VAT Liab
            ];
            // Discount? If separate line needed: 
            // Currently NetSale is reduced by discount. If we want to track Discount Expense:
            // Dr Cash (Total), Dr Sales Discount (Disc), Cr Sales Revenue (Subtotal - VAT)...
            // For simplicity, sticking to Net methodology.

            if (addJournalEntry(date, `بيع كاشير - ${custName}`, lines)) {
                // Stock Update
                posCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) p.stock -= i.qty; });
                const invoiceNo = 'POS-' + String(saleId).slice(-6);
                const saleObj = { id: saleId, invoiceNo, date, time: new Date().toLocaleTimeString('ar'), customer: custName, total, paid: total, remaining: 0, method, type: 'pos', items: [...posCart] };
                db.sales.push(saleObj);
                showToast('تمت عملية البيع ✅');
                // Print POS receipt
                printPOSReceipt(saleObj);
                clearPOSCart();
                save(); renderAll();
            }
        }

        // --- 15. HR Module Logic ---
        function previewEmpPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('emp-photo-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('emp-id').value;
            const name = document.getElementById('emp-name').value;
            const role = document.getElementById('emp-role').value;
            const salary = parseFloat(document.getElementById('emp-salary').value);
            const phone = document.getElementById('emp-phone').value;
            const photoSrc = document.getElementById('emp-photo-preview').src || '';

            if (id) {
                const emp = db.employees.find(x => x.id == id);
                if (emp) { emp.name = name; emp.role = role; emp.salary = salary; emp.phone = phone; if (photoSrc.startsWith('data:')) emp.photo = photoSrc; }
            } else {
                db.employees.push({ id: Date.now(), name, role, salary, phone, photo: photoSrc.startsWith('data:') ? photoSrc : '' });
            }
            save(); renderEmployees();
            document.getElementById('emp-id').value = '';
            document.getElementById('emp-form').reset();
            document.getElementById('emp-photo-preview').classList.add('hidden');
            showToast('تم حفظ الموظف');
        }

        function renderEmployees() {
            if (!db.employees) db.employees = [];

            // List
            const list = document.getElementById('employees-list');
            if (list) list.innerHTML = db.employees.map(e => `
                <tr class="hover:bg-slate-50">
                    <td class="p-2 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden"><img src="${e.photo || ''}" class="w-full h-full object-cover"></div>
                        <span class="font-bold">${e.name}</span>
                    </td>
                    <td class="p-2 text-xs">${e.role}</td>
                    <td class="p-2 font-mono">${e.salary}</td>
                    <td class="p-2"><button onclick="editEmployee(${e.id})" class="text-blue-500"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');

            // Select for Actions
            const sel = document.getElementById('act-emp');
            if (sel) sel.innerHTML = '<option value="">اختر موظف...</option>' + db.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');

            // Render Recent Actions
            if (!db.payrollActions) db.payrollActions = [];
            const actList = document.getElementById('actions-list');
            if (actList) actList.innerHTML = db.payrollActions.slice().reverse().slice(0, 20).map(a => `
                <tr><td class="p-2">${a.empName}</td><td class="p-2 text-xs ${a.type === 'bonus' ? 'text-emerald-600' : 'text-red-600'}">${a.type === 'bonus' ? 'مكافأة' : 'خصم'}</td><td class="p-2 font-bold">${a.amount}</td></tr>
            `).join('');
        }

        function editEmployee(id) {
            const e = db.employees.find(x => x.id == id);
            if (e) {
                document.getElementById('emp-id').value = e.id;
                document.getElementById('emp-name').value = e.name;
                document.getElementById('emp-role').value = e.role;
                document.getElementById('emp-salary').value = e.salary;
                document.getElementById('emp-phone').value = e.phone;
                const img = document.getElementById('emp-photo-preview');
                if (e.photo) { img.src = e.photo; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
            }
        }

        function postPayrollAction(e) {
            e.preventDefault();
            const empId = document.getElementById('act-emp').value;
            const type = document.getElementById('act-type').value;
            const amount = parseFloat(document.getElementById('act-amount').value);
            const desc = document.getElementById('act-desc').value;
            const emp = db.employees.find(x => x.id == empId);

            if (!emp || !amount) return showToast('بيانات ناقصة', 'error');

            db.payrollActions.push({
                id: Date.now(),
                empId, empName: emp.name,
                type, amount, description: desc,
                date: new Date().toISOString().split('T')[0]
            });
            save(); renderEmployees(); showToast('تم تسجيل الإجراء');
            document.getElementById('act-amount').value = '';
            document.getElementById('act-desc').value = '';
        }

        function generatePayrollPreview() {
            const month = document.getElementById('payroll-month').value;
            if (!month) return showToast('اختر الشهر', 'error');

            const tbody = document.getElementById('payroll-table');
            let totalNet = 0;

            const rows = db.employees.map(emp => {
                const actions = db.payrollActions.filter(a => a.empId == emp.id && a.date.startsWith(month));
                const bonuses = actions.filter(a => a.type === 'bonus').reduce((sum, a) => sum + a.amount, 0);
                const deductions = actions.filter(a => a.type === 'deduction').reduce((sum, a) => sum + a.amount, 0);
                const net = emp.salary + bonuses - deductions;
                totalNet += net;

                return `<tr>
                    <td class="p-2 font-bold">${emp.name}</td>
                    <td class="p-2">${emp.salary}</td>
                    <td class="p-2 text-green-600">${bonuses}</td>
                    <td class="p-2 text-red-600">${deductions}</td>
                    <td class="p-2 font-bold">${net}</td>
                </tr>`;
            }).join('');

            tbody.innerHTML = rows;
            document.getElementById('payroll-total').innerText = totalNet.toFixed(2);
            document.getElementById('payroll-preview').classList.remove('hidden');
        }

        function postPayroll() {
            if (!confirm('هل أنت متأكد من صرف الرواتب؟ سيتم تسجيل قيد يومي.')) return;
            const total = parseFloat(document.getElementById('payroll-total').innerText);
            const month = document.getElementById('payroll-month').value;
            const date = new Date().toISOString().split('T')[0];

            const lines = [
                { code: '5202', dr: total, cr: 0 },
                { code: '1101', dr: 0, cr: total }
            ];

            if (addJournalEntry(date, `رواتب شهر ${month}`, lines)) {
                showToast('تم صرف الرواتب');
                document.getElementById('payroll-preview').classList.add('hidden');
                save(); renderAll();
            }
        }

        // ==========================================
        // NEW ENHANCEMENTS: Cash/Credit, Discounts, Statements, POS Receipt, Barcode
        // ==========================================

        // --- Sales Payment Type Toggle ---
        let salePayType = 'cash';
        function setSalePayType(type) {
            salePayType = type;
            document.getElementById('sale-pay-cash-btn').className = type === 'cash' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('sale-pay-credit-btn').className = type === 'credit' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('sale-credit-area').classList.toggle('hidden', type === 'cash');
            document.getElementById('sale-remaining-row').classList.toggle('hidden', type === 'cash');
            if (type === 'cash') {
                document.getElementById('sale-paid').value = '';
                document.getElementById('sale-remaining').innerText = '0.00';
            }
        }

        function calcSaleRemaining() {
            const total = parseFloat(document.getElementById('cart-total').innerText) || 0;
            const paid = parseFloat(document.getElementById('sale-paid').value) || 0;
            document.getElementById('sale-remaining').innerText = Math.max(0, total - paid).toFixed(2);
        }

        // --- Purchases Payment Type Toggle ---
        let purPayType = 'cash';
        function setPurPayType(type) {
            purPayType = type;
            document.getElementById('pur-pay-cash-btn').className = type === 'cash' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-orange-600 text-white' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('pur-pay-credit-btn').className = type === 'credit' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-orange-600 text-white' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('pur-credit-area').classList.toggle('hidden', type === 'cash');
            document.getElementById('pur-remaining-row').classList.toggle('hidden', type === 'cash');
            if (type === 'cash') {
                document.getElementById('pur-paid').value = '';
                document.getElementById('pur-remaining').innerText = '0.00';
            }
        }

        function calcPurRemaining() {
            const total = parseFloat(document.getElementById('pur-total').innerText) || 0;
            const paid = parseFloat(document.getElementById('pur-paid').value) || 0;
            document.getElementById('pur-remaining').innerText = Math.max(0, total - paid).toFixed(2);
        }

        // --- Enhanced Discount Calculation (used by renderCart) ---
        function calcDiscount(prefix, subtotal) {
            const toggle = document.getElementById(prefix + '-disc-toggle');
            if (!toggle || !toggle.checked) return 0;
            const type = document.getElementById(prefix + '-disc-type')?.value || 'amount';
            const val = parseFloat(document.getElementById(prefix.replace('-disc', '') + '-discount')?.value) || 0;
            if (type === 'percent') return subtotal * (val / 100);
            return val;
        }

        // --- Customer Account Statement ---
        function renderCustStatement() {
            const tbody = document.getElementById('cust-statement-body');
            if (!tbody) return;
            const creditSales = {};
            db.sales.forEach(s => {
                if (s.remaining > 0 || s.type === 'credit') {
                    if (!creditSales[s.customer]) creditSales[s.customer] = { total: 0, paid: 0 };
                    creditSales[s.customer].total += s.total;
                    creditSales[s.customer].paid += s.paid;
                }
            });
            // Also from customers list
            let rows = '';
            db.customers.forEach(c => {
                const cCode = c.code || ('C-' + String(c.id).slice(-4));
                const data = creditSales[c.name] || { total: 0, paid: 0 };
                const rem = data.total - data.paid;
                if (data.total > 0) {
                    rows += `<tr class="hover:bg-blue-50"><td class="p-1.5 font-mono">${cCode}</td><td class="p-1.5 font-bold">${c.name}</td><td class="p-1.5">${data.total.toFixed(2)}</td><td class="p-1.5 text-emerald-600">${data.paid.toFixed(2)}</td><td class="p-1.5 text-red-600 font-bold">${rem.toFixed(2)}</td></tr>`;
                }
            });
            tbody.innerHTML = rows || '<tr><td colspan="5" class="p-3 text-center text-slate-400">لا توجد حسابات آجلة</td></tr>';
        }

        function filterCustStatement(q) {
            document.querySelectorAll('#cust-statement-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- Supplier Account Statement ---
        function renderSuppStatement() {
            const tbody = document.getElementById('supp-statement-body');
            if (!tbody) return;
            const creditPur = {};
            db.purchases.forEach(p => {
                if (p.remaining > 0) {
                    if (!creditPur[p.supplier]) creditPur[p.supplier] = { total: 0, paid: 0 };
                    creditPur[p.supplier].total += p.total;
                    creditPur[p.supplier].paid += p.paid;
                }
            });
            let rows = '';
            db.suppliers.forEach(s => {
                const sCode = s.code || ('S-' + String(s.id).slice(-4));
                const data = creditPur[s.name] || { total: 0, paid: 0 };
                const rem = data.total - data.paid;
                if (data.total > 0) {
                    rows += `<tr class="hover:bg-orange-50"><td class="p-1.5 font-mono">${sCode}</td><td class="p-1.5 font-bold">${s.name}</td><td class="p-1.5">${data.total.toFixed(2)}</td><td class="p-1.5 text-emerald-600">${data.paid.toFixed(2)}</td><td class="p-1.5 text-red-600 font-bold">${rem.toFixed(2)}</td></tr>`;
                }
            });
            tbody.innerHTML = rows || '<tr><td colspan="5" class="p-3 text-center text-slate-400">لا توجد حسابات آجلة</td></tr>';
        }

        function filterSuppStatement(q) {
            document.querySelectorAll('#supp-statement-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- POS Receipt Printing ---
        function printPOSReceipt(saleData) {
            const receiptSettings = db.settings.receiptSettings || {};
            const w = window.open('', 'receipt', 'width=320,height=600');
            w.document.write(`<html dir="rtl"><head><style>
                body { font-family: 'Cairo', sans-serif; width: 280px; margin: 0 auto; padding: 10px; font-size: 12px; }
                .center { text-align: center; } .bold { font-weight: bold; } .line { border-top: 1px dashed #000; margin: 8px 0; }
                table { width: 100%; border-collapse: collapse; } td { padding: 2px 0; font-size: 11px; } .total { font-size: 16px; font-weight: bold; }
                @media print { body { margin: 0; } }
            </style></head><body>
            ${receiptSettings.showLogo !== false && db.settings.logo ? `<div class="center"><img src="${db.settings.logo}" style="max-height:50px"></div>` : ''}
            <div class="center bold">${db.settings.companyName || 'نظام ERP'}</div>
            <div class="center" style="font-size:10px">${db.settings.address || ''}</div>
            <div class="center" style="font-size:10px">${db.settings.phone || ''}</div>
            <div class="line"></div>
            <div>فاتورة رقم: #${saleData.id}</div>
            <div>التاريخ: ${saleData.date}</div>
            <div>العميل: ${saleData.customer}</div>
            <div class="line"></div>
            <table>${saleData.items.map(i => `<tr><td>${i.name}</td><td>${i.qty}x</td><td style="text-align:left">${i.total.toFixed(2)}</td></tr>`).join('')}</table>
            <div class="line"></div>
            <div class="total center">الإجمالي: ${saleData.total.toFixed(2)}</div>
            <div class="center" style="font-size:10px">الدفع: ${saleData.method || 'كاش'}</div>
            ${receiptSettings.footerMsg ? `<div class="line"></div><div class="center" style="font-size:10px">${receiptSettings.footerMsg}</div>` : ''}
            <div class="center" style="font-size:9px;margin-top:10px;color:#999">شكراً لزيارتكم</div>
            </body></html>`);
            w.document.close();
            setTimeout(() => { w.print(); w.close(); }, 300);
        }

        // --- Barcode Generator ---
        function generateBarcode(productId) {
            const p = db.products.find(x => x.id == productId);
            if (!p) return;
            const code = p.barcode || String(p.id);
            const w = window.open('', 'barcode', 'width=400,height=300');
            w.document.write(`<html dir="rtl"><head>
            <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
            <style>body{font-family:'Cairo',sans-serif;text-align:center;padding:20px} .label{border:1px dashed #ccc;padding:10px;display:inline-block;margin:5px}</style>
            </head><body>
            <div class="label"><svg id="bc"></svg><div style="font-size:12px;margin-top:5px">${p.name}</div><div style="font-size:11px">${p.price} ${db.settings.currency || 'ر.س'}</div></div>
            <script>JsBarcode("#bc","${code}",{format:"CODE128",width:2,height:50,displayValue:true,fontSize:14})<\/script>
            <br><button onclick="window.print()" style="margin-top:20px;padding:8px 20px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer">طباعة</button>
            </body></html>`);
            w.document.close();
        }

        function renderBarcodeList() {
            const container = document.getElementById('barcode-products-list');
            if (!container) return;
            container.innerHTML = db.products.map(p => `
                <div class="flex items-center justify-between p-2 border-b hover:bg-slate-50">
                    <div><span class="font-bold text-sm">${p.name}</span> <span class="text-xs text-slate-400">(${p.price})</span></div>
                    <button onclick="generateBarcode(${p.id})" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-500"><i class="fas fa-barcode me-1"></i>طباعة</button>
                </div>
            `).join('');
        }

        // --- Print Section Helper ---
        function printSection(sectionId) {
            const el = document.getElementById(sectionId);
            if (!el) return;
            const w = window.open('', 'print', 'width=800,height=600');
            w.document.write(`<html dir="rtl"><head><style>body{font-family:'Cairo',sans-serif;padding:20px} table{width:100%;border-collapse:collapse} td,th{border:1px solid #ddd;padding:6px;text-align:right;font-size:12px} th{background:#f1f5f9}</style></head><body>${el.outerHTML}</body></html>`);
            w.document.close();
            setTimeout(() => { w.print(); w.close(); }, 300);
        }

        // --- Update renderAll to include statements ---
        const _origRenderAll = renderAll;
        renderAll = function () {
            _origRenderAll();
            try { renderCustStatement(); } catch (e) { console.error('renderCustStatement error:', e); }
            try { renderSuppStatement(); } catch (e) { console.error('renderSuppStatement error:', e); }
        };

        // --- Installment Customers ---
        function saveInstCustomer(e) {
            e.preventDefault();
            if (!db.installmentCustomers) db.installmentCustomers = [];
            const id = document.getElementById('inst-cust-id').value;
            const cust = {
                id: id ? parseInt(id) : Date.now(),
                code: 'IC-' + String(Date.now()).slice(-5),
                name: document.getElementById('inst-cust-name').value,
                phone: document.getElementById('inst-cust-phone').value,
                address: document.getElementById('inst-cust-address').value,
                nid: document.getElementById('inst-cust-nid').value
            };
            if (id) {
                const idx = db.installmentCustomers.findIndex(c => c.id == id);
                if (idx >= 0) { cust.code = db.installmentCustomers[idx].code; db.installmentCustomers[idx] = cust; }
            } else {
                db.installmentCustomers.push(cust);
            }
            showToast('تم حفظ عميل التقسيط');
            document.getElementById('inst-cust-id').value = '';
            e.target.reset();
            renderInstCustomers();
            save();
        }

        function renderInstCustomers() {
            if (!db.installmentCustomers) db.installmentCustomers = [];
            const tbody = document.getElementById('inst-cust-list');
            if (!tbody) return;
            tbody.innerHTML = db.installmentCustomers.map(c => `
                <tr class="hover:bg-slate-50">
                    <td class="p-2 font-mono text-xs">${c.code}</td>
                    <td class="p-2 font-bold">${c.name}</td>
                    <td class="p-2">${c.phone || '-'}</td>
                    <td class="p-2">${c.nid || '-'}</td>
                    <td class="p-2 flex gap-1"><button onclick="editInstCust(${c.id})" class="text-blue-500 text-xs"><i class="fas fa-edit"></i></button><button onclick="deleteInstCust(${c.id})" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function editInstCust(id) {
            const c = db.installmentCustomers.find(x => x.id == id);
            if (!c) return;
            document.getElementById('inst-cust-id').value = c.id;
            document.getElementById('inst-cust-name').value = c.name;
            document.getElementById('inst-cust-phone').value = c.phone || '';
            document.getElementById('inst-cust-address').value = c.address || '';
            document.getElementById('inst-cust-nid').value = c.nid || '';
            showSection('installment_customers');
        }

        function deleteInstCust(id) {
            if (!confirm('حذف هذا العميل؟')) return;
            db.installmentCustomers = db.installmentCustomers.filter(c => c.id != id);
            renderInstCustomers(); save();
        }

        function filterInstCust(q) {
            document.querySelectorAll('#inst-cust-list tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- Installment Payment Statement ---
        function renderInstPayments() {
            if (!db.installments) db.installments = [];
            if (!db.installmentCustomers) db.installmentCustomers = [];
            const tbody = document.getElementById('inst-pay-body');
            if (!tbody) return;
            // Aggregate by customer
            const byCustomer = {};
            db.installments.forEach(inst => {
                const key = inst.customer || 'عميل عام';
                if (!byCustomer[key]) byCustomer[key] = { total: 0, paid: 0, late: 0, due: 0 };
                byCustomer[key].total += inst.total || 0;
                byCustomer[key].paid += inst.paid || 0;
                const remaining = (inst.total || 0) - (inst.paid || 0);
                // Check if any installment is overdue
                if (inst.dueDate && new Date(inst.dueDate) < new Date() && remaining > 0) {
                    byCustomer[key].late += remaining;
                } else {
                    byCustomer[key].due += remaining;
                }
            });
            let rows = '';
            Object.keys(byCustomer).forEach(name => {
                const d = byCustomer[name];
                const custObj = db.installmentCustomers.find(c => c.name === name);
                const code = custObj?.code || 'IC-0000';
                const status = d.late > 0 ? '<span class="text-red-600 font-bold">متأخر</span>' : (d.due > 0 ? '<span class="text-yellow-600">جاري</span>' : '<span class="text-emerald-600 font-bold">مكتمل</span>');
                rows += `<tr class="hover:bg-slate-50"><td class="p-3 font-mono text-xs">${code}</td><td class="p-3 font-bold">${name}</td><td class="p-3">${d.total.toFixed(2)}</td><td class="p-3 text-emerald-600">${d.paid.toFixed(2)}</td><td class="p-3 text-yellow-600">${d.due.toFixed(2)}</td><td class="p-3 text-red-600">${d.late.toFixed(2)}</td><td class="p-3">${status}</td></tr>`;
            });
            tbody.innerHTML = rows || '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد أقساط مسجلة</td></tr>';
        }

        function filterInstPayments(q) {
            document.querySelectorAll('#inst-pay-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- Barcode List Helpers ---
        function filterBarcodeList(q) {
            const items = document.querySelectorAll('#barcode-products-list > div');
            items.forEach(d => { d.style.display = d.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none'; });
        }

        function printAllBarcodes() {
            const w = window.open('', 'barcodes', 'width=600,height=800');
            w.document.write(`<html dir="rtl"><head>
            <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
            <style>body{font-family:'Cairo',sans-serif;text-align:center;padding:10px} .label{border:1px dashed #ccc;padding:8px;display:inline-block;margin:5px;page-break-inside:avoid}</style>
            </head><body>`);
            db.products.forEach((p, i) => {
                const code = p.barcode || String(p.id);
                w.document.write(`<div class="label"><svg id="bc${i}"></svg><div style="font-size:11px;margin-top:3px">${p.name}</div><div style="font-size:10px">${p.price} ${db.settings.currency || 'ر.س'}</div></div>`);
            });
            w.document.write(`<script>document.querySelectorAll('svg[id^="bc"]').forEach((svg,i)=>{const codes=${JSON.stringify(db.products.map(p => p.barcode || String(p.id)))};JsBarcode(svg,codes[i],{format:"CODE128",width:1.5,height:40,displayValue:true,fontSize:12})})<\/script>`);
            w.document.write(`<br><button onclick="window.print()" style="margin:20px;padding:10px 30px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px">طباعة الكل</button></body></html>`);
            w.document.close();
        }

        // --- Update showSection to trigger new sub-modules ---
        const _showSection = showSection;
        showSection = function (id) {
            _showSection(id);
            try {
                if (id === 'barcode') renderBarcodeList();
                if (id === 'installment_customers') renderInstCustomers();
                if (id === 'installment_payments') renderInstPayments();
                if (id === 'sales') { renderCustStatement(); renderSalesInvoices(); }
                if (id === 'purchases') { renderSuppStatement(); }
                if (id === 'pos_products') { renderPOSProductsList(); }
                if (id === 'pos') { setTimeout(() => document.getElementById('pos-barcode-input')?.focus(), 100); }
                // Invoices Module
                if (id === 'invoices') { renderInvoicesDashboard(); }
                if (id === 'inv_pos') { renderInvPOS(); }
                if (id === 'inv_sales') { renderInvSales(); }
                if (id === 'inv_purchases') { renderInvPurchases(); }
                if (id === 'inv_services') { renderInvServices(); }
                if (id === 'inv_installments') { renderInvInstallments(); }
                // Statements
                if (id === 'cust_statement') { renderCustStatementFull(); }
                if (id === 'supp_statement') { renderSuppStatementFull(); }
                if (id === 'svc_statement') { renderSvcStatement(); }
                // Collection
                if (id === 'inst_collection') { renderInstCollection(); }
                // Expenses
                if (id === 'expense_vouchers') { renderExpenseVouchers(); }
                // HR
                if (id === 'hr_employees') { renderHREmployees(); }
                if (id === 'hr_actions') { populateHRActionEmps(); renderHRActions(); }
                if (id === 'hr_list') { renderHRList(); }
                if (id === 'hr_payroll') { populatePayrollEmps(); renderPayrollHistory(); }
                // Reports
                if (id === 'rpt_pos') { renderRptPOS(); }
                if (id === 'rpt_sales') { renderRptSales(); }
                if (id === 'rpt_customers') { renderRptCustomers(); }
                if (id === 'rpt_purchases') { renderRptPurchases(); }
                if (id === 'rpt_suppliers') { renderRptSuppliers(); }
                if (id === 'rpt_employees') { renderRptEmployees(); }
                if (id === 'rpt_inventory') { renderRptInventory(); }
                if (id === 'rpt_services') { renderRptServices(); }
                if (id === 'rpt_installments') { renderRptInstallments(); }
                if (id === 'rpt_inst_customers') { renderRptInstCustomers(); }
                if (id === 'rpt_expenses') { renderRptExpenses(); }
                if (id === 'rpt_revenue') { renderRptRevenue(); }
                if (id === 'rpt_treasury') { renderRptTreasury(); }
                if (id === 'rpt_profits') { renderRptProfits(); }
            } catch (e) { console.error('Sub-module render error:', e); }
        };

        // --- Sales Invoice List (Individual) ---
        function renderSalesInvoices() {
            const tbody = document.getElementById('recent-inv-body');
            if (!tbody) return;
            const invoices = [...db.sales].reverse();
            tbody.innerHTML = invoices.length ? invoices.map((s, i) => {
                const invNo = s.invoiceNo || ('INV-' + String(invoices.length - i).padStart(4, '0'));
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                return `<tr class="hover:bg-blue-50 cursor-pointer" ondblclick="viewSaleInvoice(${s.id})">
                    <td class="p-1.5 font-mono text-blue-600">${invNo}</td>
                    <td class="p-1.5">${s.date}</td>
                    <td class="p-1.5 font-bold">${s.customer}</td>
                    <td class="p-1.5 font-bold">${(s.total || 0).toFixed(2)}</td>
                    <td class="p-1.5">${status}</td>
                    <td class="p-1.5"><button onclick="viewSaleInvoice(${s.id})" class="text-blue-500 hover:text-blue-700" title="عرض الفاتورة"><i class="fas fa-eye"></i></button></td>
                </tr>`;
            }).join('') : '<tr><td colspan="6" class="p-3 text-center text-slate-400">لا توجد فواتير</td></tr>';
        }

        function filterSalesInvoiceList(q) {
            document.querySelectorAll('#recent-inv-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // View individual invoice
        function viewSaleInvoice(saleId) {
            const sale = db.sales.find(s => s.id == saleId);
            if (!sale) return showToast('فاتورة غير موجودة', 'error');
            const invNo = sale.invoiceNo || 'INV-' + String(sale.id).slice(-4);
            const w = window.open('', 'invoice', 'width=700,height=800');
            w.document.write(`<html dir="rtl"><head><style>
                body { font-family: 'Cairo', sans-serif; max-width: 650px; margin: 20px auto; padding: 20px; font-size: 13px; }
                .header { text-align: center; margin-bottom: 20px; }
                .header h1 { font-size: 18px; margin: 0; } .header p { color: #666; font-size: 11px; margin: 2px 0; }
                .info { display: flex; justify-content: space-between; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
                .info div { font-size: 12px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                th { background: #1e293b; color: white; padding: 8px; text-align: right; font-size: 12px; }
                td { padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: right; font-size: 12px; }
                .totals { background: #f1f5f9; padding: 12px; border-radius: 8px; }
                .totals .row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; }
                .totals .grand { font-size: 16px; font-weight: bold; color: #059669; border-top: 2px solid #1e293b; padding-top: 8px; margin-top: 8px; }
                .no-print { margin-top: 20px; text-align: center; }
                @media print { .no-print { display: none; } }
            </style></head><body>
            <div class="header">
                ${db.settings.logo ? `<img src="${db.settings.logo}" style="max-height:60px;margin-bottom:5px">` : ''}
                <h1>${db.settings.companyName || 'نظام ERP'}</h1>
                <p>${db.settings.address || ''} ${db.settings.phone ? '| ' + db.settings.phone : ''}</p>
            </div>
            <div class="info">
                <div><strong>فاتورة رقم:</strong> ${invNo}</div>
                <div><strong>التاريخ:</strong> ${sale.date}</div>
                <div><strong>العميل:</strong> ${sale.customer}</div>
            </div>
            <table>
                <thead><tr><th>#</th><th>الصنف</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead>
                <tbody>${(sale.items || []).map((it, i) => `<tr><td>${i + 1}</td><td>${it.name}</td><td>${it.qty}</td><td>${(it.price || 0).toFixed(2)}</td><td>${(it.total || 0).toFixed(2)}</td></tr>`).join('')}</tbody>
            </table>
            <div class="totals">
                ${sale.discount > 0 ? `<div class="row"><span>الخصم:</span><span style="color:#dc2626">-${sale.discount.toFixed(2)}</span></div>` : ''}
                <div class="row"><span>المدفوع:</span><span style="color:#059669">${(sale.paid || 0).toFixed(2)}</span></div>
                ${(sale.remaining || 0) > 0 ? `<div class="row"><span>المتبقي:</span><span style="color:#dc2626">${sale.remaining.toFixed(2)}</span></div>` : ''}
                <div class="row grand"><span>الإجمالي:</span><span>${(sale.total || 0).toFixed(2)}</span></div>
            </div>
            <div class="no-print">
                <button onclick="window.print()" style="padding:10px 30px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin:5px">طباعة</button>
                <button onclick="window.close()" style="padding:10px 30px;background:#64748b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin:5px">إغلاق</button>
            </div>
            </body></html>`);
            w.document.close();
        }

        // Print last invoice
        function printLastSaleInvoice() {
            if (db.sales.length === 0) return showToast('لا توجد فواتير للطباعة', 'error');
            const lastSale = db.sales[db.sales.length - 1];
            viewSaleInvoice(lastSale.id);
        }

        // Export last invoice as PDF (print dialog)
        function exportLastSalePDF() {
            if (db.sales.length === 0) return showToast('لا توجد فواتير', 'error');
            viewSaleInvoice(db.sales[db.sales.length - 1].id);
            showToast('اختر "Save as PDF" من نافذة الطباعة');
        }

        // --- Add Product by Barcode/Code ---
        function addByBarcode(code) {
            if (!code || !code.trim()) return;
            code = code.trim();
            const product = db.products.find(p =>
                String(p.barcode) === code || String(p.id) === code || String(p.code) === code
            );
            if (product) {
                addToPOSCart(product.id);
                showToast(`تم إضافة: ${product.name}`);
            } else {
                showToast('منتج غير موجود بهذا الكود! ❌', 'error');
            }
            // Re-focus scanner
            setTimeout(() => document.getElementById('pos-barcode-input')?.focus(), 50);
        }

        // --- POS Product Management ---
        function savePOSProduct(e) {
            e.preventDefault();
            const id = document.getElementById('pos-prod-id').value;
            const product = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('pos-prod-name').value,
                barcode: document.getElementById('pos-prod-barcode').value || '',
                price: parseFloat(document.getElementById('pos-prod-price').value) || 0,
                cost: parseFloat(document.getElementById('pos-prod-cost').value) || 0,
                stock: parseInt(document.getElementById('pos-prod-stock').value) || 0,
                category: document.getElementById('pos-prod-category').value || 'عام'
            };
            if (id) {
                const idx = db.products.findIndex(p => p.id == id);
                if (idx >= 0) db.products[idx] = { ...db.products[idx], ...product };
            } else {
                db.products.push(product);
            }
            showToast('تم حفظ المنتج ✅');
            resetPOSProductForm();
            renderPOSProductsList();
            save();
        }

        function resetPOSProductForm() {
            document.getElementById('pos-prod-id').value = '';
            document.getElementById('pos-prod-name').value = '';
            document.getElementById('pos-prod-barcode').value = '';
            document.getElementById('pos-prod-price').value = '';
            document.getElementById('pos-prod-cost').value = '';
            document.getElementById('pos-prod-stock').value = '0';
            document.getElementById('pos-prod-category').value = '';
        }

        function renderPOSProductsList() {
            const tbody = document.getElementById('pos-products-body');
            if (!tbody) return;
            tbody.innerHTML = db.products.map((p, i) => `
                <tr class="hover:bg-blue-50 ${i % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                    <td class="p-2 font-mono text-xs text-blue-600">${p.barcode || '-'}</td>
                    <td class="p-2 font-bold">${p.name}</td>
                    <td class="p-2 text-slate-500">${p.category || 'عام'}</td>
                    <td class="p-2 text-emerald-600 font-bold">${(p.price || 0).toFixed(2)}</td>
                    <td class="p-2 text-slate-500">${(p.cost || 0).toFixed(2)}</td>
                    <td class="p-2 ${(p.stock || 0) <= 5 ? 'text-red-600 font-bold' : ''}">${p.stock || 0}</td>
                    <td class="p-2">
                        <button onclick="editPOSProduct(${p.id})" class="text-blue-500 text-xs me-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePOSProduct(${p.id})" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد منتجات</td></tr>';
        }

        function editPOSProduct(id) {
            const p = db.products.find(x => x.id == id);
            if (!p) return;
            document.getElementById('pos-prod-id').value = p.id;
            document.getElementById('pos-prod-name').value = p.name;
            document.getElementById('pos-prod-barcode').value = p.barcode || '';
            document.getElementById('pos-prod-price').value = p.price || '';
            document.getElementById('pos-prod-cost').value = p.cost || '';
            document.getElementById('pos-prod-stock').value = p.stock || 0;
            document.getElementById('pos-prod-category').value = p.category || '';
            window.scrollTo(0, 0);
        }

        function deletePOSProduct(id) {
            if (!confirm('حذف هذا المنتج؟')) return;
            db.products = db.products.filter(p => p.id != id);
            renderPOSProductsList(); save();
        }

        function filterPOSProductsList(q) {
            document.querySelectorAll('#pos-products-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // ===== Universal table filter =====
        function filterInvTable(tbodyId, q) {
            document.querySelectorAll('#' + tbodyId + ' tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }




        // ===== Invoice view helper =====
        function openInvoiceWindow(title, invNo, date, party, items, totals) {
            const w = window.open('', 'invoice', 'width=700,height=800');
            w.document.write(`<html dir="rtl"><head><style>
                body{font-family:'Cairo',sans-serif;max-width:650px;margin:20px auto;padding:20px;font-size:13px}
                .header{text-align:center;margin-bottom:20px}.header h1{font-size:18px;margin:0}.header p{color:#666;font-size:11px}
                .info{display:flex;justify-content:space-between;margin-bottom:15px;background:#f8f9fa;padding:10px;border-radius:8px}.info div{font-size:12px}
                table{width:100%;border-collapse:collapse;margin-bottom:15px}th{background:#1e293b;color:white;padding:8px;text-align:right;font-size:12px}
                td{padding:8px;border-bottom:1px solid #e2e8f0;text-align:right;font-size:12px}
                .totals{background:#f1f5f9;padding:12px;border-radius:8px}.totals .row{display:flex;justify-content:space-between;margin-bottom:4px;font-size:12px}
                .totals .grand{font-size:16px;font-weight:bold;color:#059669;border-top:2px solid #1e293b;padding-top:8px;margin-top:8px}
                .no-print{margin-top:20px;text-align:center}@media print{.no-print{display:none}}
            </style></head><body>
            <div class="header">${db.settings.logo ? `<img src="${db.settings.logo}" style="max-height:60px;margin-bottom:5px">` : ''}<h1>${db.settings.companyName || 'نظام ERP'}</h1><p>${db.settings.address || ''} ${db.settings.phone ? '| ' + db.settings.phone : ''}</p></div>
            <div class="info"><div><strong>${title}:</strong> ${invNo}</div><div><strong>التاريخ:</strong> ${date}</div><div><strong>${party.label}:</strong> ${party.name}</div></div>
            <table><thead><tr><th>#</th><th>الصنف</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead>
            <tbody>${items.map((it, i) => `<tr><td>${i + 1}</td><td>${it.name}</td><td>${it.qty}</td><td>${(it.price || 0).toFixed(2)}</td><td>${(it.total || 0).toFixed(2)}</td></tr>`).join('')}</tbody></table>
            <div class="totals">${totals}</div>
            <div class="no-print"><button onclick="window.print()" style="padding:10px 30px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin:5px">طباعة</button><button onclick="window.close()" style="padding:10px 30px;background:#64748b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin:5px">إغلاق</button></div>
            </body></html>`);
            w.document.close();
        }

        // ===== Render Invoice Sub-Modules =====
        function renderInvPOS() { showSection('inv_sales'); } // Redirect

        // -- POS Receipt Print --
        function printPOSReceipt(sale) {
            const w = window.open('', 'receipt', 'width=350,height=600');
            const itemsHTML = (sale.items || []).map(it => `<tr><td style="padding:3px">${it.name}</td><td style="padding:3px;text-align:center">${it.qty}</td><td style="padding:3px;text-align:left">${(it.total || it.price || 0).toFixed(2)}</td></tr>`).join('');
            w.document.write(`<html dir="rtl"><head><style>body{font-family:monospace,Arial;width:280px;margin:0 auto;padding:10px;font-size:12px}h2{text-align:center;margin:5px 0;font-size:14px}p{text-align:center;margin:2px 0;font-size:10px;color:#666}.line{border-top:1px dashed #000;margin:5px 0}table{width:100%;border-collapse:collapse}th{border-bottom:1px solid #000;padding:3px;font-size:11px;text-align:right}td{font-size:11px}.total{font-weight:bold;font-size:14px;text-align:center;margin:5px 0}.footer{text-align:center;font-size:10px;color:#666;margin-top:10px}@media print{.no-print{display:none}}</style></head><body>
            <h2>${db.settings.companyName || 'نظام ERP'}</h2>
            <p>${db.settings.address || ''}</p><p>${db.settings.phone || ''}</p>
            <div class="line"></div>
            <p style="text-align:right"><strong>رقم:</strong> ${sale.invoiceNo || sale.id} | <strong>التاريخ:</strong> ${sale.date} ${sale.time || ''}</p>
            <p style="text-align:right"><strong>العميل:</strong> ${sale.customer}</p>
            <div class="line"></div>
            <table><thead><tr><th>الصنف</th><th style="text-align:center">الكمية</th><th style="text-align:left">المبلغ</th></tr></thead><tbody>${itemsHTML}</tbody></table>
            <div class="line"></div>
            <div class="total">الإجمالي: ${(sale.total || 0).toFixed(2)}</div>
            <div class="line"></div>
            <div class="footer">شكراً لزيارتكم ❤️</div>
            <div class="no-print" style="text-align:center;margin-top:15px"><button onclick="window.print()" style="padding:8px 25px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer">طباعة</button></div>
            </body></html>`);
            w.document.close();
            setTimeout(() => { try { w.print(); } catch (e) { } }, 300);
        }

        // -- Sales Invoices (includes POS) with date filter + stats + actions --
        function renderInvSales() {
            const tbody = document.getElementById('inv-sales-body'); if (!tbody) return;
            const from = document.getElementById('inv-sales-from')?.value;
            const to = document.getElementById('inv-sales-to')?.value;
            let inv = [...(db.sales || [])].reverse();
            if (from) inv = inv.filter(s => s.date >= from);
            if (to) inv = inv.filter(s => s.date <= to);
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const invNo = s.invoiceNo || 'INV-' + String(s.id).slice(-6);
                totalAll += s.total || 0; paidAll += s.paid || 0; remAll += s.remaining || 0;
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                let actions = `<button onclick="viewSaleInvoice(${s.id})" class="text-blue-500 text-xs me-1" title="عرض"><i class="fas fa-eye"></i></button>`;
                if ((s.remaining || 0) > 0) {
                    actions += `<button onclick="payPartialInvoice('sales',${s.id})" class="text-amber-500 text-xs me-1" title="دفع جزئي"><i class="fas fa-money-bill"></i></button>`;
                    actions += `<button onclick="closeInvoice('sales',${s.id})" class="text-emerald-500 text-xs" title="إقفال كامل"><i class="fas fa-check-circle"></i></button>`;
                }
                return `<tr class="hover:bg-blue-50"><td class="p-2 font-mono text-blue-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${actions}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد فواتير</td></tr>';
            _el('inv-sales-count', inv.length); _el('inv-sales-total', totalAll.toFixed(2)); _el('inv-sales-paid', paidAll.toFixed(2)); _el('inv-sales-rem', remAll.toFixed(2));
        }

        // -- Purchase Invoices with date filter + stats + actions --
        function renderInvPurchases() {
            const tbody = document.getElementById('inv-pur-body'); if (!tbody) return;
            const from = document.getElementById('inv-pur-from')?.value;
            const to = document.getElementById('inv-pur-to')?.value;
            let inv = [...(db.purchases || [])].reverse();
            if (from) inv = inv.filter(s => s.date >= from);
            if (to) inv = inv.filter(s => s.date <= to);
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const invNo = s.invoiceNo || 'PUR-' + String(s.id).slice(-6);
                totalAll += s.total || 0; paidAll += s.paid || 0; remAll += s.remaining || 0;
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">مستحق</span>' : '<span class="text-emerald-600">مدفوع</span>';
                let actions = `<button onclick="viewPurchaseInvoice(${s.id})" class="text-blue-500 text-xs me-1" title="عرض"><i class="fas fa-eye"></i></button>`;
                if ((s.remaining || 0) > 0) {
                    actions += `<button onclick="payPartialInvoice('purchases',${s.id})" class="text-amber-500 text-xs me-1" title="دفع جزئي"><i class="fas fa-money-bill"></i></button>`;
                    actions += `<button onclick="closeInvoice('purchases',${s.id})" class="text-emerald-500 text-xs" title="إقفال كامل"><i class="fas fa-check-circle"></i></button>`;
                }
                return `<tr class="hover:bg-orange-50"><td class="p-2 font-mono text-orange-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.supplier}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${actions}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد فواتير</td></tr>';
            _el('inv-pur-count', inv.length); _el('inv-pur-total', totalAll.toFixed(2)); _el('inv-pur-paid', paidAll.toFixed(2)); _el('inv-pur-rem', remAll.toFixed(2));
        }

        // -- Service Invoices with date filter + stats + actions --
        function renderInvServices() {
            const tbody = document.getElementById('inv-svc-body'); if (!tbody) return;
            if (!db.serviceInvoices) db.serviceInvoices = [];
            const from = document.getElementById('inv-svc-from')?.value;
            const to = document.getElementById('inv-svc-to')?.value;
            let inv = [...db.serviceInvoices].reverse();
            if (from) inv = inv.filter(s => s.date >= from);
            if (to) inv = inv.filter(s => s.date <= to);
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const invNo = s.invoiceNo || 'SVC-' + String(s.id).slice(-6);
                totalAll += s.total || 0; paidAll += s.paid || 0; remAll += s.remaining || 0;
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                let actions = `<button onclick="viewServiceInvoice(${s.id})" class="text-blue-500 text-xs me-1" title="عرض"><i class="fas fa-eye"></i></button>`;
                if ((s.remaining || 0) > 0) {
                    actions += `<button onclick="payPartialInvoice('services',${s.id})" class="text-amber-500 text-xs me-1" title="دفع جزئي"><i class="fas fa-money-bill"></i></button>`;
                    actions += `<button onclick="closeInvoice('services',${s.id})" class="text-emerald-500 text-xs" title="إقفال كامل"><i class="fas fa-check-circle"></i></button>`;
                }
                return `<tr class="hover:bg-teal-50"><td class="p-2 font-mono text-teal-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${actions}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد فواتير</td></tr>';
            _el('inv-svc-count', inv.length); _el('inv-svc-total', totalAll.toFixed(2)); _el('inv-svc-paid', paidAll.toFixed(2)); _el('inv-svc-rem', remAll.toFixed(2));
        }

        // -- Installment Invoices with stats + actions --
        function renderInvInstallments() {
            const tbody = document.getElementById('inv-inst-body'); if (!tbody) return;
            if (!db.installmentInvoices) db.installmentInvoices = [];
            const inv = [...db.installmentInvoices].reverse();
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const paid = (s.schedule || []).filter(p => p.paid).reduce((a, b) => a + b.amount, 0);
                const rem = (s.total || 0) - paid;
                totalAll += s.total || 0; paidAll += paid; remAll += rem;
                const status = rem <= 0 ? '<span class="text-emerald-600">مكتمل</span>' : '<span class="text-amber-600">جاري</span>';
                let actions = `<button onclick="viewInstInvoice(${s.id})" class="text-blue-500 text-xs me-1" title="عرض"><i class="fas fa-eye"></i></button>`;
                if (rem > 0) actions += `<button onclick="payPartialInvoice('installments',${s.id})" class="text-amber-500 text-xs" title="دفع قسط"><i class="fas fa-money-bill"></i></button>`;
                return `<tr class="hover:bg-indigo-50"><td class="p-2 font-mono text-indigo-600">${s.invoiceNo || '-'}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2">${(s.downPayment || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${paid.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${rem.toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${actions}</td></tr>`;
            }).join('') : '<tr><td colspan="9" class="p-4 text-center text-slate-400">لا توجد فواتير</td></tr>';
            _el('inv-inst-count', inv.length); _el('inv-inst-total', totalAll.toFixed(2)); _el('inv-inst-paid', paidAll.toFixed(2)); _el('inv-inst-rem', remAll.toFixed(2));
        }

        // ===== PARTIAL PAY (Universal for all invoice types) =====
        function payPartialInvoice(source, id) {
            let inv;
            if (source === 'sales') inv = (db.sales || []).find(x => x.id == id);
            else if (source === 'purchases') inv = (db.purchases || []).find(x => x.id == id);
            else if (source === 'services') inv = (db.serviceInvoices || []).find(x => x.id == id);
            else if (source === 'installments') {
                inv = (db.installmentInvoices || []).find(x => x.id == id);
                if (inv) { payInstallmentPartial(inv); return; }
            }
            if (!inv) return showToast('لم يتم العثور على الفاتورة', 'error');
            const remaining = (inv.total || 0) - (inv.paid || 0);
            const val = prompt(`المتبقي: ${remaining.toFixed(2)}\nأدخل المبلغ المراد تسديده:`);
            if (val === null) return;
            const amount = parseFloat(val);
            if (isNaN(amount) || amount <= 0) return showToast('مبلغ غير صحيح', 'error');
            if (amount > remaining + 0.01) return showToast('المبلغ أكبر من المتبقي', 'error');
            inv.paid = (inv.paid || 0) + amount;
            inv.remaining = (inv.total || 0) - inv.paid;
            if (inv.remaining < 0.01) inv.remaining = 0;
            const date = new Date().toISOString().split('T')[0];
            if (source === 'purchases') {
                addJournalEntry(date, `سداد فاتورة مشتريات #${inv.invoiceNo || inv.id}`, [{ code: '2101', dr: amount, cr: 0 }, { code: '1101', dr: 0, cr: amount }]);
            } else {
                addJournalEntry(date, `تحصيل فاتورة #${inv.invoiceNo || inv.id}`, [{ code: '1101', dr: amount, cr: 0 }, { code: '1201', dr: 0, cr: amount }]);
            }
            showToast(`تم تسجيل دفعة ${amount.toFixed(2)} ✅`); save();
            if (source === 'sales') renderInvSales();
            else if (source === 'purchases') renderInvPurchases();
            else if (source === 'services') renderInvServices();
            renderCustStatementFull(); renderSuppStatementFull();
        }

        // ===== Pay installment partial =====
        function payInstallmentPartial(inv) {
            const next = (inv.schedule || []).find(p => !p.paid);
            if (!next) return showToast('كل الأقساط مدفوعة', 'error');
            if (confirm(`هل تريد تسجيل دفع القسط #${(inv.schedule || []).indexOf(next) + 1} بمبلغ ${next.amount.toFixed(2)}؟`)) {
                next.paid = true;
                next.paidDate = new Date().toISOString().split('T')[0];
                addJournalEntry(next.paidDate, `تحصيل قسط #${(inv.schedule || []).indexOf(next) + 1} - ${inv.customer}`, [{ code: '1101', dr: next.amount, cr: 0 }, { code: '1201', dr: 0, cr: next.amount }]);
                showToast('تم تسجيل القسط ✅'); save();
                renderInvInstallments(); renderCustStatementFull();
            }
        }

        // ===== CLOSE INVOICE (Mark as fully paid) =====
        function closeInvoice(source, id) {
            let inv;
            if (source === 'sales') inv = (db.sales || []).find(x => x.id == id);
            else if (source === 'purchases') inv = (db.purchases || []).find(x => x.id == id);
            else if (source === 'services') inv = (db.serviceInvoices || []).find(x => x.id == id);
            if (!inv) return showToast('لم يتم العثور على الفاتورة', 'error');
            const remaining = (inv.total || 0) - (inv.paid || 0);
            if (remaining <= 0) return showToast('الفاتورة مقفلة بالفعل');
            if (!confirm(`إقفال الفاتورة وتسجيل المبلغ المتبقي ${remaining.toFixed(2)} في الخزينة؟`)) return;
            inv.paid = inv.total;
            inv.remaining = 0;
            const date = new Date().toISOString().split('T')[0];
            if (source === 'purchases') {
                addJournalEntry(date, `إقفال فاتورة مشتريات #${inv.invoiceNo || inv.id}`, [{ code: '2101', dr: remaining, cr: 0 }, { code: '1101', dr: 0, cr: remaining }]);
            } else {
                addJournalEntry(date, `إقفال فاتورة #${inv.invoiceNo || inv.id} - ${inv.customer || ''}`, [{ code: '1101', dr: remaining, cr: 0 }, { code: '1201', dr: 0, cr: remaining }]);
            }
            showToast('تم إقفال الفاتورة ✅'); save();
            if (source === 'sales') renderInvSales();
            else if (source === 'purchases') renderInvPurchases();
            else if (source === 'services') renderInvServices();
            renderCustStatementFull(); renderSuppStatementFull();
        }

        // ===== View Invoice Full (with print/PDF) =====
        function viewSaleInvoice(id) {
            const s = (db.sales || []).find(x => x.id == id); if (!s) return;
            const invNo = s.invoiceNo || 'INV-' + String(s.id).slice(-6);
            const items = (s.items || []).map(it => ({ name: it.name, qty: it.qty || 1, price: it.price || 0, total: (it.total || it.price || 0) }));
            openInvoiceWindow(s.type === 'pos' ? 'إيصال نقطة بيع' : 'فاتورة مبيعات', invNo, s.date, { label: 'العميل', name: s.customer }, items,
                `${(s.discount || 0) > 0 ? `<div class="row"><span>الخصم:</span><span style="color:#dc2626">-${s.discount.toFixed(2)}</span></div>` : ''}<div class="row"><span>المدفوع:</span><span style="color:#059669">${(s.paid || 0).toFixed(2)}</span></div>${(s.remaining || 0) > 0 ? `<div class="row"><span>المتبقي:</span><span style="color:#dc2626">${s.remaining.toFixed(2)}</span></div>` : ''}<div class="row grand"><span>الإجمالي:</span><span>${(s.total || 0).toFixed(2)}</span></div>`);
        }
        function viewPurchaseInvoice(id) {
            const s = (db.purchases || []).find(x => x.id == id); if (!s) return;
            const invNo = s.invoiceNo || 'PUR-' + String(s.id).slice(-6);
            openInvoiceWindow('فاتورة مشتريات', invNo, s.date, { label: 'المورد', name: s.supplier }, s.items || [],
                `${(s.discount || 0) > 0 ? `<div class="row"><span>الخصم:</span><span style="color:#dc2626">-${s.discount.toFixed(2)}</span></div>` : ''}<div class="row"><span>المدفوع:</span><span style="color:#059669">${(s.paid || 0).toFixed(2)}</span></div>${(s.remaining || 0) > 0 ? `<div class="row"><span>المتبقي:</span><span style="color:#dc2626">${s.remaining.toFixed(2)}</span></div>` : ''}<div class="row grand"><span>الإجمالي:</span><span>${(s.total || 0).toFixed(2)}</span></div>`);
        }
        function viewServiceInvoice(id) {
            const s = (db.serviceInvoices || []).find(x => x.id == id); if (!s) return;
            openInvoiceWindow('فاتورة خدمات', s.invoiceNo || 'SVC-' + s.id, s.date, { label: 'العميل', name: s.customer }, s.items || [],
                `<div class="row"><span>المدفوع:</span><span style="color:#059669">${(s.paid || 0).toFixed(2)}</span></div>${(s.remaining || 0) > 0 ? `<div class="row"><span>المتبقي:</span><span style="color:#dc2626">${(s.remaining || 0).toFixed(2)}</span></div>` : ''}<div class="row grand"><span>الإجمالي:</span><span>${(s.total || 0).toFixed(2)}</span></div>`);
        }
        function viewInstInvoice(id) {
            const s = (db.installmentInvoices || []).find(x => x.id == id); if (!s) return;
            const schedHTML = (s.schedule || []).map((p, i) => `<tr><td>${i + 1}</td><td>${p.dueDate}</td><td>${p.amount.toFixed(2)}</td><td>${p.paid ? '✅ مدفوع' : '⏳ قادم'}</td></tr>`).join('');
            openInvoiceWindow('فاتورة تقسيط', s.invoiceNo, s.date, { label: 'العميل', name: s.customer }, s.items || [],
                `<div class="row grand"><span>الإجمالي:</span><span>${(s.total || 0).toFixed(2)}</span></div>
                <table style="margin-top:15px"><thead><tr><th>#</th><th>تاريخ الاستحقاق</th><th>المبلغ</th><th>الحالة</th></tr></thead><tbody>${schedHTML}</tbody></table>`);
        }

        // Dashboard
        function renderInvoicesDashboard() {
            _el('inv-count-pos', (db.sales || []).filter(s => s.type === 'pos').length);
            _el('inv-count-sales', (db.sales || []).length);
            _el('inv-count-pur', (db.purchases || []).length);
            _el('inv-count-svc', (db.serviceInvoices || []).length);
        }

        // ===== CUSTOMER STATEMENT (Full - All Invoices) =====
        function renderCustStatementFull() {
            const tbody = document.getElementById('cust-stmt-body'); if (!tbody) return;
            const filterCust = document.getElementById('cust-stmt-filter')?.value || '';
            const from = document.getElementById('cust-stmt-from')?.value;
            const to = document.getElementById('cust-stmt-to')?.value;
            // Populate customer dropdown
            const sel = document.getElementById('cust-stmt-filter');
            if (sel && sel.options.length <= 1) {
                const names = new Set();
                (db.sales || []).forEach(s => names.add(s.customer));
                (db.serviceInvoices || []).forEach(s => names.add(s.customer));
                (db.installmentInvoices || []).forEach(s => names.add(s.customer));
                (db.customers || []).forEach(c => names.add(c.name));
                [...names].sort().forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; sel.appendChild(o); });
            }
            // Aggregate all customer invoices
            let rows = [];
            (db.sales || []).forEach(s => rows.push({ src: 'sales', type: 'مبيعات', id: s.id, customer: s.customer, invNo: s.invoiceNo || 'INV-' + String(s.id).slice(-4), date: s.date, total: s.total || 0, paid: s.paid || 0, remaining: s.remaining || 0 }));
            (db.serviceInvoices || []).forEach(s => rows.push({ src: 'services', type: 'خدمات', id: s.id, customer: s.customer, invNo: s.invoiceNo || 'SVC-' + String(s.id).slice(-4), date: s.date, total: s.total || 0, paid: s.paid || 0, remaining: s.remaining || 0 }));
            (db.installmentInvoices || []).forEach(s => {
                const paid = (s.schedule || []).filter(p => p.paid).reduce((a, b) => a + b.amount, 0);
                rows.push({ src: 'installments', type: 'تقسيط', id: s.id, customer: s.customer, invNo: s.invoiceNo || 'INST-' + String(s.id).slice(-4), date: s.date, total: s.total || 0, paid: paid, remaining: (s.total || 0) - paid });
            });
            if (filterCust) rows = rows.filter(r => r.customer === filterCust);
            if (from) rows = rows.filter(r => r.date >= from);
            if (to) rows = rows.filter(r => r.date <= to);
            rows.sort((a, b) => b.date.localeCompare(a.date));
            let totalAll = 0, paidAll = 0, remAll = 0;
            const typeColors = { مبيعات: 'bg-blue-100 text-blue-700', خدمات: 'bg-teal-100 text-teal-700', تقسيط: 'bg-indigo-100 text-indigo-700' };
            tbody.innerHTML = rows.length ? rows.map(r => {
                totalAll += r.total; paidAll += r.paid; remAll += r.remaining;
                const status = r.remaining > 0 ? '<span class="text-red-600 font-bold">مستحق</span>' : '<span class="text-emerald-600">تم السداد</span>';
                const viewFn = r.src === 'sales' ? `viewSaleInvoice(${r.id})` : r.src === 'services' ? `viewServiceInvoice(${r.id})` : `viewInstInvoice(${r.id})`;
                const editBtn = r.remaining > 0 ? `<button onclick="editInvoicePaid('${r.src}',${r.id})" class="text-amber-500 text-xs me-1" title="تعديل المدفوع"><i class="fas fa-edit"></i></button>` : '';
                return `<tr class="hover:bg-blue-50"><td class="p-2 font-bold">${r.customer}</td><td class="p-2"><span class="px-2 py-0.5 rounded text-xs ${typeColors[r.type] || ''}">${r.type}</span></td><td class="p-2 font-mono text-blue-600">${r.invNo}</td><td class="p-2">${r.date}</td><td class="p-2 font-bold">${r.total.toFixed(2)}</td><td class="p-2 text-emerald-600">${r.paid.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${r.remaining.toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${editBtn}<button onclick="${viewFn}" class="text-blue-500 text-xs"><i class="fas fa-eye"></i></button></td></tr>`;
            }).join('') : '<tr><td colspan="9" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('cust-stmt-count', rows.length); _el('cust-stmt-total', totalAll.toFixed(2)); _el('cust-stmt-paid', paidAll.toFixed(2)); _el('cust-stmt-remaining', remAll.toFixed(2));
        }

        // ===== SUPPLIER STATEMENT (Full - All Invoices) =====
        function renderSuppStatementFull() {
            const tbody = document.getElementById('supp-stmt-body'); if (!tbody) return;
            const filterSupp = document.getElementById('supp-stmt-filter')?.value || '';
            const from = document.getElementById('supp-stmt-from')?.value;
            const to = document.getElementById('supp-stmt-to')?.value;
            // Populate supplier dropdown
            const sel = document.getElementById('supp-stmt-filter');
            if (sel && sel.options.length <= 1) {
                const names = new Set();
                (db.purchases || []).forEach(s => names.add(s.supplier));
                (db.suppliers || []).forEach(c => names.add(c.name));
                [...names].sort().forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; sel.appendChild(o); });
            }
            let rows = [];
            (db.purchases || []).forEach(s => rows.push({ src: 'purchases', id: s.id, supplier: s.supplier, invNo: s.invoiceNo || 'PUR-' + String(s.id).slice(-4), date: s.date, total: s.total || 0, paid: s.paid || 0, remaining: s.remaining || 0 }));
            if (filterSupp) rows = rows.filter(r => r.supplier === filterSupp);
            if (from) rows = rows.filter(r => r.date >= from);
            if (to) rows = rows.filter(r => r.date <= to);
            rows.sort((a, b) => b.date.localeCompare(a.date));
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = rows.length ? rows.map(r => {
                totalAll += r.total; paidAll += r.paid; remAll += r.remaining;
                const status = r.remaining > 0 ? '<span class="text-red-600 font-bold">مستحق</span>' : '<span class="text-emerald-600">تم السداد</span>';
                const editBtn = r.remaining > 0 ? `<button onclick="editInvoicePaid('purchases',${r.id})" class="text-amber-500 text-xs me-1" title="تعديل المدفوع"><i class="fas fa-edit"></i></button>` : '';
                return `<tr class="hover:bg-orange-50"><td class="p-2 font-bold">${r.supplier}</td><td class="p-2 font-mono text-orange-600">${r.invNo}</td><td class="p-2">${r.date}</td><td class="p-2 font-bold">${r.total.toFixed(2)}</td><td class="p-2 text-emerald-600">${r.paid.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${r.remaining.toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${editBtn}<button onclick="viewPurchaseInvoice(${r.id})" class="text-blue-500 text-xs"><i class="fas fa-eye"></i></button></td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('supp-stmt-count', rows.length); _el('supp-stmt-total', totalAll.toFixed(2)); _el('supp-stmt-paid', paidAll.toFixed(2)); _el('supp-stmt-remaining', remAll.toFixed(2));
        }

        // ===== EDIT INVOICE PAID (Universal) =====
        function editInvoicePaid(source, id) {
            let inv, arr;
            if (source === 'sales') { arr = db.sales || []; inv = arr.find(x => x.id == id); }
            else if (source === 'purchases') { arr = db.purchases || []; inv = arr.find(x => x.id == id); }
            else if (source === 'services') { arr = db.serviceInvoices || []; inv = arr.find(x => x.id == id); }
            else if (source === 'installments') { showToast('التقسيط يُعدَّل من صفحة التقسيط', 'error'); return; }
            if (!inv) return showToast('لم يتم العثور على الفاتورة', 'error');
            const remaining = (inv.total || 0) - (inv.paid || 0);
            const val = prompt(`المتبقي: ${remaining.toFixed(2)}\nأدخل المبلغ المراد تسديده:`);
            if (val === null) return;
            const amount = parseFloat(val);
            if (isNaN(amount) || amount <= 0) return showToast('مبلغ غير صحيح', 'error');
            if (amount > remaining + 0.01) return showToast('المبلغ أكبر من المتبقي', 'error');
            inv.paid = (inv.paid || 0) + amount;
            inv.remaining = (inv.total || 0) - inv.paid;
            if (inv.remaining < 0.01) inv.remaining = 0;
            // Journal entry for payment
            const date = new Date().toISOString().split('T')[0];
            const desc = source === 'purchases' ? `سداد فاتورة مشتريات: ${inv.supplier || ''} #${inv.invoiceNo || inv.id}` : `تحصيل فاتورة: ${inv.customer || ''} #${inv.invoiceNo || inv.id}`;
            if (source === 'purchases') { addJournalEntry(date, desc, [{ code: '2101', dr: amount, cr: 0 }, { code: '1101', dr: 0, cr: amount }]); }
            else { addJournalEntry(date, desc, [{ code: '1101', dr: amount, cr: 0 }, { code: '1201', dr: 0, cr: amount }]); }
            showToast('تم تسجيل الدفعة ✅'); save();
            renderCustStatementFull(); renderSuppStatementFull();
        }

        // ===== SERVICE STATEMENT =====
        function renderSvcStatement() {
            const tbody = document.getElementById('svc-stmt-body'); if (!tbody) return;
            const inv = (db.serviceInvoices || []).filter(s => (s.remaining || 0) > 0);
            tbody.innerHTML = inv.length ? inv.map(s => {
                return `<tr class="hover:bg-teal-50"><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-mono text-teal-600">${s.invoiceNo || '-'}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(s.remaining || 0).toFixed(2)}</td><td class="p-2"><button onclick="viewServiceInvoice(${s.id})" class="text-blue-500"><i class="fas fa-eye"></i></button></td></tr>`;
            }).join('') : '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد حسابات آجلة</td></tr>';
        }

        // ===== INSTALLMENT COLLECTION =====
        function renderInstCollection() {
            const tbody = document.getElementById('inst-collect-body'); if (!tbody) return;
            const inv = db.installmentInvoices || [];
            tbody.innerHTML = inv.length ? inv.map(s => {
                const cust = (db.installmentCustomers || []).find(c => c.name === s.customer) || {};
                const paid = (s.schedule || []).filter(p => p.paid).reduce((a, b) => a + b.amount, 0);
                const rem = (s.total || 0) - paid;
                const next = (s.schedule || []).find(p => !p.paid);
                return `<tr class="hover:bg-indigo-50"><td class="p-2 font-bold">${s.customer}</td><td class="p-2">${cust.phone || '-'}</td><td class="p-2 font-mono text-indigo-600">${s.invoiceNo || '-'}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2">${(s.schedule || []).length}</td><td class="p-2 text-emerald-600">${paid.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${rem.toFixed(2)}</td><td class="p-2 text-amber-600">${next ? next.dueDate : '-'}</td><td class="p-2"><button onclick="viewInstInvoice(${s.id})" class="text-blue-500"><i class="fas fa-eye"></i></button></td></tr>`;
            }).join('') : '<tr><td colspan="9" class="p-4 text-center text-slate-400">لا توجد عقود تقسيط</td></tr>';
        }

        // ===== EXPENSE VOUCHERS =====
        function renderExpenseVouchers() {
            const tbody = document.getElementById('exp-voucher-body'); if (!tbody) return;
            const from = document.getElementById('exp-voucher-from')?.value;
            const to = document.getElementById('exp-voucher-to')?.value;
            let exps = db.expenses || [];
            if (from) exps = exps.filter(e => e.date >= from);
            if (to) exps = exps.filter(e => e.date <= to);
            let total = 0;
            tbody.innerHTML = exps.length ? exps.map((e, i) => {
                total += e.amount || 0;
                return `<tr class="hover:bg-red-50"><td class="p-2">${i + 1}</td><td class="p-2">${e.date}</td><td class="p-2 font-bold">${e.desc || e.description || '-'}</td><td class="p-2">${e.category || '-'}</td><td class="p-2 font-bold text-red-600">${(e.amount || 0).toFixed(2)}</td><td class="p-2">${e.method === '1101' ? 'نقدي' : e.method === '1102' ? 'بنك' : (e.method || 'نقدي')}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد سندات صرف</td></tr>';
            const el = document.getElementById('exp-voucher-total'); if (el) el.textContent = total.toFixed(2);
        }

        // ===== HR EMPLOYEE MANAGEMENT =====
        function saveHREmployee(e) {
            e.preventDefault();
            const id = document.getElementById('hr-emp-id').value;
            const emp = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('hr-emp-name').value,
                phone: document.getElementById('hr-emp-phone').value,
                position: document.getElementById('hr-emp-position').value,
                salary: parseFloat(document.getElementById('hr-emp-salary').value) || 0,
                hireDate: document.getElementById('hr-emp-hiredate').value,
                status: 'active'
            };
            if (!db.employees) db.employees = [];
            if (id) { const idx = db.employees.findIndex(x => x.id == id); if (idx >= 0) db.employees[idx] = { ...db.employees[idx], ...emp }; }
            else { db.employees.push(emp); }
            showToast('تم حفظ الموظف ✅'); resetHREmployeeForm(); renderHREmployees(); save();
        }
        function resetHREmployeeForm() {
            ['hr-emp-id', 'hr-emp-name', 'hr-emp-phone', 'hr-emp-position', 'hr-emp-salary', 'hr-emp-hiredate'].forEach(id => { const e = document.getElementById(id); if (e) e.value = ''; });
        }
        function renderHREmployees() {
            const tbody = document.getElementById('hr-emp-body'); if (!tbody) return;
            const emps = db.employees || [];
            tbody.innerHTML = emps.length ? emps.map(e => `<tr class="hover:bg-blue-50"><td class="p-2 font-bold">${e.name}</td><td class="p-2">${e.position || '-'}</td><td class="p-2">${e.phone || '-'}</td><td class="p-2 font-bold">${(e.salary || 0).toFixed(2)}</td><td class="p-2">${e.hireDate || '-'}</td><td class="p-2"><button onclick="editHREmployee(${e.id})" class="text-blue-500 text-xs me-1"><i class="fas fa-edit"></i></button><button onclick="deleteHREmployee(${e.id})" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button></td></tr>`).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا يوجد موظفين</td></tr>';
        }
        function editHREmployee(id) {
            const e = (db.employees || []).find(x => x.id == id); if (!e) return;
            document.getElementById('hr-emp-id').value = e.id;
            document.getElementById('hr-emp-name').value = e.name;
            document.getElementById('hr-emp-phone').value = e.phone || '';
            document.getElementById('hr-emp-position').value = e.position || '';
            document.getElementById('hr-emp-salary').value = e.salary || '';
            document.getElementById('hr-emp-hiredate').value = e.hireDate || '';
        }
        function deleteHREmployee(id) {
            if (!confirm('حذف هذا الموظف؟')) return;
            db.employees = (db.employees || []).filter(e => e.id != id); renderHREmployees(); save();
        }

        // ===== HR ACTIONS =====
        function populateHRActionEmps() {
            const sel = document.getElementById('hr-action-emp'); if (!sel) return;
            sel.innerHTML = '<option value="">-- اختر --</option>' + (db.employees || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }
        function saveHRAction() {
            const empId = document.getElementById('hr-action-emp').value;
            const emp = (db.employees || []).find(e => e.id == empId);
            if (!empId || !emp) return showToast('اختر الموظف', 'error');
            if (!db.hrActions) db.hrActions = [];
            db.hrActions.push({
                id: Date.now(), date: new Date().toISOString().split('T')[0],
                empId, empName: emp.name,
                type: document.getElementById('hr-action-type').value,
                amount: parseFloat(document.getElementById('hr-action-amount').value) || 0,
                reason: document.getElementById('hr-action-reason').value
            });
            showToast('تم تسجيل الإجراء ✅'); renderHRActions(); save();
            document.getElementById('hr-action-amount').value = '';
            document.getElementById('hr-action-reason').value = '';
        }
        function renderHRActions() {
            const tbody = document.getElementById('hr-action-body'); if (!tbody) return;
            const acts = [...(db.hrActions || [])].reverse();
            const typeMap = { bonus: 'مكافأة', deduction: 'خصم', warning: 'إنذار', leave: 'إجازة', promotion: 'ترقية' };
            tbody.innerHTML = acts.length ? acts.map(a => `<tr class="hover:bg-amber-50"><td class="p-2">${a.date}</td><td class="p-2 font-bold">${a.empName}</td><td class="p-2">${typeMap[a.type] || a.type}</td><td class="p-2 ${a.type === 'deduction' ? 'text-red-600' : 'text-emerald-600'} font-bold">${a.amount > 0 ? a.amount.toFixed(2) : '-'}</td><td class="p-2">${a.reason || '-'}</td></tr>`).join('') : '<tr><td colspan="5" class="p-4 text-center text-slate-400">لا توجد إجراءات</td></tr>';
        }

        // ===== HR LIST =====
        function renderHRList() {
            const tbody = document.getElementById('hr-list-body'); if (!tbody) return;
            const emps = db.employees || [];
            tbody.innerHTML = emps.length ? emps.map((e, i) => `<tr class="hover:bg-blue-50"><td class="p-2">${i + 1}</td><td class="p-2 font-bold">${e.name}</td><td class="p-2">${e.position || '-'}</td><td class="p-2">${e.phone || '-'}</td><td class="p-2 font-bold">${(e.salary || 0).toFixed(2)}</td><td class="p-2">${e.hireDate || '-'}</td><td class="p-2"><span class="px-2 py-0.5 rounded text-xs ${e.status === 'active' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${e.status === 'active' ? 'نشط' : 'متوقف'}</span></td></tr>`).join('') : '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا يوجد موظفين</td></tr>';
        }

        // ===== PAYROLL =====
        function populatePayrollEmps() {
            const sel = document.getElementById('payroll-emp'); if (!sel) return;
            sel.innerHTML = '<option value="">-- اختر --</option>' + (db.employees || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }
        function loadPayrollSalary() {
            const empId = document.getElementById('payroll-emp').value;
            const emp = (db.employees || []).find(e => e.id == empId);
            if (emp) document.getElementById('payroll-basic').value = emp.salary || '';
            calcPayrollNet();
        }
        function calcPayrollNet() {
            const basic = parseFloat(document.getElementById('payroll-basic')?.value) || 0;
            const allow = parseFloat(document.getElementById('payroll-allowance')?.value) || 0;
            const ded = parseFloat(document.getElementById('payroll-deduction')?.value) || 0;
            const bonus = parseFloat(document.getElementById('payroll-bonus')?.value) || 0;
            const gross = basic + allow; const net = gross - ded + bonus;
            const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
            el('payroll-gross', gross.toFixed(2)); el('payroll-ded-show', ded.toFixed(2)); el('payroll-net', net.toFixed(2));
        }
        function processPayroll() {
            const empSel = document.getElementById('payroll-emp');
            const empName = empSel.options[empSel.selectedIndex]?.text;
            const empId = empSel.value;
            const month = document.getElementById('payroll-month').value;
            const basic = parseFloat(document.getElementById('payroll-basic').value) || 0;
            const allowance = parseFloat(document.getElementById('payroll-allowance').value) || 0;
            const deduction = parseFloat(document.getElementById('payroll-deduction').value) || 0;
            const bonus = parseFloat(document.getElementById('payroll-bonus').value) || 0;
            const method = document.getElementById('payroll-method').value;
            const notes = document.getElementById('payroll-notes').value;
            if (!empId || basic <= 0) return showToast('اختر الموظف وحدد الراتب', 'error');
            if (!month) return showToast('حدد الشهر', 'error');
            const net = basic + allowance - deduction + bonus;
            if (net <= 0) return showToast('الصافي يجب أن يكون أكبر من صفر', 'error');
            const date = new Date().toISOString().split('T')[0];
            const lines = [{ code: '5202', dr: net, cr: 0 }, { code: method, dr: 0, cr: net }];
            if (addJournalEntry(date, `صرف راتب: ${empName} - ${month}`, lines)) {
                if (!db.salaryHistory) db.salaryHistory = [];
                db.salaryHistory.push({ id: Date.now(), date, month, empId, empName, basic, allowance, deduction, bonus, net, method: method === '1101' ? 'نقدي' : 'بنك', notes });
                showToast('تم صرف الراتب ✅'); renderPayrollHistory(); save();
                document.getElementById('payroll-basic').value = '';
                document.getElementById('payroll-allowance').value = '0';
                document.getElementById('payroll-deduction').value = '0';
                document.getElementById('payroll-bonus').value = '0';
                document.getElementById('payroll-notes').value = '';
            }
        }
        function renderPayrollHistory() {
            const tbody = document.getElementById('payroll-body'); if (!tbody) return;
            const hist = [...(db.salaryHistory || [])].reverse();
            tbody.innerHTML = hist.length ? hist.map((h, i) => `<tr class="hover:bg-emerald-50"><td class="p-2">${hist.length - i}</td><td class="p-2">${h.date}</td><td class="p-2">${h.month}</td><td class="p-2 font-bold">${h.empName}</td><td class="p-2">${(h.basic || 0).toFixed(2)}</td><td class="p-2">${(h.allowance || 0).toFixed(2)}</td><td class="p-2 text-red-600">${(h.deduction || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(h.bonus || 0).toFixed(2)}</td><td class="p-2 font-bold text-yellow-600">${(h.net || 0).toFixed(2)}</td><td class="p-2">${h.method}</td><td class="p-2 text-xs">${h.notes || '-'}</td></tr>`).join('') : '<tr><td colspan="11" class="p-4 text-center text-slate-400">لا توجد رواتب مسجلة</td></tr>';
        }
        function filterPayrollByMonth() {
            const month = document.getElementById('payroll-filter-month')?.value || '';
            document.querySelectorAll('#payroll-body tr').forEach(r => {
                r.style.display = !month || r.innerText.includes(month) ? '' : 'none';
            });
        }
        function printLastPayroll() {
            if (!(db.salaryHistory || []).length) return showToast('لا توجد رواتب', 'error');
            const h = db.salaryHistory[db.salaryHistory.length - 1];
            const w = window.open('', 'payroll', 'width=500,height=600');
            w.document.write(`<html dir="rtl"><head><style>body{font-family:'Cairo',sans-serif;max-width:450px;margin:20px auto;padding:20px;font-size:13px}.row{display:flex;justify-content:space-between;margin-bottom:5px;padding:5px 0;border-bottom:1px dashed #ddd}.no-print{text-align:center;margin-top:20px}@media print{.no-print{display:none}}</style></head><body>
            <h2 style="text-align:center">إيصال صرف راتب</h2><p style="text-align:center;color:#666">${db.settings.companyName || ''}</p><hr>
            <div class="row"><span>الموظف:</span><strong>${h.empName}</strong></div>
            <div class="row"><span>الشهر:</span><span>${h.month}</span></div>
            <div class="row"><span>التاريخ:</span><span>${h.date}</span></div>
            <div class="row"><span>الأساسي:</span><span>${(h.basic || 0).toFixed(2)}</span></div>
            <div class="row"><span>البدلات:</span><span>${(h.allowance || 0).toFixed(2)}</span></div>
            <div class="row"><span>الخصومات:</span><span style="color:red">${(h.deduction || 0).toFixed(2)}</span></div>
            <div class="row"><span>الحوافز:</span><span style="color:green">${(h.bonus || 0).toFixed(2)}</span></div>
            <div class="row" style="border-top:2px solid #333;font-size:16px;font-weight:bold"><span>الصافي:</span><span style="color:#059669">${(h.net || 0).toFixed(2)}</span></div>
            <div class="row"><span>طريقة الصرف:</span><span>${h.method}</span></div>
            ${h.notes ? `<div class="row"><span>ملاحظات:</span><span>${h.notes}</span></div>` : ''}
            <div class="no-print"><button onclick="window.print()" style="padding:8px 25px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer">طباعة</button></div>
            </body></html>`);
            w.document.close();
        }

        // ===== REPORT UTILITY =====
        function _dtFilter(arr, fromId, toId) {
            const from = document.getElementById(fromId)?.value;
            const to = document.getElementById(toId)?.value;
            let r = arr;
            if (from) r = r.filter(x => x.date >= from);
            if (to) r = r.filter(x => x.date <= to);
            return r;
        }
        function _el(id, v) { const e = document.getElementById(id); if (e) e.textContent = v; }

        // ===== RPT: POS =====
        function renderRptPOS() {
            const data = _dtFilter(db.posInvoices || [], 'rpt-pos-from', 'rpt-pos-to');
            let total = 0, items = 0;
            const tbody = document.getElementById('rpt-pos-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map(s => {
                total += s.total || 0; items += (s.items || []).reduce((a, b) => a + (b.qty || 1), 0);
                return `<tr class="hover:bg-purple-50"><td class="p-2 font-mono text-purple-600">${s.invoiceNo || '-'}</td><td class="p-2">${s.date}</td><td class="p-2">${s.time || '-'}</td><td class="p-2">${(s.items || []).length}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="5" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-pos-count', data.length); _el('rpt-pos-total', total.toFixed(2)); _el('rpt-pos-items', items);
        }

        // ===== RPT: Sales =====
        function renderRptSales() {
            const data = _dtFilter(db.sales || [], 'rpt-sales-from', 'rpt-sales-to');
            let total = 0, paid = 0, rem = 0;
            const tbody = document.getElementById('rpt-sales-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map((s, i) => {
                total += s.total || 0; paid += s.paid || 0; rem += s.remaining || 0;
                const invNo = s.invoiceNo || 'INV-' + String(data.length - i).padStart(4, '0');
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                return `<tr class="hover:bg-blue-50"><td class="p-2 font-mono text-blue-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td></tr>`;
            }).join('') : '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-sales-count', data.length); _el('rpt-sales-total', total.toFixed(2)); _el('rpt-sales-paid', paid.toFixed(2)); _el('rpt-sales-remaining', rem.toFixed(2));
        }

        // ===== RPT: Customers =====
        function renderRptCustomers() {
            const tbody = document.getElementById('rpt-customers-body'); if (!tbody) return;
            const custs = db.customers || [];
            const sales = db.sales || [];
            let totalSales = 0, totalDue = 0;
            tbody.innerHTML = custs.length ? custs.map(c => {
                const custSales = sales.filter(s => s.customer === c.name);
                const t = custSales.reduce((a, s) => a + (s.total || 0), 0);
                const p = custSales.reduce((a, s) => a + (s.paid || 0), 0);
                const d = t - p; totalSales += t; totalDue += d;
                return `<tr class="hover:bg-indigo-50"><td class="p-2 font-bold">${c.name}</td><td class="p-2">${c.phone || '-'}</td><td class="p-2">${custSales.length}</td><td class="p-2 font-bold">${t.toFixed(2)}</td><td class="p-2 text-emerald-600">${p.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${d.toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-cust-count', custs.length); _el('rpt-cust-total-sales', totalSales.toFixed(2)); _el('rpt-cust-total-due', totalDue.toFixed(2));
        }

        // ===== RPT: Purchases =====
        function renderRptPurchases() {
            const data = _dtFilter(db.purchases || [], 'rpt-pur-from', 'rpt-pur-to');
            let total = 0, paid = 0, rem = 0;
            const tbody = document.getElementById('rpt-pur-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map((s, i) => {
                total += s.total || 0; paid += s.paid || 0; rem += s.remaining || 0;
                const invNo = s.invoiceNo || 'PUR-' + String(data.length - i).padStart(4, '0');
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600">مستحق</span>' : '<span class="text-emerald-600">مدفوع</span>';
                return `<tr class="hover:bg-orange-50"><td class="p-2 font-mono text-orange-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.supplier}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td></tr>`;
            }).join('') : '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-pur-count', data.length); _el('rpt-pur-total', total.toFixed(2)); _el('rpt-pur-paid', paid.toFixed(2)); _el('rpt-pur-remaining', rem.toFixed(2));
        }

        // ===== RPT: Suppliers =====
        function renderRptSuppliers() {
            const tbody = document.getElementById('rpt-supp-body'); if (!tbody) return;
            const supps = db.suppliers || [];
            const purs = db.purchases || [];
            let totalPur = 0, totalDue = 0;
            tbody.innerHTML = supps.length ? supps.map(c => {
                const ss = purs.filter(s => s.supplier === c.name);
                const t = ss.reduce((a, s) => a + (s.total || 0), 0);
                const p = ss.reduce((a, s) => a + (s.paid || 0), 0);
                const d = t - p; totalPur += t; totalDue += d;
                return `<tr class="hover:bg-amber-50"><td class="p-2 font-bold">${c.name}</td><td class="p-2">${c.phone || '-'}</td><td class="p-2">${ss.length}</td><td class="p-2 font-bold">${t.toFixed(2)}</td><td class="p-2 text-emerald-600">${p.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${d.toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-supp-count', supps.length); _el('rpt-supp-total-pur', totalPur.toFixed(2)); _el('rpt-supp-total-due', totalDue.toFixed(2));
        }

        // ===== RPT: Employees =====
        function renderRptEmployees() {
            const tbody = document.getElementById('rpt-emp-body'); if (!tbody) return;
            const emps = db.employees || [];
            const hist = db.salaryHistory || [];
            const acts = db.hrActions || [];
            let totalSalary = 0, totalPaid = 0;
            tbody.innerHTML = emps.length ? emps.map(e => {
                totalSalary += e.salary || 0;
                const empHist = hist.filter(h => h.empId == e.id);
                const empActs = acts.filter(a => a.empId == e.id);
                const paidTotal = empHist.reduce((a, h) => a + (h.net || 0), 0); totalPaid += paidTotal;
                return `<tr class="hover:bg-blue-50"><td class="p-2 font-bold">${e.name}</td><td class="p-2">${e.position || '-'}</td><td class="p-2 font-bold">${(e.salary || 0).toFixed(2)}</td><td class="p-2">${empHist.length}</td><td class="p-2 text-emerald-600">${paidTotal.toFixed(2)}</td><td class="p-2">${empActs.length}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-emp-count', emps.length); _el('rpt-emp-total-salary', totalSalary.toFixed(2)); _el('rpt-emp-total-paid', totalPaid.toFixed(2)); _el('rpt-emp-actions', acts.length);
        }

        // ===== RPT: Inventory =====
        function renderRptInventory() {
            const tbody = document.getElementById('rpt-inv-body'); if (!tbody) return;
            const prods = db.products || [];
            let totalStock = 0, totalValue = 0, lowCount = 0;
            tbody.innerHTML = prods.length ? prods.map(p => {
                const stock = p.stock || 0; const value = stock * (p.price || 0);
                totalStock += stock; totalValue += value; if (stock <= 5) lowCount++;
                const status = stock <= 0 ? '<span class="text-red-600 font-bold">نفد</span>' : stock <= 5 ? '<span class="text-amber-600 font-bold">منخفض</span>' : '<span class="text-emerald-600">متوفر</span>';
                return `<tr class="hover:bg-teal-50"><td class="p-2 font-mono">${p.barcode || p.code || '-'}</td><td class="p-2 font-bold">${p.name}</td><td class="p-2">${p.category || 'عام'}</td><td class="p-2 text-emerald-600">${(p.price || 0).toFixed(2)}</td><td class="p-2 text-slate-500">${(p.cost || 0).toFixed(2)}</td><td class="p-2 ${stock <= 5 ? 'text-red-600 font-bold' : ''}">${stock}</td><td class="p-2 font-bold">${value.toFixed(2)}</td><td class="p-2">${status}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-inv-count', prods.length); _el('rpt-inv-total-stock', totalStock); _el('rpt-inv-total-value', totalValue.toFixed(2)); _el('rpt-inv-low', lowCount);
        }

        // ===== RPT: Services =====
        function renderRptServices() {
            const data = _dtFilter(db.serviceInvoices || [], 'rpt-svc-from', 'rpt-svc-to');
            let total = 0, paid = 0, rem = 0;
            const tbody = document.getElementById('rpt-svc-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map(s => {
                total += s.total || 0; paid += s.paid || 0; rem += s.remaining || 0;
                return `<tr class="hover:bg-cyan-50"><td class="p-2 font-mono text-cyan-600">${s.invoiceNo || '-'}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600">${(s.remaining || 0).toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-svc-count', data.length); _el('rpt-svc-total', total.toFixed(2)); _el('rpt-svc-paid', paid.toFixed(2)); _el('rpt-svc-remaining', rem.toFixed(2));
        }

        // ===== RPT: Installments =====
        function renderRptInstallments() {
            const tbody = document.getElementById('rpt-inst-body'); if (!tbody) return;
            const inv = db.installmentInvoices || [];
            let totalAll = 0, collectedAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const paid = (s.schedule || []).filter(p => p.paid).reduce((a, b) => a + b.amount, 0);
                const rem = (s.total || 0) - paid; totalAll += s.total || 0; collectedAll += paid;
                const status = rem <= 0 ? '<span class="text-emerald-600">مكتمل</span>' : '<span class="text-amber-600">جاري</span>';
                return `<tr class="hover:bg-indigo-50"><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-mono text-indigo-600">${s.invoiceNo || '-'}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2">${(s.downPayment || 0).toFixed(2)}</td><td class="p-2">${(s.schedule || []).length}</td><td class="p-2 text-emerald-600">${paid.toFixed(2)}</td><td class="p-2 text-red-600">${rem.toFixed(2)}</td><td class="p-2">${status}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-inst-count', inv.length); _el('rpt-inst-total', totalAll.toFixed(2)); _el('rpt-inst-collected', collectedAll.toFixed(2)); _el('rpt-inst-pending', (totalAll - collectedAll).toFixed(2));
        }

        // ===== RPT: Installment Customers =====
        function renderRptInstCustomers() {
            const tbody = document.getElementById('rpt-instcust-body'); if (!tbody) return;
            const custs = db.installmentCustomers || [];
            const inv = db.installmentInvoices || [];
            tbody.innerHTML = custs.length ? custs.map(c => {
                const custInv = inv.filter(s => s.customer === c.name);
                const totalAmt = custInv.reduce((a, s) => a + (s.total || 0), 0);
                const collected = custInv.reduce((a, s) => a + (s.schedule || []).filter(p => p.paid).reduce((x, y) => x + y.amount, 0), 0);
                return `<tr class="hover:bg-violet-50"><td class="p-2 font-bold">${c.name}</td><td class="p-2">${c.phone || '-'}</td><td class="p-2">${c.address || '-'}</td><td class="p-2">${custInv.length}</td><td class="p-2 font-bold">${totalAmt.toFixed(2)}</td><td class="p-2 text-emerald-600">${collected.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(totalAmt - collected).toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
        }

        // ===== RPT: Expenses =====
        function renderRptExpenses() {
            const data = _dtFilter(db.expenses || [], 'rpt-exp-from', 'rpt-exp-to');
            let total = 0;
            const tbody = document.getElementById('rpt-exp-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map((e, i) => {
                total += e.amount || 0;
                return `<tr class="hover:bg-red-50"><td class="p-2">${i + 1}</td><td class="p-2">${e.date}</td><td class="p-2 font-bold">${e.desc || e.description || '-'}</td><td class="p-2">${e.category || '-'}</td><td class="p-2 font-bold text-red-600">${(e.amount || 0).toFixed(2)}</td><td class="p-2">${e.method === '1101' ? 'نقدي' : e.method === '1102' ? 'بنك' : (e.method || 'نقدي')}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-exp-total', total.toFixed(2)); _el('rpt-exp-count', data.length); _el('rpt-exp-avg', data.length ? (total / data.length).toFixed(2) : '0.00');
        }

        // ===== RPT: Revenue =====
        function renderRptRevenue() {
            const tbody = document.getElementById('rpt-rev-body'); if (!tbody) return;
            const from = document.getElementById('rpt-rev-from')?.value;
            const to = document.getElementById('rpt-rev-to')?.value;
            let rows = [];
            // Sales revenue
            (db.sales || []).forEach(s => { if ((!from || s.date >= from) && (!to || s.date <= to)) rows.push({ src: 'مبيعات', date: s.date, desc: s.customer + ' - ' + (s.invoiceNo || ''), amount: s.paid || s.total || 0 }); });
            // POS revenue
            (db.posInvoices || []).forEach(s => { if ((!from || s.date >= from) && (!to || s.date <= to)) rows.push({ src: 'POS', date: s.date, desc: s.invoiceNo || 'POS', amount: s.total || 0 }); });
            // Service revenue
            (db.serviceInvoices || []).forEach(s => { if ((!from || s.date >= from) && (!to || s.date <= to)) rows.push({ src: 'خدمات', date: s.date, desc: s.customer + ' - ' + (s.invoiceNo || ''), amount: s.paid || s.total || 0 }); });
            rows.sort((a, b) => b.date.localeCompare(a.date));
            const salesRev = rows.filter(r => r.src === 'مبيعات').reduce((a, r) => a + r.amount, 0);
            const posRev = rows.filter(r => r.src === 'POS').reduce((a, r) => a + r.amount, 0);
            const svcRev = rows.filter(r => r.src === 'خدمات').reduce((a, r) => a + r.amount, 0);
            const totalRev = salesRev + posRev + svcRev;
            tbody.innerHTML = rows.length ? rows.map(r => `<tr class="hover:bg-yellow-50"><td class="p-2">${r.src}</td><td class="p-2">${r.date}</td><td class="p-2">${r.desc}</td><td class="p-2 font-bold text-emerald-600">${r.amount.toFixed(2)}</td></tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-rev-sales', salesRev.toFixed(2)); _el('rpt-rev-pos', posRev.toFixed(2)); _el('rpt-rev-svc', svcRev.toFixed(2)); _el('rpt-rev-total', totalRev.toFixed(2));
        }

        // ===== RPT: Treasury =====
        function renderRptTreasury() {
            const tbody = document.getElementById('rpt-treasury-body'); if (!tbody) return;
            const journal = db.journal || [];
            let totalIn = 0, totalOut = 0, balance = 0;
            const cashEntries = journal.filter(j => (j.lines || []).some(l => l.code === '1101' || l.code === '1102'));
            tbody.innerHTML = cashEntries.length ? cashEntries.map(j => {
                let dr = 0, cr = 0;
                (j.lines || []).forEach(l => { if (l.code === '1101' || l.code === '1102') { dr += l.dr || 0; cr += l.cr || 0; } });
                totalIn += dr; totalOut += cr; balance += dr - cr;
                return `<tr class="hover:bg-slate-50"><td class="p-2">${j.date}</td><td class="p-2">${j.desc || '-'}</td><td class="p-2 text-emerald-600 font-bold">${dr > 0 ? dr.toFixed(2) : '-'}</td><td class="p-2 text-red-600 font-bold">${cr > 0 ? cr.toFixed(2) : '-'}</td><td class="p-2 font-bold">${balance.toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="5" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            // Calc cash vs bank
            let cash = 0, bank = 0;
            journal.forEach(j => (j.lines || []).forEach(l => { if (l.code === '1101') { cash += (l.dr || 0) - (l.cr || 0); } if (l.code === '1102') { bank += (l.dr || 0) - (l.cr || 0); } }));
            _el('rpt-trs-in', totalIn.toFixed(2)); _el('rpt-trs-out', totalOut.toFixed(2)); _el('rpt-trs-cash', cash.toFixed(2)); _el('rpt-trs-bank', bank.toFixed(2));
        }

        // ===== RPT: Profits =====
        function renderRptProfits() {
            const from = document.getElementById('rpt-profit-from')?.value;
            const to = document.getElementById('rpt-profit-to')?.value;
            const df = (arr) => { let r = arr; if (from) r = r.filter(x => x.date >= from); if (to) r = r.filter(x => x.date <= to); return r; };
            // Revenue
            const salesRev = df(db.sales || []).reduce((a, s) => a + (s.paid || s.total || 0), 0);
            const posRev = df(db.posInvoices || []).reduce((a, s) => a + (s.total || 0), 0);
            const svcRev = df(db.serviceInvoices || []).reduce((a, s) => a + (s.paid || s.total || 0), 0);
            const totalRevenue = salesRev + posRev + svcRev;
            // COGS
            let cogs = 0;
            df(db.sales || []).forEach(s => (s.items || []).forEach(it => { const p = (db.products || []).find(x => x.name === it.name); cogs += (p?.cost || 0) * (it.qty || 1); }));
            df(db.posInvoices || []).forEach(s => (s.items || []).forEach(it => { const p = (db.products || []).find(x => x.name === it.name); cogs += (p?.cost || 0) * (it.qty || 1); }));
            // Expenses
            const expTotal = df(db.expenses || []).reduce((a, e) => a + (e.amount || 0), 0);
            const salaryTotal = df(db.salaryHistory || []).reduce((a, h) => a + (h.net || 0), 0);
            const totalExpenses = expTotal + salaryTotal;
            // Net
            const netProfit = totalRevenue - cogs - totalExpenses;
            _el('rpt-pft-revenue', totalRevenue.toFixed(2));
            _el('rpt-pft-cost', cogs.toFixed(2));
            _el('rpt-pft-expenses', totalExpenses.toFixed(2));
            const netEl = document.getElementById('rpt-pft-net');
            const labelEl = document.getElementById('rpt-pft-label');
            if (netEl) { netEl.textContent = Math.abs(netProfit).toFixed(2); netEl.style.color = netProfit >= 0 ? '#15803d' : '#dc2626'; }
            if (labelEl) { labelEl.textContent = netProfit >= 0 ? 'صافي الربح ✅' : 'صافي الخسارة ❌'; labelEl.style.color = netProfit >= 0 ? '#15803d' : '#dc2626'; }
            // Details
            const revDet = document.getElementById('rpt-pft-rev-details');
            if (revDet) revDet.innerHTML = `<div class="flex justify-between"><span>مبيعات:</span><span class="font-bold">${salesRev.toFixed(2)}</span></div><div class="flex justify-between"><span>POS:</span><span class="font-bold">${posRev.toFixed(2)}</span></div><div class="flex justify-between"><span>خدمات:</span><span class="font-bold">${svcRev.toFixed(2)}</span></div>`;
            const costDet = document.getElementById('rpt-pft-cost-details');
            if (costDet) costDet.innerHTML = `<div class="flex justify-between"><span>تكلفة البضاعة:</span><span class="font-bold text-red-600">${cogs.toFixed(2)}</span></div>`;
            const expDet = document.getElementById('rpt-pft-exp-details');
            if (expDet) expDet.innerHTML = `<div class="flex justify-between"><span>المصروفات:</span><span class="font-bold">${expTotal.toFixed(2)}</span></div><div class="flex justify-between"><span>الرواتب:</span><span class="font-bold">${salaryTotal.toFixed(2)}</span></div>`;
        }

    </script>
</body>

</html>