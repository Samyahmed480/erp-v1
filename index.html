<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WEBMAX-ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }

        .currency {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
        }

        .section-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        /* Toast & Modal */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 300px;
            justify-content: center;
            font-size: 0.9rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(-10px);
        }

        .toast.success i {
            color: #34d399;
        }

        .toast.error i {
            color: #f87171;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            overflow-y: auto;
            padding: 40px 10px;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            width: 500px;
            transform: scale(0.9);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        /* Tree Indentation */
        .level-1 {
            font-weight: 800;
            background-color: #e2e8f0;
        }

        .level-2 {
            font-weight: 700;
            padding-right: 20px !important;
        }

        .level-3 {
            font-weight: 600;
            padding-right: 35px !important;
            color: #334155;
        }

        /* Simple Bar Chart */
        .chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            padding-top: 20px;
        }

        .chart-bar {
            width: 12%;
            background: #3b82f6;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.5s;
            min-height: 2px;
        }

        .chart-bar:hover {
            background: #2563eb;
        }

        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #64748b;
            width: 100%;
            text-align: center;
        }

        .chart-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #334155;
        }

        /* Print */
        @media print {
            body * {
                visibility: hidden;
            }

            #print-area,
            #print-area * {
                visibility: visible;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                min-height: 100%;
                background: white;
                padding: 0;
                direction: rtl;
                color: black;
            }

            .no-print {
                display: none !important;
            }
        }

        /* Combobox Styles */
        .pur-combobox-wrapper {
            position: relative;
            flex: 1;
        }

        .pur-combobox-wrapper input {
            width: 100%;
            padding: 10px 14px;
            padding-left: 36px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            outline: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .pur-combobox-wrapper input:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.12);
        }

        .pur-combobox-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
            font-size: 13px;
        }

        .pur-suggestions {
            position: absolute;
            top: 100%;
            right: 0;
            left: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 220px;
            overflow-y: auto;
            z-index: 60;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
            display: none;
        }

        .pur-suggestions.open {
            display: block;
        }

        .pur-suggestion-item {
            padding: 8px 14px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s;
            border-bottom: 1px solid #f1f5f9;
        }

        .pur-suggestion-item:last-child {
            border-bottom: none;
        }

        .pur-suggestion-item:hover,
        .pur-suggestion-item.active {
            background: #fff7ed;
        }

        .pur-suggestion-item .item-name {
            font-weight: 600;
            color: #1e293b;
        }

        .pur-suggestion-item .item-meta {
            font-size: 11px;
            color: #94a3b8;
        }

        .pur-suggestion-new {
            background: #fffbeb;
            color: #d97706;
            font-weight: 700;
            border-top: 2px solid #fde68a;
        }

        .pur-suggestion-new i {
            margin-left: 6px;
            color: #f59e0b;
        }

        .pur-suggestion-new:hover {
            background: #fef3c7;
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex overflow-hidden bg-slate-50">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">تسجيل الدخول</h2>
                <p class="text-slate-500 text-sm mt-1">WEBMAX-ERP</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">اسم المستخدم</label><input type="text"
                        id="login-user" class="w-full p-3 border rounded-lg focus:border-blue-500 outline-none"
                        placeholder="admin"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">كلمة المرور</label><input
                        type="password" id="login-pass"
                        class="w-full p-3 border rounded-lg focus:border-blue-500 outline-none" placeholder="123"></div>
                <button type="submit"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">دخول</button>
                <p id="login-error" class="text-red-500 text-xs text-center hidden"><i
                        class="fas fa-exclamation-circle"></i> بيانات الدخول غير صحيحة</p>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>
    <div id="print-area" class="hidden p-8"></div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity opacity-0"></div>

    <!-- Invoice Details Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-lg">تفاصيل الفاتورة</h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-red-500"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="invoice-modal-body" class="p-6"></div>
            <div class="p-4 border-t bg-slate-50 rounded-b-xl flex justify-end gap-2">
                <button onclick="printCurrentModalInvoice()"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"><i
                        class="fas fa-print"></i> طباعة</button>
                <button onclick="closeModal()"
                    class="bg-slate-200 text-slate-700 px-4 py-2 rounded hover:bg-slate-300">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- القائمة الجانبية -->
    <aside id="sidebar"
        class="fixed inset-y-0 right-0 z-40 w-72 bg-slate-900 text-white flex flex-col shadow-2xl transform translate-x-full md:translate-x-0 md:static md:w-64 transition-transform duration-300 no-print">
        <div class="p-6 border-b border-slate-700 flex flex-col items-center bg-slate-950">
            <div
                class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-2xl mb-3 shadow-lg overflow-hidden relative">
                <i class="fas fa-cubes text-white" id="default-logo-icon"></i>
                <img id="sidebar-logo-img" src="" class="w-full h-full object-cover hidden absolute inset-0">
            </div>
            <h1 class="text-lg font-bold text-white tracking-wide">نظام ERP المتكامل</h1>
            <span class="text-[10px] text-slate-400 mt-1 bg-slate-800 px-2 py-0.5 rounded-full">V10.0 Pro</span>
        </div>

        <nav class="flex-1 p-3 space-y-0.5 overflow-y-auto text-sm" id="sidebar-nav">
            <button onclick="showSection('dashboard')"
                class="nav-btn w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="dashboard">
                <i class="fas fa-chart-pie w-7 text-center"></i> لوحة القيادة</button>

            <!-- نقطة البيع -->
            <div class="sidebar-group" id="nav-pos">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-calculator w-7 text-center"></i> نقطة البيع</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('pos')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="pos"><i class="fas fa-cash-register w-5 text-center"></i> بدء البيع</button>
                    <button onclick="showSection('pos_products')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="pos_products"><i class="fas fa-box w-5 text-center"></i> المنتجات والأسعار</button>
                    <button onclick="showSection('barcode')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="barcode"><i class="fas fa-barcode w-5 text-center"></i> إصدار باركود</button>
                </div>
            </div>

            <!-- الفواتير -->
            <div class="sidebar-group" id="nav-invoices">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-file-invoice w-7 text-center"></i> الفواتير</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('invoices')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="invoices"><i class="fas fa-th-large w-5 text-center"></i> نظرة عامة</button>
                    <button onclick="showSection('inv_sales')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inv_sales"><i class="fas fa-file-alt w-5 text-center"></i> فواتير المبيعات</button>
                    <button onclick="showSection('inv_purchases')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inv_purchases"><i class="fas fa-file-import w-5 text-center"></i> فواتير
                        المشتريات</button>
                    <button onclick="showSection('inv_services')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inv_services"><i class="fas fa-file-medical w-5 text-center"></i> فواتير
                        الخدمات</button>
                    <button onclick="showSection('inv_quotations')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inv_quotations"><i class="fas fa-file-invoice w-5 text-center"></i> عروض
                        الأسعار</button>
                    <button onclick="showSection('inv_purchase_orders')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inv_purchase_orders"><i class="fas fa-file-signature w-5 text-center"></i> أوامر
                        الشراء</button>
                    <button onclick="showSection('inv_installments')"
                        class="w-full flex items-center gap-3 px-4 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all"
                        data-target="inv_installments"><i class="fas fa-file-invoice-dollar w-5 text-center"></i> فاتورة
                        التقسيط</button>
                </div>
            </div>

            <!-- المبيعات والعملاء -->
            <div class="sidebar-group" id="nav-sales">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-shopping-bag w-7 text-center"></i> المبيعات والعملاء</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('sales')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="sales"><i class="fas fa-cash-register w-5 text-center"></i> فاتورة مبيعات</button>
                    <button onclick="showSection('quotations')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="quotations"><i class="fas fa-file-invoice w-5 text-center"></i> عرض سعر</button>
                    <button onclick="showSection('customers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="customers"><i class="fas fa-users w-5 text-center"></i> العملاء</button>
                    <button onclick="showSection('cust_statement')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="cust_statement"><i class="fas fa-file-invoice-dollar w-5 text-center"></i> كشف حساب
                        العملاء</button>
                </div>
            </div>

            <!-- المشتريات والموردين -->
            <div class="sidebar-group" id="nav-purchases">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-shopping-cart w-7 text-center"></i> المشتريات والموردين</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('purchases')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="purchases"><i class="fas fa-shopping-cart w-5 text-center"></i> فاتورة
                        مشتريات</button>
                    <button onclick="showSection('purchase-orders')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="purchase-orders"><i class="fas fa-file-signature w-5 text-center"></i> أمر
                        شراء</button>
                    <button onclick="showSection('suppliers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="suppliers"><i class="fas fa-truck w-5 text-center"></i> الموردين</button>
                    <button onclick="showSection('supp_statement')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="supp_statement"><i class="fas fa-file-invoice w-5 text-center"></i> كشف حساب
                        الموردين</button>
                </div>
            </div>

            <!-- الخدمات -->
            <div class="sidebar-group" id="nav-services">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-tools w-7 text-center"></i> الخدمات</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('services')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="services"><i class="fas fa-tools w-5 text-center"></i> إنشاء فاتورة خدمة</button>
                    <button onclick="showSection('svc_statement')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="svc_statement"><i class="fas fa-file-alt w-5 text-center"></i> كشف حساب
                        الخدمات</button>
                </div>
            </div>

            <!-- المخزون -->
            <button onclick="showSection('inventory')" id="nav-inventory"
                class="nav-btn w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="inventory">
                <i class="fas fa-boxes w-7 text-center"></i> إدارة المخزون</button>

            <!-- التقسيط -->
            <div class="sidebar-group" id="nav-installments">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-calendar-alt w-7 text-center"></i> التقسيط</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('installments')"
                        class="w-full flex items-center gap-3 px-4 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all group"
                        data-target="installments"><i class="fas fa-file-invoice-dollar w-5 text-center"></i> فاتورة
                        التقسيط</button>
                    <button onclick="showSection('installment_customers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="installment_customers"><i class="fas fa-user-plus w-5 text-center"></i> عملاء
                        التقسيط</button>
                    <button onclick="showSection('inst_collection')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="inst_collection"><i class="fas fa-hand-holding-usd w-5 text-center"></i> الأقساط
                        والتحصيل</button>
                </div>
            </div>

            <!-- المصروفات -->
            <div class="sidebar-group" id="nav-expenses">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-money-bill-wave w-7 text-center"></i> المصروفات</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('expenses')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="expenses"><i class="fas fa-money-bill-wave w-5 text-center"></i> تسجيل
                        مصروف</button>
                    <button onclick="showSection('expense_vouchers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="expense_vouchers"><i class="fas fa-receipt w-5 text-center"></i> سندات
                        الصرف</button>
                </div>
            </div>

            <!-- سندات القبض -->
            <div class="sidebar-group" id="nav-incomes">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-hand-holding-usd w-7 text-center"></i> سندات القبض (الإيرادات)</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('incomes')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="incomes"><i class="fas fa-plus-circle w-5 text-center"></i> تسجيل إيراد / سند
                        قبض</button>
                    <button onclick="showSection('income_vouchers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="income_vouchers"><i class="fas fa-receipt w-5 text-center"></i> سجل سندات
                        القبض</button>
                </div>
            </div>

            <!-- الموارد البشرية -->
            <div class="sidebar-group" id="nav-hr">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-user-tie w-7 text-center"></i> الموارد البشرية</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('hr_list')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="hr_list"><i class="fas fa-user-tie w-5 text-center"></i> قائمة الموظفين</button>
                    <button onclick="showSection('hr_actions')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="hr_actions"><i class="fas fa-clipboard-list w-5 text-center"></i>
                        الإجراءات</button>
                    <button onclick="showSection('hr_payroll')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="hr_payroll"><i class="fas fa-money-check-alt w-5 text-center"></i> كشف
                        رواتب</button>
                    <button onclick="showSection('hr_emp_statement')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="hr_emp_statement"><i class="fas fa-file-invoice w-5 text-center"></i> كشف حساب
                        موظف</button>
                </div>
            </div>

            <div class="my-2 border-t border-slate-700"></div>

            <!-- المحاسبة -->
            <div class="sidebar-group" id="nav-accounting">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-book w-7 text-center"></i> المحاسبة</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('journal')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="journal"><i class="fas fa-book w-5 text-center"></i> القيود اليومية</button>
                    <button onclick="showSection('accounts_tree')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="accounts_tree"><i class="fas fa-sitemap w-5 text-center"></i> شجرة
                        الحسابات</button>
                </div>
            </div>

            <!-- التقارير -->
            <div class="sidebar-group" id="nav-reports">
                <button onclick="toggleSubMenu(this)"
                    class="w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 justify-between">
                    <span><i class="fas fa-chart-bar w-7 text-center"></i> التقارير</span>
                    <i class="fas fa-chevron-down text-[10px] text-slate-500 transition-transform submenu-arrow"></i>
                </button>
                <div class="submenu hidden pr-3 space-y-0.5 mt-0.5">
                    <button onclick="showSection('reports')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="reports"><i class="fas fa-th-large w-5 text-center"></i> نظرة عامة</button>
                    <button onclick="showSection('rpt_pos')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_pos"><i class="fas fa-cash-register w-5 text-center"></i> نقاط البيع</button>
                    <button onclick="showSection('rpt_sales')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_sales"><i class="fas fa-chart-line w-5 text-center"></i> المبيعات</button>
                    <button onclick="showSection('rpt_customers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_customers"><i class="fas fa-users w-5 text-center"></i> العملاء</button>
                    <button onclick="showSection('rpt_purchases')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_purchases"><i class="fas fa-shopping-cart w-5 text-center"></i>
                        المشتريات</button>
                    <button onclick="showSection('rpt_suppliers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_suppliers"><i class="fas fa-truck w-5 text-center"></i> الموردين</button>
                    <button onclick="showSection('rpt_employees')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_employees"><i class="fas fa-user-tie w-5 text-center"></i> الموظفين</button>
                    <button onclick="showSection('rpt_inventory')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_inventory"><i class="fas fa-boxes w-5 text-center"></i> المخزون</button>
                    <button onclick="showSection('rpt_services')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_services"><i class="fas fa-tools w-5 text-center"></i> الخدمات</button>
                    <button onclick="showSection('rpt_installments')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_installments"><i class="fas fa-calendar-alt w-5 text-center"></i>
                        التقسيط</button>
                    <button onclick="showSection('rpt_inst_customers')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_inst_customers"><i class="fas fa-user-tag w-5 text-center"></i> عملاء
                        التقسيط</button>
                    <button onclick="showSection('rpt_expenses')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_expenses"><i class="fas fa-money-bill-wave w-5 text-center"></i>
                        المصروفات</button>
                    <button onclick="showSection('rpt_revenue')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_revenue"><i class="fas fa-coins w-5 text-center"></i> الإيرادات</button>
                    <button onclick="showSection('rpt_treasury')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_treasury"><i class="fas fa-vault w-5 text-center"></i> الخزينة</button>
                    <button onclick="showSection('rpt_profits')"
                        class="nav-btn w-full text-right pr-7 p-1.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-500 text-xs"
                        data-target="rpt_profits"><i class="fas fa-chart-pie w-5 text-center"></i> الأرباح</button>
                </div>
            </div>

            <div class="my-2 border-t border-slate-700"></div>

            <button onclick="showSection('users')" id="nav-users"
                class="nav-btn w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="users">
                <i class="fas fa-users-cog w-7 text-center"></i> المستخدمين</button>
            <button onclick="showSection('settings')" id="nav-settings"
                class="nav-btn w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="settings">
                <i class="fas fa-cogs w-7 text-center"></i> الإعدادات</button>
            <button onclick="showSection('support')" id="nav-support"
                class="nav-btn w-full text-right p-2.5 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="support">
                <i class="fas fa-headset w-7 text-center"></i> الدعم الفني</button>
        </nav>
    </aside>

    <!-- المحتوى -->
    <main class="flex-1 flex flex-col w-full overflow-hidden no-print relative">
        <!-- الهيدر -->
        <header class="bg-white shadow-sm h-16 flex justify-between items-center px-4 z-20 border-b">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()"
                    class="md:hidden text-slate-600 hover:text-blue-600 p-2 rounded-full hover:bg-slate-100 transition"><i
                        class="fas fa-bars text-xl"></i></button>
                <h2 id="page-title" class="text-lg font-bold text-slate-800 hidden md:block">لوحة القيادة</h2>
            </div>

            <div class="flex items-center gap-4">
                <!-- اختيار المستخدم الحالي -->
                <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200">
                    <i class="fas fa-user-circle text-slate-500"></i>
                    <select id="current-user-select" onchange="switchUser(this.value)"
                        class="bg-transparent border-none text-xs font-bold text-slate-700 outline-none cursor-pointer">
                        <!-- Users loaded here -->
                    </select>
                </div>

                <div class="hidden md:flex flex-col items-end border-r pr-4 border-slate-200">
                    <span class="text-xs font-bold text-slate-800" id="header-company-name">اسم الشركة</span>
                    <span class="text-[10px] text-slate-500 font-mono" id="header-date">--/--/----</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50 relative">

            <!-- 1. Dashboard -->
            <section id="dashboard" class="section-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-emerald-500">
                        <div class="text-xs text-slate-500 mb-1">الخزينة (النقدية)</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-cash">0.00</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-blue-500">
                        <div class="text-xs text-slate-500 mb-1">المبيعات</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-sales">0.00</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-red-500">
                        <div class="text-xs text-slate-500 mb-1">المصروفات</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-expenses">0.00</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-purple-500">
                        <div class="text-xs text-slate-500 mb-1">صافي الربح</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-net-profit">0.00</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-4 border-b pb-3"><i
                                class="fas fa-chart-bar text-blue-500 me-2"></i>المبيعات (آخر 7 أيام)</h3>
                        <div class="chart-container" id="sales-chart">
                            <!-- Bars will be injected here -->
                            <p class="text-sm text-slate-400 self-center">جاري تحميل البيانات...</p>
                        </div>
                    </div>

                    <!-- Recent Journal -->
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-4 border-b pb-3 flex justify-between items-center">
                            <span><i class="fas fa-history text-blue-500 me-2"></i>آخر العمليات</span>
                            <button onclick="showSection('journal')"
                                class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100">عرض
                                الكل</button>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-50 text-slate-600">
                                    <tr>
                                        <th class="p-2">#</th>
                                        <th class="p-2">التاريخ</th>
                                        <th class="p-2">البيان</th>
                                        <th class="p-2">القيمة</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-journal-list" class="divide-y text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- POS (Kiosk) -->
            <section id="pos" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-120px)]">
                    <!-- Products Grid -->
                    <div class="lg:col-span-2 flex flex-col">
                        <!-- Barcode Scanner + Search -->
                        <div class="flex gap-2 mb-3">
                            <div class="relative flex-1">
                                <i class="fas fa-barcode absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="pos-barcode-input"
                                    placeholder="امسح الباركود أو اكتب كود المنتج ثم Enter..."
                                    class="w-full p-2.5 pr-10 border-2 border-blue-200 rounded-lg text-sm outline-none focus:border-blue-500 bg-blue-50 font-mono"
                                    onkeydown="if(event.key==='Enter'){addByBarcode(this.value);this.value='';}"
                                    autofocus>
                            </div>
                            <input type="text" placeholder="بحث بالاسم..."
                                class="w-40 p-2.5 border rounded-lg text-sm outline-none focus:border-blue-500"
                                onkeyup="renderPOSProducts(this.value)">
                            <button onclick="showSection('pos_products')"
                                class="bg-indigo-600 text-white px-3 rounded-lg hover:bg-indigo-500 text-xs whitespace-nowrap"
                                title="إدارة المنتجات والأسعار">
                                <i class="fas fa-cog me-1"></i>المنتجات
                            </button>
                        </div>
                        <div id="pos-grid"
                            class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 content-start">
                            <!-- Products rendered by JS -->
                        </div>
                    </div>

                    <!-- Cart -->
                    <div class="bg-white rounded-xl shadow-sm flex flex-col p-4">
                        <h3 class="font-bold text-slate-800 mb-3 border-b pb-2"><i
                                class="fas fa-shopping-basket text-blue-500 me-2"></i>السلة</h3>

                        <!-- Customer -->
                        <div class="flex items-center gap-2 mb-3 text-xs">
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" id="pos-walkin" checked onchange="togglePOSCustomer()">
                                <span>عميل نقدي</span>
                            </label>
                            <select id="pos-customer"
                                class="hidden flex-1 p-1.5 border rounded text-xs outline-none"></select>
                        </div>

                        <!-- Cart Items -->
                        <div class="flex-1 overflow-y-auto border rounded mb-3">
                            <table class="w-full text-xs text-right">
                                <thead class="bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="p-2">الصنف</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">المبلغ</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="pos-cart-body"></tbody>
                            </table>
                        </div>

                        <!-- Discount -->
                        <div class="flex items-center gap-2 mb-2 text-xs">
                            <span class="text-slate-500">خصم:</span>
                            <input type="number" id="pos-discount" value="0" min="0"
                                class="w-20 p-1 border rounded text-center text-xs" onchange="renderPOSCart()">
                        </div>

                        <!-- Totals -->
                        <div class="bg-slate-900 text-white p-3 rounded-lg mb-3">
                            <div class="flex justify-between text-xs text-slate-400 mb-1">
                                <span>المجموع:</span><span id="pos-subtotal">0.00</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold text-emerald-400">
                                <span>الإجمالي:</span><span id="pos-total">0.00</span>
                            </div>
                        </div>

                        <!-- Payment Buttons -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button onclick="checkoutPOS('Cash')"
                                class="bg-emerald-600 text-white py-2.5 rounded-lg font-bold hover:bg-emerald-500 shadow text-sm">
                                <i class="fas fa-money-bill-wave me-1"></i> كاش
                            </button>
                            <button onclick="checkoutPOS('Bank')"
                                class="bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-500 shadow text-sm">
                                <i class="fas fa-credit-card me-1"></i> بنك
                            </button>
                        </div>
                        <div id="pos-other-methods" class="grid grid-cols-2 gap-2 mb-2"></div>
                        <button onclick="clearPOSCart()"
                            class="w-full bg-red-100 text-red-600 py-1.5 rounded text-xs font-bold hover:bg-red-200">
                            <i class="fas fa-trash me-1"></i> مسح السلة
                        </button>
                    </div>
                </div>
            </section>

            <!-- POS Products Management Sub-Module -->
            <section id="pos_products" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-box text-blue-500 me-2"></i>إضافة منتج سريع</h3>
                        <form onsubmit="savePOSProduct(event)" class="space-y-3">
                            <input type="hidden" id="pos-prod-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم المنتج *</label>
                                <input type="text" id="pos-prod-name" required
                                    class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">كود المنتج / الباركود</label>
                                <input type="text" id="pos-prod-barcode"
                                    class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500 font-mono"
                                    dir="ltr" placeholder="مثال: 6281001234567">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="block text-xs text-slate-500 mb-1">سعر البيع *</label>
                                    <input type="number" id="pos-prod-price" required step="0.01"
                                        class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                                </div>
                                <div><label class="block text-xs text-slate-500 mb-1">التكلفة</label>
                                    <input type="number" id="pos-prod-cost" step="0.01"
                                        class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="block text-xs text-slate-500 mb-1">المخزون</label>
                                    <input type="number" id="pos-prod-stock" value="0"
                                        class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                                </div>
                                <div><label class="block text-xs text-slate-500 mb-1">الفئة</label>
                                    <input type="text" id="pos-prod-category" placeholder="عام"
                                        class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow"><i
                                        class="fas fa-save me-1"></i>حفظ</button>
                                <button type="button" onclick="resetPOSProductForm()"
                                    class="bg-slate-200 text-slate-600 px-4 py-2.5 rounded-lg hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة المنتجات والأسعار</h3>
                            <div class="flex gap-2">
                                <input type="text" placeholder="بحث..."
                                    class="p-2 border rounded text-sm w-48 outline-none"
                                    onkeyup="filterPOSProductsList(this.value)">
                                <button onclick="exportTableToCSV('pos-products-table','المنتجات_والأسعار')"
                                    class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                        class="fas fa-file-excel me-1"></i>Excel</button>
                                <button onclick="printSection('pos-products-body')"
                                    class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                        class="fas fa-print me-1"></i>طباعة</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                            <table id="pos-products-table" class="w-full text-sm text-right">
                                <thead class="bg-slate-800 text-white sticky top-0">
                                    <tr>
                                        <th class="p-2.5">الباركود</th>
                                        <th class="p-2.5">المنتج</th>
                                        <th class="p-2.5">الفئة</th>
                                        <th class="p-2.5">سعر البيع</th>
                                        <th class="p-2.5">التكلفة</th>
                                        <th class="p-2.5">المخزون</th>
                                        <th class="p-2.5">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="pos-products-body" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- POS Barcode Sub-Module -->
            <section id="barcode" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-barcode text-indigo-500 me-2"></i>إصدار باركود للمنتجات</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث عن منتج..."
                                class="p-2 border rounded text-sm outline-none w-48"
                                onkeyup="filterBarcodeList(this.value)">
                            <button onclick="printAllBarcodes()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-500"><i
                                    class="fas fa-print me-1"></i>طباعة الكل</button>
                        </div>
                    </div>
                    <div id="barcode-products-list" class="max-h-[500px] overflow-y-auto border rounded-lg"></div>
                </div>
            </section>

            <!-- 2. Users Management -->
            <section id="users" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-user-plus text-blue-500 me-2"></i><span id="user-form-title">إضافة
                                مستخدم</span></h3>
                        <form onsubmit="saveUser(event)" class="space-y-4">
                            <input type="hidden" id="user-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم المستخدم</label><input type="text"
                                    id="user-name" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">الدور (الصلاحية)</label>
                                <select id="user-role"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none bg-white">
                                    <option value="admin">مدير (كامل الصلاحيات)</option>
                                    <option value="cashier">كاشير (مبيعات فقط)</option>
                                    <option value="accountant">محاسب</option>
                                </select>
                            </div>

                            <!-- Custom Permissions Matrix -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h4 class="font-bold text-xs text-slate-700 mb-2 border-b pb-1 flex justify-between">
                                    <span>صلاحيات النظام (مخصص)</span>
                                    <button type="button" onclick="selectAllPermissions()"
                                        class="text-blue-600 hover:text-blue-800 text-[10px]">تحديد الكل</button>
                                </h4>
                                <div class="grid grid-cols-2 gap-2" id="permissions-grid">
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-pos" class="w-3 h-3 text-blue-600 rounded"
                                            checked> نقطة البيع
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-invoices" class="w-3 h-3 text-blue-600 rounded"
                                            checked> الفواتير
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-sales" class="w-3 h-3 text-blue-600 rounded"
                                            checked> المبيعات والعملاء
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-purchases" class="w-3 h-3 text-blue-600 rounded"
                                            checked> المشتريات والموردين
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-services" class="w-3 h-3 text-blue-600 rounded"
                                            checked> الخدمات
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-inventory" class="w-3 h-3 text-blue-600 rounded"
                                            checked> إدارة المخزون
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-installments"
                                            class="w-3 h-3 text-blue-600 rounded" checked> التقسيط
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-expenses" class="w-3 h-3 text-blue-600 rounded"
                                            checked> المصروفات
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-incomes" class="w-3 h-3 text-blue-600 rounded"
                                            checked> سندات القبض والإيرادات
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-hr" class="w-3 h-3 text-blue-600 rounded"
                                            checked> الموارد البشرية
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-accounting"
                                            class="w-3 h-3 text-blue-600 rounded" checked> المحاسبة (عرض)
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-accounting-add"
                                            class="w-3 h-3 text-blue-600 rounded" checked> المحاسبة (إضافة)
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-accounting-edit"
                                            class="w-3 h-3 text-blue-600 rounded" checked> المحاسبة (تعديل/حذف)
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-reports" class="w-3 h-3 text-blue-600 rounded"
                                            checked> التقارير
                                    </label>
                                    <label class="flex items-center gap-2 text-xs text-slate-600">
                                        <input type="checkbox" id="perm-settings" class="w-3 h-3 text-blue-600 rounded"
                                            checked> الإعدادات والمستخدمين
                                    </label>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-2">*تطبيق فوري للصلاحيات (يتم إخفاء القوائم غير
                                    المصرح بها).</p>
                                <script>
                                    function selectAllPermissions() {
                                        document.querySelectorAll('#permissions-grid input[type="checkbox"]').forEach(c => c.checked = true);
                                    }
                                </script>
                            </div>

                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="user-phone"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>

                            <div><label class="block text-xs text-slate-500 mb-1">كلمة المرور</label><input
                                    type="password" id="user-password" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none w-full"
                                    autocomplete="new-password"></div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">حفظ</button>
                                <button type="button" onclick="resetUserForm()"
                                    class="bg-slate-200 text-slate-600 px-4 rounded hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800"><i
                                    class="fas fa-users text-blue-500 me-2"></i>قائمة المستخدمين</h3>
                            <input type="text" placeholder="بحث عن مستخدم..."
                                class="p-2 border rounded text-sm w-48 focus:border-blue-500 outline-none"
                                onkeyup="filterUsers(this.value)">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-50 text-slate-700">
                                    <tr>
                                        <th class="p-3 rounded-tr-lg">الاسم</th>
                                        <th class="p-3">الدور</th>
                                        <th class="p-3">الهاتف</th>
                                        <th class="p-3 rounded-tl-lg">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="users-list" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Settings -->
            <section id="settings" class="section-content">
                <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex items-center gap-3 border-b pb-4 mb-6">
                        <div
                            class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-600">
                            <i class="fas fa-sliders-h"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-slate-800">إعدادات النظام</h3>
                            <p class="text-xs text-slate-500">تحكم في بيانات الشركة والنسخ الاحتياطي</p>
                        </div>
                    </div>

                    <form onsubmit="saveSettings(event)" class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">اسم الشركة</label><input
                                type="text" id="set-name"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">رقم الهاتف</label><input
                                type="text" id="set-phone"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div class="md:col-span-2"><label
                                class="text-xs font-bold text-slate-600 mb-1 block">العنوان</label><input type="text"
                                id="set-address"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">الرقم الضريبي</label><input
                                type="text" id="set-vat-no"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">رابط شعار الشركة
                                (URL)</label><input type="text" id="set-logo-url"
                                placeholder="https://example.com/logo.png"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none"
                                dir="ltr"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">الضريبة %</label><input
                                    type="number" id="set-vat-rate"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                            </div>
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">العملة</label><input
                                    type="text" id="set-currency"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                            </div>
                        </div>
                        <div class="md:col-span-2 mt-4 border-t pt-4">
                            <h4 class="font-bold text-slate-700 mb-2 text-sm">طرق الدفع</h4>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="new-pay-method"
                                    placeholder="اسم طريقة الدفع (مثلاً: فودافون كاش)"
                                    class="flex-1 p-2 border rounded text-sm outline-none bg-slate-50 focus:bg-white transition">
                                <button type="button" onclick="addPaymentMethod()"
                                    class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 text-sm">إضافة</button>
                            </div>
                            <div id="payment-methods-list" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="md:col-span-2 text-left pt-2">
                            <button type="submit"
                                class="bg-slate-800 text-white px-8 py-2.5 rounded-lg hover:bg-slate-700 transition shadow-lg font-bold text-sm">حفظ
                                التغييرات</button>
                        </div>
                    </form>

                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <h4 class="font-bold text-slate-700 mb-4 text-sm">إدارة البيانات والنسخ الاحتياطي</h4>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="exportData()"
                                class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-100 transition text-sm flex items-center gap-2"><i
                                    class="fas fa-download"></i> تصدير Backup</button>

                            <div class="relative">
                                <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                                <button onclick="document.getElementById('import-file').click()"
                                    class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-100 transition text-sm flex items-center gap-2"><i
                                        class="fas fa-upload"></i> استعادة Backup</button>
                            </div>

                            <button onclick="resetData()"
                                class="bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition text-sm flex items-center gap-2 mr-auto"><i
                                    class="fas fa-trash-alt"></i> تصفير النظام</button>
                        </div>
                    </div>

                    <!-- ضبط الفواتير -->
                    <div class="bg-white p-5 rounded-xl shadow-sm mt-6">
                        <h4 class="font-bold text-slate-700 mb-4 text-sm"><i
                                class="fas fa-file-invoice text-blue-500 me-2"></i>ضبط الفواتير والإيصالات</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- فاتورة المبيعات -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">فاتورة المبيعات</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sales-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sales-vat" checked> إظهار الضريبة</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sales-notes"> ملاحظات</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sales-sign"> التوقيع</label>
                                <input type="text" id="inv-sales-footer" placeholder="رسالة أسفل الفاتورة"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                            <!-- فاتورة المشتريات -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">فاتورة المشتريات</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pur-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pur-vat" checked> إظهار الضريبة</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pur-notes"> ملاحظات</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pur-sign"> التوقيع</label>
                                <input type="text" id="inv-pur-footer" placeholder="رسالة أسفل الفاتورة"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                            <!-- فاتورة التقسيط -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">فاتورة التقسيط</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-inst-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-inst-vat" checked> إظهار الضريبة</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-inst-notes"> ملاحظات</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-inst-sign"> التوقيع</label>
                                <input type="text" id="inv-inst-footer" placeholder="رسالة أسفل الفاتورة"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                            <!-- جدول الأقساط -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">جدول الأقساط</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sched-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sched-notes"> ملاحظات</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-sched-sign"> التوقيع</label>
                                <input type="text" id="inv-sched-footer" placeholder="رسالة أسفل الجدول"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                            <!-- ريسيت POS -->
                            <div class="border rounded-lg p-3 bg-slate-50">
                                <h5 class="font-bold text-xs text-slate-600 mb-2">إيصال نقطة البيع (POS)</h5>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pos-logo" checked> إظهار الشعار</label>
                                <label class="flex items-center gap-2 text-xs mb-1"><input type="checkbox"
                                        id="inv-pos-vat" checked> إظهار الضريبة</label>
                                <input type="text" id="inv-pos-footer" placeholder="رسالة أسفل الإيصال (شكراً لزيارتكم)"
                                    class="w-full p-1.5 border rounded text-xs mt-1 outline-none">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. Sales & POS -->
            <section id="sales" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                    <!-- الفاتورة -->
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <span id="sale-title">فاتورة مبيعات</span>
                                <span id="sale-mode-badge"
                                    class="hidden text-xs bg-red-100 text-red-800 px-2 py-1 rounded border border-red-200">مرتجع</span>
                            </h3>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer text-sm select-none">
                                    <input type="checkbox" id="is-return-sale"
                                        class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                                        onchange="toggleSaleMode()">
                                    <span>وضع المرتجع</span>
                                </label>
                                <div
                                    class="text-xs font-mono bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100">
                                    INV-<span id="inv-num">Auto</span></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <select id="sale-customer"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"></select>
                            <select id="sale-account"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"></select>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <select id="sale-product"
                                class="flex-1 p-2.5 border rounded-lg text-sm bg-white outline-none shadow-sm"></select>
                            <input type="number" id="sale-qty" value="1"
                                class="w-20 p-2.5 border rounded-lg text-center outline-none" min="1">
                            <button onclick="addToCart()"
                                class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 transition shadow"><i
                                    class="fas fa-plus"></i></button>
                        </div>

                        <!-- جدول السلة -->
                        <div class="flex-1 border rounded-lg overflow-y-auto mb-3 bg-slate-50">
                            <table class="w-full text-sm text-center relative">
                                <thead class="bg-slate-200 text-slate-700 sticky top-0">
                                    <tr>
                                        <th class="p-2">الصنف</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">السعر</th>
                                        <th class="p-2">الإجمالي</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="cart-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                            <div id="cart-empty" class="text-center text-slate-400 py-10 text-sm">ابدأ بإضافة المنتجات
                            </div>
                        </div>

                        <div class="bg-slate-900 text-white p-4 rounded-xl shadow-lg">
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>المجموع:</span><span
                                    id="cart-subtotal">0.00</span></div>
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>الضريبة (<span
                                        id="cart-vat-rate">15</span>%):</span><span id="cart-vat">0.00</span></div>

                            <!-- الخصم المسموح به -->
                            <div class="flex items-center gap-2 mb-1 text-xs text-slate-400">
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" id="sale-disc-toggle"
                                        onchange="document.getElementById('sale-disc-area').classList.toggle('hidden');renderCart()">
                                    <span>الخصم المسموح به</span>
                                </label>
                            </div>
                            <div id="sale-disc-area" class="hidden mb-2 flex gap-1 items-center">
                                <select id="sale-disc-type" class="p-1 text-black rounded text-[10px] w-16"
                                    onchange="renderCart()">
                                    <option value="amount">مبلغ</option>
                                    <option value="percent">نسبة%</option>
                                </select>
                                <input type="number" id="sale-discount"
                                    class="w-16 p-1 text-black rounded text-center text-xs font-bold" value="0" min="0"
                                    onchange="renderCart()">
                            </div>

                            <div class="flex justify-between items-center border-t border-slate-700 pt-2 mb-2">
                                <span class="text-slate-400 text-xs">الإجمالي:</span>
                                <div class="text-xl font-bold text-emerald-400" id="cart-total">0.00</div>
                            </div>

                            <!-- نوع الدفع -->
                            <div class="flex gap-2 mb-2">
                                <button type="button" onclick="setSalePayType('cash')" id="sale-pay-cash-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white">كاش</button>
                                <button type="button" onclick="setSalePayType('credit')" id="sale-pay-credit-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300">آجل</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="text-[10px] text-slate-400 block mb-1">طريقة الدفع</label>
                                    <select id="sale-method" class="w-full p-1.5 text-black rounded text-sm"></select>
                                </div>
                                <div id="sale-credit-area" class="hidden">
                                    <label class="text-[10px] text-slate-400 block mb-1">المدفوع</label>
                                    <input type="number" id="sale-paid"
                                        class="w-full p-1.5 text-black rounded text-sm font-bold" placeholder="0.00"
                                        oninput="calcSaleRemaining()">
                                </div>
                            </div>
                            <div id="sale-remaining-row"
                                class="hidden flex justify-between text-xs text-yellow-400 mb-2">
                                <span>المتبقي على العميل:</span><span id="sale-remaining">0.00</span>
                            </div>
                            <!-- أزرار الإجراءات المنفصلة -->
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="postSale()"
                                    class="bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg font-bold shadow transition active:scale-95 text-sm">
                                    <i class="fas fa-save me-1"></i>حفظ الفاتورة
                                </button>
                                <button onclick="printLastSaleInvoice()"
                                    class="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold shadow transition active:scale-95 text-sm">
                                    <i class="fas fa-print me-1"></i>طباعة آخر فاتورة
                                </button>
                                <button onclick="exportLastSalePDF()"
                                    class="bg-red-600 hover:bg-red-500 text-white py-1.5 rounded-lg font-bold text-xs">
                                    <i class="fas fa-file-pdf me-1"></i>تصدير PDF
                                </button>
                                <button onclick="exportTableToCSV('recent-inv-table','فواتير_المبيعات')"
                                    class="bg-green-700 hover:bg-green-600 text-white py-1.5 rounded-lg font-bold text-xs">
                                    <i class="fas fa-file-excel me-1"></i>تصدير Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- الشريط الجانبي: فواتير + كشف حساب عملاء -->
                    <div class="lg:col-span-1 flex flex-col gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-file-alt text-blue-500 me-1"></i>سجل الفواتير</h3>
                                <div class="flex gap-1">
                                    <input type="text" placeholder="بحث..."
                                        class="p-1 border rounded text-[10px] w-24 outline-none"
                                        onkeyup="filterSalesInvoiceList(this.value)">
                                    <button onclick="exportTableToCSV('recent-inv-table','فواتير_المبيعات')"
                                        class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('recent-inv-body')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <div class="overflow-y-auto max-h-[250px] border rounded bg-slate-50">
                                <table id="recent-inv-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-slate-800 text-white sticky top-0">
                                        <tr>
                                            <th class="p-1.5">#</th>
                                            <th class="p-1.5">التاريخ</th>
                                            <th class="p-1.5">العميل</th>
                                            <th class="p-1.5">الإجمالي</th>
                                            <th class="p-1.5">الحالة</th>
                                            <th class="p-1.5"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-inv-body" class="bg-white divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-file-invoice-dollar text-blue-500 me-1"></i>كشف حساب العملاء</h3>
                                <div class="flex gap-1">
                                    <button onclick="exportTableToCSV('cust-statement-table','كشف_حساب_العملاء')"
                                        class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('cust-statement-body')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <input type="text" placeholder="بحث بالكود أو الاسم..."
                                class="w-full p-1.5 border rounded text-xs mb-2 outline-none"
                                onkeyup="filterCustStatement(this.value)">
                            <div class="overflow-y-auto max-h-[200px] border rounded bg-slate-50">
                                <table id="cust-statement-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-slate-200 sticky top-0">
                                        <tr>
                                            <th class="p-1.5">الكود</th>
                                            <th class="p-1.5">العميل</th>
                                            <th class="p-1.5">الإجمالي</th>
                                            <th class="p-1.5">المدفوع</th>
                                            <th class="p-1.5 text-red-600">المتبقي</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cust-statement-body" class="bg-white divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 9. Sales Quotations -->
            <section id="quotations" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <!-- عرض السعر (الجانب العملي) -->
                    <div
                        class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col gap-4">
                        <div class="flex justify-between items-center pb-4 border-b border-slate-50">
                            <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
                                <i class="fas fa-file-invoice text-blue-500"></i>
                                <span id="quote-title">عرض سعر جديد</span>
                                <span id="quote-mode-badge"
                                    class="hidden text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full border border-red-200">وضع
                                    المرتجع</span>
                            </h3>
                            <div class="flex items-center gap-4">
                                <label
                                    class="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-500 hover:text-red-600 transition">
                                    <input type="checkbox" id="is-return-quote"
                                        class="w-4 h-4 text-red-600 rounded border-slate-300 focus:ring-red-500"
                                        onchange="toggleQuoteMode()">
                                    <span>وضع المرتجع</span>
                                </label>
                                <div
                                    class="text-xs font-mono bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg border border-blue-100 font-black shadow-sm">
                                    QT-<span id="QT-num">AUTO</span>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" id="quote-edit-id">

                        <!-- الحقول الأساسية -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-400 font-black mr-2">اختيار
                                    العميل</label>
                                <div class="quote-cust-wrapper" style="position:relative;">
                                    <input type="text" id="quote-customer" placeholder="ابحث عن عميل أو أضف جديداً..."
                                        class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-500/10 outline-none transition-all"
                                        onfocus="onQuoteCustomerFocus()" oninput="onQuoteCustomerInput(this.value)"
                                        onkeydown="onQuoteCustomerKeydown(event)">
                                    <i class="fas fa-user-tag pur-combobox-icon"></i>
                                    <input type="hidden" id="quote-customer-id" value="">
                                    <div id="quote-customer-suggestions" class="pur-suggestions"></div>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-400 font-black mr-2">الحساب
                                    المحاسبي</label>
                                <select id="quote-account"
                                    class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-500/10 outline-none transition-all"></select>
                            </div>
                        </div>

                        <!-- إدخال المنتجات -->
                        <div class="p-4 bg-slate-50/50 rounded-2xl border border-dashed border-slate-200">
                            <div class="flex flex-wrap md:flex-nowrap gap-3">
                                <div class="flex-1 min-w-[200px]">
                                    <label class="text-[10px] font-black text-slate-400 block mb-1">المنتج /
                                        الصنف</label>
                                    <div class="quote-prod-wrapper" style="position:relative;">
                                        <input type="text" id="quote-product" placeholder="ابحث عن منتج..."
                                            class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-white outline-none focus:ring-4 focus:ring-blue-500/10 transition-all shadow-sm"
                                            onfocus="onQuoteProductFocus()" oninput="onQuoteProductInput(this.value)"
                                            onkeydown="onQuoteProductKeydown(event)">
                                        <i class="fas fa-search pur-combobox-icon"></i>
                                        <input type="hidden" id="quote-product-id" value="">
                                        <div id="quote-product-suggestions" class="pur-suggestions"></div>
                                    </div>
                                </div>
                                <div class="w-24">
                                    <label class="text-[10px] font-black text-slate-400 block mb-1">الكمية</label>
                                    <input type="number" id="quote-qty" value="1" min="1"
                                        class="w-full p-3 border border-slate-200 rounded-xl text-center text-sm font-bold bg-white outline-none focus:ring-4 focus:ring-blue-500/10">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="addToQuoteCart()"
                                        class="h-[46px] w-[46px] bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-100 flex items-center justify-center active:scale-95">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- جدول العناصر -->
                        <div class="flex-1 border border-slate-100 rounded-2xl overflow-hidden bg-white shadow-inner">
                            <div class="max-h-[350px] overflow-y-auto">
                                <table class="w-full text-sm text-center">
                                    <thead class="bg-slate-800 text-slate-300 sticky top-0 z-10">
                                        <tr>
                                            <th class="p-4 font-black">الصنف</th>
                                            <th class="p-4 font-black">الكمية</th>
                                            <th class="p-4 font-black">السعر</th>
                                            <th class="p-4 font-black">الإجمالي</th>
                                            <th class="p-4 w-12"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="quote-cart-body" class="divide-y divide-slate-50"></tbody>
                                </table>
                                <div id="quote-cart-empty" class="p-16 text-center text-slate-300">
                                    <i class="fas fa-folder-open text-4xl mb-3 block opacity-20"></i>
                                    <p class="text-[10px] italic">ابدأ بإضافة المنتجات لعرض السعر</p>
                                </div>
                            </div>
                        </div>

                        <!-- خلاصة الفاتورة والدفع -->
                        <div
                            class="bg-slate-900 border border-slate-800 text-white p-6 rounded-3xl shadow-2xl mt-auto relative overflow-hidden">
                            <div
                                class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-full -mr-16 -mt-16 blur-3xl">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center text-slate-400 text-xs">
                                        <span>المجموع الفرعي:</span>
                                        <span id="quote-cart-subtotal"
                                            class="font-mono font-bold text-white">0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center text-slate-400 text-xs">
                                        <span>ضريبة القيمة المضافة (15%):</span>
                                        <span id="quote-cart-vat" class="font-mono font-bold text-blue-400">0.00</span>
                                    </div>
                                    <div class="pt-2 border-t border-slate-800">
                                        <label
                                            class="flex items-center gap-2 cursor-pointer text-[10px] text-slate-500 mb-2 hover:text-blue-400 transition">
                                            <input type="checkbox" id="quote-disc-toggle"
                                                class="w-3 h-3 rounded bg-transparent border-slate-700"
                                                onchange="document.getElementById('quote-disc-area').classList.toggle('hidden');renderQuoteCart()">
                                            <span>تطبيق خصم؟</span>
                                        </label>
                                        <div id="quote-disc-area" class="hidden flex gap-2 animate-fadeIn">
                                            <select id="quote-disc-type"
                                                class="bg-slate-800 text-[10px] p-2 rounded-lg border-none outline-none"
                                                onchange="renderQuoteCart()">
                                                <option value="amount">مبلغ ثابت</option>
                                                <option value="percent">نسبة %</option>
                                            </select>
                                            <input type="number" id="quote-discount"
                                                class="bg-slate-800 text-sm p-2 rounded-lg border-none w-20 text-center font-bold outline-none ring-1 ring-slate-700"
                                                value="0" onchange="renderQuoteCart()">
                                        </div>
                                    </div>
                                    <div class="pt-4 flex justify-between items-end">
                                        <span class="text-lg font-bold">المبلغ الإجمالي:</span>
                                        <span id="quote-total" class="text-4xl font-black text-emerald-400">0.00</span>
                                    </div>
                                </div>
                                <div class="space-y-4 border-r border-slate-800 pr-8">
                                    <div class="flex p-1 bg-slate-800 rounded-xl mb-4">
                                        <button onclick="setQuotePayType('cash')" id="quote-pay-cash-btn"
                                            class="flex-1 py-2.5 rounded-lg text-[10px] font-black bg-blue-600 text-white shadow-lg transition transform active:scale-95">كاش</button>
                                        <button onclick="setQuotePayType('credit')" id="quote-pay-credit-btn"
                                            class="flex-1 py-2.5 rounded-lg text-[10px] font-black text-slate-500 hover:text-slate-300 transition transform active:scale-95">آجل
                                            / دفعات</button>
                                    </div>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div class="space-y-1">
                                            <label
                                                class="text-[10px] text-slate-500 font-bold uppercase block ml-1">طريقة
                                                التحصيل</label>
                                            <select id="quote-method"
                                                class="w-full bg-slate-800 text-white p-2.5 rounded-xl border-none text-sm font-bold outline-none ring-1 ring-slate-700 focus:ring-blue-500 transition"></select>
                                        </div>
                                        <div id="quote-credit-area" class="hidden space-y-1 animate-slideDown">
                                            <label
                                                class="text-[10px] text-slate-500 font-bold uppercase block ml-1">المبلغ
                                                المحصل</label>
                                            <input type="number" id="quote-paid"
                                                class="w-full bg-slate-800 p-2.5 rounded-xl border-none text-emerald-400 text-xl font-black outline-none ring-1 ring-slate-700 focus:ring-blue-500 transition"
                                                placeholder="0.00" oninput="calcQuoteRemaining()">
                                        </div>
                                    </div>
                                    <div id="quote-remaining-row"
                                        class="hidden flex justify-between items-center text-xs p-4 bg-yellow-500/10 rounded-2xl border border-yellow-500/10 animate-pulse">
                                        <span class="text-yellow-400 font-bold">باقي على العميل:</span>
                                        <span id="quote-remaining"
                                            class="text-2xl font-black text-yellow-500">0.00</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button onclick="postQuotation()"
                                            class="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-black text-xs shadow-xl shadow-blue-900/40 transition active:scale-95 flex items-center justify-center gap-2">
                                            <i class="fas fa-save"></i> حفظ
                                        </button>
                                        <button onclick="printLastQuotation()"
                                            class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-black text-xs shadow-xl transition active:scale-95 flex items-center justify-center gap-2">
                                            <i class="fas fa-print"></i> طباعة
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- سجلات العملاء (الجانب المعلوماتي) -->
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <!-- سجل العروض -->
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[450px]">
                            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-50">
                                <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                                    <i class="fas fa-history text-blue-500"></i>
                                    سجل عروض الأسعار
                                </h3>
                                <div class="flex gap-1">
                                    <input type="text" placeholder="بحث..."
                                        class="p-1.5 px-3 border border-slate-200 rounded-lg text-[10px] w-28 outline-none focus:border-blue-500 transition"
                                        onkeyup="filterQuotationList(this.value)">
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar">
                                <table class="w-full text-[10px] text-center">
                                    <thead class="bg-slate-50 text-slate-500 sticky top-0 z-10">
                                        <tr>
                                            <th class="p-3 text-right">العرض</th>
                                            <th class="p-3">العميل</th>
                                            <th class="p-3">الإجمالي</th>
                                            <th class="p-3"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-QT-body" class="divide-y divide-slate-50 bg-white"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- مديونيات العملاء -->
                        <div
                            class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-3xl shadow-2xl text-white relative overflow-hidden group">
                            <div
                                class="absolute -bottom-4 -right-4 w-24 h-24 bg-blue-500 opacity-5 rounded-full blur-2xl group-hover:opacity-10 transition">
                            </div>

                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-sm flex items-center gap-2">
                                    <i class="fas fa-users-cog text-blue-400"></i>
                                    كشف حساب العملاء
                                </h3>
                                <button onclick="showSection('customers')"
                                    class="text-[9px] bg-white/10 text-white px-3 py-1.5 rounded-full hover:bg-white/20 transition backdrop-blur-sm border border-white/5">إدارة
                                    العملاء</button>
                            </div>

                            <div class="relative mb-4">
                                <input type="text" placeholder="ابحث عن عميل..."
                                    class="w-full bg-white/5 border border-white/10 text-white p-2.5 rounded-xl text-[10px] outline-none focus:ring-2 focus:ring-blue-500/30 transition placeholder:text-slate-500"
                                    onkeyup="filterCustStatement(this.value)">
                                <i
                                    class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 text-[10px]"></i>
                            </div>

                            <div
                                class="max-h-[250px] overflow-y-auto mb-4 bg-black/20 rounded-2xl border border-white/5 custom-scrollbar-light">
                                <table id="cust-statement-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-white/5 text-slate-400 sticky top-0 z-10">
                                        <tr>
                                            <th class="p-3">العميل</th>
                                            <th class="p-3">المدفوع</th>
                                            <th class="p-3 text-emerald-400">الباقي</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cust-statement-body" class="divide-y divide-white/5"></tbody>
                                </table>
                            </div>
                            <div
                                class="p-4 bg-blue-500/10 rounded-2xl border border-blue-500/20 flex flex-col items-center">
                                <p class="text-[9px] text-blue-200/50 uppercase tracking-widest mb-1 font-bold">إجمالي
                                    مستحقاتنا لدى العملاء</p>
                                <p id="total-customer-receivable"
                                    class="text-3xl font-black text-blue-400 leading-none">0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. Journal (Entries) -->
            <section id="journal" class="section-content">
                <div class="flex flex-col gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-plus-circle text-blue-600"></i> قيد يومية يدوي
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                            <div class="md:col-span-3">
                                <label class="block text-xs font-bold text-slate-500 mb-1">شرح القيد (البيان)</label>
                                <input type="text" id="manual-desc" placeholder="أدخل وصفاً مفصلاً للقيد..."
                                    class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500 bg-slate-50 focus:bg-white transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">التاريخ</label>
                                <input type="date" id="manual-date"
                                    class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500 bg-slate-50 focus:bg-white transition">
                            </div>
                        </div>

                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4">
                            <div
                                class="grid grid-cols-12 gap-2 text-[10px] font-bold text-slate-500 mb-2 px-2 uppercase tracking-wider">
                                <div class="col-span-6">الحساب</div>
                                <div class="col-span-2 text-center">مدين</div>
                                <div class="col-span-2 text-center">دائن</div>
                                <div class="col-span-2"></div>
                            </div>
                            <div id="journal-lines" class="space-y-2"></div>
                            <button onclick="addJournalLineRow()"
                                class="mt-4 text-xs bg-blue-50 text-blue-600 px-4 py-2 rounded-full hover:bg-blue-100 font-bold transition flex items-center gap-2 w-fit">
                                <i class="fas fa-plus"></i> إضافة طرف جديد
                            </button>
                        </div>

                        <div class="flex justify-between items-center bg-slate-900 p-4 rounded-xl text-white shadow-lg">
                            <div class="flex gap-6 text-sm font-mono font-bold">
                                <div class="flex flex-col">
                                    <span class="text-slate-400 text-[10px]">إجمالي المدين</span>
                                    <span class="text-emerald-400 text-lg" id="total-dr">0.00</span>
                                </div>
                                <div class="w-px bg-slate-700 mx-2"></div>
                                <div class="flex flex-col">
                                    <span class="text-slate-400 text-[10px]">إجمالي الدائن</span>
                                    <span class="text-red-400 text-lg" id="total-cr">0.00</span>
                                </div>
                                <span id="unbalanced-msg"
                                    class="bg-red-500/20 text-red-400 px-3 py-1 rounded-lg text-xs hidden flex items-center gap-2 animate-pulse">
                                    <i class="fas fa-exclamation-triangle"></i> القيد غير متزن
                                </span>
                            </div>
                            <button onclick="saveManualJournal()"
                                class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-blue-900/20 active:scale-95">
                                ترحيل القيد <i class="fas fa-paper-plane ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Journal List -->
                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col min-h-[400px]">
                        <div class="flex flex-wrap justify-between items-center mb-5 gap-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2 text-2xl">
                                <i class="fas fa-book-open text-slate-400"></i> سجل العمليات المحاسبية
                            </h3>
                            <div class="flex gap-2 bg-slate-50 p-1.5 rounded-xl border">
                                <input type="date" id="journal-filter-date" onchange="renderJournal()"
                                    title="تصفية بالتاريخ"
                                    class="bg-transparent text-xs p-1 outline-none border-r me-1">
                                <div class="relative">
                                    <i
                                        class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px]"></i>
                                    <input type="text" id="journal-search" placeholder="بحث في الملاحظات..."
                                        onkeyup="renderJournal()"
                                        class="bg-transparent text-xs py-1.5 pr-8 pl-3 rounded-lg outline-none w-56 focus:bg-white transition">
                                </div>
                            </div>
                        </div>
                        <div class="overflow-y-auto flex-1 border rounded-xl bg-slate-50/30">
                            <table id="journal-table" class="w-full text-xs text-right">
                                <thead class="bg-slate-800 text-white sticky top-0 z-20">
                                    <tr>
                                        <th class="p-3 w-16 text-center border-l border-slate-700">#</th>
                                        <th class="p-3 w-28 border-l border-slate-700">التاريخ</th>
                                        <th class="p-3">البيان / الملاحظات</th>
                                        <th class="p-3 w-28 text-center border-l border-slate-700">المصدر</th>
                                        <th class="p-3 w-32 text-center border-l border-slate-700">إجمالي مدين</th>
                                        <th class="p-3 w-32 text-center">إجمالي دائن</th>
                                        <th class="p-3 w-20 px-4"></th>
                                    </tr>
                                </thead>
                                <tbody id="journal-history-body"
                                    class="divide-y divide-slate-100 bg-white shadow-inner">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Modal تفاصيل القيد -->
            <div id="entry-modal" class="modal">
                <div class="modal-content w-[700px] p-0 shadow-2xl scale-95 transition-transform">
                    <div class="bg-slate-900 text-white p-5 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg">
                                <i class="fas fa-file-invoice-dollar text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight" id="entry-modal-title">تفاصيل القيد المحاسبي
                                </h3>
                                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Transaction
                                    Voucher Details</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex items-center bg-white/10 rounded-lg p-1 gap-1">
                                <button onclick="navigateEntry(1)" id="prev-entry-btn"
                                    class="w-8 h-8 rounded-md hover:bg-white/20 transition flex items-center justify-center title='السابق'">
                                    <i class="fas fa-chevron-right text-xs"></i>
                                </button>
                                <span class="text-[10px] font-bold px-1 opacity-50">تصفح</span>
                                <button onclick="navigateEntry(-1)" id="next-entry-btn"
                                    class="w-8 h-8 rounded-md hover:bg-white/20 transition flex items-center justify-center title='التالي'">
                                    <i class="fas fa-chevron-left text-xs"></i>
                                </button>
                            </div>
                            <button onclick="printEntry()"
                                class="w-8 h-8 rounded-md bg-white/10 hover:bg-white/20 transition flex items-center justify-center title='طباعة'">
                                <i class="fas fa-print text-xs"></i>
                            </button>
                            <button onclick="closeModal('entry-modal')"
                                class="w-8 h-8 rounded-full hover:bg-white/10 transition flex items-center justify-center">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-8">
                        <div
                            class="mb-6 grid grid-cols-2 gap-8 text-sm bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <div>
                                <p class="text-[10px] text-slate-400 mb-1 font-bold">رقم القيد</p>
                                <span class="font-mono text-blue-600 font-bold text-lg" id="view-entry-id"></span>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400 mb-1 font-bold">تاريخ العملية</p>
                                <span class="font-bold" id="view-entry-date"></span>
                            </div>
                            <div class="col-span-2">
                                <p class="text-[10px] text-slate-400 mb-1 font-bold">البيان والوصف</p>
                                <span class="text-slate-700 leading-relaxed font-bold" id="view-entry-desc"></span>
                            </div>
                        </div>
                        <div class="border rounded-xl overflow-hidden shadow-sm">
                            <table class="w-full text-xs text-right border-collapse">
                                <thead class="bg-slate-100 text-slate-600">
                                    <tr>
                                        <th class="p-3 font-bold border-b">اسم الحساب</th>
                                        <th
                                            class="p-3 w-32 text-center font-bold border-b border-r bg-emerald-50 text-emerald-700">
                                            مدين (DR)</th>
                                        <th class="p-3 w-32 text-center font-bold border-b bg-red-50 text-red-700">دائن
                                            (CR)</th>
                                    </tr>
                                </thead>
                                <tbody id="view-entry-lines" class="divide-y divide-slate-100"></tbody>
                                <tfoot class="bg-slate-800 text-white font-bold">
                                    <tr>
                                        <td class="p-3 text-left">الإجمالي</td>
                                        <td class="p-3 text-center border-r border-slate-700 font-mono"
                                            id="view-total-dr">
                                            0.00</td>
                                        <td class="p-3 text-center font-mono" id="view-total-cr">0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-5 flex justify-end gap-3 border-t">
                        <button onclick="closeModal('entry-modal')"
                            class="bg-slate-900 text-white px-8 py-2.5 rounded-lg text-xs font-bold hover:bg-slate-800 transition active:scale-95 shadow-lg">
                            إغلاق النافذة
                        </button>
                    </div>
                </div>
            </div>

            <!-- 9. Purchases (New) -->
            <section id="purchases" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <span id="pur-title">فاتورة مشتريات</span>
                                <span id="pur-mode-badge"
                                    class="hidden text-xs bg-red-100 text-red-800 px-2 py-1 rounded border border-red-200">مرتجع</span>
                            </h3>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer text-sm select-none">
                                    <input type="checkbox" id="is-return-pur"
                                        class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                                        onchange="togglePurMode()">
                                    <span>وضع المرتجع</span>
                                </label>
                                <div
                                    class="text-xs font-mono bg-orange-50 text-orange-700 px-2 py-1 rounded border border-orange-100">
                                    PUR-<span id="pur-num">Auto</span></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <select id="pur-supplier"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"></select>
                            <input type="date" id="pur-date"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none">
                        </div>
                        <div class="flex gap-2 mb-3">
                            <div class="pur-combobox-wrapper">
                                <input type="text" id="pur-product-input"
                                    placeholder="اكتب اسم المنتج أو اختر من القائمة..." autocomplete="off"
                                    onfocus="onPurProductFocus()" oninput="onPurProductInput(this.value)"
                                    onkeydown="onPurProductKeydown(event)">
                                <i class="fas fa-search pur-combobox-icon"></i>
                                <input type="hidden" id="pur-product-id" value="">
                                <input type="hidden" id="pur-product-type" value="product">
                                <div id="pur-suggestions" class="pur-suggestions"></div>
                            </div>
                            <input type="number" id="pur-cost" placeholder="التكلفة"
                                class="w-24 p-2.5 border rounded-lg text-center outline-none">
                            <input type="number" id="pur-qty" value="1"
                                class="w-20 p-2.5 border rounded-lg text-center outline-none" min="1">
                            <button onclick="addToPurCart()"
                                class="bg-orange-600 text-white px-4 rounded-lg hover:bg-orange-700 transition shadow"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div class="flex-1 border rounded-lg overflow-y-auto mb-3 bg-slate-50">
                            <table class="w-full text-sm text-center relative">
                                <thead class="bg-slate-200 text-slate-700 sticky top-0">
                                    <tr>
                                        <th class="p-2">الصنف</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">التكلفة</th>
                                        <th class="p-2">الإجمالي</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="pur-cart-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                        <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg">
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>المجموع:</span><span
                                    id="pur-subtotal">0.00</span></div>
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>الضريبة
                                    (15%):</span><span id="pur-vat">0.00</span></div>

                            <!-- الخصم المكتسب -->
                            <div class="flex items-center gap-2 mb-1 text-xs text-slate-400">
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" id="pur-disc-toggle"
                                        onchange="document.getElementById('pur-disc-area').classList.toggle('hidden');renderPurCart()">
                                    <span>الخصم المكتسب</span>
                                </label>
                            </div>
                            <div id="pur-disc-area" class="hidden mb-2 flex gap-1 items-center">
                                <select id="pur-disc-type" class="p-1 text-black rounded text-[10px] w-16"
                                    onchange="renderPurCart()">
                                    <option value="amount">مبلغ</option>
                                    <option value="percent">نسبة%</option>
                                </select>
                                <input type="number" id="pur-discount"
                                    class="w-16 p-1 text-black rounded text-center text-xs font-bold" value="0" min="0"
                                    onchange="renderPurCart()">
                            </div>

                            <div class="flex justify-between items-center border-t border-slate-700 pt-2 mb-2">
                                <span class="text-slate-400 text-xs">الإجمالي:</span>
                                <div class="text-xl font-bold text-orange-400" id="pur-total">0.00</div>
                            </div>

                            <!-- نوع الدفع -->
                            <div class="flex gap-2 mb-2">
                                <button type="button" onclick="setPurPayType('cash')" id="pur-pay-cash-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-orange-600 text-white">كاش</button>
                                <button type="button" onclick="setPurPayType('credit')" id="pur-pay-credit-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300">آجل</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="text-[10px] text-slate-400 block mb-1">طريقة الدفع</label>
                                    <select id="pur-method" class="w-full p-1.5 text-black rounded text-sm"></select>
                                </div>
                                <div id="pur-credit-area" class="hidden">
                                    <label class="text-[10px] text-slate-400 block mb-1">المدفوع</label>
                                    <input type="number" id="pur-paid"
                                        class="w-full p-1.5 text-black rounded text-sm font-bold" placeholder="0.00"
                                        oninput="calcPurRemaining()">
                                </div>
                            </div>
                            <div id="pur-remaining-row"
                                class="hidden flex justify-between text-xs text-yellow-400 mb-2">
                                <span>المتبقي للمورد:</span><span id="pur-remaining">0.00</span>
                            </div>
                            <button onclick="postPurchase()"
                                class="w-full bg-orange-600 hover:bg-orange-500 text-white py-2 rounded-lg font-bold shadow-lg transition">حفظ
                                الفاتورة</button>
                        </div>
                    </div>
                    <!-- الشريط الجانبي: مشتريات + كشف حساب موردين -->
                    <div class="lg:col-span-1 flex flex-col gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-file-import text-orange-500 me-1"></i>سجل فواتير المشتريات</h3>
                                <div class="flex gap-1">
                                    <input type="text" placeholder="بحث..."
                                        class="p-1 border rounded text-[10px] w-24 outline-none"
                                        onkeyup="filterPurchaseInvoiceList(this.value)">
                                    <button onclick="exportTableToCSV('recent-pur-table','فواتير_المشتريات')"
                                        class="text-[10px] bg-orange-50 text-orange-600 px-2 py-1 rounded hover:bg-orange-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('recent-pur-body')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <div class="overflow-y-auto max-h-[250px] border rounded bg-slate-50">
                                <table id="recent-pur-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-slate-800 text-white sticky top-0">
                                        <tr>
                                            <th class="p-1.5">#</th>
                                            <th class="p-1.5">التاريخ</th>
                                            <th class="p-1.5">المورد</th>
                                            <th class="p-1.5">الإجمالي</th>
                                            <th class="p-1.5">الحالة</th>
                                            <th class="p-1.5"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-pur-body" class="bg-white divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-file-invoice text-orange-500 me-1"></i>كشف حساب الموردين</h3>
                                <div class="flex gap-1">
                                    <button onclick="exportTableToCSV('supp-statement-table','كشف_حساب_الموردين')"
                                        class="text-[10px] bg-orange-50 text-orange-600 px-2 py-1 rounded hover:bg-orange-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('supp-statement-body')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <input type="text" placeholder="بحث بالكود أو الاسم..."
                                class="w-full p-1.5 border rounded text-xs mb-2 outline-none"
                                onkeyup="filterSuppStatement(this.value)">
                            <div class="overflow-y-auto max-h-[200px] border rounded bg-slate-50">
                                <table id="supp-statement-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-slate-200 sticky top-0">
                                        <tr>
                                            <th class="p-1.5">الكود</th>
                                            <th class="p-1.5">المورد</th>
                                            <th class="p-1.5">الإجمالي</th>
                                            <th class="p-1.5">المدفوع</th>
                                            <th class="p-1.5 text-red-600">المتبقي</th>
                                        </tr>
                                    </thead>
                                    <tbody id="supp-statement-body" class="bg-white divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 10. Purchase Orders -->
            <section id="purchase-orders" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <!-- الفاتورة (الجانب العملي) -->
                    <div
                        class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col gap-4">
                        <div class="flex justify-between items-center pb-4 border-b border-slate-50">
                            <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
                                <i class="fas fa-shopping-bag text-orange-500"></i>
                                <span id="po-title">طلب شراء جديد</span>
                                <span id="po-mode-badge"
                                    class="hidden text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full border border-red-200">مرتجع</span>
                            </h3>
                            <div class="flex items-center gap-4">
                                <label
                                    class="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-500 hover:text-red-600 transition">
                                    <input type="checkbox" id="is-return-po"
                                        class="w-4 h-4 text-red-600 rounded border-slate-300 focus:ring-red-500"
                                        onchange="togglePOMode()">
                                    <span>وضع المرتجع</span>
                                </label>
                                <div
                                    class="text-xs font-mono bg-orange-50 text-orange-700 px-3 py-1.5 rounded-lg border border-orange-100 font-black shadow-sm">
                                    PO-<span id="po-num">AUTO</span>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" id="po-edit-id">

                        <!-- الحقول الأساسية -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] uppercase tracking-wider text-slate-400 font-black mr-2">اختيار
                                    المورد</label>
                                <div class="po-supp-wrapper" style="position:relative;">
                                    <input type="text" id="po-supplier" placeholder="ابحث عن مورد أو أضف جديداً..."
                                        class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:ring-4 focus:ring-orange-500/10 outline-none transition-all"
                                        onfocus="onPOSupplierFocus()" oninput="onPOSupplierInput(this.value)"
                                        onkeydown="onPOSupplierKeydown(event)">
                                    <i class="fas fa-truck-loading pur-combobox-icon"></i>
                                    <input type="hidden" id="po-supplier-id" value="">
                                    <div id="po-supplier-suggestions" class="pur-suggestions"></div>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] uppercase tracking-wider text-slate-400 font-black mr-2">تاريخ
                                    الأمر</label>
                                <input type="date" id="po-date"
                                    class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:ring-4 focus:ring-orange-500/10 outline-none transition-all">
                            </div>
                        </div>

                        <!-- إدخال المنتجات -->
                        <div class="p-4 bg-slate-50/50 rounded-2xl border border-dashed border-slate-200">
                            <div class="flex flex-wrap md:flex-nowrap gap-3">
                                <div class="flex-1 min-w-[200px] pur-combobox-wrapper relative">
                                    <label class="text-[10px] font-black text-slate-400 block mb-1">ابحث عن منتج
                                        بالاسم</label>
                                    <div class="relative">
                                        <input type="text" id="po-product-input"
                                            class="w-full p-3 pr-10 border border-slate-200 rounded-xl text-sm shadow-sm outline-none focus:ring-4 focus:ring-orange-500/10 bg-white"
                                            placeholder="اكتب للبحث..." autocomplete="off" onfocus="onPOProductFocus()"
                                            oninput="onPOProductInput(this.value)"
                                            onkeydown="onPOProductKeydown(event)">
                                        <i
                                            class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-300"></i>
                                    </div>
                                    <input type="hidden" id="po-product-id" value="">
                                    <input type="hidden" id="po-product-type" value="product">
                                    <div id="po-suggestions" class="pur-suggestions"></div>
                                </div>
                                <div class="w-28">
                                    <label class="text-[10px] font-black text-slate-400 block mb-1">تكلفة الوحدة</label>
                                    <input type="number" id="pur-cost" placeholder="0.00"
                                        class="w-full p-3 border border-slate-200 rounded-xl text-center text-sm font-bold bg-white outline-none focus:ring-4 focus:ring-orange-500/10">
                                </div>
                                <div class="w-24">
                                    <label class="text-[10px] font-black text-slate-400 block mb-1">الكمية</label>
                                    <input type="number" id="po-qty" value="1" min="1"
                                        class="w-full p-3 border border-slate-200 rounded-xl text-center text-sm font-bold bg-white outline-none focus:ring-4 focus:ring-orange-500/10">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="addToPOCart()"
                                        class="h-[46px] w-[46px] bg-orange-600 text-white rounded-xl hover:bg-orange-700 transition shadow-lg shadow-orange-100 flex items-center justify-center active:scale-90">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- جدول العناصر -->
                        <div class="flex-1 border border-slate-100 rounded-2xl overflow-hidden bg-white shadow-inner">
                            <div class="max-h-[350px] overflow-y-auto">
                                <table class="w-full text-sm text-center">
                                    <thead class="bg-slate-800 text-slate-300 sticky top-0 z-10">
                                        <tr>
                                            <th class="p-4 font-black">الصنف</th>
                                            <th class="p-4 font-black">الكمية</th>
                                            <th class="p-4 font-black">التكلفة</th>
                                            <th class="p-4 font-black">الإجمالي</th>
                                            <th class="p-4 w-12"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="po-cart-body" class="divide-y divide-slate-50"></tbody>
                                </table>
                                <div id="po-cart-empty" class="p-16 text-center text-slate-300">
                                    <i class="fas fa-box-open text-4xl mb-3 block opacity-20"></i>
                                    <p class="text-[10px] italic">ابدأ بإضافة المنتجات للمسودة</p>
                                </div>
                            </div>
                        </div>

                        <!-- خلاصة الفاتورة والدفع -->
                        <div
                            class="bg-slate-900 border border-slate-800 text-white p-6 rounded-3xl shadow-2xl mt-auto relative overflow-hidden">
                            <div
                                class="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 rounded-full -mr-16 -mt-16 blur-3xl">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center text-slate-400 text-xs">
                                        <span>المجموع الفرعي:</span>
                                        <span id="po-subtotal" class="font-mono font-bold text-white">0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center text-slate-400 text-xs">
                                        <span>ضريبة القيمة المضافة (15%):</span>
                                        <span id="po-vat" class="font-mono font-bold text-orange-400">0.00</span>
                                    </div>
                                    <div class="pt-2 border-t border-slate-800">
                                        <label
                                            class="flex items-center gap-2 cursor-pointer text-[10px] text-slate-500 mb-2 hover:text-orange-400 transition">
                                            <input type="checkbox" id="po-disc-toggle"
                                                class="w-3 h-3 rounded bg-transparent border-slate-700"
                                                onchange="document.getElementById('po-disc-area').classList.toggle('hidden');renderPOCart()">
                                            <span>هل يوجد خصم مكتسب؟</span>
                                        </label>
                                        <div id="po-disc-area" class="hidden flex gap-2 animate-fadeIn">
                                            <select id="po-disc-type"
                                                class="bg-slate-800 text-[10px] p-2 rounded-lg border-none outline-none"
                                                onchange="renderPOCart()">
                                                <option value="amount">مبلغ ثابت</option>
                                                <option value="percent">نسبة %</option>
                                            </select>
                                            <input type="number" id="po-discount"
                                                class="bg-slate-800 text-sm p-2 rounded-lg border-none w-20 text-center font-bold outline-none ring-1 ring-slate-700"
                                                value="0" onchange="renderPOCart()">
                                        </div>
                                    </div>
                                    <div class="pt-4 flex justify-between items-end">
                                        <span class="text-lg font-bold">صافي القيمة:</span>
                                        <span id="po-total" class="text-4xl font-black text-orange-500">0.00</span>
                                    </div>
                                </div>
                                <div class="space-y-4 border-r border-slate-800 pr-8">
                                    <div class="flex p-1 bg-slate-800 rounded-xl mb-4">
                                        <button onclick="setPOPayType('cash')" id="po-pay-cash-btn"
                                            class="flex-1 py-2.5 rounded-lg text-[10px] font-black bg-orange-600 text-white shadow-lg transition transform active:scale-95">كاش</button>
                                        <button onclick="setPOPayType('credit')" id="po-pay-credit-btn"
                                            class="flex-1 py-2.5 rounded-lg text-[10px] font-black text-slate-500 hover:text-slate-300 transition transform active:scale-95">آجل
                                            / ذمم</button>
                                    </div>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div class="space-y-1">
                                            <label
                                                class="text-[10px] text-slate-500 font-bold uppercase block ml-1">حساب
                                                التحصيل/الدفع</label>
                                            <select id="po-method"
                                                class="w-full bg-slate-800 text-white p-2.5 rounded-xl border-none text-sm font-bold outline-none ring-1 ring-slate-700 focus:ring-orange-500 transition"></select>
                                        </div>
                                        <div id="po-credit-area" class="hidden space-y-1 animate-slideDown">
                                            <label
                                                class="text-[10px] text-slate-500 font-bold uppercase block ml-1">المبلغ
                                                المدفوع حـالياً</label>
                                            <input type="number" id="po-paid"
                                                class="w-full bg-slate-800 p-2.5 rounded-xl border-none text-orange-500 text-xl font-black outline-none ring-1 ring-slate-700 focus:ring-orange-500 transition"
                                                placeholder="0.00" oninput="calcPORemaining()">
                                        </div>
                                    </div>
                                    <div id="po-remaining-row"
                                        class="hidden flex justify-between items-center text-xs p-4 bg-red-500/10 rounded-2xl border border-red-500/10 animate-pulse">
                                        <span class="text-red-400 font-bold">متبقي للمورد:</span>
                                        <span id="po-remaining" class="text-2xl font-black text-red-500">0.00</span>
                                    </div>
                                    <button onclick="postPurchaseOrder()"
                                        class="w-full bg-orange-600 hover:bg-orange-500 text-white py-4 rounded-2xl font-black text-lg shadow-xl shadow-orange-900/40 transition-all hover:gap-4 active:scale-95 flex items-center justify-center gap-2">
                                        <i class="fas fa-check-double"></i> حفظ أمر الشراء
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- سجلات الموردين (الجانب المعلوماتي) -->
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <!-- سجل الطلبات -->
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[450px]">
                            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-50">
                                <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                                    <i class="fas fa-history text-orange-500"></i>
                                    سجل أوامر الشراء
                                </h3>
                                <div class="flex gap-1">
                                    <input type="text" placeholder="بحث..."
                                        class="p-1.5 px-3 border border-slate-200 rounded-lg text-[10px] w-28 outline-none focus:border-orange-500 transition"
                                        onkeyup="filterPOList(this.value)">
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar">
                                <table class="w-full text-[10px] text-center">
                                    <thead class="bg-slate-50 text-slate-500 sticky top-0 z-10">
                                        <tr>
                                            <th class="p-3 text-right">الأمر</th>
                                            <th class="p-3">المورد</th>
                                            <th class="p-3">الإجمالي</th>
                                            <th class="p-3"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-po-body" class="divide-y divide-slate-50 bg-white"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- مديونيات الموردين -->
                        <div
                            class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-3xl shadow-2xl text-white relative overflow-hidden group">
                            <div
                                class="absolute -bottom-4 -right-4 w-24 h-24 bg-orange-500 opacity-5 rounded-full blur-2xl group-hover:opacity-10 transition">
                            </div>

                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-sm flex items-center gap-2">
                                    <i class="fas fa-university text-orange-400"></i>
                                    كشف المديونيات
                                </h3>
                                <button onclick="showSection('suppliers')"
                                    class="text-[9px] bg-white/10 text-white px-3 py-1.5 rounded-full hover:bg-white/20 transition backdrop-blur-sm border border-white/5">فتح
                                    الحسابات</button>
                            </div>

                            <div class="relative mb-4">
                                <input type="text" placeholder="ابحث عن مورد..."
                                    class="w-full bg-white/5 border border-white/10 text-white p-2.5 rounded-xl text-[10px] outline-none focus:ring-2 focus:ring-orange-500/30 transition placeholder:text-slate-500"
                                    onkeyup="filterSuppStatement(this.value)">
                                <i
                                    class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 text-[10px]"></i>
                            </div>

                            <div
                                class="max-h-[250px] overflow-y-auto mb-4 bg-black/20 rounded-2xl border border-white/5 custom-scrollbar-light">
                                <table id="supp-statement-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-white/5 text-slate-400 sticky top-0 z-10">
                                        <tr>
                                            <th class="p-3">المورد</th>
                                            <th class="p-3">المدفوع</th>
                                            <th class="p-3 text-red-500">الباقي</th>
                                        </tr>
                                    </thead>
                                    <tbody id="supp-statement-body" class="divide-y divide-white/5"></tbody>
                                </table>
                            </div>
                            <div
                                class="p-4 bg-orange-500/10 rounded-2xl border border-orange-500/20 flex flex-col items-center">
                                <p class="text-[9px] text-orange-200/50 uppercase tracking-widest mb-1 font-bold">إجمالي
                                    مستحقات الموردين</p>
                                <p id="total-supplier-debt" class="text-3xl font-black text-orange-500 leading-none">
                                    0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 10. Suppliers (New) -->


            <section id="suppliers" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4">إضافة مورد</h3>
                        <form onsubmit="saveSupplier(event)" class="space-y-4">
                            <input type="hidden" id="supp-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم المورد</label><input type="text"
                                    id="supp-name" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">اسم الشركة</label><input type="text"
                                    id="supp-company"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">العنوان</label><input type="text"
                                    id="supp-address"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="supp-phone"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">الرقم الضريبي (اختياري)</label><input
                                    type="text" id="supp-vat"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">حفظ</button>
                                <button type="button" onclick="resetSupplierForm()"
                                    class="bg-slate-200 text-slate-600 px-4 rounded hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة الموردين</h3>
                            <button onclick="exportTableToCSV('suppliers-table', 'suppliers_list')"
                                class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs shadow flex items-center gap-1"><i
                                    class="fas fa-file-excel"></i> تصدير</button>
                        </div>
                        <table id="suppliers-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-50 text-slate-700">
                                <tr>
                                    <th class="p-3">الاسم</th>
                                    <th class="p-3">الهاتف</th>
                                    <th class="p-3">الضريبي</th>
                                    <th class="p-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="suppliers-list" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 14. Services Module (New) -->
            <section id="services" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                    <!-- الفاتورة -->
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <span>فاتورة خدمات</span>
                            </h3>
                            <div class="flex items-center gap-3">
                                <div
                                    class="text-xs font-mono bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-100">
                                    SRV-<span id="srv-num">Auto</span></div>
                            </div>
                        </div>

                        <!-- بيانات العميل والتاريخ -->
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div class="srv-cust-wrapper" style="position:relative;">
                                <input type="text" id="srv-customer" placeholder="اسم العميل (اختياري)"
                                    class="w-full p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"
                                    onfocus="onSrvCustomerFocus()" oninput="onSrvCustomerInput(this.value)"
                                    onkeydown="onSrvCustomerKeydown(event)">
                                <i class="fas fa-user-tag pur-combobox-icon"></i>
                                <input type="hidden" id="srv-customer-id" value="">
                                <div id="srv-customer-suggestions" class="pur-suggestions"></div>
                            </div>
                            <input type="date" id="srv-date"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none">
                        </div>

                        <!-- اختيار خدمة -->
                        <div class="flex gap-2 mb-3">
                            <div class="srv-combobox-wrapper" style="position:relative;flex:1;">
                                <input type="text" id="srv-product-input"
                                    placeholder="اكتب اسم الخدمة أو اختر من القائمة..." autocomplete="off"
                                    onfocus="onSrvProductFocus()" oninput="onSrvProductInput(this.value)"
                                    onkeydown="onSrvProductKeydown(event)"
                                    class="w-full p-2.5 border rounded-lg text-sm bg-white outline-none shadow-sm"
                                    style="padding-left:36px;">
                                <i class="fas fa-search"
                                    style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#94a3b8;pointer-events:none;font-size:13px;"></i>
                                <input type="hidden" id="srv-product-id" value="">
                                <div id="srv-suggestions" class="pur-suggestions"></div>
                            </div>
                            <input type="number" id="srv-price-input" placeholder="السعر"
                                class="w-24 p-2.5 border rounded-lg text-center outline-none">
                            <input type="number" id="srv-qty" value="1"
                                class="w-20 p-2.5 border rounded-lg text-center outline-none" min="1">
                            <button onclick="addToServiceCart()"
                                class="bg-purple-600 text-white px-4 rounded-lg hover:bg-purple-700 transition shadow"><i
                                    class="fas fa-plus"></i></button>
                        </div>

                        <!-- جدول السلة -->
                        <div class="flex-1 border rounded-lg overflow-y-auto mb-3 bg-slate-50">
                            <table class="w-full text-sm text-center relative">
                                <thead class="bg-slate-200 text-slate-700 sticky top-0">
                                    <tr>
                                        <th class="p-2">الخدمة</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">السعر</th>
                                        <th class="p-2">الإجمالي</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="srv-cart-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>

                        <!-- التوتالات والدفع -->
                        <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg">
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>المجموع:</span><span
                                    id="srv-subtotal">0.00</span></div>
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>الضريبة (<span
                                        id="srv-vat-rate">15</span>%):</span><span id="srv-vat">0.00</span></div>

                            <!-- الخصم المسموح به -->
                            <div class="flex items-center gap-2 mb-1 text-xs text-slate-400">
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" id="srv-disc-toggle"
                                        onchange="document.getElementById('srv-disc-area').classList.toggle('hidden');renderServiceCart()">
                                    <span>الخصم المسموح به</span>
                                </label>
                            </div>
                            <div id="srv-disc-area" class="hidden mb-2 flex gap-1 items-center">
                                <select id="srv-disc-type" class="p-1 text-black rounded text-[10px] w-16"
                                    onchange="renderServiceCart()">
                                    <option value="amount">مبلغ</option>
                                    <option value="percent">نسبة%</option>
                                </select>
                                <input type="number" id="srv-discount"
                                    class="w-16 p-1 text-black rounded text-center text-xs font-bold" value="0" min="0"
                                    onchange="renderServiceCart()">
                            </div>

                            <div class="flex justify-between items-center border-t border-slate-700 pt-2 mb-2">
                                <span class="text-slate-400 text-xs">الإجمالي:</span>
                                <div class="text-xl font-bold text-purple-400" id="srv-total">0.00</div>
                            </div>

                            <!-- نوع الدفع -->
                            <div class="flex gap-2 mb-2">
                                <button type="button" onclick="setSrvPayType('cash')" id="srv-pay-cash-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-purple-600 text-white">كاش</button>
                                <button type="button" onclick="setSrvPayType('credit')" id="srv-pay-credit-btn"
                                    class="flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300">آجل</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="text-[10px] text-slate-400 block mb-1">طريقة الدفع</label>
                                    <select id="srv-method" class="w-full p-1.5 text-black rounded text-sm"></select>
                                </div>
                                <div id="srv-credit-area" class="hidden">
                                    <label class="text-[10px] text-slate-400 block mb-1">المدفوع</label>
                                    <input type="number" id="srv-paid"
                                        class="w-full p-1.5 text-black rounded text-sm font-bold" placeholder="0.00"
                                        oninput="calcSrvRemaining()">
                                </div>
                            </div>
                            <div id="srv-remaining-row"
                                class="hidden flex justify-between text-xs text-yellow-400 mb-2">
                                <span>المتبقي:</span><span id="srv-remaining">0.00</span>
                            </div>
                            <button onclick="postServiceBill()"
                                class="w-full bg-purple-600 hover:bg-purple-500 text-white py-2 rounded-lg font-bold shadow-lg transition">حفظ
                                الفاتورة</button>
                        </div>
                    </div>

                    <!-- الشريط الجانبي -->
                    <div class="lg:col-span-1 flex flex-col gap-4">
                        <!-- سجل فواتير الخدمات -->
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-file-medical text-purple-500 me-1"></i>سجل فواتير الخدمات</h3>
                                <div class="flex gap-1">
                                    <input type="text" placeholder="بحث..."
                                        class="p-1 border rounded text-[10px] w-24 outline-none"
                                        onkeyup="filterServiceInvoiceList(this.value)">
                                    <button onclick="exportTableToCSV('recent-srv-table','فواتير_الخدمات')"
                                        class="text-[10px] bg-purple-50 text-purple-600 px-2 py-1 rounded hover:bg-purple-100"
                                        title="Excel"><i class="fas fa-file-excel"></i></button>
                                    <button onclick="printSection('recent-srv-body')"
                                        class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100"
                                        title="طباعة"><i class="fas fa-print"></i></button>
                                </div>
                            </div>
                            <div class="overflow-y-auto max-h-[250px] border rounded bg-slate-50">
                                <table id="recent-srv-table" class="w-full text-[10px] text-right">
                                    <thead class="bg-slate-800 text-white sticky top-0">
                                        <tr>
                                            <th class="p-1.5">#</th>
                                            <th class="p-1.5">التاريخ</th>
                                            <th class="p-1.5">العميل</th>
                                            <th class="p-1.5">الإجمالي</th>
                                            <th class="p-1.5">الحالة</th>
                                            <th class="p-1.5"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-srv-body" class="bg-white divide-y"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- إدارة الخدمات -->
                        <div class="bg-white p-4 rounded-xl shadow-sm flex-1">
                            <div class="flex justify-between items-center mb-3 border-b pb-2">
                                <h3 class="font-bold text-sm text-slate-800"><i
                                        class="fas fa-tools text-indigo-500 me-1"></i>إدارة الخدمات</h3>
                                <button
                                    onclick="document.getElementById('serv-id').value='';document.getElementById('serv-form').reset();"
                                    class="text-blue-600 text-xs"><i class="fas fa-plus"></i> جديد</button>
                            </div>
                            <form id="serv-form" onsubmit="saveService(event)" class="space-y-2 mb-3">
                                <input type="hidden" id="serv-id">
                                <input type="text" id="serv-name" required placeholder="اسم الخدمة *"
                                    class="w-full p-2 border rounded text-xs outline-none">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="serv-cost" placeholder="التكلفة"
                                        class="w-full p-2 border rounded text-xs outline-none">
                                    <input type="number" id="serv-price" required placeholder="سعر البيع *"
                                        class="w-full p-2 border rounded text-xs outline-none">
                                </div>
                                <input type="text" id="serv-desc" placeholder="الوصف"
                                    class="w-full p-2 border rounded text-xs outline-none">
                                <button type="submit"
                                    class="w-full bg-indigo-600 text-white py-1.5 rounded text-xs font-bold hover:bg-indigo-700 shadow">حفظ
                                    الخدمة</button>
                            </form>
                            <div class="overflow-y-auto max-h-[180px] border rounded bg-slate-50">
                                <table class="w-full text-[10px] text-right">
                                    <thead class="bg-indigo-50 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-1.5">الخدمة</th>
                                            <th class="p-1.5">التكلفة</th>
                                            <th class="p-1.5">البيع</th>
                                            <th class="p-1.5">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="services-list" class="divide-y divide-slate-200 bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 15. Expenses Module (New) -->
            <section id="expenses" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Add Expense -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">تسجيل مصروف جديد</h3>
                        <form onsubmit="postExpense(event)" class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">بيان المصروف</label><input
                                    type="text" id="exp-desc" required
                                    class="w-full p-2.5 border rounded-lg outline-none">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">المبلغ</label><input
                                        type="number" id="exp-amount" required step="0.01"
                                        class="w-full p-2.5 border rounded-lg outline-none"></div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">التصنيف</label>
                                    <select id="exp-cat"
                                        class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white">
                                        <!-- Categories -->
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">طريقة الدفع</label>
                                <select id="exp-method"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <button type="submit"
                                class="w-full bg-red-600 text-white py-2 rounded font-bold hover:bg-red-700 shadow">تسجيل
                                المصروف</button>
                        </form>
                    </div>

                    <!-- Expenses List -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">سجل المصروفات</h3>
                            <div class="text-xs bg-red-50 text-red-700 px-2 py-1 rounded">الإجمالي: <span
                                    id="exp-list-total" class="font-bold">0.00</span></div>
                        </div>
                        <div class="flex-1 overflow-y-auto border rounded-lg bg-slate-50 mb-3">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-100 font-bold sticky top-0">
                                    <tr>
                                        <th class="p-2">التاريخ</th>
                                        <th class="p-2">البيان</th>
                                        <th class="p-2">المبلغ</th>
                                        <th class="p-2">التصنيف</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-list" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 17. HR Module (New) -->
            <section id="hr" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Employee Management -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">إدارة الموظفين</h3>
                            <button
                                onclick="document.getElementById('emp-id').value='';document.getElementById('emp-form').reset();document.getElementById('emp-photo-preview').classList.add('hidden');"
                                class="text-blue-600 text-xs"><i class="fas fa-plus"></i> جديد</button>
                        </div>
                        <form id="emp-form" onsubmit="saveEmployee(event)" class="space-y-3 mb-6">
                            <input type="hidden" id="emp-id">
                            <div class="flex gap-4">
                                <div class="w-24 h-24 bg-slate-100 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center relative overflow-hidden cursor-pointer"
                                    onclick="document.getElementById('emp-photo').click()">
                                    <img id="emp-photo-preview"
                                        class="absolute inset-0 w-full h-full object-cover hidden">
                                    <i class="fas fa-camera text-slate-400"></i>
                                    <input type="file" id="emp-photo" class="hidden" accept="image/*"
                                        onchange="previewEmpPhoto(this)">
                                </div>
                                <div class="flex-1 space-y-2">
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">الاسم</label><input
                                            type="text" id="emp-name" required
                                            class="w-full p-2 border rounded outline-none"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">الوظيفة /
                                            الرتبة</label><input type="text" id="emp-role" required
                                            class="w-full p-2 border rounded outline-none"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">الراتب
                                        الأساسي</label><input type="number" id="emp-salary" required
                                        class="w-full p-2 border rounded outline-none"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">البدلات</label><input
                                        type="number" id="emp-allowance" class="w-full p-2 border rounded outline-none">
                                </div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">الهاتف</label><input
                                        type="text" id="emp-phone" class="w-full p-2 border rounded outline-none"></div>
                            </div>
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 shadow">حفظ
                                بيانات الموظف</button>
                        </form>

                        <div class="border-t pt-4">
                            <h4 class="font-bold text-sm text-slate-700 mb-2">قائمة الموظفين</h4>
                            <div class="overflow-y-auto max-h-[250px] border rounded bg-slate-50">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-indigo-50 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">موظف</th>
                                            <th class="p-2">الوظيفة</th>
                                            <th class="p-2">أساسي + بدلات</th>
                                            <th class="p-2">الإجمالي</th>
                                            <th class="p-2">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employees-list" class="divide-y divide-slate-200 bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Actions & Payroll -->
                    <div class="flex flex-col gap-6 h-full">



                    </div>
                </div>
            </section>

            <!-- 13. Installment Management (New) -->
            <section id="installments" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- New Installment Invoice -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">إنشاء فاتورة تقسيط</h3>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">العميل</label><select
                                    id="inst-customer"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">المنتج</label>
                                <select id="inst-product"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"
                                    onchange="updateInstPrice(this)"></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">سعر البيع (يتضمن
                                        الفائدة)</label><input type="number" id="inst-price"
                                        class="w-full p-2.5 border rounded-lg outline-none" onkeyup="calcInst()"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">الدفعة
                                        المقدمة</label><input type="number" id="inst-down"
                                        class="w-full p-2.5 border rounded-lg outline-none" onkeyup="calcInst()"
                                        placeholder="0"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">عدد الأقساط
                                        (شهر)</label><input type="number" id="inst-count"
                                        class="w-full p-2.5 border rounded-lg outline-none" value="12"
                                        onkeyup="calcInst()">
                                </div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">قيمة القسط
                                        الشهري</label><input type="number" id="inst-monthly"
                                        class="w-full p-2.5 border rounded-lg bg-slate-100 font-bold text-blue-600 outline-none"
                                        readonly></div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">طريقة دفع المقدم</label>
                                <select id="inst-method"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <button onclick="createInstallmentPlan()"
                                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-lg mt-2 transition transform active:scale-95">إنشاء
                                فاتورة التقسيط</button>
                        </div>
                    </div>

                    <!-- Upcoming Installments -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col h-[600px]">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">الأقساط والتحصيل</h3>
                            <div class="flex gap-2">
                                <button onclick="renderInstallments()"
                                    class="bg-slate-100 text-slate-600 px-3 py-1 rounded hover:bg-slate-200 text-xs"><i
                                        class="fas fa-sync"></i> تحديث</button>
                                <button onclick="exportTableToCSV('installments-table', 'installments_list')"
                                    class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs shadow flex items-center gap-1"><i
                                        class="fas fa-file-excel"></i> تصدير</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="text" placeholder="بحث باسم العميل..."
                                class="p-2 border rounded text-sm w-full focus:border-blue-500 outline-none bg-slate-50"
                                onkeyup="filterInstallments(this.value)">
                        </div>
                        <div class="flex-1 overflow-y-auto border rounded-lg bg-slate-50">
                            <table id="installments-summary-table"
                                class="w-full text-sm text-right relative border-collapse">
                                <thead class="bg-indigo-100 text-indigo-900 sticky top-0 font-bold">
                                    <tr>
                                        <th class="p-3">العميل</th>
                                        <th class="p-3">التلفون</th>
                                        <th class="p-3">رقم الفاتورة</th>
                                        <th class="p-3">إجمالي الفاتورة</th>
                                        <th class="p-3">عدد الأقساط</th>
                                        <th class="p-3 text-emerald-600">المدفوع</th>
                                        <th class="p-3 text-red-600">المتبقي</th>
                                        <th class="p-3">القسط القادم</th>
                                        <th class="p-3 text-center">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody id="installments-summary-list" class="divide-y divide-slate-200 bg-white">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Installment Details Modal -->
            <div id="inst-details-modal"
                class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
                <div
                    class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden animate-slide-up">
                    <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
                        <h3 class="font-bold" id="inst-details-title">تفاصيل الأقساط</h3>
                        <button onclick="document.getElementById('inst-details-modal').classList.add('hidden')"
                            class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-4 overflow-y-auto flex-1">
                        <div id="inst-details-info"
                            class="grid grid-cols-2 gap-4 mb-4 bg-slate-50 p-3 rounded-lg text-sm">
                        </div>
                        <div class="border rounded-lg overflow-hidden">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-100 font-bold">
                                    <tr>
                                        <th class="p-2.5">رقم القسط</th>
                                        <th class="p-2.5">تاريخ الاستحقاق</th>
                                        <th class="p-2.5">المبلغ</th>
                                        <th class="p-2.5">الحالة</th>
                                        <th class="p-2.5 text-center">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody id="inst-details-list" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 border-t flex justify-end">
                        <button onclick="document.getElementById('inst-details-modal').classList.add('hidden')"
                            class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold">إغلاق</button>
                    </div>
                </div>
            </div>

            <!-- Installment Customers Sub-Module -->
            <section id="installment_customers" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-user-plus text-indigo-500 me-2"></i>تسجيل عميل تقسيط</h3>
                        <form onsubmit="saveInstCustomer(event)" class="space-y-3">
                            <input type="hidden" id="inst-cust-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم العميل</label><input type="text"
                                    id="inst-cust-name" required class="w-full p-2 border rounded outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="inst-cust-phone" class="w-full p-2 border rounded outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">العنوان</label><input type="text"
                                    id="inst-cust-address" class="w-full p-2 border rounded outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهوية</label><input type="text"
                                    id="inst-cust-nid" class="w-full p-2 border rounded outline-none"></div>
                            <button type="submit"
                                class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">حفظ
                                العميل</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة عملاء التقسيط</h3>
                            <div class="flex gap-2">
                                <input type="text" placeholder="بحث بالكود أو الاسم..."
                                    class="p-2 border rounded text-sm w-48 outline-none"
                                    onkeyup="filterInstCust(this.value)">
                                <button onclick="exportTableToCSV('inst-cust-table','عملاء_التقسيط')"
                                    class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                        class="fas fa-file-excel me-1"></i>Excel</button>
                                <button onclick="printSection('inst-cust-list')"
                                    class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                        class="fas fa-print me-1"></i>طباعة</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto border rounded">
                            <table id="inst-cust-table" class="w-full text-sm text-right">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-2">الكود</th>
                                        <th class="p-2">الاسم</th>
                                        <th class="p-2">الهاتف</th>
                                        <th class="p-2">الهوية</th>
                                        <th class="p-2">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="inst-cust-list" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Installment Payment Statement Sub-Module -->
            <section id="installment_payments" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-receipt text-purple-500 me-2"></i>كشف
                            حساب الدفعات</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInstPayments(this.value)">
                            <button onclick="exportTableToCSV('inst-pay-table','كشف_حساب_الدفعات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inst-pay-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded">
                        <table id="inst-pay-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white">
                                <tr>
                                    <th class="p-3">الكود</th>
                                    <th class="p-3">العميل</th>
                                    <th class="p-3">إجمالي العقد</th>
                                    <th class="p-3 text-emerald-400">المدفوع</th>
                                    <th class="p-3 text-yellow-400">المستحق</th>
                                    <th class="p-3 text-red-400">المتأخر</th>
                                    <th class="p-3">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="inst-pay-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 12. Customers (New) -->
            <section id="customers" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4">إضافة عميل</h3>
                        <form onsubmit="saveCustomer(event)" class="space-y-4">
                            <input type="hidden" id="cust-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم العميل</label><input type="text"
                                    id="cust-name" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">اسم الشركة</label><input type="text"
                                    id="cust-company"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">العنوان</label><input type="text"
                                    id="cust-address"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="cust-phone"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">الرقم الضريبي (اختياري)</label><input
                                    type="text" id="cust-vat"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">حفظ</button>
                                <button type="button" onclick="resetCustomerForm()"
                                    class="bg-slate-200 text-slate-600 px-4 rounded hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة العملاء</h3>
                            <button onclick="exportTableToCSV('customers-table', 'customers_list')"
                                class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs shadow flex items-center gap-1"><i
                                    class="fas fa-file-excel"></i> تصدير</button>
                        </div>
                        <table id="customers-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-50 text-slate-700">
                                <tr>
                                    <th class="p-3">الاسم</th>
                                    <th class="p-3">الشركة</th>
                                    <th class="p-3">الهاتف</th>
                                    <th class="p-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="customers-list" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>


            <!-- 6. Accounts Tree -->
            <section id="accounts_tree" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <!-- Account Form -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2"><span id="coa-form-title">إضافة
                                حساب جديد</span></h3>
                        <form id="coa-form" onsubmit="saveAccount(event)" class="space-y-4">
                            <input type="hidden" id="coa-id">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">اسم الحساب</label>
                                <input type="text" id="coa-name" required
                                    class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">الكود (اختياري)</label>
                                    <input type="text" id="coa-code" placeholder="تلقائي"
                                        class="w-full p-2.5 border rounded-lg outline-none font-mono text-sm bg-slate-50">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">نوع الحساب</label>
                                    <input type="text" id="coa-type" list="coa-type-list" placeholder="اكتب أو اختر..."
                                        class="w-full p-2.5 border rounded-lg outline-none text-sm bg-slate-50 focus:bg-white">
                                    <datalist id="coa-type-list">
                                        <option value="asset">أصل</option>
                                        <option value="liability">التزام</option>
                                        <option value="equity">حقوق ملكية</option>
                                        <option value="revenue">إيراد</option>
                                        <option value="expense">مصروف</option>
                                    </datalist>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">الحساب الرئيسي
                                    (اختياري)</label>
                                <input type="text" id="coa-parent" list="coa-parent-list"
                                    placeholder="اكتب كود أو اسم الحساب..."
                                    class="w-full p-2.5 border rounded-lg outline-none text-sm bg-slate-50 focus:bg-white">
                                <datalist id="coa-parent-list">
                                    <option value="">-- بدون (حساب رئيسي) --</option>
                                </datalist>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">الرصيد الافتتاحي</label>
                                <input type="number" id="coa-balance" value="0" step="0.01"
                                    class="w-full p-2.5 border rounded-lg outline-none font-bold text-blue-600">
                            </div>
                            <div class="flex gap-2 pt-2">
                                <button type="submit"
                                    class="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg font-bold hover:bg-indigo-700 shadow shadow-indigo-200">حفظ
                                    الحساب</button>
                                <button type="button" onclick="resetCoAForm()"
                                    class="bg-slate-100 text-slate-600 px-4 py-2.5 rounded-lg font-bold hover:bg-slate-200">إلغاء</button>
                            </div>
                        </form>
                    </div>

                    <!-- Accounts List -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm flex flex-col h-[600px]">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">الدليل المحاسبي</h3>
                            <div class="flex gap-2">
                                <input type="text" placeholder="بحث..."
                                    class="p-1.5 border rounded text-xs w-32 focus:border-blue-500 outline-none"
                                    onkeyup="filterAccounts(this.value)">
                                <button onclick="exportCoA()"
                                    class="bg-green-50 text-green-600 px-3 py-1.5 rounded-lg text-xs hover:bg-green-100"
                                    title="Excel"><i class="fas fa-file-excel"></i></button>
                            </div>
                        </div>
                        <div
                            style="overflow-x:auto; overflow-y:auto; flex:1; border:1px solid #e2e8f0; border-radius:8px; background:#fff;">
                            <table id="coa-table" dir="rtl"
                                style="width:100%; min-width:600px; table-layout:fixed; border-collapse:collapse; font-size:11px;">
                                <thead>
                                    <tr style="background:#1e293b; color:#fff; position:sticky; top:0; z-index:10;">
                                        <th style="width:30px; padding:7px 4px; text-align:center; opacity:0.5;"><i
                                                class="fas fa-hashtag" style="font-size:10px;"></i></th>
                                        <th
                                            style="width:70px; padding:7px 6px; text-align:right; font-family:monospace;">
                                            الكود</th>
                                        <th style="padding:7px 6px; text-align:right;">اسم الحساب</th>
                                        <th style="width:70px; padding:7px 6px; text-align:right;">النوع</th>
                                        <th style="width:90px; padding:7px 6px; text-align:center;">الرصيد</th>
                                        <th style="width:100px; padding:7px 6px; text-align:center;">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody id="coa-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 7. Inventory -->
            <section id="inventory" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <h3 class="font-bold text-lg text-slate-800 mb-4"><span id="prod-form-title">إضافة صنف جديد</span>
                    </h3>
                    <form onsubmit="saveProduct(event)" class="flex flex-wrap gap-3 items-end">
                        <input type="hidden" id="prod-id">
                        <div class="flex-1 min-w-[200px]">
                            <label class="text-xs text-slate-500 mb-1 block">اسم المنتج</label>
                            <input type="text" id="new-prod-name" required
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-slate-500 mb-1 block">سعر البيع</label>
                            <input type="number" id="new-prod-price" required step="0.01"
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-slate-500 mb-1 block">التكلفة</label>
                            <input type="number" id="new-prod-cost" step="0.01"
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-slate-500 mb-1 block">الرصيد</label>
                            <input type="number" id="new-prod-stock"
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="flex gap-1">
                            <button type="submit"
                                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 h-[42px] mb-[1px] shadow">حفظ</button>
                            <button type="button" onclick="resetProductForm()"
                                class="bg-slate-200 text-slate-600 px-3 py-2 rounded hover:bg-slate-300 h-[42px] mb-[1px]">إلغاء</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">قائمة الأصناف</h3>
                        <input type="text" placeholder="بحث عن منتج..."
                            class="p-2 border rounded text-sm w-48 focus:border-blue-500 outline-none"
                            onkeyup="filterInventory(this.value)">
                    </div>
                    <table class="w-full text-sm text-right">
                        <thead class="bg-slate-50 text-slate-700">
                            <tr>
                                <th class="p-3 rounded-tr-lg">المنتج</th>
                                <th class="p-3">سعر البيع</th>
                                <th class="p-3">التكلفة</th>
                                <th class="p-3">الرصيد</th>
                                <th class="p-3 rounded-tl-lg">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- 8. Reports -->
            <section id="reports" class="section-content">
                <div class="max-w-6xl mx-auto">
                    <!-- Filters -->
                    <div
                        class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-wrap gap-4 items-end border border-slate-200">
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">من تاريخ</label>
                            <input type="date" id="rpt-start-date"
                                class="p-2 border rounded text-sm outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">إلى تاريخ</label>
                            <input type="date" id="rpt-end-date"
                                class="p-2 border rounded text-sm outline-none focus:border-blue-500">
                        </div>
                        <button onclick="renderReports()"
                            class="bg-slate-800 text-white px-6 py-2 rounded text-sm hover:bg-slate-700 shadow">تحديث
                            التقرير</button>
                    </div>

                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 col-span-1 md:col-span-2 mb-6">
                        <h3 class="font-bold text-center border-b pb-3 mb-4 text-slate-800 text-lg">ملخص العمليات</h3>
                        <div class="grid grid-cols-3 gap-4 text-center text-sm">
                            <div class="bg-blue-50 p-3 rounded"><strong>إجمالي المبيعات</strong>
                                <div id="rpt-sales-total" class="text-lg text-blue-700 mt-1">0.00</div>
                            </div>
                            <div class="bg-orange-50 p-3 rounded"><strong>إجمالي المشتريات</strong>
                                <div id="rpt-pur-total" class="text-lg text-orange-700 mt-1">0.00</div>
                            </div>
                            <div class="bg-red-50 p-3 rounded"><strong>إجمالي المصروفات</strong>
                                <div id="rpt-exp-total" class="text-lg text-red-700 mt-1">0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-center border-b pb-3 mb-4 text-slate-800 text-lg">قائمة الدخل</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between font-bold text-blue-700 bg-blue-50 p-2 rounded">
                                    <span>إيرادات النشاط</span><span id="is-rev">0.00</span>
                                </div>
                                <div class="flex justify-between text-red-500 px-2"><span>(-) تكلفة النشاط</span><span
                                        id="is-cogs">0.00</span></div>
                                <div class="flex justify-between font-bold border-t pt-2 px-2"><span>مجمل
                                        الربح</span><span id="is-gross">0.00</span></div>
                                <div class="flex justify-between text-red-500 px-2"><span>(-) المصروفات
                                        العمومية</span><span id="is-exp">0.00</span></div>
                                <div
                                    class="bg-slate-900 text-white p-3 rounded-lg flex justify-between text-lg font-bold mt-4">
                                    <span>صافي الربح</span><span id="is-net">0.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-[500px] flex flex-col">
                            <h3 class="font-bold text-center border-b pb-3 mb-4 text-slate-800 text-lg">ميزان المراجعة
                                (تراكمي)</h3>
                            <div class="overflow-y-auto flex-1">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-slate-100 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">الحساب</th>
                                            <th class="p-2">مدين</th>
                                            <th class="p-2">دائن</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trial-balance-body" class="divide-y"></tbody>
                                </table>
                            </div>
                            <div class="bg-slate-100 p-2 rounded font-bold text-xs flex justify-between mt-2">
                                <span>الإجمالي</span>
                                <span class="text-emerald-600" id="tb-total-dr">0.00</span>
                                <span class="text-red-600" id="tb-total-cr">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>


            <!-- ===== INVOICES MODULE ===== -->
            <section id="invoices" class="section-content">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center cursor-pointer hover:shadow-md transition"
                        onclick="showSection('inv_pos')">
                        <i class="fas fa-cash-register text-3xl text-purple-500 mb-2"></i>
                        <div class="text-2xl font-bold text-purple-600" id="inv-count-pos">0</div>
                        <div class="text-xs text-slate-500">فواتير نقاط البيع</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center cursor-pointer hover:shadow-md transition"
                        onclick="showSection('inv_sales')">
                        <i class="fas fa-file-alt text-3xl text-blue-500 mb-2"></i>
                        <div class="text-2xl font-bold text-blue-600" id="inv-count-sales">0</div>
                        <div class="text-xs text-slate-500">فواتير المبيعات</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center cursor-pointer hover:shadow-md transition"
                        onclick="showSection('inv_purchases')">
                        <i class="fas fa-file-import text-3xl text-orange-500 mb-2"></i>
                        <div class="text-2xl font-bold text-orange-600" id="inv-count-pur">0</div>
                        <div class="text-xs text-slate-500">فواتير المشتريات</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center cursor-pointer hover:shadow-md transition"
                        onclick="showSection('inv_services')">
                        <i class="fas fa-file-medical text-3xl text-teal-500 mb-2"></i>
                        <div class="text-2xl font-bold text-teal-600" id="inv-count-svc">0</div>
                        <div class="text-xs text-slate-500">فواتير الخدمات</div>
                    </div>
                </div>
            </section>

            <!-- فواتير نقاط البيع -->
            <!-- inv_pos hidden - merged into inv_sales -->
            <section id="inv_pos" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm text-center text-slate-400"><i
                        class="fas fa-info-circle me-2"></i>تم دمج فواتير نقاط البيع مع فواتير المبيعات <button
                        onclick="showSection('inv_sales')" class="text-blue-500 underline">عرض فواتير المبيعات</button>
                </div>
            </section>

            <!-- ===== فواتير المبيعات (Enhanced) ===== -->
            <section id="inv_sales" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-alt text-blue-500 me-2"></i>فواتير المبيعات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="inv-sales-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvSales()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="inv-sales-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvSales()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-sales-body',this.value)">
                            <button onclick="exportTableToCSV('inv-sales-table','فواتير_المبيعات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-sales-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="inv-sales-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="inv-sales-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-sales-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-sales-rem">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-sales-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-sales-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== فواتير المشتريات (Enhanced) ===== -->
            <section id="inv_quotations" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-alt text-blue-500 me-2"></i>عروض
                            الأسعار</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="inv-quotations-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvQuotations()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="inv-quotations-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvQuotations()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-quotations-body',this.value)">
                            <button onclick="exportTableToCSV('inv-quotations-table','فواتير_المبيعات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-quotations-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="inv-quotations-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="inv-quotations-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-quotations-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-quotations-rem">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-quotations-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-quotations-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== فواتير المشتريات (Enhanced) ===== -->


            <!-- ===== فواتير المشتريات (Enhanced) ===== -->
            <section id="inv_purchases" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-import text-orange-500 me-2"></i>فواتير المشتريات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="inv-pur-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvPurchases()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="inv-pur-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvPurchases()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-pur-body',this.value)">
                            <button onclick="exportTableToCSV('inv-pur-table','فواتير_المشتريات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-pur-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-orange-600" id="inv-pur-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="inv-pur-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-pur-paid">0.00</div>
                            <div class="text-xs text-slate-500">المدفوع</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-pur-rem">0.00</div>
                            <div class="text-xs text-slate-500">المستحق علينا</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-pur-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">المورد</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-pur-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== فواتير الخدمات (Enhanced) ===== -->
            <section id="inv_purchase_orders" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-import text-orange-500 me-2"></i>أوامر الشراء</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="inv-po-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvPurchaseOrders()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="inv-po-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvPurchaseOrders()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-po-body',this.value)">
                            <button onclick="exportTableToCSV('inv-po-table','فواتير_المشتريات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-po-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-orange-600" id="inv-po-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="inv-po-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-po-paid">0.00</div>
                            <div class="text-xs text-slate-500">المدفوع</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-po-rem">0.00</div>
                            <div class="text-xs text-slate-500">المستحق علينا</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-po-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">المورد</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-po-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== فواتير الخدمات (Enhanced) ===== -->


            <!-- ===== فواتير الخدمات (Enhanced) ===== -->
            <section id="inv_services" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-medical text-teal-500 me-2"></i>فواتير الخدمات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="inv-svc-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvServices()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="inv-svc-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderInvServices()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-svc-body',this.value)">
                            <button onclick="exportTableToCSV('inv-svc-table','فواتير_الخدمات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-svc-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-teal-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-teal-600" id="inv-svc-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-cyan-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-cyan-600" id="inv-svc-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-svc-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-svc-rem">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-svc-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-svc-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== فواتير التقسيط (Enhanced) ===== -->
            <section id="inv_installments" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-contract text-indigo-500 me-2"></i>فواتير التقسيط</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('inv-inst-body',this.value)">
                            <button onclick="exportTableToCSV('inv-inst-table','فواتير_التقسيط')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inv-inst-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="inv-inst-count">0</div>
                            <div class="text-xs text-slate-500">عدد العقود</div>
                        </div>
                        <div class="bg-violet-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-violet-600" id="inv-inst-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="inv-inst-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="inv-inst-rem">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inv-inst-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المقدم</th>
                                    <th class="p-2.5">المحصّل</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inv-inst-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== كشف حساب العملاء (مستقل) ===== -->
            <section id="cust_statement" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-invoice-dollar text-blue-500 me-2"></i>كشف حساب العملاء</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <select id="cust-stmt-filter" class="p-2 border rounded text-sm outline-none"
                                onchange="renderCustStatementFull()">
                                <option value="">كل العملاء</option>
                            </select>
                            <label class="text-xs text-slate-500">من</label><input type="date" id="cust-stmt-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderCustStatementFull()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="cust-stmt-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderCustStatementFull()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('cust-stmt-body',this.value)">
                            <button onclick="exportTableToCSV('cust-stmt-table','كشف_حساب_العملاء')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('cust-stmt-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[550px] overflow-y-auto">
                        <table id="cust-stmt-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">النوع</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">إجمالي الفاتورة</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="cust-stmt-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 bg-slate-100 p-4 rounded-lg grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-lg font-bold text-indigo-600" id="cust-stmt-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-blue-600" id="cust-stmt-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الفواتير</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-emerald-600" id="cust-stmt-paid">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المدفوع</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-red-600" id="cust-stmt-remaining">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المتبقي</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== كشف حساب الموردين (مستقل) ===== -->
            <section id="supp_statement" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-invoice text-orange-500 me-2"></i>كشف حساب الموردين</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <select id="supp-stmt-filter" class="p-2 border rounded text-sm outline-none"
                                onchange="renderSuppStatementFull()">
                                <option value="">كل الموردين</option>
                            </select>
                            <label class="text-xs text-slate-500">من</label><input type="date" id="supp-stmt-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderSuppStatementFull()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="supp-stmt-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderSuppStatementFull()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-40 outline-none"
                                onkeyup="filterInvTable('supp-stmt-body',this.value)">
                            <button onclick="exportTableToCSV('supp-stmt-table','كشف_حساب_الموردين')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('supp-stmt-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[550px] overflow-y-auto">
                        <table id="supp-stmt-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">المورد</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">إجمالي الفاتورة</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="supp-stmt-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 bg-slate-100 p-4 rounded-lg grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-lg font-bold text-indigo-600" id="supp-stmt-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-orange-600" id="supp-stmt-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الفواتير</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-emerald-600" id="supp-stmt-paid">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المدفوع</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-red-600" id="supp-stmt-remaining">0.00</div>
                            <div class="text-xs text-slate-500">المستحق علينا</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== كشف حساب الخدمات ===== -->
            <section id="svc_statement" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-file-alt text-teal-500 me-2"></i>كشف
                            حساب الخدمات</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('svc-stmt-body',this.value)">
                            <button onclick="exportTableToCSV('svc-stmt-table','كشف_حساب_الخدمات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('svc-stmt-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="svc-stmt-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                    <th class="p-2.5"></th>
                                </tr>
                            </thead>
                            <tbody id="svc-stmt-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== الأقساط والتحصيل ===== -->
            <section id="inst_collection" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-hand-holding-usd text-indigo-500 me-2"></i>الأقساط والتحصيل</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث باسم العميل أو رقم التلفون..."
                                class="p-2 border rounded text-sm w-56 outline-none"
                                onkeyup="filterInvTable('inst-collect-body',this.value)">
                            <button onclick="exportTableToCSV('inst-collect-table','الأقساط_والتحصيل')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inst-collect-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[550px] overflow-y-auto">
                        <table id="inst-collect-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">التلفون</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">إجمالي العقد</th>
                                    <th class="p-2.5">عدد الأقساط</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                    <th class="p-2.5">القسط القادم</th>
                                    <th class="p-2.5"></th>
                                </tr>
                            </thead>
                            <tbody id="inst-collect-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== سندات الصرف ===== -->
            <section id="expense_vouchers" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-receipt text-red-500 me-2"></i>سندات
                            الصرف</h3>
                        <div class="flex gap-2">
                            <input type="date" id="exp-voucher-from" class="p-2 border rounded text-xs outline-none"
                                onchange="renderExpenseVouchers()">
                            <input type="date" id="exp-voucher-to" class="p-2 border rounded text-xs outline-none"
                                onchange="renderExpenseVouchers()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-36 outline-none"
                                onkeyup="filterInvTable('exp-voucher-body',this.value)">
                            <button onclick="exportTableToCSV('exp-voucher-table','سندات_الصرف')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('exp-voucher-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="exp-voucher-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">#</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">البيان</th>
                                    <th class="p-2.5">الفئة</th>
                                    <th class="p-2.5">المبلغ</th>
                                    <th class="p-2.5">طريقة الصرف</th>
                                </tr>
                            </thead>
                            <tbody id="exp-voucher-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 bg-red-50 p-3 rounded-lg text-center">
                        <span class="text-sm text-slate-600">إجمالي المصروفات: </span>
                        <span class="text-xl font-bold text-red-600" id="exp-voucher-total">0.00</span>
                    </div>
                </div>
            </section>

            <!-- ===== الإيرادات (سندات القبض) ===== -->
            <section id="incomes" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Add Income -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2"><i
                                class="fas fa-hand-holding-usd text-emerald-500 me-2"></i>تسجيل سند قبض إيراد</h3>
                        <form onsubmit="postIncome(event)" class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">بيان الإيراد /
                                    القبض</label><input type="text" id="inc-desc" required
                                    class="w-full p-2.5 border rounded-lg outline-none"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">المبلغ</label><input
                                        type="number" id="inc-amount" required step="0.01"
                                        class="w-full p-2.5 border rounded-lg outline-none"></div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">النوع</label>
                                    <select id="inc-cat"
                                        class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white">
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">طريقة القبض</label>
                                <select id="inc-method"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <button type="submit"
                                class="w-full bg-emerald-600 text-white py-2 rounded font-bold hover:bg-emerald-700 shadow">حفظ
                                سند القبض</button>
                        </form>
                    </div>

                    <!-- Incomes List -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">آخر سندات القبض</h3>
                            <div class="text-xs bg-emerald-50 text-emerald-700 px-2 py-1 rounded">الإجمالي: <span
                                    id="inc-list-total" class="font-bold">0.00</span></div>
                        </div>
                        <div class="flex-1 overflow-y-auto border rounded-lg bg-slate-50 mb-3">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-100 font-bold sticky top-0">
                                    <tr>
                                        <th class="p-2">التاريخ</th>
                                        <th class="p-2">البيان</th>
                                        <th class="p-2">المبلغ</th>
                                        <th class="p-2">النوع</th>
                                    </tr>
                                </thead>
                                <tbody id="incomes-list" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== سجل سندات القبض ===== -->
            <section id="income_vouchers" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-receipt text-emerald-500 me-2"></i>سجل
                            سندات القبض</h3>
                        <div class="flex gap-2">
                            <input type="date" id="inc-voucher-from" class="p-2 border rounded text-xs outline-none"
                                onchange="renderIncomeVouchers()">
                            <input type="date" id="inc-voucher-to" class="p-2 border rounded text-xs outline-none"
                                onchange="renderIncomeVouchers()">
                            <input type="text" placeholder="بحث..." class="p-2 border rounded text-sm w-36 outline-none"
                                onkeyup="filterInvTable('inc-voucher-body',this.value)">
                            <button onclick="exportTableToCSV('inc-voucher-table','سندات_القبض')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('inc-voucher-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="inc-voucher-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">#</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">البيان</th>
                                    <th class="p-2.5">النوع</th>
                                    <th class="p-2.5">المبلغ</th>
                                    <th class="p-2.5">طريقة القبض</th>
                                </tr>
                            </thead>
                            <tbody id="inc-voucher-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 bg-emerald-50 p-3 rounded-lg text-center">
                        <span class="text-sm text-slate-600">إجمالي المقبوضات: </span>
                        <span class="text-xl font-bold text-emerald-600" id="inc-voucher-total">0.00</span>
                    </div>
                </div>
            </section>



            <!-- ===== HR: الإجراءات ===== -->
            <section id="hr_actions" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-clipboard-list text-amber-500 me-2"></i>تسجيل إجراء</h3>
                        <div class="space-y-3">
                            <div><label class="text-xs text-slate-500 mb-1 block">الموظف</label><select
                                    id="hr-action-emp" class="w-full p-2.5 border rounded-lg outline-none"></select>
                            </div>
                            <div><label class="text-xs text-slate-500 mb-1 block">نوع الإجراء</label>
                                <select id="hr-action-type" class="w-full p-2.5 border rounded-lg outline-none">
                                    <option value="bonus">مكافأة</option>
                                    <option value="deduction">خصم</option>
                                    <option value="warning">إنذار</option>
                                    <option value="leave">إجازة</option>
                                    <option value="promotion">ترقية</option>
                                </select>
                            </div>
                            <div><label class="text-xs text-slate-500 mb-1 block">المبلغ (إن وجد)</label><input
                                    type="number" id="hr-action-amount" step="0.01"
                                    class="w-full p-2.5 border rounded-lg outline-none"></div>
                            <div><label class="text-xs text-slate-500 mb-1 block">السبب / الملاحظات</label><input
                                    type="text" id="hr-action-reason"
                                    class="w-full p-2.5 border rounded-lg outline-none">
                            </div>
                            <button onclick="saveHRAction()"
                                class="w-full bg-amber-600 text-white py-2.5 rounded-lg font-bold hover:bg-amber-500"><i
                                    class="fas fa-save me-1"></i>تسجيل</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">سجل الإجراءات</h3>
                            <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                    class="p-2 border rounded text-sm w-36 outline-none"
                                    onkeyup="filterInvTable('hr-action-body',this.value)"><button
                                    onclick="exportTableToCSV('hr-action-table','الإجراءات')"
                                    class="text-xs bg-emerald-50 text-emerald-600 px-2 py-1 rounded"><i
                                        class="fas fa-file-excel"></i></button><button
                                    onclick="printSection('hr-action-body')"
                                    class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded"><i
                                        class="fas fa-print"></i></button></div>
                        </div>
                        <div class="overflow-x-auto border rounded-lg max-h-[400px] overflow-y-auto">
                            <table id="hr-action-table" class="w-full text-sm text-right">
                                <thead class="bg-slate-800 text-white sticky top-0">
                                    <tr>
                                        <th class="p-2.5">التاريخ</th>
                                        <th class="p-2.5">الموظف</th>
                                        <th class="p-2.5">النوع</th>
                                        <th class="p-2.5">المبلغ</th>
                                        <th class="p-2.5">السبب</th>
                                    </tr>
                                </thead>
                                <tbody id="hr-action-body" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== HR: قائمة الموظفين ===== -->
            <section id="hr_list" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-list-ul text-blue-500 me-2"></i>قائمة
                            الموظفين</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('hr-list-body',this.value)"><button
                                onclick="exportTableToCSV('hr-list-table','الموظفين')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('hr-list-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="hr-list-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">#</th>
                                    <th class="p-2.5">الاسم</th>
                                    <th class="p-2.5">الوظيفة</th>
                                    <th class="p-2.5">الهاتف</th>
                                    <th class="p-2.5">الراتب</th>
                                    <th class="p-2.5">تاريخ التعيين</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="hr-list-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== HR: كشف رواتب ===== -->
            <section id="hr_payroll" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-money-check-alt text-emerald-500 me-2"></i>صرف راتب</h3>
                        <div class="space-y-3">
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">الموظف</label><select
                                    id="payroll-emp" class="w-full p-2.5 border rounded-lg text-sm outline-none"
                                    onchange="loadPayrollSalary()">
                                    <option value="">-- اختر --</option>
                                </select></div>
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">الشهر</label><input
                                    type="month" id="payroll-month"
                                    class="w-full p-2.5 border rounded-lg text-sm outline-none"
                                    onchange="loadPayrollSalary()"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-600 mb-1 block">الأساسي</label><input
                                        type="number" id="payroll-basic"
                                        class="w-full p-2 border rounded-lg text-sm outline-none"
                                        oninput="calcPayrollNet()"></div>
                                <div><label class="text-xs text-slate-600 mb-1 block">البدلات</label><input
                                        type="number" id="payroll-allowance" value="0"
                                        class="w-full p-2 border rounded-lg text-sm outline-none"
                                        oninput="calcPayrollNet()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-slate-600 mb-1 block">الخصومات (آلي)</label><input
                                        type="number" id="payroll-deduction" value="0" readonly
                                        class="w-full p-2 border rounded-lg text-sm outline-none bg-slate-50"></div>
                                <div><label class="text-xs text-slate-600 mb-1 block">الحوافز (آلي)</label><input
                                        type="number" id="payroll-bonus" value="0" readonly
                                        class="w-full p-2 border rounded-lg text-sm outline-none bg-slate-50"></div>
                            </div>
                            <!-- Synced Actions Preview -->
                            <div id="payroll-actions-details"
                                class="text-[10px] space-y-1 bg-amber-50 p-2 rounded-lg border border-amber-200 hidden">
                                <p class="font-bold text-amber-800 border-b border-amber-200 mb-1">الإجراءات المرحّلة من
                                    موديول الإجراءات:</p>
                                <div id="payroll-actions-list" class="space-y-1 max-h-[80px] overflow-y-auto"></div>
                            </div>
                            <div><label class="text-xs text-slate-600 mb-1 block">ملاحظات</label><input type="text"
                                    id="payroll-notes" class="w-full p-2 border rounded-lg text-sm outline-none"></div>
                            <div><label class="text-xs text-slate-600 mb-1 block">طريقة الصرف</label><select
                                    id="payroll-method" class="w-full p-2.5 border rounded-lg text-sm outline-none">
                                    <option value="1101">نقدي</option>
                                    <option value="1102">بنك</option>
                                </select></div>
                            <div class="bg-slate-900 text-white p-3 rounded-lg">
                                <div class="flex justify-between text-xs text-slate-400 mb-1">
                                    <span>الإجمالي:</span><span id="payroll-gross">0.00</span>
                                </div>
                                <div class="flex justify-between text-xs text-red-400 mb-1"><span>- خصومات:</span><span
                                        id="payroll-ded-show">0.00</span></div>
                                <div
                                    class="flex justify-between text-sm font-bold text-emerald-400 border-t border-slate-700 pt-1">
                                    <span>الصافي:</span><span id="payroll-net">0.00</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="processPayroll()"
                                    class="bg-emerald-600 text-white py-2.5 rounded-lg font-bold hover:bg-emerald-500 text-sm"><i
                                        class="fas fa-save me-1"></i>حفظ</button>
                                <button onclick="printLastPayroll()"
                                    class="bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-500 text-sm"><i
                                        class="fas fa-print me-1"></i>طباعة</button>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-sm text-slate-800"><i
                                    class="fas fa-history text-blue-500 me-1"></i>سجل الرواتب</h3>
                            <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                    class="p-1.5 border rounded text-xs w-36 outline-none"
                                    onkeyup="filterInvTable('payroll-body',this.value)"><input type="month"
                                    id="payroll-filter-month" class="p-1.5 border rounded text-xs outline-none"
                                    onchange="filterPayrollByMonth()"><button
                                    onclick="exportTableToCSV('payroll-table','كشف_رواتب')"
                                    class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded"><i
                                        class="fas fa-file-excel"></i></button><button
                                    onclick="printSection('payroll-body')"
                                    class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded"><i
                                        class="fas fa-print"></i></button></div>
                        </div>
                        <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                            <table id="payroll-table" class="w-full text-xs text-right">
                                <thead class="bg-slate-800 text-white sticky top-0">
                                    <tr>
                                        <th class="p-2">#</th>
                                        <th class="p-2">التاريخ</th>
                                        <th class="p-2">الشهر</th>
                                        <th class="p-2">الموظف</th>
                                        <th class="p-2">الأساسي</th>
                                        <th class="p-2">البدلات</th>
                                        <th class="p-2 text-red-400">الخصومات</th>
                                        <th class="p-2 text-emerald-400">الحوافز</th>
                                        <th class="p-2 text-yellow-400 font-bold">الصافي</th>
                                        <th class="p-2">الصرف</th>
                                        <th class="p-2">ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody id="payroll-body" class="divide-y bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== HR: كشف حساب موظف ===== -->
            <section id="hr_emp_statement" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <div class="flex items-center gap-4">
                            <h3 class="font-bold text-xl text-slate-800"><i
                                    class="fas fa-file-invoice text-indigo-500 me-2"></i>كشف حساب الموظف الشامل</h3>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="exportTableToCSV('emp-stmt-table','كشف_حساب_موظف')"
                                class="bg-emerald-50 text-emerald-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-emerald-100 transition"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('emp-stmt-print-area')"
                                class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-100 transition"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>

                    <div
                        class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1">الموظف</label>
                            <select id="emp-stmt-id"
                                class="w-full p-2.5 border rounded-lg outline-none bg-white text-sm"
                                onchange="renderHREmpStatement()">
                                <option value="">اختر الموظف...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">من تاريخ</label>
                            <input type="date" id="emp-stmt-from"
                                class="w-full p-2.5 border rounded-lg outline-none bg-white text-sm"
                                onchange="renderHREmpStatement()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">إلى تاريخ</label>
                            <input type="date" id="emp-stmt-to"
                                class="w-full p-2.5 border rounded-lg outline-none bg-white text-sm"
                                onchange="renderHREmpStatement()">
                        </div>
                    </div>

                    <div id="emp-stmt-print-area">
                        <div id="emp-stmt-header" class="mb-4 hidden">
                            <h2 class="text-2xl font-bold text-center border-b-2 pb-2 mb-4">كشف حساب تاريخي للموظف</h2>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>الموظف:</strong> <span id="emp-stmt-name-show">-</span></div>
                                <div><strong>الوظيفة:</strong> <span id="emp-stmt-role-show">-</span></div>
                                <div><strong>الهاتف:</strong> <span id="emp-stmt-phone-show">-</span></div>
                                <div><strong>الراتب الأساسي:</strong> <span id="emp-stmt-salary-show">-</span></div>
                            </div>
                        </div>

                        <div class="overflow-x-auto border rounded-lg">
                            <table id="emp-stmt-table" class="w-full text-sm text-right">
                                <thead class="bg-slate-800 text-white">
                                    <tr>
                                        <th class="p-3">التاريخ</th>
                                        <th class="p-3">النوع</th>
                                        <th class="p-3">البيان / السبب</th>
                                        <th class="p-3">المبلغ (+)</th>
                                        <th class="p-3">المبلغ (-)</th>
                                        <th class="p-3">الصافي / الرصيد</th>
                                    </tr>
                                </thead>
                                <tbody id="emp-stmt-body" class="divide-y bg-white">
                                    <tr>
                                        <td colspan="6" class="p-8 text-center text-slate-400">يرجى اختيار الموظف لعرض
                                            البيانات</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>


            <!-- ===== تقارير نقاط البيع ===== -->
            <section id="rpt_pos" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-cash-register text-purple-500 me-2"></i>تقرير نقاط البيع</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-pos-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptPOS()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-pos-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptPOS()">
                            <button onclick="exportTableToCSV('rpt-pos-table','تقرير_نقاط_البيع')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-pos-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-purple-600" id="rpt-pos-count">0</div>
                            <div class="text-xs text-slate-500">عدد الإيصالات</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-pos-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المبيعات</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-pos-items">0</div>
                            <div class="text-xs text-slate-500">عدد الأصناف المباعة</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-pos-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الإيصال</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">الوقت</th>
                                    <th class="p-2.5">عدد الأصناف</th>
                                    <th class="p-2.5">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-pos-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير المبيعات ===== -->
            <section id="rpt_sales" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-chart-line text-blue-500 me-2"></i>تقرير المبيعات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-sales-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptSales()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-sales-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptSales()">
                            <button onclick="exportTableToCSV('rpt-sales-table','تقرير_المبيعات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-sales-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-sales-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-sales-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المبيعات</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-green-600" id="rpt-sales-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-sales-remaining">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-sales-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-sales-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير العملاء ===== -->
            <section id="rpt_customers" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-users text-indigo-500 me-2"></i>تقرير
                            العملاء</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-customers-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-customers-table','تقرير_العملاء')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-customers-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="rpt-cust-count">0</div>
                            <div class="text-xs text-slate-500">عدد العملاء</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-cust-total-sales">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المبيعات</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-cust-total-due">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المستحق</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-customers-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الهاتف</th>
                                    <th class="p-2.5">عدد الفواتير</th>
                                    <th class="p-2.5">إجمالي المشتريات</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المستحق</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-customers-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير المشتريات ===== -->
            <section id="rpt_purchases" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-shopping-cart text-orange-500 me-2"></i>تقرير المشتريات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-pur-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptPurchases()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-pur-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptPurchases()">
                            <button onclick="exportTableToCSV('rpt-pur-table','تقرير_المشتريات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-pur-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-orange-600" id="rpt-pur-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-pur-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المشتريات</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-pur-paid">0.00</div>
                            <div class="text-xs text-slate-500">المدفوع</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="rpt-pur-remaining">0.00</div>
                            <div class="text-xs text-slate-500">المستحق علينا</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-pur-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">المورد</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-pur-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الموردين ===== -->
            <section id="rpt_suppliers" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-truck text-amber-500 me-2"></i>تقرير
                            الموردين</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-supp-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-supp-table','تقرير_الموردين')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-supp-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="rpt-supp-count">0</div>
                            <div class="text-xs text-slate-500">عدد الموردين</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-orange-600" id="rpt-supp-total-pur">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المشتريات</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-supp-total-due">0.00</div>
                            <div class="text-xs text-slate-500">المستحق علينا</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-supp-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">المورد</th>
                                    <th class="p-2.5">الهاتف</th>
                                    <th class="p-2.5">عدد الفواتير</th>
                                    <th class="p-2.5">إجمالي المشتريات</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5 text-red-400">المستحق</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-supp-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الموظفين ===== -->
            <section id="rpt_employees" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-user-tie text-blue-500 me-2"></i>تقرير
                            الموظفين</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-emp-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-emp-table','تقرير_الموظفين')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-emp-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-emp-count">0</div>
                            <div class="text-xs text-slate-500">عدد الموظفين</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-emp-total-salary">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الرواتب الشهري</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="rpt-emp-total-paid">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المصروف</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-emp-actions">0</div>
                            <div class="text-xs text-slate-500">عدد الإجراءات</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-emp-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">الاسم</th>
                                    <th class="p-2.5">الوظيفة</th>
                                    <th class="p-2.5">الراتب</th>
                                    <th class="p-2.5">عدد المرتبات</th>
                                    <th class="p-2.5">إجمالي المصروف</th>
                                    <th class="p-2.5">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-emp-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير المخزون ===== -->
            <section id="rpt_inventory" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-boxes text-teal-500 me-2"></i>تقرير
                            المخزون</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-inv-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-inv-table','تقرير_المخزون')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-inv-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-teal-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-teal-600" id="rpt-inv-count">0</div>
                            <div class="text-xs text-slate-500">عدد الأصناف</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-inv-total-stock">0</div>
                            <div class="text-xs text-slate-500">إجمالي المخزون</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-inv-total-value">0.00</div>
                            <div class="text-xs text-slate-500">قيمة المخزون (بيع)</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-inv-low">0</div>
                            <div class="text-xs text-slate-500">أصناف منخفضة</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-inv-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">الكود</th>
                                    <th class="p-2.5">الصنف</th>
                                    <th class="p-2.5">الفئة</th>
                                    <th class="p-2.5">سعر البيع</th>
                                    <th class="p-2.5">التكلفة</th>
                                    <th class="p-2.5">المخزون</th>
                                    <th class="p-2.5">قيمة المخزون</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-inv-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الخدمات ===== -->
            <section id="rpt_services" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-tools text-cyan-500 me-2"></i>تقرير
                            الخدمات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-svc-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptServices()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-svc-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptServices()">
                            <button onclick="exportTableToCSV('rpt-svc-table','تقرير_الخدمات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-svc-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-cyan-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-cyan-600" id="rpt-svc-count">0</div>
                            <div class="text-xs text-slate-500">عدد الفواتير</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-svc-total">0.00</div>
                            <div class="text-xs text-slate-500">الإجمالي</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-green-600" id="rpt-svc-paid">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-svc-remaining">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-svc-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المدفوع</th>
                                    <th class="p-2.5">المتبقي</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-svc-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير التقسيط ===== -->
            <section id="rpt_installments" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-calendar-alt text-indigo-500 me-2"></i>تقرير التقسيط</h3>
                        <div class="flex gap-2"><button onclick="exportTableToCSV('rpt-inst-table','تقرير_التقسيط')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-inst-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="rpt-inst-count">0</div>
                            <div class="text-xs text-slate-500">عدد العقود</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-inst-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي العقود</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-inst-collected">0.00</div>
                            <div class="text-xs text-slate-500">المحصّل</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-inst-pending">0.00</div>
                            <div class="text-xs text-slate-500">المتبقي</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-inst-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">رقم الفاتورة</th>
                                    <th class="p-2.5">الإجمالي</th>
                                    <th class="p-2.5">المقدم</th>
                                    <th class="p-2.5">الأقساط</th>
                                    <th class="p-2.5">المحصّل</th>
                                    <th class="p-2.5">المتبقي</th>
                                    <th class="p-2.5">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-inst-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير عملاء التقسيط ===== -->
            <section id="rpt_inst_customers" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-user-tag text-violet-500 me-2"></i>تقرير عملاء التقسيط</h3>
                        <div class="flex gap-2"><input type="text" placeholder="بحث..."
                                class="p-2 border rounded text-sm w-48 outline-none"
                                onkeyup="filterInvTable('rpt-instcust-body',this.value)"><button
                                onclick="exportTableToCSV('rpt-instcust-table','تقرير_عملاء_التقسيط')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-instcust-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[500px] overflow-y-auto">
                        <table id="rpt-instcust-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">العميل</th>
                                    <th class="p-2.5">الهاتف</th>
                                    <th class="p-2.5">العنوان</th>
                                    <th class="p-2.5">عدد العقود</th>
                                    <th class="p-2.5">إجمالي المبلغ</th>
                                    <th class="p-2.5">المحصّل</th>
                                    <th class="p-2.5 text-red-400">المتبقي</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-instcust-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير المصروفات ===== -->
            <section id="rpt_expenses" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-money-bill-wave text-red-500 me-2"></i>تقرير المصروفات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-exp-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptExpenses()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-exp-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptExpenses()">
                            <button onclick="exportTableToCSV('rpt-exp-table','تقرير_المصروفات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-exp-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-exp-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي المصروفات</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-orange-600" id="rpt-exp-count">0</div>
                            <div class="text-xs text-slate-500">عدد السندات</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-amber-600" id="rpt-exp-avg">0.00</div>
                            <div class="text-xs text-slate-500">المتوسط لكل سند</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-exp-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">#</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">البيان</th>
                                    <th class="p-2.5">الفئة</th>
                                    <th class="p-2.5">المبلغ</th>
                                    <th class="p-2.5">الطريقة</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-exp-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الإيرادات ===== -->
            <section id="rpt_revenue" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-coins text-yellow-500 me-2"></i>تقرير
                            الإيرادات</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-rev-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptRevenue()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-rev-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptRevenue()">
                            <button onclick="exportTableToCSV('rpt-rev-table','تقرير_الإيرادات')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button>
                            <button onclick="printSection('rpt-rev-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-yellow-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-yellow-600" id="rpt-rev-sales">0.00</div>
                            <div class="text-xs text-slate-500">إيرادات المبيعات</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-purple-600" id="rpt-rev-pos">0.00</div>
                            <div class="text-xs text-slate-500">إيرادات POS</div>
                        </div>
                        <div class="bg-teal-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-teal-600" id="rpt-rev-svc">0.00</div>
                            <div class="text-xs text-slate-500">إيرادات الخدمات</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-rev-total">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الإيرادات</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-rev-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">المصدر</th>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">البيان</th>
                                    <th class="p-2.5">المبلغ</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-rev-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الخزينة ===== -->
            <section id="rpt_treasury" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-vault text-slate-600 me-2"></i>تقرير
                            الخزينة</h3>
                        <div class="flex gap-2"><button onclick="exportTableToCSV('rpt-treasury-table','تقرير_الخزينة')"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-file-excel me-1"></i>Excel</button><button
                                onclick="printSection('rpt-treasury-body')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-emerald-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-emerald-600" id="rpt-trs-in">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الوارد</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-red-600" id="rpt-trs-out">0.00</div>
                            <div class="text-xs text-slate-500">إجمالي الصادر</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-blue-600" id="rpt-trs-cash">0.00</div>
                            <div class="text-xs text-slate-500">رصيد الصندوق</div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold text-indigo-600" id="rpt-trs-bank">0.00</div>
                            <div class="text-xs text-slate-500">رصيد البنك</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded-lg max-h-[450px] overflow-y-auto">
                        <table id="rpt-treasury-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-800 text-white sticky top-0">
                                <tr>
                                    <th class="p-2.5">التاريخ</th>
                                    <th class="p-2.5">البيان</th>
                                    <th class="p-2.5 text-emerald-400">وارد</th>
                                    <th class="p-2.5 text-red-400">صادر</th>
                                    <th class="p-2.5">الرصيد</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-treasury-body" class="divide-y bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== تقارير الأرباح ===== -->
            <section id="rpt_profits" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-bold text-lg text-slate-800"><i
                                class="fas fa-chart-pie text-green-500 me-2"></i>تقرير الأرباح</h3>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label class="text-xs text-slate-500">من</label><input type="date" id="rpt-profit-from"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptProfits()">
                            <label class="text-xs text-slate-500">إلى</label><input type="date" id="rpt-profit-to"
                                class="p-1.5 border rounded text-xs outline-none" onchange="renderRptProfits()">
                            <button onclick="printSection('rpt-profit-summary')"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded"><i
                                    class="fas fa-print me-1"></i>طباعة</button>
                        </div>
                    </div>
                    <div id="rpt-profit-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-emerald-100 p-4 rounded-xl text-center border-2 border-emerald-300">
                            <div class="text-2xl font-bold text-emerald-700" id="rpt-pft-revenue">0.00</div>
                            <div class="text-xs text-emerald-600 font-bold">إجمالي الإيرادات</div>
                        </div>
                        <div class="bg-red-100 p-4 rounded-xl text-center border-2 border-red-300">
                            <div class="text-2xl font-bold text-red-700" id="rpt-pft-cost">0.00</div>
                            <div class="text-xs text-red-600 font-bold">تكلفة البضاعة المباعة</div>
                        </div>
                        <div class="bg-amber-100 p-4 rounded-xl text-center border-2 border-amber-300">
                            <div class="text-2xl font-bold text-amber-700" id="rpt-pft-expenses">0.00</div>
                            <div class="text-xs text-amber-600 font-bold">المصروفات + الرواتب</div>
                        </div>
                        <div class="bg-green-100 p-4 rounded-xl text-center border-2 border-green-400">
                            <div class="text-3xl font-bold" id="rpt-pft-net">0.00</div>
                            <div class="text-xs font-bold" id="rpt-pft-label">صافي الربح</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">تفاصيل الإيرادات</h4>
                            <div id="rpt-pft-rev-details" class="space-y-1 text-xs"></div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">تفاصيل التكاليف</h4>
                            <div id="rpt-pft-cost-details" class="space-y-1 text-xs"></div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">تفاصيل المصروفات</h4>
                            <div id="rpt-pft-exp-details" class="space-y-1 text-xs"></div>
                        </div>
                    </div>
            </section>

            <!-- الدعم الفني -->
            <section id="support" class="section-content">
                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Header -->
                    <div
                        class="bg-gradient-to-r from-slate-800 to-slate-900 p-8 rounded-2xl shadow-lg relative overflow-hidden text-white">
                        <div class="relative z-10 flex items-center justify-between">
                            <div class="space-y-2">
                                <h2 class="text-3xl font-bold">مركز الدعم والمساعدة</h2>
                                <p class="text-slate-300">نسعى دائماً لتقديم أفضل تجربة مستخدم، فريقنا جاهز للرد على
                                    جميع استفساراتكم.</p>
                            </div>
                            <div class="hidden md:block opacity-20"><i class="fas fa-headset text-8xl"></i></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Technical Support -->
                        <div
                            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:border-blue-200 transition group">
                            <div
                                class="w-14 h-14 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 mb-6 group-hover:scale-110 transition">
                                <i class="fas fa-tools text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800 mb-2">الدعم الفني المباشر</h3>
                            <p class="text-xs text-slate-500 mb-6 leading-relaxed">لحل المشكلات التقنية والأعطال وحالات
                                الطوارئ، تواصل معنا فوراً.</p>
                            <a href="https://wa.me/201279180008" target="_blank"
                                class="flex items-center justify-center gap-2 w-full bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold transition shadow-md shadow-emerald-100">
                                <i class="fab fa-whatsapp text-lg"></i>واتساب 01279180008
                            </a>
                        </div>

                        <!-- User Guide -->
                        <div
                            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:border-purple-200 transition group">
                            <div
                                class="w-14 h-14 bg-purple-50 rounded-xl flex items-center justify-center text-purple-600 mb-6 group-hover:scale-110 transition">
                                <i class="fas fa-book-open text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800 mb-2">دليل المستخدم</h3>
                            <p class="text-xs text-slate-500 mb-6 leading-relaxed">تعرف على كيفية استخدام النظام بالكامل
                                من خلال الدليل الشامل والدروس المصورة.</p>
                            <button
                                class="w-full border border-slate-200 hover:bg-slate-50 text-slate-700 py-3 rounded-xl font-bold transition">
                                <i class="fas fa-external-link-alt me-2 text-xs"></i>فتح الدليل
                            </button>
                        </div>

                        <!-- Suggestions -->
                        <div
                            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:border-amber-200 transition group">
                            <div
                                class="w-14 h-14 bg-amber-50 rounded-xl flex items-center justify-center text-amber-600 mb-6 group-hover:scale-110 transition">
                                <i class="fas fa-lightbulb text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800 mb-2">الاقتراحات والشكاوى</h3>
                            <p class="text-xs text-slate-500 mb-6 leading-relaxed">رأيك يهمنا، شاركنا اقتراحاتك لتطوير
                                النظام أو قدم شكوى لتحسين خدمتنا.</p>
                            <button
                                class="w-full border border-slate-200 hover:bg-slate-50 text-slate-700 py-3 rounded-xl font-bold transition">
                                <i class="fas fa-paper-plane me-2 text-xs"></i>إرسال طلب
                            </button>
                        </div>
                    </div>

                    <!-- Additional Help -->
                    <div class="bg-blue-50 p-6 rounded-2xl flex items-center gap-4 border border-blue-100">
                        <div class="text-blue-600"><i class="fas fa-info-circle text-2xl"></i></div>
                        <div class="text-sm text-blue-800 font-medium">
                            لضمان سرعة الرد، يرجى إرفاق صورة للمشكلة أو رسالة الخطأ عند التواصل مع فريق الدعم الفني.
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- CoA Details Modal -->
    <div id="coa-details-modal" class="modal">
        <div class="modal-content" style="max-width:800px; width:95%;" id="print-coa-ledger">
            <div class="flex justify-between items-center mb-4 border-b pb-2 no-print">
                <h3 class="font-bold text-lg text-slate-800"><i class="fas fa-book me-2"></i>كشف حساب / تفاصيل (<span
                        id="coa-det-code-val"></span>)</h3>
                <div class="flex gap-2">
                    <button onclick="printSection('print-coa-ledger')"
                        class="text-slate-600 hover:text-blue-600 bg-slate-100 hover:bg-blue-50 px-3 py-1.5 rounded transition text-sm flex items-center font-bold"><i
                            class="fas fa-print me-1"></i> طباعة</button>
                    <button onclick="closeModal('coa-details-modal')" class="text-slate-400 hover:text-red-500"><i
                            class="fas fa-times text-xl"></i></button>
                </div>
            </div>

            <!-- معلومات للطباعة فقط كترويسة -->
            <div class="hidden print:block mb-6 text-center border-b pb-4">
                <h2 class="text-2xl font-bold mb-2">كشف حساب تفصيلي</h2>
                <p class="text-sm text-slate-500" id="print-coa-date"></p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4 text-sm bg-slate-50 p-4 rounded-lg border border-slate-100">
                <div><strong>اسم الحساب:</strong> <span id="coa-det-name"></span></div>
                <div><strong>الرصيد الافتتاحي:</strong> <span id="coa-det-init" dir="ltr"></span></div>
                <div><strong>النوع:</strong> <span id="coa-det-type"></span></div>
                <div><strong>الرصيد الحالي:</strong> <span id="coa-det-curr" dir="ltr" class="font-bold"></span></div>
            </div>
            <div class="overflow-x-auto border rounded-xl">
                <table class="w-full text-sm text-right" style="font-size:11px;">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="p-2 w-24">التاريخ</th>
                            <th class="p-2 w-20">الرقم</th>
                            <th class="p-2">البيان</th>
                            <th class="p-2 w-24 text-center">مدين</th>
                            <th class="p-2 w-24 text-center">دائن</th>
                            <th class="p-2 w-24 text-center">الرصيد</th>
                        </tr>
                    </thead>
                    <tbody id="coa-det-body" class="bg-white"></tbody>
                </table>
            </div>
            <div class="flex justify-end gap-2 mt-4 pt-4 border-t no-print">
                <button onclick="closeModal('coa-details-modal')"
                    class="px-4 py-2 border rounded-lg text-slate-600 hover:bg-slate-50">إغلاق</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. Firebase Config & Login ---
        const firebaseConfig = {
            apiKey: "AIzaSyB6if5oe1FBqJlp-glu2AmRaGKODRo14ck",
            authDomain: "erm1-92e4f.firebaseapp.com",
            projectId: "erm1-92e4f",
            storageBucket: "erm1-92e4f.firebasestorage.app",
            messagingSenderId: "868668789906",
            appId: "1:868668789906:web:a56f9a9c441c66c008024b",
            measurementId: "G-JJ2MHMPX22"
        };
        firebase.initializeApp(firebaseConfig);
        const dbFirestore = firebase.firestore();

        // --- 1. Data Structure ---
        let db = {
            quotations: [],
            purchaseOrders: [],
            settings: {
                companyName: 'شركتي', logo: '',
                vatRate: 15,
                currency: 'SAR',
                phone: '', address: '', vatNumber: '',
                paymentMethods: ['Cash', 'Bank', 'Wallet', 'InstaPay']
            },
            services: [{ id: 1, name: 'خدمة تركيب', price: 150, description: 'تركيب وصيانة' }],
            expensesCategories: [
                { id: '5201', name: 'مصروفات تشغيلية عامة' },
                { id: '5202', name: 'مصروفات نثرية' },
                { id: '5203', name: 'إيجارات' },
                { id: '5204', name: 'رواتب وأجور' },
                { id: '5205', name: 'كهرباء، مياه وإنترنت' },
                { id: '5206', name: 'تسويق وإعلانات' },
                { id: '5207', name: 'صيانة وإصلاحات' },
                { id: '5208', name: 'خصم مسموح به' },
                { id: '5209', name: 'مصاريف حكومية ورخص' },
                { id: '5210', name: 'مصاريف بنكية وعمولات' }
            ],
            expenses: [],

            employees: [
                { id: 1, name: 'موظف تجريبي', role: 'مبيعات', salary: 3000, phone: '0500000000', photo: '' }
            ],
            payrollActions: [],
            payrollRuns: [],

            users: [
                { id: 1, name: 'المدير العام', role: 'admin', phone: '0000' }
            ],
            currentUser: 1,
            chartOfAccounts: [
                { code: '1', name: 'الأصول', type: 'asset', level: 1, balance: 0, isGroup: true },
                { code: '11', name: 'أصول متداولة', type: 'asset', level: 2, parent: '1', balance: 0, isGroup: true },
                { code: '1101', name: 'الخزينة الرئيسية', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1102', name: 'البنك ', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1103', name: 'العملاء', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1104', name: 'المخزون', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1105', name: 'أقساط مستحقة (مدينو تقسيط)', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1106', name: 'سلف وعُهد موظفين', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '12', name: 'الأصول الثابتة', type: 'asset', level: 1, balance: 0, isGroup: true },
                { code: '1201', name: 'أثاث ومعدات مكتبية', type: 'asset', level: 3, parent: '12', balance: 0 },
                { code: '1202', name: 'أجهزة إلكترونية وحاسب', type: 'asset', level: 3, parent: '12', balance: 0 },
                { code: '2', name: 'الالتزامات', type: 'liability', level: 1, balance: 0, isGroup: true },
                { code: '2101', name: 'الموردين (الدائنون)', type: 'liability', level: 3, parent: '2', balance: 0 },
                { code: '2102', name: 'ضريبة القيمة المضافة', type: 'liability', level: 3, parent: '2', balance: 0 },
                { code: '2103', name: 'إيرادات تقسيط مؤجلة', type: 'liability', level: 3, parent: '2', balance: 0 },
                { code: '2104', name: 'رواتب وأجور مستحقة', type: 'liability', level: 3, parent: '2', balance: 0 },
                { code: '2105', name: 'مصاريف أخرى مستحقة', type: 'liability', level: 3, parent: '2', balance: 0 },
                { code: '3', name: 'حقوق الملكية', type: 'equity', level: 1, balance: 0, isGroup: true },
                { code: '3101', name: 'رأس المال', type: 'equity', level: 3, parent: '3', balance: 0 },
                { code: '3201', name: 'مسحوبات الشركاء', type: 'equity', level: 3, parent: '3', balance: 0 },
                { code: '4', name: 'الإيرادات', type: 'revenue', level: 1, balance: 0, isGroup: true },
                { code: '4101', name: 'إيرادات المبيعات', type: 'revenue', level: 3, parent: '4', balance: 0 },
                { code: '4102', name: 'إيرادات فوائد تقسيط', type: 'revenue', level: 3, parent: '4', balance: 0 },
                { code: '4103', name: 'مرتجعات مبيعات (مدين)', type: 'revenue', level: 3, parent: '4', balance: 0 },
                { code: '4201', name: 'إيرادات خصومات وجزاءات', type: 'revenue', level: 3, parent: '4', balance: 0 },
                { code: '5', name: 'المصروفات', type: 'expense', level: 1, balance: 0, isGroup: true },
                { code: '5101', name: 'تكلفة المبيعات', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5201', name: 'مصروفات تشغيلية عامة', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5202', name: 'مصروفات نثرية', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5203', name: 'إيجارات', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5204', name: 'مصروف رواتب وأجور', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5205', name: 'كهرباء، مياه وإنترنت', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5206', name: 'تسويق وإعلانات', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5207', name: 'صيانة وإصلاحات', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5208', name: 'خصم مسموح به', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5209', name: 'مصاريف حكومية ورخص', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5210', name: 'مصاريف بنكية وعمولات', type: 'expense', level: 3, parent: '5', balance: 0 }
            ],
            journal: [],
            products: [{ id: 1, name: 'منتج تجريبي', price: 100, cost: 80, stock: 10 }],
            customers: [{ id: 1, name: 'عميل نقدي', phone: '', address: '', company: '', vat: '' }],
            suppliers: [{ id: 1, name: 'مورد عام', phone: '', address: '', company: '', vat: '' }],
            installments: [],
            returns: [],
            sales: [],
            purchases: []
        };

        let currentCart = [];
        let currentPurCart = [];
        let currentInvoiceToPrint = null;

        // --- 2. Initialization ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;

            // Await DB Load to authenticate properly if it's the first time
            if (!db.users) {
                // Initial bypass if DB is not loaded yet (fallback)
                if (u === 'admin' && p === '123') {
                    currentUser = { id: 1, name: 'Admin', role: 'admin' };
                    document.getElementById('login-modal').classList.add('hidden');
                    init();
                    return;
                }
            }

            // Authenticate against db.users (Check against new password field, fallback to old bypass for legacy users if no pass set)
            const user = db.users.find(user =>
                (user.name === u || user.phone === u) &&
                (user.password ? p === user.password : (p === '123' || user.phone === p))
            );

            if (user || (u === 'admin' && p === '123')) {
                currentUser = user || { id: 1, name: 'Admin', role: 'admin' };
                document.getElementById('login-modal').classList.add('hidden');

                // Enforce Sidebar Permissions Immediately
                // Enforce Comprehensive Sidebar Permissions
                const p = currentUser.permissions || {};

                // Helper to safely toggle sidebar groups
                const toggleNav = (id, permission, defaultState = true) => {
                    const el = document.getElementById(id);
                    if (el) {
                        const hasPerm = permission !== undefined ? permission : (currentUser.role === 'admin' ? true : defaultState);
                        el.style.display = hasPerm ? 'block' : 'none';
                    }
                };

                toggleNav('nav-pos', p.pos);
                toggleNav('nav-invoices', p.invoices);
                toggleNav('nav-sales', p.sales);
                toggleNav('nav-purchases', p.purchases);
                toggleNav('nav-services', p.services);
                toggleNav('nav-inventory', p.inventory);
                toggleNav('nav-installments', p.installments);
                toggleNav('nav-expenses', p.expenses);
                toggleNav('nav-incomes', p.incomes !== false);
                toggleNav('nav-hr', p.hr);
                toggleNav('nav-reports', p.reports);
                toggleNav('nav-users', p.settings);
                toggleNav('nav-settings', p.settings);
                toggleNav('nav-support', true); // Support is always visible

                // Account specific logic
                const navAcc = document.getElementById('nav-accounting');
                if (navAcc) {
                    const accPerms = p.accounts || { view: true, add: true, edit: true };
                    const canViewAccounts = currentUser.role !== 'admin' && !p.accounts ? false : accPerms.view;
                    navAcc.style.display = canViewAccounts ? 'block' : 'none';
                }

                init();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        async function init() {
            showSection('dashboard');
            showToast('جاري تحميل البيانات من السيرفر...', 'info');
            try {
                const doc = await dbFirestore.collection('app_data').doc('main_db').get();
                if (doc.exists) {
                    db = doc.data();
                    // Ensure structure integrity if fields are missing
                    if (!db.users) db.users = [{ id: 1, name: 'Admin', role: 'admin' }];
                    if (!db.suppliers) db.suppliers = [{ id: 1, name: 'مورد عام' }];
                    if (!db.products) db.products = [];
                    if (!db.chartOfAccounts) db.chartOfAccounts = []; // Should ideally be full chart, but empty prevents crash
                    if (!db.purchases) db.purchases = [];
                    if (!db.settings.paymentMethods) db.settings.paymentMethods = ['Cash', 'Bank', 'Wallet', 'InstaPay'];
                    if (!db.installments) db.installments = [];
                    if (!db.returns) db.returns = [];
                    if (!db.settings.logo) db.settings.logo = '';
                    if (!db.services) db.services = [];
                    // Structural updates
                    db.customers.forEach(c => { if (c.address === undefined) c.address = ''; if (c.company === undefined) c.company = ''; if (c.vat === undefined) c.vat = ''; });
                    db.suppliers.forEach(s => { if (s.address === undefined) s.address = ''; if (s.company === undefined) s.company = ''; });

                    // Rename migration for expense categories
                    if (db.expensesCategories) {
                        const cat5202 = db.expensesCategories.find(c => c.id == '5202');
                        if (cat5202 && cat5202.name.includes('رواتب')) {
                            cat5202.name = 'مصروفات نثرية';
                        }
                    }
                    if (db.chartOfAccounts) {
                        const acc5202 = db.chartOfAccounts.find(a => a.code == '5202');
                        if (acc5202 && acc5202.name.includes('رواتب')) {
                            acc5202.name = 'مصروفات نثرية';
                        }

                        // Ensure All Accounts exist (Migration)
                        const defaultAccs = [
                            { code: '1105', name: 'أقساط مستحقة (مدينو تقسيط)', type: 'asset', level: 3, parent: '11', balance: 0 },
                            { code: '1106', name: 'سلف وعُهد موظفين', type: 'asset', level: 3, parent: '11', balance: 0 },
                            { code: '12', name: 'الأصول الثابتة', type: 'asset', level: 1, balance: 0, isGroup: true },
                            { code: '1201', name: 'أثاث ومعدات مكتبية', type: 'asset', level: 3, parent: '12', balance: 0 },
                            { code: '1202', name: 'أجهزة إلكترونية وحاسب', type: 'asset', level: 3, parent: '12', balance: 0 },
                            { code: '2103', name: 'إيرادات تقسيط مؤجلة', type: 'liability', level: 3, parent: '2', balance: 0 },
                            { code: '2104', name: 'رواتب وأجور مستحقة', type: 'liability', level: 3, parent: '2', balance: 0 },
                            { code: '2105', name: 'مصاريف أخرى مستحقة', type: 'liability', level: 3, parent: '2', balance: 0 },
                            { code: '3201', name: 'مسحوبات الشركاء', type: 'equity', level: 3, parent: '3', balance: 0 },
                            { code: '4102', name: 'إيرادات فوائد تقسيط', type: 'revenue', level: 3, parent: '4', balance: 0 },
                            { code: '4103', name: 'مرتجعات مبيعات (مدين)', type: 'revenue', level: 3, parent: '4', balance: 0 },
                            { code: '5203', name: 'إيجارات', type: 'expense', level: 3, parent: '5', balance: 0 },
                            { code: '5205', name: 'كهرباء، مياه وإنترنت', type: 'expense', level: 3, parent: '5', balance: 0 },
                            { code: '5206', name: 'تسويق وإعلانات', type: 'expense', level: 3, parent: '5', balance: 0 },
                            { code: '5207', name: 'صيانة وإصلاحات', type: 'expense', level: 3, parent: '5', balance: 0 },
                            { code: '5208', name: 'خصم مسموح به', type: 'expense', level: 3, parent: '5', balance: 0 },
                            { code: '5209', name: 'مصاريف حكومية ورخص', type: 'expense', level: 3, parent: '5', balance: 0 },
                            { code: '5210', name: 'مصاريف بنكية وعمولات', type: 'expense', level: 3, parent: '5', balance: 0 }
                        ];

                        defaultAccs.forEach(newAcc => {
                            if (!db.chartOfAccounts.some(a => a.code == newAcc.code)) {
                                db.chartOfAccounts.push(newAcc);
                            }
                        });
                    }

                    showToast('تم تحميل البيانات بنجاح');
                } else {
                    // Initialize default data if new
                    addJournalEntry(new Date().toISOString().split('T')[0], 'قيد افتتاحي: رأس المال', [
                        { code: '1101', dr: 50000, cr: 0 },
                        { code: '3101', dr: 0, cr: 50000 }
                    ]);
                    save(); // Save initial state to Firebase
                }
            } catch (error) {
                console.error("Error loading data:", error);
                showToast('خطأ في الاتصال بقاعدة البيانات', 'error');
                // Fallback to local if needed, or just stay empty
            }

            // Set Default Dates for Reports (This Month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            if (document.getElementById('rpt-start-date')) document.getElementById('rpt-start-date').valueAsDate = firstDay;
            if (document.getElementById('rpt-end-date')) document.getElementById('rpt-end-date').valueAsDate = today;
            if (document.getElementById('pur-date')) document.getElementById('pur-date').valueAsDate = today;

            try { loadSettingsToForm(); } catch (e) { console.error('Error loading settings', e); }
            try { populateSelects(); } catch (e) { console.error('Error populating selects', e); }
            try { renderUsersTable(); } catch (e) { console.error('Error rendering users', e); }
            try { renderSuppliersTable(); } catch (e) { console.error('Error rendering suppliers', e); }
            try { renderCustomersTable(); } catch (e) { console.error('Error rendering customers', e); }
            try { updateLogoView(); } catch (e) { console.error('Error updating logo', e); }
            renderAll();

            document.getElementById('journal-lines').innerHTML = '';
            addJournalLineRow(); addJournalLineRow();

            document.getElementById('header-date').innerText = new Date().toLocaleDateString('ar-EG');
            showSection('dashboard');
        }

        async function save() {
            // Save to Firestore
            // localStorage.setItem('erp_pro_v10', JSON.stringify(db)); // Backup local
            await dbFirestore.collection('app_data').doc('main_db').set(db).catch(e => console.error(e));
            renderAll();
        }

        // --- 3. User Management ---
        function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const name = document.getElementById('user-name').value;
            const role = document.getElementById('user-role').value;
            const phone = document.getElementById('user-phone').value;
            const password = document.getElementById('user-password').value;

            // Gather Comprehensive Permissions
            const permissions = {
                pos: document.getElementById('perm-pos').checked,
                invoices: document.getElementById('perm-invoices').checked,
                sales: document.getElementById('perm-sales').checked,
                purchases: document.getElementById('perm-purchases').checked,
                services: document.getElementById('perm-services').checked,
                inventory: document.getElementById('perm-inventory').checked,
                installments: document.getElementById('perm-installments').checked,
                expenses: document.getElementById('perm-expenses').checked,
                incomes: document.getElementById('perm-incomes') ? document.getElementById('perm-incomes').checked : true,
                hr: document.getElementById('perm-hr').checked,
                reports: document.getElementById('perm-reports').checked,
                settings: document.getElementById('perm-settings').checked,
                accounts: {
                    view: document.getElementById('perm-accounting').checked,
                    add: document.getElementById('perm-accounting-add').checked,
                    edit: document.getElementById('perm-accounting-edit').checked
                }
            };

            if (id) { // Edit
                const user = db.users.find(u => u.id == id);
                if (user) {
                    user.name = name;
                    user.role = role;
                    user.phone = phone;
                    user.password = password;
                    user.permissions = permissions;
                }
                showToast('تم تعديل المستخدم');
            } else { // New
                db.users.push({ id: Date.now(), name, role, phone, password, permissions });
                showToast('تم إضافة المستخدم');
            }
            save(); renderUsersTable(); populateSelects(); resetUserForm();
        }

        function deleteUser(id) {
            if (confirm('حذف المستخدم؟')) {
                db.users = db.users.filter(u => u.id !== id);
                save(); renderUsersTable(); populateSelects();
            }
        }

        function editUser(id) {
            const user = db.users.find(u => u.id == id);
            if (user) {
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-name').value = user.name;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-phone').value = user.phone || '';
                document.getElementById('user-password').value = user.password || '';

                // Load Permissions (Default true for old users to prevent lockouts)
                const p = user.permissions || {};
                document.getElementById('perm-pos').checked = p.pos !== false;
                document.getElementById('perm-invoices').checked = p.invoices !== false;
                document.getElementById('perm-sales').checked = p.sales !== false;
                document.getElementById('perm-purchases').checked = p.purchases !== false;
                document.getElementById('perm-services').checked = p.services !== false;
                document.getElementById('perm-inventory').checked = p.inventory !== false;
                document.getElementById('perm-installments').checked = p.installments !== false;
                document.getElementById('perm-expenses').checked = p.expenses !== false;
                if (document.getElementById('perm-incomes')) document.getElementById('perm-incomes').checked = p.incomes !== false;
                document.getElementById('perm-hr').checked = p.hr !== false;
                document.getElementById('perm-reports').checked = p.reports !== false;
                document.getElementById('perm-settings').checked = p.settings !== false;

                const acc = p.accounts || { view: true, add: true, edit: true };
                document.getElementById('perm-accounting').checked = acc.view;
                document.getElementById('perm-accounting-add').checked = acc.add;
                document.getElementById('perm-accounting-edit').checked = acc.edit;

                document.getElementById('user-form-title').innerText = 'تعديل مستخدم';
            }
        }

        function resetUserForm() {
            document.getElementById('user-id').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-phone').value = '';
            document.getElementById('user-password').value = '';
            document.querySelectorAll('#permissions-grid input[type="checkbox"]').forEach(c => c.checked = true);
            document.getElementById('user-form-title').innerText = 'إضافة مستخدم';
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = db.users.map(u => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-3 font-bold">${u.name}</td>
                    <td class="p-3"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">${u.role === 'admin' ? 'مدير' : 'موظف'}</span></td>
                    <td class="p-3 text-slate-500 text-xs">${u.phone || '-'}</td>
                    <td class="p-3 flex gap-2">
                        <button onclick="editUser(${u.id})" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteUser(${u.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            const userSelect = document.getElementById('current-user-select');
            userSelect.innerHTML = db.users.map(u => `<option value="${u.id}" ${u.id == db.currentUser ? 'selected' : ''}>${u.name}</option>`).join('');
        }

        function filterUsers(query) {
            const rows = document.querySelectorAll('#users-list tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function switchUser(id) {
            db.currentUser = parseInt(id);
            save();
            showToast(`مرحباً, ${db.users.find(u => u.id == id).name}`);
        }

        // --- 4. Product Management (With Edit) ---
        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('prod-id').value;
            const name = document.getElementById('new-prod-name').value;
            const price = parseFloat(document.getElementById('new-prod-price').value);
            const cost = parseFloat(document.getElementById('new-prod-cost').value) || 0;
            const stock = parseFloat(document.getElementById('new-prod-stock').value) || 0;

            if (id) {
                const prod = db.products.find(p => p.id == id);
                if (prod) { prod.name = name; prod.price = price; prod.cost = cost; prod.stock = stock; }
                showToast('تم تعديل المنتج');
            } else {
                const newId = Date.now();
                db.products.push({ id: newId, name, price, cost, stock });
                if (stock > 0) {
                    addJournalEntry(new Date().toISOString().split('T')[0], `رصيد افتتاحي: ${name}`, [
                        { code: '1104', dr: stock * cost, cr: 0 }, { code: '3101', dr: 0, cr: stock * cost }
                    ]);
                }
                showToast('تم إضافة المنتج');
            }
            save(); populateSelects(); resetProductForm();
        }

        function editProduct(id) {
            const prod = db.products.find(p => p.id == id);
            if (prod) {
                document.getElementById('prod-id').value = prod.id;
                document.getElementById('new-prod-name').value = prod.name;
                document.getElementById('new-prod-price').value = prod.price;
                document.getElementById('new-prod-cost').value = prod.cost;
                document.getElementById('new-prod-stock').value = prod.stock;
                document.getElementById('prod-form-title').innerText = 'تعديل صنف';
            }
        }

        function deleteProduct(id) {
            if (confirm('حذف المنتج؟')) {
                db.products = db.products.filter(p => p.id !== id);
                save(); populateSelects();
            }
        }

        function resetProductForm() {
            document.getElementById('prod-id').value = '';
            document.getElementById('new-prod-name').value = '';
            document.getElementById('new-prod-price').value = '';
            document.getElementById('new-prod-cost').value = '';
            document.getElementById('new-prod-stock').value = '';
            document.getElementById('prod-form-title').innerText = 'إضافة صنف جديد';
        }

        function filterInventory(query) {
            const rows = document.querySelectorAll('#inventory-list tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // --- 5. Invoice Modal & View ---
        function viewInvoice(id) {
            const inv = db.sales.find(s => s.id == id);
            if (!inv) return;
            currentInvoiceToPrint = inv;

            const modal = document.getElementById('invoice-modal');
            const body = document.getElementById('invoice-modal-body');

            body.innerHTML = `
                <div class="text-center mb-4">
                    <h2 class="font-bold text-xl text-slate-800">${db.settings.companyName}</h2>
                    <p class="text-sm text-slate-500">فاتورة #${inv.id}</p>
                    ${db.settings.logo ? `<img src="${db.settings.logo}" class="h-16 mx-auto my-2">` : ''}
                    <p class="text-xs text-slate-400">${inv.date}</p>
                </div>
                <div class="mb-4 text-sm">
                    <p><strong>العميل:</strong> ${inv.customer}</p>
                    <p><strong>الموظف:</strong> ${db.users.find(u => u.id == inv.by)?.name || 'غير معروف'}</p>
                </div>
                <table class="w-full text-sm border-collapse mb-4">
                    <thead class="bg-slate-100"><tr><th class="p-2 text-right">الصنف</th><th class="p-2 text-center">الكمية</th><th class="p-2 text-center">السعر</th><th class="p-2 text-center">الإجمالي</th></tr></thead>
                    <tbody class="divide-y">
                        ${inv.items.map(i => `<tr><td class="p-2">${i.name}</td><td class="p-2 text-center">${i.qty}</td><td class="p-2 text-center">${i.price}</td><td class="p-2 text-center">${i.total.toFixed(2)}</td></tr>`).join('')}
                    </tbody>
                </table>
                <div class="flex justify-between items-center font-bold text-lg border-t pt-2">
                    <span>الإجمالي النهائي:</span>
                    <span>${inv.total.toFixed(2)} ${db.settings.currency}</span>
                </div>
            `;
            modal.classList.add('active');
        }

        function openModal(id) {
            const m = document.getElementById(id);
            if (m) m.classList.add('active');
        }

        function closeModal(id) {
            const m = document.getElementById(id || 'invoice-modal');
            if (m) m.classList.remove('active');
        }

        function printCurrentModalInvoice() {
            if (currentInvoiceToPrint) printInvoice(currentInvoiceToPrint);
        }

        // --- 6. Accounting Engine ---
        function getAccountBalance(code) {
            const acc = db.chartOfAccounts.find(a => a.code === code);
            if (!acc) return 0;
            if (!acc.isGroup) return acc.balance;
            const children = db.chartOfAccounts.filter(a => a.parent === code);
            return children.reduce((sum, child) => sum + getAccountBalance(child.code), 0);
        }

        function addJournalEntry(date, desc, lines, type = 'System') {
            const totalDr = lines.reduce((s, l) => s + (l.dr || 0), 0);
            const totalCr = lines.reduce((s, l) => s + (l.cr || 0), 0);

            if (Math.abs(totalDr - totalCr) > 0.01) {
                showToast(`خطأ: القيد غير متزن`, 'error');
                return false;
            }

            const entryId = db.journal.length + 1;
            const userName = db.users.find(u => u.id == db.currentUser)?.name || 'System';

            db.journal.push({ id: entryId, date, desc: desc + ` (بواسطة: ${userName})`, lines, type });

            lines.forEach(line => {
                const acc = db.chartOfAccounts.find(a => a.code === line.code);
                if (acc && !acc.isGroup) {
                    if (acc.type === 'asset' || acc.type === 'expense') acc.balance += ((line.dr || 0) - (line.cr || 0));
                    else acc.balance += ((line.cr || 0) - (line.dr || 0));
                }
            });

            save();
            return true;
        }

        function getMethodAccount(name) {
            if (!name) return '1101';
            if (name === 'Bank' || name === '1102' || name === 'بنك' || name === 'شبكة') return '1102';
            if (/^\d{4}$/.test(name)) return name;
            return '1101';
        }

        // --- 7. Operations ---
        function populateSelects() {
            const accounts = db.chartOfAccounts.filter(a => !a.isGroup);
            const salesAccs = accounts.filter(a => ['1101', '1102'].includes(a.code) || a.parent === '11').map(a => `<option value="${a.code}">${a.name}</option>`).join('');
            document.getElementById('sale-account').innerHTML = salesAccs;

            const methods = (db.settings.paymentMethods || ['Cash', 'Bank']).map(m => `<option value="${m}">${m}</option>`).join('');
            ['sale-method', 'pur-method', 'inst-method', 'quote-method', 'po-method', 'srv-method', 'exp-method', 'payroll-method'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = methods;
            });

            document.getElementById('sale-product').innerHTML = '<option value="">اختر منتج...</option>' + db.products.map(p => `<option value="${p.id}">${p.name} (${p.price})</option>`).join('');
            document.getElementById('sale-customer').innerHTML = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('inst-product').innerHTML = '<option value="">اختر منتج...</option>' + db.products.map(p => `<option value="${p.id}">${p.name} (${p.price})</option>`).join('');
            document.getElementById('inst-customer').innerHTML = (db.installmentCustomers || []).map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            // Searchable inputs reset
            ['pur-product-input', 'po-product-input', 'po-supplier', 'quote-customer', 'quote-product'].forEach(id => {
                const el = document.getElementById(id); if (el) el.value = '';
            });
            ['pur-product-id', 'po-product-id', 'po-supplier-id', 'quote-customer-id', 'quote-product-id'].forEach(id => {
                const el = document.getElementById(id); if (el) el.value = '';
            });
        }

        function addToCart() {
            const prodId = document.getElementById('sale-product').value;
            const qty = parseInt(document.getElementById('sale-qty').value);
            const prod = db.products.find(p => p.id == prodId);

            if (!prod) return showToast('اختر منتجاً', 'error');
            if (prod.stock < qty) return showToast('الرصيد غير كافٍ', 'error');

            const item = { ...prod, qty, total: prod.price * qty };
            currentCart.push(item);
            renderCart();
        }

        function renderCart() {
            const tbody = document.getElementById('cart-body');
            tbody.innerHTML = '';
            let subtotal = 0;
            currentCart.forEach((item, idx) => {
                subtotal += item.total;
                tbody.innerHTML += `
                    <tr class="bg-white"><td class="p-2">${item.name}</td><td class="p-2 font-bold">${item.qty}</td><td class="p-2">${item.price}</td><td class="p-2">${item.total}</td>
                    <td class="p-2"><button onclick="currentCart.splice(${idx},1);renderCart()" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
            });

            if (currentCart.length > 0) document.getElementById('cart-empty').classList.add('hidden');
            else document.getElementById('cart-empty').classList.remove('hidden');

            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const net = Math.max(0, subtotal - discount);
            const vat = net * (db.settings.vatRate / 100);
            const total = net + vat;

            document.getElementById('cart-subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('cart-vat').innerText = vat.toFixed(2);
            document.getElementById('cart-total').innerText = total.toFixed(2);

            if (!document.getElementById('sale-paid').value && total > 0) document.getElementById('sale-paid').value = total.toFixed(2);
        }

        // --- Returns Logic ---
        function toggleSaleMode() {
            const isRet = document.getElementById('is-return-sale').checked;
            document.getElementById('sale-title').innerText = isRet ? 'مرتجع مبيعات' : 'فاتورة مبيعات';
            document.getElementById('sale-mode-badge').classList.toggle('hidden', !isRet);
            document.getElementById('sale-header-sec').classList.toggle('bg-red-50', isRet);
        }
        function togglePurMode() {
            const isRet = document.getElementById('is-return-pur').checked;
            document.getElementById('pur-title').innerText = isRet ? 'مرتجع مشتريات' : 'فاتورة مشتريات';
            document.getElementById('pur-mode-badge').classList.toggle('hidden', !isRet);
        }

        // Updated postSale to handle Returns and Cash/Credit logic
        function postSale() {
            if (currentCart.length === 0) return showToast('السلة فارغة', 'error');

            const custId = document.getElementById('sale-customer').value;
            const customer = db.customers.find(c => c.id == custId);
            const date = new Date().toISOString().split('T')[0];
            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const method = document.getElementById('sale-method').value || '1101';
            const isReturn = document.getElementById('is-return-sale').checked;

            let totalSale = 0, totalCost = 0;
            currentCart.forEach(i => { totalSale += i.total; totalCost += (i.cost * i.qty); });

            const netSale = totalSale - discount;
            const vatAmount = netSale * (db.settings.vatRate / 100);
            const grandTotal = netSale + vatAmount;

            // Robust check for paid amount based on payment type
            let paid;
            if (salePayType === 'cash' && !isReturn) {
                paid = grandTotal;
            } else {
                paid = parseFloat(document.getElementById('sale-paid').value) || 0;
            }
            const remaining = Math.max(0, grandTotal - paid);

            const lines = [];

            if (isReturn) {
                // Return Logic
                if (paid > 0) lines.push({ code: method, dr: 0, cr: paid }); // Cr Cash/Bank
                if (remaining > 0.01) lines.push({ code: '1103', dr: 0, cr: remaining }); // Cr Customer

                lines.push({ code: '4103', dr: netSale, cr: 0 }); // Dr Sales Return
                lines.push({ code: '2102', dr: vatAmount, cr: 0 }); // Dr VAT
                lines.push({ code: '1104', dr: totalCost, cr: 0 }); // Dr Inventory
                lines.push({ code: '5101', dr: 0, cr: totalCost }); // Cr COGS

                if (addJournalEntry(date, `مرتجع مبيعات - ${customer.name}`, lines)) {
                    currentCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) p.stock += i.qty; });
                    db.returns.push({ id: Date.now(), date, type: 'sale', customer: customer.name, total: grandTotal, items: [...currentCart] });
                    showToast('تم حفظ المرتجع');
                }
            } else {
                // Sale Logic
                if (paid > 0) lines.push({ code: getMethodAccount(method), dr: paid, cr: 0 }); // Dr Cash/Bank
                if (remaining > 0.01) lines.push({ code: '1103', dr: remaining, cr: 0 }); // Dr Customer Account
                if (discount > 0) lines.push({ code: '5208', dr: discount, cr: 0 }); // Dr Discount Allowed

                lines.push({ code: '5101', dr: totalCost, cr: 0 }); // Dr COGS
                lines.push({ code: '4101', dr: 0, cr: totalSale }); // Cr Sales Revenue
                lines.push({ code: '2102', dr: 0, cr: vatAmount }); // Cr VAT
                lines.push({ code: '1104', dr: 0, cr: totalCost }); // Cr Inventory

                if (addJournalEntry(date, `فاتورة - ${customer.name}`, lines)) {
                    currentCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) p.stock -= i.qty; });
                    const saleId = 'INV-' + String(db.sales.length + 1).padStart(4, '0');
                    db.sales.push({ id: Date.now(), invoiceNo: saleId, date, customer: customer.name, total: grandTotal, paid, discount, remaining, method, by: db.currentUser, items: [...currentCart], payType: salePayType });
                    showToast('تم حفظ الفاتورة بنجاح ✅');
                    renderSalesInvoices();
                }
            }
            // Reset
            currentCart = []; renderCart();
            document.getElementById('sale-discount').value = 0;
            document.getElementById('sale-paid').value = '';
            document.getElementById('is-return-sale').checked = false; toggleSaleMode();
            renderAll();
        }

        // Updated postPurchase to handle Returns and Cash/Credit logic
        function postPurchase() {
            if (currentPurCart.length === 0) return showToast('السلة فارغة', 'error');

            const suppId = document.getElementById('pur-supplier').value;
            const supplier = db.suppliers.find(s => s.id == suppId);
            const date = document.getElementById('pur-date').value || new Date().toISOString().split('T')[0];
            const discount = parseFloat(document.getElementById('pur-discount').value) || 0;
            const method = document.getElementById('pur-method').value || '1101';
            const isReturn = document.getElementById('is-return-pur').checked;

            let totalCost = 0;
            currentPurCart.forEach(i => totalCost += i.total);
            const netCost = totalCost - discount;
            const vatAmount = netCost * 0.15;
            const grandTotal = netCost + vatAmount;

            // Robust check for paid amount based on payment type
            let paid;
            if (purPayType === 'cash' && !isReturn) {
                paid = grandTotal;
            } else {
                paid = parseFloat(document.getElementById('pur-paid').value) || 0;
            }
            const remaining = Math.max(0, grandTotal - paid);

            const lines = [];

            if (isReturn) {
                // Return Logic
                if (paid > 0) lines.push({ code: method, dr: paid, cr: 0 }); // Dr Cash/Bank (Refund)
                if (remaining > 0.01) lines.push({ code: '2101', dr: remaining, cr: 0 }); // Dr Supplier (Debit Note)

                lines.push({ code: '1104', dr: 0, cr: totalCost }); // Cr Inventory
                lines.push({ code: '2102', dr: 0, cr: vatAmount }); // Cr VAT (Reverse Input)

                if (addJournalEntry(date, `مرتجع مشتريات - ${supplier.name}`, lines)) {
                    currentPurCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) { p.stock -= i.qty; } });
                    db.returns.push({ id: Date.now(), date, type: 'purchase', supplier: supplier.name, total: grandTotal, items: [...currentPurCart] });
                    showToast('تم حفظ المرتجع');
                }
            } else {
                // Purchase Logic
                lines.push({ code: '1104', dr: totalCost, cr: 0 }); // Dr Inventory
                lines.push({ code: '2102', dr: vatAmount, cr: 0 }); // Dr VAT (Input)

                if (discount > 0) lines.push({ code: '4201', dr: 0, cr: discount }); // Cr Discount Received
                if (paid > 0) lines.push({ code: method, dr: 0, cr: paid }); // Cr Cash/Bank
                if (remaining > 0.01) lines.push({ code: '2101', dr: 0, cr: remaining }); // Cr Supplier Account

                if (addJournalEntry(date, `فاتورة مشتريات - ${supplier.name} (${method})`, lines)) {
                    currentPurCart.forEach(i => {
                        if (i.isNew) {
                            if (i.type === 'service') {
                                if (!db.services) db.services = [];
                                const newSrv = { id: Date.now() + Math.floor(Math.random() * 1000), name: i.name, cost: i.cost, price: i.cost * 1.2, description: '' };
                                db.services.push(newSrv);
                                i.id = newSrv.id;
                            } else {
                                const newProd = { id: Date.now() + Math.floor(Math.random() * 1000), name: i.name, price: i.cost * 1.2, cost: i.cost, stock: i.qty };
                                db.products.push(newProd);
                                i.id = newProd.id;
                            }
                            delete i.isNew;
                        } else {
                            if (i.type === 'product' || !i.type) {
                                const p = db.products.find(x => x.id == i.id);
                                if (p) { p.stock += i.qty; p.cost = i.cost; }
                            } else if (i.type === 'service') {
                                const s = db.services.find(x => x.id == i.id);
                                if (s) { s.cost = i.cost; }
                            }
                        }
                    });
                    db.purchases.push({ id: Date.now(), date, supplier: supplier.name, total: grandTotal, paid, discount, remaining, method, items: [...currentPurCart], payType: purPayType });
                    showToast('تم حفظ المشتريات');
                    renderRecentPurchases();
                }
            }

            currentPurCart = []; renderPurCart();
            document.getElementById('pur-paid').value = '';
            document.getElementById('pur-discount').value = '0';
            document.getElementById('is-return-pur').checked = false; togglePurMode();
            renderAll();
        }

        function printInvoice(inv) {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div class="text-center mb-6">
                    ${db.settings.logo ? `<img src="${db.settings.logo}" style="height: 80px; margin: 0 auto 10px auto; display: block;">` : ''}
                    <h1 class="text-2xl font-bold">${db.settings.companyName}</h1>
                    <p class="text-sm">${db.settings.address} - ${db.settings.phone}</p>
                    <p class="text-sm">الرقم الضريبي: ${db.settings.vatNumber}</p>
                </div>
                <div class="flex justify-between border-b pb-4 mb-4">
                    <div class="text-right">
                        <p><strong>فاتورة ضريبية</strong></p>
                        <p>العميل: ${inv.customer}</p>
                    </div>
                    <div class="text-left">
                        <p>التاريخ: ${inv.date}</p>
                        <p>رقم: #${inv.id}</p>
                    </div>
                </div>
                <table class="w-full text-sm mb-6 border-collapse border border-black">
                    <thead><tr class="bg-gray-100"><th class="border border-black p-2">الصنف</th><th class="border border-black p-2">الكمية</th><th class="border border-black p-2">السعر</th><th class="border border-black p-2">الإجمالي</th></tr></thead>
                    <tbody>
                        ${inv.items.map(i => `<tr><td class="border border-black p-2">${i.name}</td><td class="border border-black p-2">${i.qty}</td><td class="border border-black p-2">${(i.price || 0).toFixed(2)}</td><td class="border border-black p-2">${(i.total || (i.price * i.qty) || 0).toFixed(2)}</td></tr>`).join('')}
                    </tbody>
                </table>
                <div class="flex flex-col items-end w-full text-sm">
                    ${inv.subtotal !== undefined ? `<div class="w-48 flex justify-between mb-1"><span>المجموع:</span><span>${inv.subtotal.toFixed(2)} ${db.settings.currency || ''}</span></div>` : ''}
                    ${inv.discount ? `<div class="w-48 flex justify-between mb-1 text-red-600"><span>الخصم:</span><span>-${inv.discount.toFixed(2)} ${db.settings.currency || ''}</span></div>` : ''}
                    ${inv.vat !== undefined ? `<div class="w-48 flex justify-between mb-1"><span>الضريبة:</span><span>${inv.vat.toFixed(2)} ${db.settings.currency || ''}</span></div>` : ''}
                    <div class="w-48 flex justify-between font-bold text-lg border-t-2 border-black pt-2 mt-2"><span>الإجمالي:</span><span>${(inv.total || 0).toFixed(2)} ${db.settings.currency || ''}</span></div>
                </div>
            `;
            window.print();
        }

        // --- 7.1 Purchases Logic ---
        function updatePurCost(select) {
            const opt = select.options[select.selectedIndex];
            if (opt && opt.dataset.cost) document.getElementById('pur-cost').value = opt.dataset.cost;
        }

        // --- Purchase Combobox Logic ---
        let purComboActive = -1;

        function onPurProductFocus() {
            onPurProductInput(document.getElementById('pur-product-input').value);
        }

        function onPurProductInput(query) {
            const container = document.getElementById('pur-suggestions');
            const q = query.trim().toLowerCase();
            let html = '';
            purComboActive = -1;

            if (!db.products) db.products = [];
            if (!db.services) db.services = [];

            const filteredProducts = db.products.filter(p => p.name.toLowerCase().includes(q));
            const filteredServices = db.services.filter(s => s.name.toLowerCase().includes(q));

            if (q === '') {
                // show all products
                html = db.products.map((p, i) => `
                    <div class="pur-suggestion-item" data-index="${i}" onclick="selectPurProduct(${p.id}, 'product')">
                        <span class="item-name"><i class="fas fa-box text-blue-500 me-1"></i> ${p.name}</span>
                        <span class="item-meta">تكلفة: ${p.cost || 0} | مخزون: ${p.stock || 0}</span>
                    </div>`).join('');
                html += db.services.map((s, i) => `
                    <div class="pur-suggestion-item" data-index="${db.products.length + i}" onclick="selectPurProduct(${s.id}, 'service')">
                        <span class="item-name"><i class="fas fa-concierge-bell text-emerald-500 me-1"></i> ${s.name}</span>
                        <span class="item-meta">سعر: ${s.price || 0}</span>
                    </div>`).join('');
            } else {
                html = filteredProducts.map((p, i) => `
                    <div class="pur-suggestion-item" data-index="${i}" onclick="selectPurProduct(${p.id}, 'product')">
                        <span class="item-name"><i class="fas fa-box text-blue-500 me-1"></i> ${p.name}</span>
                        <span class="item-meta">تكلفة: ${p.cost || 0} | مخزون: ${p.stock || 0}</span>
                    </div>`).join('');

                html += filteredServices.map((s, i) => `
                    <div class="pur-suggestion-item" data-index="${filteredProducts.length + i}" onclick="selectPurProduct(${s.id}, 'service')">
                        <span class="item-name"><i class="fas fa-concierge-bell text-emerald-500 me-1"></i> ${s.name}</span>
                        <span class="item-meta">سعر: ${s.price || 0}</span>
                    </div>`).join('');

                // If no exact match, show "add new product" option
                const exactMatchProd = db.products.some(p => p.name.toLowerCase() === q);
                const exactMatchServ = db.services.some(s => s.name.toLowerCase() === q);

                if (!exactMatchProd && !exactMatchServ && q.length > 0) {
                    const newIdx = filteredProducts.length + filteredServices.length;
                    html += `
                    <div class="pur-suggestion-item pur-suggestion-new" data-index="${newIdx}" onclick="selectNewPurProduct('${query.replace(/'/g, "\\'")}')"> 
                        <span class="font-bold"><i class="fas fa-plus-circle text-orange-500 me-1"></i> إضافة كمنتج جديد: "${query}"</span>
                    </div>`;
                    html += `
                    <div class="pur-suggestion-item pur-suggestion-new" data-index="${newIdx + 1}" onclick="selectNewPurService('${query.replace(/'/g, "\\'")}')"> 
                        <span class="font-bold"><i class="fas fa-plus-circle text-emerald-500 me-1"></i> إضافة كخدمة جديدة: "${query}"</span>
                    </div>`;
                }
            }

            container.innerHTML = html;
            container.classList.toggle('open', html.length > 0);
        }

        function selectPurProduct(productId, type = 'product') {
            if (type === 'product') {
                const prod = db.products.find(p => p.id == productId);
                if (!prod) return;
                document.getElementById('pur-product-input').value = prod.name;
                document.getElementById('pur-product-id').value = prod.id;
                document.getElementById('pur-product-type').value = 'product';
                document.getElementById('pur-cost').value = prod.cost || '';
            } else {
                const serv = db.services.find(s => s.id == productId);
                if (!serv) return;
                document.getElementById('pur-product-input').value = serv.name;
                document.getElementById('pur-product-id').value = serv.id;
                document.getElementById('pur-product-type').value = 'service';
                document.getElementById('pur-cost').value = serv.cost || serv.price || '';
            }
            document.getElementById('pur-suggestions').classList.remove('open');
        }

        function selectNewPurProduct(name) {
            document.getElementById('pur-product-input').value = name;
            document.getElementById('pur-product-id').value = '__new__';
            document.getElementById('pur-product-type').value = 'product';
            document.getElementById('pur-cost').value = '';
            document.getElementById('pur-cost').focus();
            document.getElementById('pur-suggestions').classList.remove('open');
        }

        function selectNewPurService(name) {
            document.getElementById('pur-product-input').value = name;
            document.getElementById('pur-product-id').value = '__new_service__';
            document.getElementById('pur-product-type').value = 'service';
            document.getElementById('pur-cost').value = '';
            document.getElementById('pur-cost').focus();
            document.getElementById('pur-suggestions').classList.remove('open');
        }

        function onPurProductKeydown(e) {
            const container = document.getElementById('pur-suggestions');
            const items = container.querySelectorAll('.pur-suggestion-item');
            if (!items.length) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                purComboActive = Math.min(purComboActive + 1, items.length - 1);
                updatePurComboHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                purComboActive = Math.max(purComboActive - 1, 0);
                updatePurComboHighlight(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (purComboActive >= 0 && items[purComboActive]) {
                    items[purComboActive].click();
                }
            } else if (e.key === 'Escape') {
                container.classList.remove('open');
            }
        }

        function updatePurComboHighlight(items) {
            items.forEach((el, i) => {
                el.classList.toggle('active', i === purComboActive);
            });
            if (items[purComboActive]) items[purComboActive].scrollIntoView({ block: 'nearest' });
        }

        // Close suggestions on outside click
        document.addEventListener('click', function (e) {
            const wrapper = document.querySelector('.pur-combobox-wrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                document.getElementById('pur-suggestions').classList.remove('open');
            }
        });

        function addToPurCart() {
            const prodIdVal = document.getElementById('pur-product-id').value;
            const prodName = document.getElementById('pur-product-input').value.trim();
            const qty = parseFloat(document.getElementById('pur-qty').value);
            const cost = parseFloat(document.getElementById('pur-cost').value);

            const type = document.getElementById('pur-product-type').value;

            if (!prodName || !qty || !cost) return showToast('بيانات ناقصة', 'error');

            let item;
            if (prodIdVal && !prodIdVal.startsWith('__new')) {
                // Existing product or service
                if (type === 'product') {
                    const prod = db.products.find(p => p.id == prodIdVal);
                    if (!prod) return showToast('منتج غير موجود', 'error');
                    item = { ...prod, qty, cost, total: cost * qty, type: 'product' };
                } else {
                    const serv = db.services.find(s => s.id == prodIdVal);
                    if (!serv) return showToast('خدمة غير موجودة', 'error');
                    item = { ...serv, qty, cost, total: cost * qty, type: 'service' };
                }
            } else {
                // New product or service
                const isService = prodIdVal === '__new_service__' || type === 'service';
                item = {
                    id: '__new_' + Date.now(),
                    name: prodName,
                    price: cost,
                    cost: cost,
                    stock: 0,
                    qty,
                    total: cost * qty,
                    isNew: true,
                    type: isService ? 'service' : 'product'
                };
            }

            currentPurCart.push(item);
            document.getElementById('pur-product-input').value = '';
            document.getElementById('pur-product-id').value = '';
            document.getElementById('pur-cost').value = '';
            renderPurCart();
        }

        function renderPurCart() {
            const tbody = document.getElementById('pur-cart-body');
            tbody.innerHTML = '';
            let subtotal = 0;
            currentPurCart.forEach((item, idx) => {
                subtotal += item.total;
                const typeIcon = item.type === 'service' ? '<i class="fas fa-concierge-bell text-emerald-500" title="خدمة"></i>' : '<i class="fas fa-box text-blue-500" title="منتج"></i>';
                tbody.innerHTML += `
                    <tr class="bg-white">
                        <td class="p-2 text-right">${typeIcon} ${item.name}</td>
                        <td class="p-2 font-bold">${item.qty}</td>
                        <td class="p-2">${item.cost}</td>
                        <td class="p-2">${item.total.toFixed(2)}</td>
                        <td class="p-2"><button onclick="currentPurCart.splice(${idx},1);renderPurCart()" class="text-red-500"><i class="fas fa-times"></i></button></td>
                    </tr>`;
            });
            const discount = parseFloat(document.getElementById('pur-discount').value) || 0;
            const net = Math.max(0, subtotal - discount);
            const vat = net * 0.15;
            const total = net + vat;

            document.getElementById('pur-subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('pur-vat').innerText = vat.toFixed(2);
            document.getElementById('pur-total').innerText = total.toFixed(2);

            if (!document.getElementById('pur-paid').value && total > 0) document.getElementById('pur-paid').value = total.toFixed(2);
        }







        // --- 7.1 Inventory Logic ---
        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('prod-id').value;
            const name = document.getElementById('new-prod-name').value;
            const price = parseFloat(document.getElementById('new-prod-price').value);
            const cost = parseFloat(document.getElementById('new-prod-cost').value) || 0;
            const stock = parseFloat(document.getElementById('new-prod-stock').value) || 0;

            if (id) {
                const p = db.products.find(x => x.id == id);
                if (p) { p.name = name; p.price = price; p.cost = cost; p.stock = stock; }
            } else {
                db.products.push({ id: Date.now(), name, price, cost, stock });
            }
            save(); filterInventory(''); resetProductForm(); showToast('تم حفظ المنتج');
        }

        function filterInventory(q) {
            const list = document.getElementById('inventory-list');
            if (!list) return;
            const filtered = db.products.filter(p => p.name.includes(q));
            list.innerHTML = filtered.map(p => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 font-bold">${p.name}</td><td class="p-3 text-emerald-600">${p.price}</td><td class="p-3 text-slate-500">${p.cost}</td><td class="p-3 font-bold">${p.stock}</td>
                    <td class="p-3 flex gap-2"><button onclick="editProduct(${p.id})" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="deleteProduct(${p.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }

        function editProduct(id) {
            const p = db.products.find(x => x.id == id);
            if (p) {
                document.getElementById('prod-id').value = p.id;
                document.getElementById('new-prod-name').value = p.name;
                document.getElementById('new-prod-price').value = p.price;
                document.getElementById('new-prod-cost').value = p.cost;
                document.getElementById('new-prod-stock').value = p.stock;
                document.getElementById('prod-form-title').innerText = 'تعديل منتج';
            }
        }

        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                db.products = db.products.filter(x => x.id != id);
                save(); filterInventory(''); showToast('تم حذف المنتج');
            }
        }

        function resetProductForm() {
            document.getElementById('prod-id').value = '';
            document.getElementById('new-prod-name').value = '';
            document.getElementById('new-prod-price').value = '';
            document.getElementById('new-prod-cost').value = '';
            document.getElementById('new-prod-stock').value = '';
            document.getElementById('prod-form-title').innerText = 'إضافة صنف جديد';
        }

        // --- 7.2 Suppliers Logic ---
        function saveSupplier(e) {
            e.preventDefault();
            const id = document.getElementById('supp-id').value;
            const name = document.getElementById('supp-name').value;
            const company = document.getElementById('supp-company').value;
            const address = document.getElementById('supp-address').value;
            const phone = document.getElementById('supp-phone').value;
            const vat = document.getElementById('supp-vat').value;

            if (id) {
                const s = db.suppliers.find(x => x.id == id);
                if (s) { s.name = name; s.company = company; s.address = address; s.phone = phone; s.vat = vat; }
                showToast('تم تعديل المورد');
            } else {
                db.suppliers.push({ id: Date.now(), name, company, address, phone, vat });
                showToast('تم إضافة المورد');
            }
            save(); renderSuppliersTable(); populateSelects(); resetSupplierForm();
        }
        function renderSuppliersTable() {
            document.getElementById('suppliers-list').innerHTML = db.suppliers.map(s => `
                <tr class="hover:bg-slate-50 border-b"><td class="p-3 font-bold">${s.name}</td><td class="p-3 text-sm text-slate-500">${s.company || '-'}</td><td class="p-3 text-sm">${s.phone || '-'}</td>
                <td class="p-3"><button onclick="editSupplier(${s.id})" class="text-blue-500 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition"><i class="fas fa-edit"></i></button></td></tr>
            `).join('');
        }
        function editSupplier(id) {
            const s = db.suppliers.find(x => x.id == id);
            if (s) {
                document.getElementById('supp-id').value = s.id;
                document.getElementById('supp-name').value = s.name;
                document.getElementById('supp-company').value = s.company || '';
                document.getElementById('supp-address').value = s.address || '';
                document.getElementById('supp-phone').value = s.phone || '';
                document.getElementById('supp-vat').value = s.vat || '';
            }
        }
        function resetSupplierForm() {
            document.getElementById('supp-id').value = '';
            document.getElementById('supp-name').value = '';
            document.getElementById('supp-company').value = '';
            document.getElementById('supp-address').value = '';
            document.getElementById('supp-phone').value = '';
            document.getElementById('supp-vat').value = '';
        }

        // --- 7.4 Customers Logic (New) ---
        function saveCustomer(e) {
            e.preventDefault();
            const id = document.getElementById('cust-id').value;
            const name = document.getElementById('cust-name').value;
            const company = document.getElementById('cust-company').value;
            const address = document.getElementById('cust-address').value;
            const phone = document.getElementById('cust-phone').value;
            const vat = document.getElementById('cust-vat').value;

            if (id) {
                const c = db.customers.find(x => x.id == id);
                if (c) { c.name = name; c.company = company; c.address = address; c.phone = phone; c.vat = vat; }
                showToast('تم تعديل العميل');
            } else {
                db.customers.push({ id: Date.now(), name, company, address, phone, vat });
                showToast('تم إضافة العميل');
            }
            save(); renderCustomersTable(); populateSelects(); resetCustomerForm();
        }

        function renderCustomersTable() {
            document.getElementById('customers-list').innerHTML = db.customers.map(c => `
                <tr class="hover:bg-slate-50 border-b"><td class="p-3 font-bold">${c.name}</td><td class="p-3 text-sm text-slate-500">${c.company || '-'}</td><td class="p-3 text-sm">${c.phone || '-'}</td>
                <td class="p-3"><button onclick="editCustomer(${c.id})" class="text-blue-500 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition"><i class="fas fa-edit"></i></button></td></tr>
            `).join('');
        }

        function editCustomer(id) {
            const c = db.customers.find(x => x.id == id);
            if (c) {
                document.getElementById('cust-id').value = c.id;
                document.getElementById('cust-name').value = c.name;
                document.getElementById('cust-company').value = c.company || '';
                document.getElementById('cust-address').value = c.address || '';
                document.getElementById('cust-phone').value = c.phone || '';
                document.getElementById('cust-vat').value = c.vat || '';
            }
        }

        function resetCustomerForm() {
            document.getElementById('cust-id').value = '';
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-company').value = '';
            document.getElementById('cust-address').value = '';
            document.getElementById('cust-phone').value = '';
            document.getElementById('cust-vat').value = '';
        }


        // --- 8. Charts & Reports ---
        function renderSalesChart() {
            // Simple bar chart for last 7 days sales
            const container = document.getElementById('sales-chart');
            container.innerHTML = '';
            const last7Days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toISOString().split('T')[0];
            }).reverse();

            const maxSale = Math.max(...last7Days.map(d => db.sales.filter(s => s.date === d).reduce((sum, s) => sum + s.total, 0))) || 100;

            last7Days.forEach(date => {
                const daySales = db.sales.filter(s => s.date === date).reduce((sum, s) => sum + s.total, 0);
                const height = (daySales / maxSale) * 100;

                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${height}%`;
                bar.innerHTML = `
                    <span class="chart-value">${daySales > 0 ? daySales : ''}</span>
                    <span class="chart-label">${date.slice(5)}</span>
                `;
                container.appendChild(bar);
            });
        }

        // --- 9. Manual Journal & Settings UI (Same as before) ---
        function addJournalLineRow() {
            const div = document.createElement('div'); div.className = 'grid grid-cols-12 gap-2 j-row mb-2';
            const opts = db.chartOfAccounts.filter(a => !a.isGroup).map(a => `<option value="${a.code}">${a.code} - ${a.name}</option>`).join('');
            div.innerHTML = `<div class="col-span-6"><select class="w-full p-2 border rounded text-sm j-code">${opts}</select></div><div class="col-span-2"><input type="number" class="w-full p-2 border rounded text-sm j-dr" placeholder="0" onchange="calcJTotals()"></div><div class="col-span-2"><input type="number" class="w-full p-2 border rounded text-sm j-cr" placeholder="0" onchange="calcJTotals()"></div><div class="col-span-2"><button onclick="this.parentElement.remove();calcJTotals()" class="text-red-500 w-full"><i class="fas fa-times"></i></button></div>`;
            document.getElementById('journal-lines').appendChild(div);
        }
        function calcJTotals() {
            let dr = 0, cr = 0; document.querySelectorAll('.j-dr').forEach(i => dr += parseFloat(i.value || 0)); document.querySelectorAll('.j-cr').forEach(i => cr += parseFloat(i.value || 0));
            document.getElementById('total-dr').innerText = dr.toFixed(2); document.getElementById('total-cr').innerText = cr.toFixed(2);
            document.getElementById('unbalanced-msg').classList.toggle('hidden', Math.abs(dr - cr) <= 0.01);
        }
        function saveManualJournal() {
            const date = document.getElementById('manual-date').value;
            const desc = document.getElementById('manual-desc').value;
            const lines = [];

            document.querySelectorAll('.journal-row').forEach(row => {
                const code = row.querySelector('.acc-select').value;
                const dr = parseFloat(row.querySelector('.dr-input').value) || 0;
                const cr = parseFloat(row.querySelector('.cr-input').value) || 0;
                if (code && (dr > 0 || cr > 0)) lines.push({ code, dr, cr });
            });

            if (lines.length < 2) return showToast('أدخل طرفين للقيد على الأقل', 'error');

            if (addJournalEntry(date, desc, lines, 'Adjustment')) {
                showToast('تم ترحيل القيد');
                document.getElementById('journal-lines').innerHTML = '';
                addJournalLineRow(); addJournalLineRow();
                document.getElementById('manual-desc').value = '';
                calcJTotals();
                save(); renderAll();
            }
        }

        function saveSettings(e) {
            e.preventDefault();
            db.settings.companyName = document.getElementById('set-name').value;
            db.settings.vatRate = parseFloat(document.getElementById('set-vat-rate').value);
            db.settings.currency = document.getElementById('set-currency').value;
            db.settings.phone = document.getElementById('set-phone').value;
            db.settings.address = document.getElementById('set-address').value;
            db.settings.vatNumber = document.getElementById('set-vat-no').value;
            db.settings.logo = document.getElementById('set-logo-url').value;

            save();
            loadSettingsToForm();
            updateLogoView();
            showToast('تم الحفظ');
        }

        function addPaymentMethod() {
            const val = document.getElementById('new-pay-method').value.trim();
            if (val && !db.settings.paymentMethods.includes(val)) {
                db.settings.paymentMethods.push(val);
                save(); renderPaymentMethods();
                document.getElementById('new-pay-method').value = '';
            }
        }

        function deletePaymentMethod(m) {
            if (confirm('حذف طريقة الدفع؟')) {
                db.settings.paymentMethods = db.settings.paymentMethods.filter(x => x !== m);
                save(); renderPaymentMethods();
            }
        }

        function renderPaymentMethods() {
            if (!db.settings.paymentMethods) db.settings.paymentMethods = ['Cash', 'Bank'];
            const list = document.getElementById('payment-methods-list');
            if (list) {
                list.innerHTML = db.settings.paymentMethods.map(m => `
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs flex items-center gap-1 font-bold">
                        ${m} <button onclick="deletePaymentMethod('${m}')" class="text-red-500 hover:text-red-700 ml-1 bg-white rounded-full w-4 h-4 flex items-center justify-center"><i class="fas fa-times text-[10px]"></i></button>
                    </span>
                `).join('');
            }
        }

        function loadSettingsToForm() { document.getElementById('set-name').value = db.settings.companyName; document.getElementById('set-vat-rate').value = db.settings.vatRate; document.getElementById('set-currency').value = db.settings.currency; document.getElementById('set-phone').value = db.settings.phone; document.getElementById('set-address').value = db.settings.address; document.getElementById('set-vat-no').value = db.settings.vatNumber; document.getElementById('set-logo-url').value = db.settings.logo || ''; document.getElementById('header-company-name').innerText = db.settings.companyName; document.querySelectorAll('.currency').forEach(el => el.setAttribute('data-curr', db.settings.currency)); document.getElementById('cart-vat-rate').innerText = db.settings.vatRate; renderPaymentMethods(); }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "WEBMAX_ERP_Backup_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(inp) {
            const f = inp.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const importedDb = JSON.parse(e.target.result);
                    if (importedDb && importedDb.settings) {
                        db = importedDb;
                        save();
                        alert('تم استعادة النسخة الاحتياطية بنجاح! سيتم إعادة تحميل النظام.');
                        location.reload();
                    } else {
                        alert('ملف النسخة الاحتياطية غير صالح!');
                    }
                } catch (x) {
                    alert('خطأ في قراءة ملف النسخة الاحتياطية');
                }
            };
            r.readAsText(f);
        }

        function resetData() {
            if (confirm('تحذير خطير: هل أنت متأكد من تصفير النظام؟ سيتم مسح جميع حركات البيع، الشراء، المصروفات والقيود اليومية والرواتب. (سيتم الاحتفاظ بالمستخدمين، الإعدادات، الأصناف، العملاء والدليل المحاسبي الأساسي)')) {
                // Keep Structural Data
                const preservedUsers = db.users;
                const preservedSettings = db.settings;
                const preservedCoA = db.chartOfAccounts;
                const preservedProducts = db.products;
                const preservedCustomers = db.customers;
                const preservedSuppliers = db.suppliers;
                const preservedEmployees = db.employees;

                // Reset Transactional Data
                db = {
                    users: preservedUsers,
                    settings: preservedSettings,
                    chartOfAccounts: preservedCoA,
                    products: preservedProducts,
                    customers: preservedCustomers,
                    suppliers: preservedSuppliers,
                    employees: preservedEmployees,
                    sales: [],
                    purchases: [],
                    expenses: [],
                    journal: [],
                    installments: [],
                    installmentCustomers: db.installmentCustomers || [], // Usually keep names, but drop invoices (below)
                    installmentInvoices: [],
                    installmentCollections: [],
                    services: [],
                    hr_actions: [],
                    hr_payroll: []
                };

                save();
                alert('تم تصفير حركات النظام بنجاح وبدء دورة مالية جديدة.');
                location.reload();
            }
        }

        function updateLogoView() {
            const logoImg = document.getElementById('sidebar-logo-img');
            const defIcon = document.getElementById('default-logo-icon');
            if (db.settings.logo) {
                logoImg.src = db.settings.logo;
                logoImg.classList.remove('hidden');
                defIcon.classList.add('hidden');
            } else {
                logoImg.classList.add('hidden');
                defIcon.classList.remove('hidden');
            }
        }

        // --- 10. Rendering ---
        function renderInventoryTable() {
            const list = document.getElementById('inventory-list');
            if (list) list.innerHTML = db.products.map(p => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 font-bold">${p.name}</td><td class="p-3 text-emerald-600">${p.price}</td><td class="p-3 text-slate-500">${p.cost}</td><td class="p-3 font-bold">${p.stock}</td>
                    <td class="p-3 flex gap-2"><button onclick="editProduct(${p.id})" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="deleteProduct(${p.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }

        function renderRecentSales() {
            const container = document.getElementById('recent-invoices');
            if (container) container.innerHTML = db.sales.slice().reverse().slice(0, 10).map(inv => `
                <div class="p-2 bg-slate-50 rounded border text-xs cursor-pointer hover:bg-blue-50" onclick="viewInvoice(${inv.id})">
                    <div class="flex justify-between font-bold"><span>#${inv.id}</span><span>${inv.total.toFixed(2)}</span></div>
                    <div class="text-slate-500">${inv.customer}</div>
                </div>`).join('');
        }

        function renderRecentPurchases() {
            const purTbody = document.getElementById('recent-pur-body');
            if (purTbody) {
                const purchases = [...db.purchases].reverse();
                purTbody.innerHTML = purchases.length ? purchases.map((p, i) => {
                    const status = (p.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">\u0622\u062c\u0644</span>' : '<span class="text-emerald-600">\u0645\u062f\u0641\u0648\u0639</span>';
                    return `<tr class="hover:bg-orange-50 cursor-pointer" ondblclick="viewPurchaseInvoice(${p.id})">
                        <td class="p-1.5 font-mono text-orange-600">${p.invoiceNo || 'PUR-' + p.id}</td>
                        <td class="p-1.5">${p.date}</td>
                        <td class="p-1.5 font-bold">${p.supplier}</td>
                        <td class="p-1.5 font-bold">${(p.total || 0).toFixed(2)}</td>
                        <td class="p-1.5">${status}</td>
                        <td class="p-1.5"><button onclick="viewPurchaseInvoice(${p.id})" class="text-blue-500 hover:text-blue-700"><i class="fas fa-eye"></i></button></td>
                    </tr>`;
                }).join('') : '<tr><td colspan="6" class="p-3 text-center text-slate-400">لا توجد بيانات</td></tr>';
            }
        }

        let _coaDragSrc = null;

        function renderCOATable() {
            const tbody = document.getElementById('coa-body');
            if (!tbody) return;

            // Current User Permissions Check
            let canEdit = true;
            if (currentUser && currentUser.permissions && currentUser.permissions.accounts) {
                canEdit = currentUser.permissions.accounts.edit;
            } else if (currentUser && currentUser.role !== 'admin') {
                canEdit = false; // Fallback for old users without permissions array
            }

            tbody.innerHTML = db.chartOfAccounts.map((a, idx) => {
                const bal = getAccountBalance(a.code);
                const balColor = bal < 0 ? '#ef4444' : '#059669';

                const dragAttrs = canEdit ? `draggable="true" ondragstart="coaDragStart(event)" ondragover="coaDragOver(event)" ondrop="coaDrop(event)" ondragend="coaDragEnd(event)" cursor:grab;` : `cursor:default;`;
                const dragIcon = canEdit ? `<i class="fas fa-grip-vertical" style="font-size:10px;"></i>` : ``;

                const editBtn = canEdit ? `
                    <button onclick="editAccount('${a.code}')" title="تعديل"
                        style="background:#eff6ff; color:#2563eb; border:none; width:24px; height:24px; border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-edit" style="font-size:10px;"></i>
                    </button>
                    <button onclick="deleteAccount('${a.code}')" title="حذف"
                        style="background:#fef2f2; color:#ef4444; border:none; width:24px; height:24px; border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-trash" style="font-size:10px;"></i>
                    </button>` : ``;

                return `<tr dir="rtl" style="border-bottom:1px solid #f1f5f9; ${canEdit ? 'cursor:grab;' : ''}"
                            data-code="${a.code}"
                            ${dragAttrs}
                            onmouseover="this.style.background='#eff6ff'"
                            onmouseout="this.style.background=''">
                    <td style="width:30px; padding:5px 4px; text-align:center; color:#cbd5e1; user-select:none;">
                        ${dragIcon}
                    </td>
                    <td style="width:70px; padding:5px 6px; text-align:right; font-family:monospace; font-size:11px; white-space:nowrap; overflow:hidden;">${a.code}</td>
                    <td style="padding:5px 6px; text-align:right; font-size:11px; font-weight:500; max-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${a.name}">${a.name}</td>
                    <td style="width:70px; padding:5px 6px; text-align:right; font-size:9px; color:#94a3b8; white-space:nowrap; overflow:hidden;">${a.type}</td>
                    <td style="width:90px; padding:5px 6px; text-align:center; font-weight:bold; font-size:11px; color:${balColor}; white-space:nowrap; overflow:hidden;">${bal.toFixed(2)}</td>
                    <td style="width:100px; padding:5px 4px; text-align:center;">
                        <div style="display:flex; justify-content:center; gap:3px;">
                            <button onclick="viewAccount('${a.code}')" title="التفاصيل"
                                style="background:#f3f4f6; color:#475569; border:none; width:24px; height:24px; border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-eye" style="font-size:10px;"></i>
                            </button>
                            ${editBtn}
                        </div>
                    </td>
                </tr>`;
            }).join('');
            populateCoAParents();
        }

        function coaDragStart(e) {
            _coaDragSrc = e.currentTarget.dataset.code;
            e.currentTarget.style.opacity = '0.4';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', _coaDragSrc);
        }

        function coaDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            document.querySelectorAll('#coa-body tr').forEach(r => {
                r.style.borderTop = '';
                r.style.boxShadow = '';
            });
            e.currentTarget.style.borderTop = '2px solid #3b82f6';
            e.currentTarget.style.boxShadow = '0 -2px 0 #3b82f6';
        }

        function coaDrop(e) {
            e.preventDefault();
            const fromCode = e.dataTransfer.getData('text/plain');
            const toCode = e.currentTarget.dataset.code;
            if (!fromCode || fromCode === toCode) return;
            const arr = db.chartOfAccounts;
            const fromIdx = arr.findIndex(a => a.code === fromCode);
            const toIdx = arr.findIndex(a => a.code === toCode);
            if (fromIdx === -1 || toIdx === -1) return;
            const [moved] = arr.splice(fromIdx, 1);
            arr.splice(toIdx, 0, moved);
            save(); // Save the new explicit ordering
            renderCOATable();
        }

        function coaDragEnd(e) {
            document.querySelectorAll('#coa-body tr').forEach(r => {
                r.style.opacity = '1';
                r.style.borderTop = '';
                r.style.boxShadow = '';
            });
        }
        function exportCoA() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "الكود,اسم الحساب,النوع,الرصيد\n";

            const typeMap = {
                'asset': 'أصول',
                'liability': 'الالتزامات',
                'equity': 'حقوق الملكية',
                'revenue': 'الإيرادات',
                'expense': 'المصروفات'
            };

            db.chartOfAccounts.forEach(a => {
                const bal = getAccountBalance(a.code);
                const translatedType = typeMap[a.type] || a.type;
                const safeName = a.name ? a.name.replace(/"/g, '""') : '';

                // Use ="code" to force Excel to treat it as string and not drop leading zeros
                csvContent += `="${a.code}","${safeName}","${translatedType}",${bal.toFixed(2)}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `ChartOfAccounts_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveAccount(e) {
            e.preventDefault();

            // Permission Check
            if (currentUser && currentUser.permissions && currentUser.permissions.accounts) {
                if (!currentUser.permissions.accounts.add) {
                    return showToast('عفواً، لا تملك صلاحية إضافة حسابات جديدة', 'error');
                }
            } else if (currentUser && currentUser.role !== 'admin') {
                return showToast('عفواً، لا تملك صلاحية إضافة حسابات', 'error');
            }

            const id = document.getElementById('coa-id').value;
            const name = document.getElementById('coa-name').value;
            let code = document.getElementById('coa-code').value;
            const type = document.getElementById('coa-type').value;
            const parent = document.getElementById('coa-parent').value;
            const initBal = parseFloat(document.getElementById('coa-balance').value) || 0;

            if (!id && !code) {
                // Generate auto code if not provided
                const prefix = parent || (type === 'asset' ? '1' : type === 'liability' ? '2' : type === 'equity' ? '3' : type === 'revenue' ? '4' : '5');
                const existing = db.chartOfAccounts.filter(a => a.code.startsWith(prefix) && a.code.length > prefix.length);
                const nextSuffix = (existing.length + 1).toString().padStart(2, '0');
                code = prefix + nextSuffix;
            }

            if (id) {
                const acc = db.chartOfAccounts.find(a => a.code == id);
                if (acc) {
                    if (code !== id && db.chartOfAccounts.some(a => a.code == code)) {
                        return showToast('الكود موجود بالفعل', 'error');
                    }
                    acc.code = code || id;
                    acc.name = name;
                    acc.type = type;
                    acc.parent = parent;
                    acc.level = parent ? (db.chartOfAccounts.find(x => x.code == parent)?.level + 1 || 2) : 1;
                    acc.balance = initBal;
                }
            } else {
                if (db.chartOfAccounts.some(a => a.code == code)) return showToast('الكود موجود بالفعل', 'error');
                const level = parent ? (db.chartOfAccounts.find(x => x.code == parent)?.level + 1 || 2) : 1;
                db.chartOfAccounts.push({
                    code, name, type, parent, level, balance: initBal, isGroup: false
                });
                // Removed auto-sort to preserve manual ordering
            }
            save(); renderAll(); resetCoAForm();
            showToast('تم حفظ الحساب بنجاح ✅');
        }

        function viewAccount(code) {
            const acc = db.chartOfAccounts.find(a => a.code == code);
            if (!acc) return;

            document.getElementById('coa-det-code-val').innerText = acc.code;

            // For printing
            const today = new Date();
            const dateStr = today.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            document.getElementById('print-coa-date').innerText = 'تاريخ الطباعة: ' + dateStr;

            document.getElementById('coa-det-name').innerText = acc.name;
            document.getElementById('coa-det-init').innerText = (acc.balance || 0).toFixed(2);
            document.getElementById('coa-det-type').innerText = acc.type;

            const tbody = document.getElementById('coa-det-body');
            tbody.innerHTML = '';

            let runningBal = parseFloat(acc.balance || 0);
            let html = '';

            // Initial Balance Row
            html += `<tr class="bg-slate-50 border-b">
                <td class="p-2 text-slate-500">-</td>
                <td class="p-2 text-slate-500">-</td>
                <td class="p-2 font-bold text-slate-600">رصيد افتتاحي</td>
                <td class="p-2 text-center text-slate-400">-</td>
                <td class="p-2 text-center text-slate-400">-</td>
                <td class="p-2 text-center font-bold" dir="ltr">${runningBal.toFixed(2)}</td>
            </tr>`;

            const relatedEntries = [];
            db.journal.forEach(entry => {
                entry.lines.forEach(line => {
                    if (line.code === code) {
                        relatedEntries.push({
                            date: entry.date,
                            id: entry.id,
                            desc: entry.desc,
                            dr: line.dr,
                            cr: line.cr
                        });
                    }
                });
            });

            relatedEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

            relatedEntries.forEach(entry => {
                if (acc.type === 'asset' || acc.type === 'expense') {
                    runningBal += (entry.dr - entry.cr);
                } else {
                    runningBal += (entry.cr - entry.dr);
                }

                html += `<tr class="border-b hover:bg-slate-50">
                    <td class="p-2 text-xs">${entry.date}</td>
                    <td class="p-2 text-xs font-mono text-blue-600 cursor-pointer" onclick="viewEntry(${entry.id}); closeModal('coa-details-modal')">#${entry.id}</td>
                    <td class="p-2 text-xs" title="${entry.desc}">${entry.desc.length > 40 ? entry.desc.substring(0, 40) + '...' : entry.desc}</td>
                    <td class="p-2 text-center text-emerald-600 font-mono">${entry.dr > 0 ? entry.dr.toFixed(2) : '-'}</td>
                    <td class="p-2 text-center text-red-500 font-mono">${entry.cr > 0 ? entry.cr.toFixed(2) : '-'}</td>
                    <td class="p-2 text-center font-bold font-mono" dir="ltr">${runningBal.toFixed(2)}</td>
                </tr>`;
            });

            tbody.innerHTML = html;
            document.getElementById('coa-det-curr').innerText = runningBal.toFixed(2);
            document.getElementById('coa-details-modal').classList.add('active');
        }

        function editAccount(code) {
            const acc = db.chartOfAccounts.find(a => a.code == code);
            if (!acc) return;
            document.getElementById('coa-id').value = acc.code;
            document.getElementById('coa-code').value = acc.code;
            document.getElementById('coa-name').value = acc.name;
            document.getElementById('coa-type').value = acc.type;
            document.getElementById('coa-parent').value = acc.parent || '';
            document.getElementById('coa-balance').value = acc.balance || 0;
            document.getElementById('coa-form-title').innerText = 'تعديل حساب';
            const formEl = document.getElementById('coa-form');
            if (formEl) formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function resetCoAForm() {
            document.getElementById('coa-id').value = '';
            document.getElementById('coa-code').value = '';
            document.getElementById('coa-name').value = '';
            document.getElementById('coa-balance').value = 0;
            document.getElementById('coa-form-title').innerText = 'إضافة حساب جديد';
        }

        function populateCoAParents() {
            const dl = document.getElementById('coa-parent-list');
            if (!dl) return;
            dl.innerHTML = '<option value="">-- بدون (حساب رئيسي) --</option>' +
                db.chartOfAccounts.map(a => `<option value="${a.code}">${a.code} - ${a.name}</option>`).join('');
        }

        function deleteAccount(code) {
            // Permission Check
            if (currentUser && currentUser.permissions && currentUser.permissions.accounts) {
                if (!currentUser.permissions.accounts.edit) {
                    return showToast('عفواً، لا تملك صلاحية التعديل أو الحذف', 'error');
                }
            } else if (currentUser && currentUser.role !== 'admin') {
                return showToast('عفواً، لا تملك صلاحية الحذف', 'error');
            }

            if (confirm('هل أنت متأكد من حذف هذا الحساب؟')) {
                if (db.chartOfAccounts.some(a => a.parent == code)) return showToast('لا يمكن حذف حساب له حسابات فرعية', 'error');
                if (db.journal.some(j => j.lines.some(l => l.code == code))) return showToast('لا يمكن حذف حساب له قيود يومية', 'error');
                db.chartOfAccounts = db.chartOfAccounts.filter(a => a.code !== code);
                save(); renderAll();
                showToast('تم حذف الحساب');
            }
        }

        function moveAccount(code, dir) {
            const arr = db.chartOfAccounts;
            const idx = arr.findIndex(a => a.code === code);
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= arr.length) return;
            [arr[idx], arr[newIdx]] = [arr[newIdx], arr[idx]];
            save(); renderCOATable();
        }

        function renderReports() {
            // Apply Date Filter logic here for reports (IS)
            const from = new Date(document.getElementById('rpt-start-date').value);
            const to = new Date(document.getElementById('rpt-end-date').value);
            to.setHours(23, 59, 59); // End of day

            // Filter journal entries by date
            const filteredJournal = db.journal.filter(e => {
                const d = new Date(e.date);
                return d >= from && d <= to;
            });

            // Calculate balances from filtered journal
            let tempBalances = {};
            db.chartOfAccounts.forEach(a => tempBalances[a.code] = 0);

            filteredJournal.forEach(e => {
                e.lines.forEach(l => {
                    const acc = db.chartOfAccounts.find(a => a.code === l.code);
                    if (acc) {
                        if (acc.type === 'asset' || acc.type === 'expense') tempBalances[l.code] += ((l.dr || 0) - (l.cr || 0));
                        else tempBalances[l.code] += ((l.cr || 0) - (l.dr || 0));
                    }
                });
            });

            // Aggregate Groups
            const getFilteredBal = (code) => {
                const acc = db.chartOfAccounts.find(a => a.code === code);
                if (!acc.isGroup) return tempBalances[code] || 0;
                const children = db.chartOfAccounts.filter(a => a.parent === code);
                return children.reduce((sum, child) => sum + getFilteredBal(child.code), 0);
            };

            const rev = getFilteredBal('4');
            const exp = getFilteredBal('5');
            const cogs = getFilteredBal('5101');

            document.getElementById('is-rev').innerText = rev.toFixed(2);
            document.getElementById('is-cogs').innerText = cogs.toFixed(2);
            document.getElementById('is-gross').innerText = (rev - cogs).toFixed(2);
            document.getElementById('is-exp').innerText = (exp - cogs).toFixed(2);
            document.getElementById('is-net').innerText = (rev - exp).toFixed(2);

            document.getElementById('rpt-sales-total').innerText = rev.toFixed(2);
            document.getElementById('rpt-pur-total').innerText = filteredJournal.reduce((sum, e) => sum + (e.desc.includes('فاتورة مشتريات') ? e.lines.find(l => l.code == '1104')?.dr || 0 : 0), 0).toFixed(2);
            document.getElementById('rpt-exp-total').innerText = (exp - cogs).toFixed(2);

            // TB (Cumulative always)
            let tbDr = 0, tbCr = 0;
            document.getElementById('trial-balance-body').innerHTML = db.chartOfAccounts.filter(a => !a.isGroup).map(a => {
                if (a.balance == 0) return '';
                let dr = 0, cr = 0;
                if (['asset', 'expense'].includes(a.type)) { if (a.balance > 0) dr = a.balance; else cr = -a.balance; }
                else { if (a.balance > 0) cr = a.balance; else dr = -a.balance; }
                tbDr += dr; tbCr += cr;
                return `<tr><td class="p-2 border-b">${a.name}</td><td class="p-2 border-b text-emerald-600">${dr ? dr.toFixed(2) : '-'}</td><td class="p-2 border-b text-red-600">${cr ? cr.toFixed(2) : '-'}</td></tr>`;
            }).join('');
            document.getElementById('tb-total-dr').innerText = tbDr.toFixed(2);
            document.getElementById('tb-total-cr').innerText = tbCr.toFixed(2);
        }


        function getAccountBalance(code) {
            const acc = db.chartOfAccounts.find(a => a.code === code);
            if (!acc) return 0;
            if (acc.isGroup) {
                return db.chartOfAccounts.filter(a => a.parent === code).reduce((sum, child) => sum + getAccountBalance(child.code), 0);
            }
            // Calc from Journal
            let bal = 0;
            db.journal.forEach(e => {
                e.lines.forEach(l => {
                    if (l.code === code) {
                        if (acc.type === 'asset' || acc.type === 'expense') bal += ((l.dr || 0) - (l.cr || 0));
                        else bal += ((l.cr || 0) - (l.dr || 0));
                    }
                });
            });
            return bal;
        }

        function renderAll() {
            // Dashboard Counters
            try {
                const cash = getAccountBalance('1101') + getAccountBalance('1102');
                if (document.getElementById('dash-cash')) document.getElementById('dash-cash').innerText = cash.toFixed(2);

                // Revenue account (includes sales, services, and installment collections)
                const revenue = getAccountBalance('4');
                if (document.getElementById('dash-sales')) document.getElementById('dash-sales').innerText = revenue.toFixed(2);

                const expenses = getAccountBalance('5');
                if (document.getElementById('dash-expenses')) document.getElementById('dash-expenses').innerText = expenses.toFixed(2);

                const netProfit = revenue - expenses;
                if (document.getElementById('dash-net-profit')) document.getElementById('dash-net-profit').innerText = netProfit.toFixed(2);
            } catch (e) { console.error('Dashboard error:', e); }

            // Table Renders
            try { renderInventoryTable(); } catch (e) { }
            try { renderRecentSales(); } catch (e) { }
            try { renderRecentQuotations(); } catch (e) { }
            try { renderRecentPurchaseOrders(); } catch (e) { }
            try { renderRecentPurchases(); } catch (e) { }
            try { renderJournal(); } catch (e) { }
            try { renderCOATable(); } catch (e) { }
            try { renderUsersTable(); } catch (e) { }
            try { renderSuppliersTable(); } catch (e) { }
            try { renderCustomersTable(); } catch (e) { }
            try { renderSalesChart(); } catch (e) { }
            try { renderReports(); } catch (e) { }
            try { renderExpenses(); } catch (e) { }
            try { renderIncomes(); } catch (e) { }
            try { renderPOSProducts(); } catch (e) { }
            try { renderServiceCart(); } catch (e) { }
            try { renderServices(); } catch (e) { }
            try { renderEmployees(); } catch (e) { }
            try { renderPayrollHistory(); } catch (e) { }
            try { renderInstallments(); } catch (e) { }
            try { renderPaymentMethods(); } catch (e) { }
            try { renderPurchaseInvoices(); } catch (e) { }
            try { renderSalesInvoices(); } catch (e) { }
            try { renderServiceInvoices(); } catch (e) { }

            // Update header
            try {
                if (document.getElementById('header-company-name')) document.getElementById('header-company-name').innerText = db.settings.companyName;
            } catch (e) { }
        }

        // --- Helpers ---
        function showToast(msg, type = 'success') {
            const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<i class="fas fa-${type == 'success' ? 'check' : 'times'}-circle"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300) }, 3000);
        }
        function toggleSidebar() {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay');
            if (sb.classList.contains('translate-x-full')) { sb.classList.remove('translate-x-full'); ov.classList.remove('hidden'); setTimeout(() => ov.classList.remove('opacity-0'), 10); }
            else { sb.classList.add('translate-x-full'); ov.classList.add('opacity-0'); setTimeout(() => ov.classList.add('hidden'), 300); }
        }
        function toggleSubMenu(btn) {
            const submenu = btn.nextElementSibling;
            const arrow = btn.querySelector('.submenu-arrow');
            if (submenu) {
                submenu.classList.toggle('hidden');
                if (arrow) arrow.style.transform = submenu.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            }
        }
        function showSection(id) {
            // Comprehensive Permission Enforcement (Routing)
            if (id !== 'dashboard' && id !== 'login' && currentUser && currentUser.role !== 'admin') {
                const p = currentUser.permissions || {};
                let hasAccess = true;
                let reqPerm = '';

                // Map sections to their required permission key
                const permMap = {
                    'pos': p.pos, 'pos_products': p.pos, 'barcode': p.pos,
                    'invoices': p.invoices, 'inv_sales': p.invoices, 'inv_purchases': p.invoices, 'inv_services': p.invoices, 'inv_installments': p.invoices,
                    'sales': p.sales, 'customers': p.sales, 'cust_statement': p.sales,
                    'purchases': p.purchases, 'suppliers': p.purchases, 'supp_statement': p.purchases,
                    'services': p.services, 'svc_statement': p.services,
                    'inventory': p.inventory,
                    'installments': p.installments, 'installment_customers': p.installments, 'inst_collection': p.installments,
                    'expenses': p.expenses, 'expense_vouchers': p.expenses,
                    'incomes': p.incomes !== false, 'income_vouchers': p.incomes !== false,
                    'hr': p.hr, 'hr_actions': p.hr, 'hr_list': p.hr, 'hr_payroll': p.hr, 'hr_emp_statement': p.hr,
                    'reports': p.reports, 'rpt_pos': p.reports, 'rpt_sales': p.reports, 'rpt_customers': p.reports, 'rpt_purchases': p.reports, 'rpt_suppliers': p.reports, 'rpt_employees': p.reports, 'rpt_inventory': p.reports, 'rpt_services': p.reports, 'rpt_installments': p.reports, 'rpt_inst_customers': p.reports, 'rpt_expenses': p.reports, 'rpt_revenue': p.reports, 'rpt_treasury': p.reports, 'rpt_profits': p.reports,
                    'users': p.settings, 'settings': p.settings
                };

                // Accounting has specialized sub-permissions
                if (id === 'accounts_tree' || id === 'journal') {
                    const accPerms = p.accounts || { view: false };
                    hasAccess = accPerms.view;
                    reqPerm = 'المحاسبة';
                } else if (permMap[id] !== undefined) {
                    hasAccess = permMap[id] !== false; // Default true if undefined for legacy users
                }

                if (!hasAccess) {
                    showToast(`عفواً، لا تملك صلاحية لفتح هذا القسم`, 'error');
                    return showSection('dashboard');
                }

                // Hide Add Form if no permission (Accounting specific)
                if (id === 'accounts_tree') {
                    const canAdd = p.accounts ? p.accounts.add : false;
                    const addFormContainer = document.getElementById('coa-form')?.parentElement;
                    if (addFormContainer) addFormContainer.style.display = canAdd ? 'block' : 'none';
                    const addManualJournal = document.getElementById('manual-entry-form');
                    if (addManualJournal) addManualJournal.style.display = canAdd ? 'block' : 'none';
                }
            }

            document.querySelectorAll('.section-content').forEach(e => e.classList.remove('active'));
            const section = document.getElementById(id);
            if (!section) { console.error('Section not found:', id); return; }
            section.classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-blue-300'));
            const btn = document.querySelector(`button[data-target="${id}"]`); if (btn) btn.classList.add('text-blue-300');
            if (window.innerWidth < 768) toggleSidebar();

            // Trigger section-specific rendering
            try {
                if (id === 'pos') renderPOSProducts();
                if (id === 'accounts_tree') renderCOATable();
                if (id === 'reports') renderReports();
                if (id === 'inventory') filterInventory('');
            } catch (e) { console.error('Section render error:', e); }
        }

        function filterAccounts(q) {
            const rows = document.querySelectorAll('#coa-body tr');
            rows.forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;
            let csv = [];
            const companyName = db.settings?.companyName || 'نظام ERP';

            csv.push('"' + companyName + '"');
            csv.push('"' + filename + '"');
            csv.push('"' + 'تاريخ الاستخراج: ' + new Date().toLocaleString('ar-EG') + '"');
            csv.push('');

            const rows = table.querySelectorAll('tr');
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) row.push('"' + (cols[j].innerText || '').replace(/"/g, '""') + '"');
                csv.push(row.join(','));
            }
            const blob = new Blob(["\uFEFF" + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- 11. Installment Module Logic ---
        function updateInstPrice(sel) {
            const opt = sel.options[sel.selectedIndex];
            if (opt) {
                const prod = db.products.find(p => p.id == sel.value);
                if (prod) {
                    document.getElementById('inst-price').value = prod.price;
                    calcInst();
                }
            }
        }

        function calcInst() {
            const price = parseFloat(document.getElementById('inst-price').value) || 0;
            const down = parseFloat(document.getElementById('inst-down').value) || 0;
            const count = parseInt(document.getElementById('inst-count').value) || 1;

            const remaining = Math.max(0, price - down);
            const monthly = count > 0 ? remaining / count : 0;

            document.getElementById('inst-monthly').value = monthly.toFixed(2);
        }

        function createInstallmentPlan() {
            const custId = document.getElementById('inst-customer').value;
            const prodId = document.getElementById('inst-product').value;
            const price = parseFloat(document.getElementById('inst-price').value) || 0;
            const down = parseFloat(document.getElementById('inst-down').value) || 0;
            const count = parseInt(document.getElementById('inst-count').value) || 12;
            const method = document.getElementById('inst-method').value;

            if (!custId || !prodId || !price) return showToast('بيانات ناقصة', 'error');

            const customer = (db.installmentCustomers || []).find(c => c.id == custId);
            const product = db.products.find(p => p.id == prodId);
            const monthly = parseFloat(document.getElementById('inst-monthly').value);
            const date = new Date().toISOString().split('T')[0];
            const remaining = price - down;

            // Sequential invoice number
            if (!db.installmentInvoices) db.installmentInvoices = [];
            const nextNum = db.installmentInvoices.length + 1;
            const invoiceNo = 'INST-' + String(nextNum).padStart(4, '0');

            const lines = [];
            // Down payment is Revenue + Cash/Bank
            if (down > 0) {
                lines.push({ code: getMethodAccount(method), dr: down, cr: 0 });
                lines.push({ code: '4101', dr: 0, cr: down });
            }
            // The remaining amount is Receivable (1103) vs Deferred/Stock cleanup
            // For simplicity in this ERP, we'll track the balance in 1103
            if (remaining > 0) {
                lines.push({ code: '1103', dr: remaining, cr: 0 }); // DR Receivable
                lines.push({ code: '2103', dr: 0, cr: remaining }); // CR Deferred Revenue
            }

            // Stock reduction logic
            lines.push({ code: '5101', dr: product.cost, cr: 0 }); // COGS
            lines.push({ code: '1104', dr: 0, cr: product.cost }); // Inventory

            if (addJournalEntry(date, `فاتورة تقسيط ${invoiceNo} - ${customer.name} (${product.name})`, lines)) {
                // Generate Installments
                const schedule = [];
                for (let i = 0; i < count; i++) {
                    const d = new Date();
                    d.setMonth(d.getMonth() + i + 1);
                    schedule.push({
                        num: i + 1,
                        dueDate: d.toISOString().split('T')[0],
                        amount: monthly,
                        status: 'pending'
                    });
                }

                const invObj = {
                    id: Date.now(),
                    invoiceNo,
                    date,
                    customerId: custId,
                    customer: customer.name,
                    phone: customer.phone || '-',
                    total: price,
                    down,
                    remaining,
                    paid: down,
                    count,
                    schedule,
                    items: [{ ...product, qty: 1, price: price, total: price }]
                };
                db.installmentInvoices.push(invObj);

                // Reduce Stock
                product.stock -= 1;

                showToast(`تم إنشاء فاتورة التقسيط ${invoiceNo} ✅`);
                save(); renderInstallments(); renderAll();
                document.getElementById('inst-price').value = '';
                document.getElementById('inst-down').value = '';
            }
        }

        function renderInstallments() {
            if (!db.installmentInvoices) db.installmentInvoices = [];
            const tbody = document.getElementById('installments-summary-list');
            if (!tbody) return;

            tbody.innerHTML = db.installmentInvoices.map(inv => {
                const nextInst = (inv.schedule || []).find(s => s.status === 'pending');
                const nextDue = nextInst ? nextInst.dueDate : '-';

                return `<tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 font-bold">${inv.customer}</td>
                    <td class="p-3">${inv.phone || '-'}</td>
                    <td class="p-3 font-mono text-indigo-600">${inv.invoiceNo}</td>
                    <td class="p-3 font-bold">${inv.total.toFixed(2)}</td>
                    <td class="p-3">${inv.count}</td>
                    <td class="p-3 text-emerald-600 font-bold">${(inv.paid || 0).toFixed(2)}</td>
                    <td class="p-3 text-red-600 font-bold">${(inv.remaining || 0).toFixed(2)}</td>
                    <td class="p-3 ${nextInst && new Date(nextDue) < new Date() ? 'text-red-600 font-bold' : ''}">${nextDue}</td>
                    <td class="p-3 text-center">
                        <button onclick="viewInstDetails('${inv.invoiceNo}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-700 shadow">عرض \u0631\u0624\u064a\u0629</button>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="9" class="p-4 text-center text-slate-400">لا توجد فواتير تقسيط</td></tr>';

            // Update summary counters
            if (document.getElementById('inv-inst-count')) document.getElementById('inv-inst-count').innerText = db.installmentInvoices.length;
            if (document.getElementById('inv-inst-total')) document.getElementById('inv-inst-total').innerText = db.installmentInvoices.reduce((a, b) => a + b.total, 0).toFixed(2);
            if (document.getElementById('inv-inst-paid')) document.getElementById('inv-inst-paid').innerText = db.installmentInvoices.reduce((a, b) => a + (b.paid || 0), 0).toFixed(2);
            if (document.getElementById('inv-inst-rem')) document.getElementById('inv-inst-rem').innerText = db.installmentInvoices.reduce((a, b) => a + (b.remaining || 0), 0).toFixed(2);
        }

        function viewInstDetails(invoiceNo) {
            const inv = db.installmentInvoices.find(i => i.invoiceNo === invoiceNo);
            if (!inv) return;

            document.getElementById('inst-details-title').innerText = `\u062a\u0641\u0627\u0635\u064a\u0644 \u0627\u0644\u0623\u0642\u0633\u0627\u0637 - ${inv.invoiceNo}`;
            document.getElementById('inst-details-info').innerHTML = `
                <div><strong>\u0627\u0644\u0639\u0645\u064a\u0644:</strong> ${inv.customer}</div>
                <div><strong>\u0627\u0644\u0647\u0627\u062a\u0641:</strong> ${inv.phone}</div>
                <div><strong>\u0627\u0644\u0625\u062c\u0645\u0627\u0644\u064a:</strong> ${inv.total.toFixed(2)}</div>
                <div><strong>\u0627\u0644\u0645\u062a\u0628\u0642\u064a:</strong> <span class="text-red-600 font-bold">${inv.remaining.toFixed(2)}</span></div>
            `;

            const tbody = document.getElementById('inst-details-list');
            tbody.innerHTML = (inv.schedule || []).map(s => {
                const isLate = s.status === 'pending' && new Date(s.dueDate) < new Date();
                const statusText = s.status === 'paid' ? 'مدفوع' : (isLate ? 'متأخر' : 'مستحق');
                const statusClass = s.status === 'paid' ? 'text-emerald-600 bg-emerald-50' : (isLate ? 'text-red-600 bg-red-50' : 'text-slate-600');

                return `<tr>
                    <td class="p-2.5 font-bold">#${s.num}</td>
                    <td class="p-2.5 ${isLate ? 'text-red-600 font-bold' : ''}">${s.dueDate}</td>
                    <td class="p-2.5 font-bold">${s.amount.toFixed(2)}</td>
                    <td class="p-2.5"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${statusClass}">${statusText}</span></td>
                    <td class="p-2.5 text-center">
                        ${s.status === 'pending' ? `<button onclick="payInstallment('${inv.invoiceNo}', ${s.num})" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] shadow">تحصيل</button>` : '✅'}
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('inst-details-modal').classList.remove('hidden');
        }

        function payInstallment(invoiceNo, num) {
            if (!confirm('\u062a\u0623\u0643\u064a\u062f \u062a\u062d\u0635\u064a\u0644 \u0627\u0644\u0642\u0633\u0637\u061f')) return;
            const inv = db.installmentInvoices.find(i => i.invoiceNo === invoiceNo);
            if (!inv) return;

            const inst = inv.schedule.find(s => s.num === num);
            if (inst && inst.status === 'pending') {
                const date = new Date().toISOString().split('T')[0];
                const lines = [
                    { code: '1101', dr: inst.amount, cr: 0 },    // Cash
                    { code: '4101', dr: 0, cr: inst.amount },   // Revenue
                    { code: '2103', dr: inst.amount, cr: 0 },   // Reduction of Deferred Revenue
                    { code: '1103', dr: 0, cr: inst.amount }    // Reduction of Receivable
                ];

                if (addJournalEntry(date, `تحصيل قسط #${num} - ${inv.invoiceNo} (${inv.customer})`, lines)) {
                    inst.status = 'paid';
                    inst.paidDate = date;
                    inv.paid = (inv.paid || 0) + inst.amount;
                    inv.remaining = Math.max(0, inv.total - inv.paid);

                    save();
                    renderInstallments();
                    viewInstDetails(invoiceNo); // Refresh details modal
                    renderAll();
                    showToast('\u062a\u0645 \u0627\u0644\u062a\u062d\u0635\u064a\u0644 \u0648\u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u0625\u064a\u0631\u0627\u062f \u2705');
                }
            }
        }

        function filterInstallments(q) {
            const rows = document.querySelectorAll('#installments-summary-list tr');
            rows.forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- 12. Services Module Logic ---
        let currentSrvCart = [];
        let srvComboActive = -1;

        function renderServices() {
            if (!db.services) db.services = [];
            const list = document.getElementById('services-list');
            if (list) list.innerHTML = db.services.map(s => `
                <tr class="hover:bg-slate-50">
                    <td class="p-1.5 font-bold">${s.name}</td>
                    <td class="p-1.5 font-mono text-red-500">${s.cost || 0}</td>
                    <td class="p-1.5 font-mono text-emerald-600">${s.price}</td>
                    <td class="p-1.5"><button onclick="editService(${s.id})" class="text-blue-500"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');

            const methodSel = document.getElementById('srv-method');
            if (methodSel && db.settings.paymentMethods) methodSel.innerHTML = db.settings.paymentMethods.map(m => `<option value="${m}">${m}</option>`).join('');

            // Set date
            const dateEl = document.getElementById('srv-date');
            if (dateEl && !dateEl.value) dateEl.value = new Date().toISOString().split('T')[0];

            // Set next invoice number
            if (!db.serviceInvoices) db.serviceInvoices = [];
            const srvNumEl = document.getElementById('srv-num');
            if (srvNumEl) srvNumEl.innerText = String(db.serviceInvoices.length + 1).padStart(4, '0');
        }

        function saveService(e) {
            e.preventDefault();
            const id = document.getElementById('serv-id').value;
            const name = document.getElementById('serv-name').value;
            const cost = parseFloat(document.getElementById('serv-cost').value) || 0;
            const price = parseFloat(document.getElementById('serv-price').value);
            const desc = document.getElementById('serv-desc').value;

            if (id) {
                const s = db.services.find(x => x.id == id);
                if (s) { s.name = name; s.cost = cost; s.price = price; s.description = desc; }
            } else {
                db.services.push({ id: Date.now(), name, cost, price, description: desc });
            }
            save(); renderServices();
            document.getElementById('serv-id').value = '';
            document.getElementById('serv-form').reset();
            showToast('تم حفظ الخدمة');
        }

        function editService(id) {
            const s = db.services.find(x => x.id == id);
            if (s) {
                document.getElementById('serv-id').value = s.id;
                document.getElementById('serv-name').value = s.name;
                document.getElementById('serv-cost').value = s.cost || 0;
                document.getElementById('serv-price').value = s.price;
                document.getElementById('serv-desc').value = s.description || '';
            }
        }

        // --- Service Combobox Logic ---
        function onSrvProductFocus() {
            onSrvProductInput(document.getElementById('srv-product-input').value);
        }

        function onSrvProductInput(query) {
            const container = document.getElementById('srv-suggestions');
            if (!db.services) db.services = [];
            const q = query.trim().toLowerCase();
            let html = '';
            srvComboActive = -1;

            const filtered = db.services.filter(s => s.name.toLowerCase().includes(q));

            if (q === '') {
                html = db.services.map((s, i) => `
                    <div class="pur-suggestion-item" data-index="${i}" onclick="selectSrvProduct(${s.id})">
                        <span class="item-name">${s.name}</span>
                        <span class="item-meta">سعر: ${s.price || 0}</span>
                    </div>`).join('');
            } else {
                html = filtered.map((s, i) => `
                    <div class="pur-suggestion-item" data-index="${i}" onclick="selectSrvProduct(${s.id})">
                        <span class="item-name">${s.name}</span>
                        <span class="item-meta">سعر: ${s.price || 0}</span>
                    </div>`).join('');

                const exactMatch = db.services.some(s => s.name.toLowerCase() === q);
                if (!exactMatch && q.length > 0) {
                    const newIdx = filtered.length;
                    html += `
                    <div class="pur-suggestion-item pur-suggestion-new" data-index="${newIdx}" onclick="selectNewSrvProduct('${query.replace(/'/g, "\\'")}')">
                        <span><i class="fas fa-plus-circle"></i> إضافة خدمة جديدة: "${query}"</span>
                    </div>`;
                }
            }

            container.innerHTML = html;
            container.classList.toggle('open', html.length > 0);
        }

        function selectSrvProduct(id) {
            const serv = db.services.find(s => s.id == id);
            if (serv) {
                document.getElementById('srv-product-input').value = serv.name;
                document.getElementById('srv-product-id').value = serv.id;
                document.getElementById('srv-price-input').value = serv.price;
            }
            document.getElementById('srv-suggestions').classList.remove('open');
            document.getElementById('srv-suggestions').innerHTML = '';
        }

        function selectNewSrvProduct(name) {
            document.getElementById('srv-product-input').value = name;
            document.getElementById('srv-product-id').value = '__new__';
            document.getElementById('srv-price-input').value = '';
            document.getElementById('srv-price-input').focus();
            document.getElementById('srv-suggestions').classList.remove('open');
            document.getElementById('srv-suggestions').innerHTML = '';
        }

        function onSrvProductKeydown(e) {
            const container = document.getElementById('srv-suggestions');
            const items = container.querySelectorAll('.pur-suggestion-item');
            if (!items.length) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                srvComboActive = Math.min(srvComboActive + 1, items.length - 1);
                updateSrvComboHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                srvComboActive = Math.max(srvComboActive - 1, 0);
                updateSrvComboHighlight(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (srvComboActive >= 0 && srvComboActive < items.length) {
                    items[srvComboActive].click();
                }
            } else if (e.key === 'Escape') {
                container.classList.remove('open');
                container.innerHTML = '';
            }
        }

        let srvCustComboActive = -1;
        function onSrvCustomerFocus() {
            onSrvCustomerInput(document.getElementById('srv-customer').value);
        }
        function onSrvCustomerInput(query) {
            const container = document.getElementById('srv-customer-suggestions');
            if (!db.customers) db.customers = [];
            const q = query.trim().toLowerCase();
            let html = '';
            srvCustComboActive = -1;
            const filtered = db.customers.filter(c => c.name.toLowerCase().includes(q));
            if (q === '') {
                html = db.customers.map((c, i) => `
                    <div class="pur-suggestion-item" data-index="${i}" onclick="selectSrvCustomer(${c.id})">
                        <span class="item-name">${c.name}</span>
                    </div>`).join('');
            } else {
                html = filtered.map((c, i) => `
                    <div class="pur-suggestion-item" data-index="${i}" onclick="selectSrvCustomer(${c.id})">
                        <span class="item-name">${c.name}</span>
                    </div>`).join('');
                const exactMatch = db.customers.some(c => c.name.toLowerCase() === q);
                if (!exactMatch && q.length > 0) {
                    html += `
                    <div class="pur-suggestion-item pur-suggestion-new" data-index="${filtered.length}" onclick="selectNewSrvCustomer('${query.replace(/'/g, "\\'")}')">
                        <span><i class="fas fa-plus-circle text-orange-500"></i> إضافة عميل جديد: "${query}"</span>
                    </div>`;
                }
            }
            container.innerHTML = html;
            container.classList.toggle('open', html.length > 0);
        }
        function selectSrvCustomer(id) {
            const cust = db.customers.find(c => c.id == id);
            if (cust) {
                document.getElementById('srv-customer').value = cust.name;
                document.getElementById('srv-customer-id').value = cust.id;
            }
            document.getElementById('srv-customer-suggestions').classList.remove('open');
        }
        function selectNewSrvCustomer(name) {
            document.getElementById('srv-customer').value = name;
            document.getElementById('srv-customer-id').value = '__new__';
            document.getElementById('srv-customer-suggestions').classList.remove('open');
        }
        function onSrvCustomerKeydown(e) {
            const container = document.getElementById('srv-customer-suggestions');
            const items = container.querySelectorAll('.pur-suggestion-item');
            if (!items.length) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                srvCustComboActive = Math.min(srvCustComboActive + 1, items.length - 1);
                items.forEach((item, i) => item.classList.toggle('active', i === srvCustComboActive));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                srvCustComboActive = Math.max(srvCustComboActive - 1, 0);
                items.forEach((item, i) => item.classList.toggle('active', i === srvCustComboActive));
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (srvCustComboActive >= 0) items[srvCustComboActive].click();
            } else if (e.key === 'Escape') {
                container.classList.remove('open');
            }
        }

        function updateSrvComboHighlight(items) {
            items.forEach((el, i) => {
                el.style.background = i === srvComboActive ? '#e2e8f0' : '';
            });
            if (srvComboActive >= 0 && items[srvComboActive]) items[srvComboActive].scrollIntoView({ block: 'nearest' });
        }

        // Close suggestions on outside click
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.srv-combobox-wrapper')) {
                const s = document.getElementById('srv-suggestions');
                if (s) { s.classList.remove('open'); s.innerHTML = ''; }
            }
            if (!e.target.closest('.srv-cust-wrapper')) {
                const s = document.getElementById('srv-customer-suggestions');
                if (s) { s.classList.remove('open'); s.innerHTML = ''; }
            }
            if (!e.target.closest('.pur-combobox-wrapper') && !e.target.closest('.po-supp-wrapper') && !e.target.closest('.quote-cust-wrapper') && !e.target.closest('.quote-prod-wrapper')) {
                const s = document.getElementById('pur-suggestions');
                if (s) { s.classList.remove('open'); s.innerHTML = ''; }
                const s2 = document.getElementById('po-suggestions');
                if (s2) { s2.classList.remove('open'); s2.innerHTML = ''; }
                const s3 = document.getElementById('po-supplier-suggestions');
                if (s3) { s3.classList.remove('open'); s3.innerHTML = ''; }
                const s4 = document.getElementById('quote-customer-suggestions');
                if (s4) { s4.classList.remove('open'); s4.innerHTML = ''; }
                const s5 = document.getElementById('quote-product-suggestions');
                if (s5) { s5.classList.remove('open'); s5.innerHTML = ''; }
            }
        });

        function addToServiceCart() {
            const srvIdVal = document.getElementById('srv-product-id').value;
            const srvName = document.getElementById('srv-product-input').value.trim();
            const price = parseFloat(document.getElementById('srv-price-input').value);
            const qty = parseInt(document.getElementById('srv-qty').value) || 1;

            if (!srvName) return showToast('اختر خدمة أو اكتب اسم خدمة', 'error');
            if (!price || price <= 0) return showToast('أدخل سعر الخدمة', 'error');

            let item;
            if (srvIdVal && srvIdVal !== '__new__') {
                const serv = db.services.find(s => s.id == srvIdVal);
                if (serv) {
                    item = { id: serv.id, name: serv.name, cost: serv.cost || 0, price, qty, total: price * qty };
                }
            }

            if (!item) {
                item = { id: '__new_' + Date.now(), name: srvName, price, qty, total: price * qty, isNew: true };
            }

            currentSrvCart.push(item);
            renderServiceCart();

            document.getElementById('srv-product-input').value = '';
            document.getElementById('srv-product-id').value = '';
            document.getElementById('srv-price-input').value = '';
            document.getElementById('srv-qty').value = '1';
        }

        function renderServiceCart() {
            const tbody = document.getElementById('srv-cart-body');
            let subtotal = 0;
            if (tbody) {
                tbody.innerHTML = currentSrvCart.map((item, idx) => {
                    const lineTotal = item.price * item.qty;
                    subtotal += lineTotal;
                    return `<tr>
                        <td class="p-2">${item.name}</td>
                        <td class="p-2">${item.qty}</td>
                        <td class="p-2 font-mono">${item.price.toFixed(2)}</td>
                        <td class="p-2 font-bold">${lineTotal.toFixed(2)}</td>
                        <td class="p-2"><button onclick="currentSrvCart.splice(${idx},1);renderServiceCart()" class="text-red-500"><i class="fas fa-times"></i></button></td>
                    </tr>`;
                }).join('');

                // VAT
                const vatRate = db.settings.vatRate || 15;
                const vatRateEl = document.getElementById('srv-vat-rate');
                if (vatRateEl) vatRateEl.innerText = vatRate;
                const vat = subtotal * (vatRate / 100);

                // Discount
                let discount = 0;
                const discToggle = document.getElementById('srv-disc-toggle');
                if (discToggle && discToggle.checked) {
                    const discType = document.getElementById('srv-disc-type').value;
                    const discVal = parseFloat(document.getElementById('srv-discount').value) || 0;
                    discount = discType === 'percent' ? (subtotal * discVal / 100) : discVal;
                }

                const grandTotal = subtotal + vat - discount;

                const subtotalEl = document.getElementById('srv-subtotal');
                if (subtotalEl) subtotalEl.innerText = subtotal.toFixed(2);
                const vatEl = document.getElementById('srv-vat');
                if (vatEl) vatEl.innerText = vat.toFixed(2);
                document.getElementById('srv-total').innerText = grandTotal.toFixed(2);

                // Update remaining if credit
                calcSrvRemaining();
            }
        }

        // --- Service Payment Helpers ---
        let srvPayType = 'cash';
        function setSrvPayType(type) {
            srvPayType = type;
            document.getElementById('srv-pay-cash-btn').className = 'flex-1 py-1.5 rounded text-xs font-bold ' + (type === 'cash' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-300');
            document.getElementById('srv-pay-credit-btn').className = 'flex-1 py-1.5 rounded text-xs font-bold ' + (type === 'credit' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-300');
            const creditArea = document.getElementById('srv-credit-area');
            const remainRow = document.getElementById('srv-remaining-row');
            if (type === 'credit') { creditArea.classList.remove('hidden'); remainRow.classList.remove('hidden'); }
            else { creditArea.classList.add('hidden'); remainRow.classList.add('hidden'); }
        }

        function calcSrvRemaining() {
            const subtotal = currentSrvCart.reduce((sum, item) => sum + item.price * item.qty, 0);
            const vatRate = db.settings.vatRate || 15;
            const vat = subtotal * (vatRate / 100);
            let discount = 0;
            const discToggle = document.getElementById('srv-disc-toggle');
            if (discToggle && discToggle.checked) {
                const discType = document.getElementById('srv-disc-type').value;
                const discVal = parseFloat(document.getElementById('srv-discount').value) || 0;
                discount = discType === 'percent' ? (subtotal * discVal / 100) : discVal;
            }
            const grandTotal = subtotal + vat - discount;
            const paid = parseFloat(document.getElementById('srv-paid')?.value) || 0;
            const rem = grandTotal - paid;
            const remEl = document.getElementById('srv-remaining');
            if (remEl) remEl.innerText = rem.toFixed(2);
        }

        function postServiceBill() {
            if (currentSrvCart.length === 0) return showToast('\u0627\u0644\u0641\u0627\u062a\u0648\u0631\u0629 \u0641\u0627\u0631\u063a\u0629', 'error');
            const subtotal = currentSrvCart.reduce((sum, item) => sum + item.price * item.qty, 0);
            const vatRate = db.settings.vatRate || 15;
            const vat = subtotal * (vatRate / 100);

            // Discount
            let discount = 0;
            const discToggle = document.getElementById('srv-disc-toggle');
            if (discToggle && discToggle.checked) {
                const discType = document.getElementById('srv-disc-type').value;
                const discVal = parseFloat(document.getElementById('srv-discount').value) || 0;
                discount = discType === 'percent' ? (subtotal * discVal / 100) : discVal;
            }

            const grandTotal = subtotal + vat - discount;
            const method = document.getElementById('srv-method')?.value || 'Cash';
            const custId = document.getElementById('srv-customer-id')?.value;
            let custName = document.getElementById('srv-customer')?.value || '\u0639\u0645\u064a\u0644 \u062e\u062f\u0645\u0627\u062a';
            const date = document.getElementById('srv-date')?.value || new Date().toISOString().split('T')[0];
            let paid, remaining;

            if (srvPayType === 'cash') {
                paid = grandTotal;
                remaining = 0;
            } else {
                paid = parseFloat(document.getElementById('srv-paid')?.value) || 0;
                remaining = grandTotal - paid;
            }

            // Sequential invoice number
            if (!db.serviceInvoices) db.serviceInvoices = [];
            const nextNum = db.serviceInvoices.length + 1;
            const invoiceNo = 'SVC-' + String(nextNum).padStart(4, '0');

            // Journal entries
            const lines = [
                { code: getMethodAccount(method), dr: paid, cr: 0 },
                { code: '4101', dr: 0, cr: subtotal }  // Revenue
            ];
            if (vat > 0) lines.push({ code: '2102', dr: 0, cr: vat }); // VAT Payable
            if (discount > 0) lines.push({ code: '4201', dr: discount, cr: 0 }); // Discount Allowed
            if (remaining > 0) lines.push({ code: '1201', dr: remaining, cr: 0 }); // Receivable

            if (addJournalEntry(date, `\u0641\u0627\u062a\u0648\u0631\u0629 \u062e\u062f\u0645\u0627\u062a ${invoiceNo} - ${custName}`, lines)) {
                // Handle new customer auto-creation
                if (custId === '__new__') {
                    const newId = Date.now();
                    db.customers.push({ id: newId, name: custName, phone: '', balance: 0 });
                }

                // Auto-create new services
                currentSrvCart.forEach(i => {
                    if (i.isNew) {
                        if (!db.services) db.services = [];
                        const newSrv = { id: Date.now() + Math.floor(Math.random() * 1000), name: i.name, cost: 0, price: i.price, description: '' };
                        db.services.push(newSrv);
                        i.id = newSrv.id;
                        delete i.isNew;
                    }
                });

                const invObj = {
                    id: Date.now(), invoiceNo, date, customer: custName,
                    subtotal, vat, vatRate, discount, total: grandTotal,
                    paid, remaining, method, type: 'service',
                    items: [...currentSrvCart]
                };
                db.serviceInvoices.push(invObj);
                showToast(`\u062a\u0645 \u062d\u0641\u0638 \u0641\u0627\u062a\u0648\u0631\u0629 \u0627\u0644\u062e\u062f\u0645\u0629 ${invoiceNo} \u2705`);

                // Update invoice number display
                const srvNumEl = document.getElementById('srv-num');
                if (srvNumEl) srvNumEl.innerText = String(db.serviceInvoices.length + 1).padStart(4, '0');

                // Reset form
                currentSrvCart = [];
                renderServiceCart();
                document.getElementById('srv-customer').value = '';
                document.getElementById('srv-customer-id').value = '';
                document.getElementById('srv-paid') && (document.getElementById('srv-paid').value = '');
                if (discToggle) { discToggle.checked = false; document.getElementById('srv-disc-area').classList.add('hidden'); }
                document.getElementById('srv-discount') && (document.getElementById('srv-discount').value = '0');
                setSrvPayType('cash');
                save();
                renderAll();
            }
        }

        // --- Service Invoice Sidebar ---
        function renderServiceInvoices() {
            if (!db.serviceInvoices) db.serviceInvoices = [];
            const tbody = document.getElementById('recent-srv-body');
            if (!tbody) return;
            const invoices = [...db.serviceInvoices].reverse();
            tbody.innerHTML = invoices.length ? invoices.map((s, i) => {
                const invNo = s.invoiceNo || ('SVC-' + String(invoices.length - i).padStart(4, '0'));
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                return `<tr class="hover:bg-purple-50 cursor-pointer" ondblclick="viewServiceInvoice(${s.id})">
                    <td class="p-1.5 font-mono text-purple-600">${invNo}</td>
                    <td class="p-1.5">${s.date}</td>
                    <td class="p-1.5 font-bold">${s.customer}</td>
                    <td class="p-1.5 font-bold">${(s.total || 0).toFixed(2)}</td>
                    <td class="p-1.5">${status}</td>
                    <td class="p-1.5"><button onclick="viewServiceInvoice(${s.id})" class="text-blue-500 hover:text-blue-700" title="عرض الفاتورة"><i class="fas fa-eye"></i></button></td>
                </tr>`;
            }).join('') : '<tr><td colspan="6" class="p-3 text-center text-slate-400">لا توجد فواتير</td></tr>';
        }

        function filterServiceInvoiceList(q) {
            document.querySelectorAll('#recent-srv-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        function viewServiceInvoice(id) {
            if (!db.serviceInvoices) return;
            const inv = db.serviceInvoices.find(s => s.id == id);
            if (!inv) return showToast('فاتورة غير موجودة', 'error');
            const w = window.open('', 'srv_invoice', 'width=700,height=800');
            w.document.write(`<html dir="rtl"><head><style>
                body { font-family: 'Cairo', sans-serif; max-width: 650px; margin: 20px auto; padding: 20px; font-size: 13px; }
                .header { text-align: center; margin-bottom: 20px; }
                .header h1 { font-size: 18px; margin: 0; } .header p { color: #666; font-size: 11px; margin: 2px 0; }
                .info { display: flex; justify-content: space-between; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
                .info div { font-size: 12px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                th { background: #1e293b; color: white; padding: 8px; text-align: right; font-size: 12px; }
                td { padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: right; font-size: 12px; }
                .totals { background: #f1f5f9; padding: 15px; border-radius: 8px; }
                .totals .row { display: flex; justify-content: space-between; margin-bottom: 5px; }
                .totals .grand { font-size: 18px; font-weight: bold; color: #7c3aed; border-top: 2px solid #cbd5e1; padding-top: 8px; margin-top: 8px; }
                .print-btn { display: block; margin: 20px auto; padding: 10px 40px; background: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
                @media print { .print-btn { display: none; } }
            </style></head><body>
            <div class="header">
                ${db.settings.logo ? `<img src="${db.settings.logo}" style="height: 60px; margin: 0 auto 8px; display: block;">` : ''}
                <h1>${db.settings.companyName}</h1>
                <p>${db.settings.address || ''} - ${db.settings.phone || ''}</p>
                <p>فاتورة خدمات</p>
            </div>
            <div class="info">
                <div><strong>العميل:</strong> ${inv.customer}<br><strong>التاريخ:</strong> ${inv.date}</div>
                <div><strong>رقم الفاتورة:</strong> ${inv.invoiceNo}<br><strong>طريقة الدفع:</strong> ${inv.method || 'كاش'}</div>
            </div>
            <table>
                <thead><tr><th>الخدمة</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead>
                <tbody>${inv.items.map(i => `<tr><td>${i.name}</td><td>${i.qty || 1}</td><td>${(i.price || 0).toFixed(2)}</td><td>${((i.price || 0) * (i.qty || 1)).toFixed(2)}</td></tr>`).join('')}</tbody>
            </table>
            <div class="totals">
                <div class="row"><span>المجموع:</span><span>${(inv.subtotal || 0).toFixed(2)}</span></div>
                ${(inv.vat || 0) > 0 ? `<div class="row"><span>الضريبة (${inv.vatRate || 15}%):</span><span>${inv.vat.toFixed(2)}</span></div>` : ''}
                ${(inv.discount || 0) > 0 ? `<div class="row" style="color:red"><span>الخصم:</span><span>-${inv.discount.toFixed(2)}</span></div>` : ''}
                <div class="row"><span>المدفوع:</span><span>${(inv.paid || 0).toFixed(2)}</span></div>
                ${(inv.remaining || 0) > 0 ? `<div class="row" style="color:red"><span>المتبقي:</span><span>${inv.remaining.toFixed(2)}</span></div>` : ''}
                <div class="row grand"><span>صافي الفاتورة:</span><span>${(inv.total || 0).toFixed(2)} ${db.settings.currency || 'ر.س'}</span></div>
            </div>
            <button class="print-btn" onclick="window.print()">🖨️ طباعة</button>
            </body></html>`);
            w.document.close();
        }

        // --- 13. Expenses Module Logic ---
        function renderExpenses() {
            if (!db.expensesCategories) {
                db.expensesCategories = [
                    { id: '5201', name: 'مصروفات تشغيلية' },
                    { id: '5202', name: 'مصروفات نثرية' },
                    { id: '5203', name: 'مصروفات أخرى (طارئة)' }
                ];
            }
            // Auto-migration: ensure 5202 is named Petty Cash and exists in the list
            const cat5202 = db.expensesCategories.find(c => c.id == '5202');
            if (cat5202) {
                cat5202.name = 'مصروفات نثرية';
            } else {
                db.expensesCategories.push({ id: '5202', name: 'مصروفات نثرية' });
                db.expensesCategories.sort((a, b) => parseInt(a.id) - parseInt(b.id));
            }

            const catSel = document.getElementById('exp-cat');
            if (catSel) catSel.innerHTML = db.expensesCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            const methodSel = document.getElementById('exp-method');
            if (methodSel && db.settings.paymentMethods) methodSel.innerHTML = db.settings.paymentMethods.map(m => `<option value="${m}">${m}</option>`).join('');

            if (!db.expenses) db.expenses = [];
            const list = document.getElementById('expenses-list');
            let total = 0;
            if (list) {
                list.innerHTML = db.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 50).map(e => {
                    total += parseFloat(e.amount);
                    return `<tr><td class="p-2 border-l">${e.date}</td><td class="p-2 border-l">${e.description}</td><td class="p-2 font-bold text-red-600 border-l">${parseFloat(e.amount).toFixed(2)}</td><td class="p-2 text-xs">${e.categoryName}</td></tr>`;
                }).join('');
                document.getElementById('exp-list-total').innerText = total.toFixed(2);
            }
        }

        function postExpense(e) {
            e.preventDefault();
            const desc = document.getElementById('exp-desc').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const catId = document.getElementById('exp-cat').value;
            const catName = db.expensesCategories.find(c => c.id == catId)?.name || 'مصروف';
            const method = document.getElementById('exp-method').value;
            const date = new Date().toISOString().split('T')[0];

            if (!amount || !desc) return showToast('بيانات ناقصة', 'error');

            const lines = [
                { code: catId, dr: amount, cr: 0 },
                { code: getMethodAccount(method), dr: 0, cr: amount }
            ];

            if (addJournalEntry(date, `مصروف - ${desc}`, lines)) {
                db.expenses.push({ id: Date.now(), date, description: desc, amount, categoryId: catId, categoryName: catName, method });
                showToast('تم تسجيل المصروف Successfully');
                document.getElementById('exp-desc').value = '';
                document.getElementById('exp-amount').value = '';
                save(); renderExpenses(); renderAll();
            }
        }

        // --- 13.5 Incomes Module Logic ---
        function renderIncomes() {
            if (!db.incomeCategories) {
                db.incomeCategories = [
                    { id: '4201', name: 'إيرادات مبيعات أخرى' },
                    { id: '4202', name: 'إيرادات خدمات' },
                    { id: '4203', name: 'إيرادات متنوعة' }
                ];
            }

            const catSel = document.getElementById('inc-cat');
            if (catSel) catSel.innerHTML = db.incomeCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            const methodSel = document.getElementById('inc-method');
            if (methodSel && db.settings.paymentMethods) methodSel.innerHTML = db.settings.paymentMethods.map(m => `<option value="${m}">${m}</option>`).join('');

            if (!db.incomes) db.incomes = [];
            const list = document.getElementById('incomes-list');
            let total = 0;
            if (list) {
                list.innerHTML = db.incomes.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 50).map(e => {
                    total += parseFloat(e.amount);
                    return `<tr><td class="p-2 border-l">${e.date}</td><td class="p-2 border-l">${e.description}</td><td class="p-2 font-bold text-emerald-600 border-l">${parseFloat(e.amount).toFixed(2)}</td><td class="p-2 text-xs">${e.categoryName}</td></tr>`;
                }).join('');
                document.getElementById('inc-list-total').innerText = total.toFixed(2);
            }
        }

        function postIncome(e) {
            e.preventDefault();
            const desc = document.getElementById('inc-desc').value;
            const amount = parseFloat(document.getElementById('inc-amount').value);
            const catId = document.getElementById('inc-cat').value;
            const catName = db.incomeCategories.find(c => c.id == catId)?.name || 'إيراد';
            const method = document.getElementById('inc-method').value;
            const date = new Date().toISOString().split('T')[0];

            if (!amount || !desc) return showToast('بيانات ناقصة', 'error');

            const lines = [
                { code: method || '1101', dr: amount, cr: 0 },
                { code: catId, dr: 0, cr: amount }
            ];

            if (addJournalEntry(date, `سند قبض - ${desc}`, lines)) {
                if (!db.incomes) db.incomes = [];
                db.incomes.push({ id: Date.now(), date, description: desc, amount, categoryId: catId, categoryName: catName, method });
                showToast('تم حفظ سند القبض بنجاح', 'success');
                document.getElementById('inc-desc').value = '';
                document.getElementById('inc-amount').value = '';
                save(); renderIncomes(); renderAll();
            }
        }

        // --- 14. POS Module Logic ---
        let posCart = [];

        function renderPOSProducts(q = '', cat = '') {
            const grid = document.getElementById('pos-grid');
            if (!grid) return;
            grid.innerHTML = db.products.filter(p => p.name.includes(q)).map(p => `
                <div class="bg-slate-50 border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition cursor-pointer group" onclick="addToPOSCart(${p.id})">
                    <div class="h-32 bg-slate-200 flex items-center justify-center relative">
                        ${p.image ? `<img src="${p.image}" class="w-full h-full object-cover">` : `<i class="fas fa-box text-4xl text-slate-400"></i>`}
                        <div class="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center text-white font-bold backdrop-blur-sm transition">إضافة للسلة</div>
                    </div>
                    <div class="p-3">
                        <div class="font-bold text-slate-800 text-sm truncate">${p.name}</div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-emerald-600 font-mono font-bold">${p.price}</span>
                            <span class="text-xs text-slate-500 bg-slate-200 px-1.5 py-0.5 rounded">مخزون: ${p.stock}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Populate Customers Select
            const custSel = document.getElementById('pos-customer');
            if (custSel && (!custSel.innerHTML || custSel.innerHTML.length < 10)) {
                custSel.innerHTML = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }

            // Render Other Methods
            const otherDiv = document.getElementById('pos-other-methods');
            if (otherDiv && db.settings.paymentMethods) {
                const others = db.settings.paymentMethods.filter(m => m !== 'Cash' && m !== 'Bank');
                otherDiv.innerHTML = others.map(m => `
                    <button onclick="checkoutPOS('${m}')" class="bg-slate-700 text-white py-2 rounded font-bold hover:bg-slate-600 text-xs shadow">${m}</button>
                `).join('');
            }
        }



        function addToPOSCart(id) {
            const p = db.products.find(x => x.id == id);
            if (!p) return;
            if (p.stock <= 0) return showToast('نافذ من المخزون', 'error');

            const exist = posCart.find(x => x.id == id);
            if (exist) {
                if (exist.qty < p.stock) exist.qty++;
            } else {
                posCart.push({ ...p, qty: 1, total: p.price });
            }
            renderPOSCart();
        }

        function renderPOSCart() {
            const tbody = document.getElementById('pos-cart-body');
            let sub = 0;
            posCart.forEach(i => { i.total = i.price * i.qty; sub += i.total; });

            tbody.innerHTML = posCart.map((i, idx) => `
                <tr class="border-b"><td class="p-2 text-xs font-bold">${i.name}</td>
                <td class="p-2 flex items-center gap-1">
                    <button onclick="updatePOSQty(${idx}, -1)" class="w-5 h-5 bg-red-100 text-red-600 rounded flex items-center justify-center hover:bg-red-200">-</button>
                    <span class="font-mono text-xs w-4 text-center">${i.qty}</span>
                    <button onclick="updatePOSQty(${idx}, 1)" class="w-5 h-5 bg-green-100 text-green-600 rounded flex items-center justify-center hover:bg-green-200">+</button>
                </td>
                <td class="p-2 font-mono text-xs">${i.total.toFixed(2)}</td>
                <td class="p-2"><button onclick="posCart.splice(${idx},1);renderPOSCart()" class="text-red-400 hover:text-red-500"><i class="fas fa-times"></i></button></td></tr>
            `).join('');

            const disc = parseFloat(document.getElementById('pos-discount').value) || 0;
            const final = Math.max(0, sub - disc);
            document.getElementById('pos-subtotal').innerText = sub.toFixed(2);
            document.getElementById('pos-total').innerText = final.toFixed(2);
        }

        function updatePOSQty(idx, change) {
            const item = posCart[idx];
            const p = db.products.find(x => x.id == item.id);
            if (change > 0 && item.qty >= p.stock) return showToast('الكمية غير متاحة', 'error');
            item.qty += change;
            if (item.qty <= 0) posCart.splice(idx, 1);
            renderPOSCart();
        }

        function clearPOSCart() { posCart = []; renderPOSCart(); }

        function checkoutPOS(method) {
            if (posCart.length === 0) return showToast('السلة فارغة', 'error');

            const isWalkIn = document.getElementById('pos-walkin').checked;
            const custId = document.getElementById('pos-customer').value;
            const custName = isWalkIn ? 'عميل نقدي (كاشير)' : (db.customers.find(c => c.id == custId)?.name || 'غير معروف');

            const total = parseFloat(document.getElementById('pos-total').innerText);
            const subtotal = parseFloat(document.getElementById('pos-subtotal').innerText);
            const discount = parseFloat(document.getElementById('pos-discount').value) || 0;

            // Logic similar to Sale
            const date = new Date().toISOString().split('T')[0];
            const saleId = Date.now();

            // Journal
            // Dr Cash/Bank, Dr COGS
            // Cr Sales Rev, Cr VAT, Cr Inventory, Dr Discount Exp

            const vat = total * (db.settings.vatRate / (100 + db.settings.vatRate)); // Inclusive VAT
            const netSale = total - vat;
            let totalCost = 0;
            posCart.forEach(i => { const p = db.products.find(x => x.id == i.id); totalCost += (p?.cost || 0) * i.qty; });

            const lines = [
                { code: getMethodAccount(method), dr: total, cr: 0 }, // Asset Up
                { code: '5101', dr: totalCost, cr: 0 }, // COGS
                { code: '4101', dr: 0, cr: netSale }, // Revenue
                { code: '1104', dr: 0, cr: totalCost }, // Inventory Down
                { code: '2102', dr: 0, cr: vat } // VAT Liab
            ];
            // Discount? If separate line needed: 
            // Currently NetSale is reduced by discount. If we want to track Discount Expense:
            // Dr Cash (Total), Dr Sales Discount (Disc), Cr Sales Revenue (Subtotal - VAT)...
            // For simplicity, sticking to Net methodology.

            if (addJournalEntry(date, `بيع كاشير - ${custName}`, lines)) {
                // Stock Update
                posCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) p.stock -= i.qty; });
                const invoiceNo = 'POS-' + String(saleId).slice(-6);
                const saleObj = { id: saleId, invoiceNo, date, time: new Date().toLocaleTimeString('ar'), customer: custName, subtotal, discount, vat, total, paid: total, remaining: 0, method, type: 'pos', items: [...posCart] };
                db.sales.push(saleObj);
                showToast('تمت عملية البيع ✅');
                // Print POS receipt
                printPOSReceipt(saleObj);
                clearPOSCart();
                save(); renderAll();
            }
        }

        // --- 15. HR Module Logic ---
        function previewEmpPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('emp-photo-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('emp-id').value;
            const name = document.getElementById('emp-name').value;
            const role = document.getElementById('emp-role').value;
            const salary = parseFloat(document.getElementById('emp-salary').value);
            const allowance = parseFloat(document.getElementById('emp-allowance').value) || 0;
            const phone = document.getElementById('emp-phone').value;
            const photoSrc = document.getElementById('emp-photo-preview').src || '';

            if (id) {
                const emp = db.employees.find(x => x.id == id);
                if (emp) {
                    emp.name = name; emp.role = role; emp.salary = salary;
                    emp.allowance = allowance; emp.phone = phone;
                    if (photoSrc.startsWith('data:')) emp.photo = photoSrc;
                }
            } else {
                db.employees.push({
                    id: Date.now(), name, role, salary, allowance, phone,
                    photo: photoSrc.startsWith('data:') ? photoSrc : ''
                });
            }
            save(); renderEmployees();
            document.getElementById('emp-id').value = '';
            document.getElementById('emp-form').reset();
            document.getElementById('emp-photo-preview').classList.add('hidden');
            showToast('تم حفظ الموظف');
        }

        function renderEmployees() {
            if (!db.employees) db.employees = [];

            // List
            const list = document.getElementById('employees-list');
            if (list) list.innerHTML = db.employees.map(e => `
                <tr class="hover:bg-slate-50">
                    <td class="p-2 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden"><img src="${e.photo || ''}" class="w-full h-full object-cover"></div>
                        <span class="font-bold">${e.name}</span>
                    </td>
                    <td class="p-2 text-xs">${e.role}</td>
                    <td class="p-2 font-mono text-xs">${e.salary.toFixed(2)} + ${(e.allowance || 0).toFixed(2)}</td>
                    <td class="p-2 font-bold text-blue-600">${(e.salary + (e.allowance || 0)).toFixed(2)}</td>
                    <td class="p-2 text-center"><button onclick="editEmployee(${e.id})" class="text-blue-500"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');

        }

        function editEmployee(id) {
            const e = db.employees.find(x => x.id == id);
            if (e) {
                document.getElementById('emp-id').value = e.id;
                document.getElementById('emp-name').value = e.name;
                document.getElementById('emp-role').value = e.role;
                document.getElementById('emp-salary').value = e.salary;
                document.getElementById('emp-allowance').value = e.allowance || 0;
                document.getElementById('emp-phone').value = e.phone;
                const img = document.getElementById('emp-photo-preview');
                if (e.photo) { img.src = e.photo; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
            }
        }



        // ==========================================
        // NEW ENHANCEMENTS: Cash/Credit, Discounts, Statements, POS Receipt, Barcode
        // ==========================================

        // --- Sales Payment Type Toggle ---
        let salePayType = 'cash';
        function setSalePayType(type) {
            salePayType = type;
            document.getElementById('sale-pay-cash-btn').className = type === 'cash' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white shadow-lg' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('sale-pay-credit-btn').className = type === 'credit' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white shadow-lg' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('sale-credit-area').classList.toggle('hidden', type === 'cash');
            document.getElementById('sale-remaining-row').classList.toggle('hidden', type === 'cash');
            if (type === 'cash') {
                const total = parseFloat(document.getElementById('cart-total').innerText) || 0;
                document.getElementById('sale-paid').value = total > 0 ? total.toFixed(2) : '';
                document.getElementById('sale-remaining').innerText = '0.00';
            }
        }

        function calcSaleRemaining() {
            const total = parseFloat(document.getElementById('cart-total').innerText) || 0;
            const paid = parseFloat(document.getElementById('sale-paid').value) || 0;
            document.getElementById('sale-remaining').innerText = Math.max(0, total - paid).toFixed(2);
        }

        // --- Purchases Payment Type Toggle ---
        let purPayType = 'cash';
        function setPurPayType(type) {
            purPayType = type;
            document.getElementById('pur-pay-cash-btn').className = type === 'cash' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-orange-600 text-white shadow-lg' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('pur-pay-credit-btn').className = type === 'credit' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-orange-600 text-white shadow-lg' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('pur-credit-area').classList.toggle('hidden', type === 'cash');
            document.getElementById('pur-remaining-row').classList.toggle('hidden', type === 'cash');
            if (type === 'cash') {
                const total = parseFloat(document.getElementById('pur-total').innerText) || 0;
                document.getElementById('pur-paid').value = total > 0 ? total.toFixed(2) : '';
                document.getElementById('pur-remaining').innerText = '0.00';
            }
        }

        function calcPurRemaining() {
            const total = parseFloat(document.getElementById('pur-total').innerText) || 0;
            const paid = parseFloat(document.getElementById('pur-paid').value) || 0;
            document.getElementById('pur-remaining').innerText = Math.max(0, total - paid).toFixed(2);
        }

        // --- Enhanced Discount Calculation (used by renderCart) ---
        function calcDiscount(prefix, subtotal) {
            const toggle = document.getElementById(prefix + '-disc-toggle');
            if (!toggle || !toggle.checked) return 0;
            const type = document.getElementById(prefix + '-disc-type')?.value || 'amount';
            const val = parseFloat(document.getElementById(prefix.replace('-disc', '') + '-discount')?.value) || 0;
            if (type === 'percent') return subtotal * (val / 100);
            return val;
        }

        // --- Customer Account Statement ---
        function renderCustStatement() {
            const tbody = document.getElementById('cust-statement-body');
            if (!tbody) return;
            const creditSales = {};
            db.sales.forEach(s => {
                if (s.remaining > 0 || s.type === 'credit') {
                    if (!creditSales[s.customer]) creditSales[s.customer] = { total: 0, paid: 0 };
                    creditSales[s.customer].total += s.total;
                    creditSales[s.customer].paid += s.paid;
                }
            });
            // Also from customers list
            let rows = '';
            db.customers.forEach(c => {
                const cCode = c.code || ('C-' + String(c.id).slice(-4));
                const data = creditSales[c.name] || { total: 0, paid: 0 };
                const rem = data.total - data.paid;
                if (data.total > 0) {
                    rows += `<tr class="hover:bg-blue-50"><td class="p-1.5 font-mono">${cCode}</td><td class="p-1.5 font-bold">${c.name}</td><td class="p-1.5">${data.total.toFixed(2)}</td><td class="p-1.5 text-emerald-600">${data.paid.toFixed(2)}</td><td class="p-1.5 text-red-600 font-bold">${rem.toFixed(2)}</td></tr>`;
                }
            });
            tbody.innerHTML = rows || '<tr><td colspan="5" class="p-3 text-center text-slate-400">لا توجد حسابات آجلة</td></tr>';
        }

        function filterCustStatement(q) {
            document.querySelectorAll('#cust-statement-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- Supplier Account Statement ---
        function renderSuppStatement() {
            const tbody = document.getElementById('supp-statement-body');
            if (!tbody) return;
            const creditPur = {};
            db.purchases.forEach(p => {
                if (p.remaining > 0) {
                    if (!creditPur[p.supplier]) creditPur[p.supplier] = { total: 0, paid: 0 };
                    creditPur[p.supplier].total += p.total;
                    creditPur[p.supplier].paid += p.paid;
                }
            });
            let rows = '';
            db.suppliers.forEach(s => {
                const sCode = s.code || ('S-' + String(s.id).slice(-4));
                const data = creditPur[s.name] || { total: 0, paid: 0 };
                const rem = data.total - data.paid;
                if (data.total > 0) {
                    rows += `<tr class="hover:bg-orange-50"><td class="p-1.5 font-mono">${sCode}</td><td class="p-1.5 font-bold">${s.name}</td><td class="p-1.5">${data.total.toFixed(2)}</td><td class="p-1.5 text-emerald-600">${data.paid.toFixed(2)}</td><td class="p-1.5 text-red-600 font-bold">${rem.toFixed(2)}</td></tr>`;
                }
            });
            tbody.innerHTML = rows || '<tr><td colspan="5" class="p-3 text-center text-slate-400">لا توجد حسابات آجلة</td></tr>';
        }

        function filterSuppStatement(q) {
            document.querySelectorAll('#supp-statement-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- POS Receipt Printing ---
        function printPOSReceipt(saleData) {
            const receiptSettings = db.settings.receiptSettings || {};
            const w = window.open('', 'receipt', 'width=320,height=600');
            w.document.write(`<html dir="rtl"><head><style>
                body { font-family: 'Cairo', sans-serif; width: 280px; margin: 0 auto; padding: 10px; font-size: 12px; }
                .center { text-align: center; } .bold { font-weight: bold; } .line { border-top: 1px dashed #000; margin: 8px 0; }
                table { width: 100%; border-collapse: collapse; } td { padding: 2px 0; font-size: 11px; } .total { font-size: 16px; font-weight: bold; }
                @media print { body { margin: 0; } }
            </style></head><body>
            ${receiptSettings.showLogo !== false && db.settings.logo ? `<div class="center"><img src="${db.settings.logo}" style="max-height:50px"></div>` : ''}
            <div class="center bold">${db.settings.companyName || 'نظام ERP'}</div>
            <div class="center" style="font-size:10px">${db.settings.address || ''}</div>
            <div class="center" style="font-size:10px">${db.settings.phone || ''}</div>
            <div class="line"></div>
            <div>فاتورة رقم: #${saleData.id}</div>
            <div>التاريخ: ${saleData.date}</div>
            <div>العميل: ${saleData.customer}</div>
            <div class="line"></div>
            <table>${saleData.items.map(i => `<tr><td>${i.name}</td><td>${i.qty}x</td><td style="text-align:left">${(i.total || (i.price * i.qty) || 0).toFixed(2)}</td></tr>`).join('')}</table>
            <div class="line"></div>
            ${saleData.subtotal !== undefined ? `<div class="center" style="font-size:11px">المجموع: ${saleData.subtotal.toFixed(2)}</div>` : ''}
            ${saleData.discount ? `<div class="center" style="font-size:11px;color:red">الخصم: -${saleData.discount.toFixed(2)}</div>` : ''}
            ${saleData.vat !== undefined ? `<div class="center" style="font-size:11px">الضريبة (شامل): ${saleData.vat.toFixed(2)}</div>` : ''}
            <div class="total center">الإجمالي: ${saleData.total.toFixed(2)}</div>
            <div class="center" style="font-size:10px">الدفع: ${saleData.method || 'كاش'}</div>
            ${receiptSettings.footerMsg ? `<div class="line"></div><div class="center" style="font-size:10px">${receiptSettings.footerMsg}</div>` : ''}
            <div class="center" style="font-size:9px;margin-top:10px;color:#999">شكراً لزيارتكم</div>
            </body></html>`);
            w.document.close();
            setTimeout(() => { w.print(); w.close(); }, 300);
        }

        // --- Barcode Generator ---
        function generateBarcode(productId) {
            const p = db.products.find(x => x.id == productId);
            if (!p) return;
            const code = p.barcode || String(p.id);
            const w = window.open('', 'barcode', 'width=400,height=300');
            w.document.write(`<html dir="rtl"><head>
            <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
            <style>body{font-family:'Cairo',sans-serif;text-align:center;padding:20px} .label{border:1px dashed #ccc;padding:10px;display:inline-block;margin:5px}</style>
            </head><body>
            <div class="label"><svg id="bc"></svg><div style="font-size:12px;margin-top:5px">${p.name}</div><div style="font-size:11px">${p.price} ${db.settings.currency || 'ر.س'}</div></div>
            <script>JsBarcode("#bc","${code}",{format:"CODE128",width:2,height:50,displayValue:true,fontSize:14})<\/script>
            <br><button onclick="window.print()" style="margin-top:20px;padding:8px 20px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer">طباعة</button>
            </body></html>`);
            w.document.close();
        }

        function renderBarcodeList() {
            const container = document.getElementById('barcode-products-list');
            if (!container) return;
            container.innerHTML = db.products.map(p => `
                <div class="flex items-center justify-between p-2 border-b hover:bg-slate-50">
                    <div><span class="font-bold text-sm">${p.name}</span> <span class="text-xs text-slate-400">(${p.price})</span></div>
                    <button onclick="generateBarcode(${p.id})" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-500"><i class="fas fa-barcode me-1"></i>طباعة</button>
                </div>
            `).join('');
        }

        // --- Print Section Helper ---
        function printSection(sectionId, reportTitle = 'تقرير') {
            const el = document.getElementById(sectionId);
            if (!el) return;

            const companyName = db.settings?.companyName || 'نظام ERP';
            const logoHtml = db.settings?.logo ? `<img src="${db.settings.logo}" style="max-height:70px; margin-bottom:10px;">` : '';

            const headerHtml = `
                <div style="text-align:center; margin-bottom:20px; border-bottom:2px solid #e2e8f0; padding-bottom:15px;">
                    ${logoHtml}
                    <h2 style="margin:0; color:#1e293b; font-size:20px;">${companyName}</h2>
                    <h3 style="margin:5px 0 0; color:#475569; font-size:16px;">${reportTitle}</h3>
                    <div style="font-size:11px; color:#64748b; margin-top:8px;">تاريخ الطباعة: ${new Date().toLocaleString('ar-EG')}</div>
                </div>
            `;

            const w = window.open('', 'print', 'width=800,height=600');
            w.document.write(`
                <html dir="rtl">
                <head>
                    <title>طباعة ${reportTitle}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family:'Cairo',sans-serif; padding:20px; color:#0f172a; } 
                        table { width:100%; border-collapse:collapse; margin-top:10px; } 
                        td, th { border:1px solid #cbd5e1; padding:8px 12px; text-align:right; font-size:13px; } 
                        th { background-color:#f8fafc; font-weight:bold; color:#334155; }
                        tr:nth-child(even) td { background-color:#f8fafc; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    ${headerHtml}
                    ${el.outerHTML}
                </body>
                </html>
            `);
            w.document.close();
            setTimeout(() => { w.print(); w.close(); }, 500);
        }

        // --- Update renderAll to include statements ---
        const _origRenderAll = renderAll;
        renderAll = function () {
            _origRenderAll();
            try { renderCustStatement(); } catch (e) { console.error('renderCustStatement error:', e); }
            try { renderSuppStatement(); } catch (e) { console.error('renderSuppStatement error:', e); }
        };

        // --- Installment Customers ---
        function saveInstCustomer(e) {
            e.preventDefault();
            if (!db.installmentCustomers) db.installmentCustomers = [];
            const id = document.getElementById('inst-cust-id').value;
            const cust = {
                id: id ? parseInt(id) : Date.now(),
                code: 'IC-' + String(Date.now()).slice(-5),
                name: document.getElementById('inst-cust-name').value,
                phone: document.getElementById('inst-cust-phone').value,
                address: document.getElementById('inst-cust-address').value,
                nid: document.getElementById('inst-cust-nid').value
            };
            if (id) {
                const idx = db.installmentCustomers.findIndex(c => c.id == id);
                if (idx >= 0) { cust.code = db.installmentCustomers[idx].code; db.installmentCustomers[idx] = cust; }
            } else {
                db.installmentCustomers.push(cust);
            }
            showToast('تم حفظ عميل التقسيط');
            document.getElementById('inst-cust-id').value = '';
            e.target.reset();
            renderInstCustomers();
            save();
        }

        function renderInstCustomers() {
            if (!db.installmentCustomers) db.installmentCustomers = [];
            const tbody = document.getElementById('inst-cust-list');
            if (!tbody) return;
            tbody.innerHTML = db.installmentCustomers.map(c => `
                <tr class="hover:bg-slate-50">
                    <td class="p-2 font-mono text-xs">${c.code}</td>
                    <td class="p-2 font-bold">${c.name}</td>
                    <td class="p-2">${c.phone || '-'}</td>
                    <td class="p-2">${c.nid || '-'}</td>
                    <td class="p-2 flex gap-1"><button onclick="editInstCust(${c.id})" class="text-blue-500 text-xs"><i class="fas fa-edit"></i></button><button onclick="deleteInstCust(${c.id})" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function editInstCust(id) {
            const c = db.installmentCustomers.find(x => x.id == id);
            if (!c) return;
            document.getElementById('inst-cust-id').value = c.id;
            document.getElementById('inst-cust-name').value = c.name;
            document.getElementById('inst-cust-phone').value = c.phone || '';
            document.getElementById('inst-cust-address').value = c.address || '';
            document.getElementById('inst-cust-nid').value = c.nid || '';
            showSection('installment_customers');
        }

        function deleteInstCust(id) {
            if (!confirm('حذف هذا العميل؟')) return;
            db.installmentCustomers = db.installmentCustomers.filter(c => c.id != id);
            renderInstCustomers(); save();
        }

        function filterInstCust(q) {
            document.querySelectorAll('#inst-cust-list tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- Installment Payment Statement ---
        function renderInstPayments() {
            if (!db.installments) db.installments = [];
            if (!db.installmentCustomers) db.installmentCustomers = [];
            const tbody = document.getElementById('inst-pay-body');
            if (!tbody) return;
            // Aggregate by customer
            const byCustomer = {};
            db.installments.forEach(inst => {
                const key = inst.customer || 'عميل عام';
                if (!byCustomer[key]) byCustomer[key] = { total: 0, paid: 0, late: 0, due: 0 };
                byCustomer[key].total += inst.total || 0;
                byCustomer[key].paid += inst.paid || 0;
                const remaining = (inst.total || 0) - (inst.paid || 0);
                // Check if any installment is overdue
                if (inst.dueDate && new Date(inst.dueDate) < new Date() && remaining > 0) {
                    byCustomer[key].late += remaining;
                } else {
                    byCustomer[key].due += remaining;
                }
            });
            let rows = '';
            Object.keys(byCustomer).forEach(name => {
                const d = byCustomer[name];
                const custObj = db.installmentCustomers.find(c => c.name === name);
                const code = custObj?.code || 'IC-0000';
                const status = d.late > 0 ? '<span class="text-red-600 font-bold">متأخر</span>' : (d.due > 0 ? '<span class="text-yellow-600">جاري</span>' : '<span class="text-emerald-600 font-bold">مكتمل</span>');
                rows += `<tr class="hover:bg-slate-50"><td class="p-3 font-mono text-xs">${code}</td><td class="p-3 font-bold">${name}</td><td class="p-3">${d.total.toFixed(2)}</td><td class="p-3 text-emerald-600">${d.paid.toFixed(2)}</td><td class="p-3 text-yellow-600">${d.due.toFixed(2)}</td><td class="p-3 text-red-600">${d.late.toFixed(2)}</td><td class="p-3">${status}</td></tr>`;
            });
            tbody.innerHTML = rows || '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد أقساط مسجلة</td></tr>';
        }

        function filterInstPayments(q) {
            document.querySelectorAll('#inst-pay-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- Barcode List Helpers ---
        function filterBarcodeList(q) {
            const items = document.querySelectorAll('#barcode-products-list > div');
            items.forEach(d => { d.style.display = d.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none'; });
        }

        function printAllBarcodes() {
            const w = window.open('', 'barcodes', 'width=600,height=800');
            w.document.write(`<html dir="rtl"><head>
            <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
            <style>body{font-family:'Cairo',sans-serif;text-align:center;padding:10px} .label{border:1px dashed #ccc;padding:8px;display:inline-block;margin:5px;page-break-inside:avoid}</style>
            </head><body>`);
            db.products.forEach((p, i) => {
                const code = p.barcode || String(p.id);
                w.document.write(`<div class="label"><svg id="bc${i}"></svg><div style="font-size:11px;margin-top:3px">${p.name}</div><div style="font-size:10px">${p.price} ${db.settings.currency || 'ر.س'}</div></div>`);
            });
            w.document.write(`<script>document.querySelectorAll('svg[id^="bc"]').forEach((svg,i)=>{const codes=${JSON.stringify(db.products.map(p => p.barcode || String(p.id)))};JsBarcode(svg,codes[i],{format:"CODE128",width:1.5,height:40,displayValue:true,fontSize:12})})<\/script>`);
            w.document.write(`<br><button onclick="window.print()" style="margin:20px;padding:10px 30px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px">طباعة الكل</button></body></html>`);
            w.document.close();
        }

        // --- Update showSection to trigger new sub-modules ---
        const _showSection = showSection;
        showSection = function (id) {
            _showSection(id);
            try {
                if (id === 'barcode') renderBarcodeList();
                if (id === 'installment_customers') renderInstCustomers();
                if (id === 'installment_payments') renderInstPayments();
                if (id === 'sales') { renderCustStatement(); renderSalesInvoices(); }
                if (id === 'purchases') { renderSuppStatement(); renderPurchaseInvoices(); }
                if (id === 'services') { renderServiceInvoices(); renderServices(); }
                if (id === 'pos_products') { renderPOSProductsList(); }
                if (id === 'pos') { setTimeout(() => document.getElementById('pos-barcode-input')?.focus(), 100); }
                // Invoices Module
                if (id === 'invoices') { renderInvoicesDashboard(); }
                if (id === 'inv_pos') { renderInvPOS(); }
                if (id === 'inv_sales') { renderInvSales(); }
                if (id === 'inv_quotations') { renderInvQuotations(); }
                if (id === 'inv_purchases') { renderInvPurchases(); }
                if (id === 'inv_purchase_orders') { renderInvPurchaseOrders(); }
                if (id === 'inv_services') { renderInvServices(); }
                if (id === 'inv_installments') { renderInvInstallments(); }
                // Statements
                if (id === 'cust_statement') { renderCustStatementFull(); }
                if (id === 'supp_statement') { renderSuppStatementFull(); }
                if (id === 'svc_statement') { renderSvcStatement(); }
                // Collection
                if (id === 'inst_collection') { renderInstCollection(); }
                // Expenses
                if (id === 'expense_vouchers') { renderExpenseVouchers(); }
                if (id === 'income_vouchers') { renderIncomeVouchers(); }
                if (id === 'journal') renderJournal();
                // HR
                if (id === 'hr_actions') { populateHRActionEmps(); renderHRActions(); }
                if (id === 'hr_list') { renderHRList(); }
                if (id === 'hr_payroll') { populatePayrollEmps(); renderPayrollHistory(); }
                if (id === 'hr_emp_statement') { populateHRStmtEmps(); }
                // Reports
                if (id === 'rpt_pos') { renderRptPOS(); }
                if (id === 'rpt_sales') { renderRptSales(); }
                if (id === 'rpt_customers') { renderRptCustomers(); }
                if (id === 'rpt_purchases') { renderRptPurchases(); }
                if (id === 'rpt_suppliers') { renderRptSuppliers(); }
                if (id === 'rpt_employees') { renderRptEmployees(); }
                if (id === 'rpt_inventory') { renderRptInventory(); }
                if (id === 'rpt_services') { renderRptServices(); }
                if (id === 'rpt_installments') { renderRptInstallments(); }
                if (id === 'rpt_inst_customers') { renderRptInstCustomers(); }
                if (id === 'rpt_expenses') { renderRptExpenses(); }
                if (id === 'rpt_revenue') { renderRptRevenue(); }
                if (id === 'rpt_treasury') { renderRptTreasury(); }
                if (id === 'rpt_profits') { renderRptProfits(); }
            } catch (e) { console.error('Sub-module render error:', e); }
        };

        // --- Journal Module Functions ---
        function renderJournal() {
            const tbody = document.getElementById('journal-history-body');
            if (!tbody) return;
            const filterDate = document.getElementById('journal-filter-date').value;
            const search = document.getElementById('journal-search').value.toLowerCase();

            let filtered = [...db.journal].reverse();
            if (filterDate) filtered = filtered.filter(e => e.date === filterDate);
            if (search) filtered = filtered.filter(e => e.desc.toLowerCase().includes(search));

            tbody.innerHTML = filtered.length ? filtered.map(e => {
                const lines = e.lines || [];
                const totalDr = lines.reduce((s, l) => s + (l.dr || 0), 0);
                const totalCr = lines.reduce((s, l) => s + (l.cr || 0), 0);
                const typeColor = e.type === 'Adjustment' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700';
                const typeLabel = e.type === 'Adjustment' ? 'تعديل يدوي' : 'نظام آلي';

                return `<tr class="hover:bg-blue-50/50 transition border-b border-slate-50">
                    <td class="p-3 text-center font-mono text-slate-400 border-l">${e.id}</td>
                    <td class="p-3 font-bold text-slate-600 border-l">${e.date}</td>
                    <td class="p-3">
                        <div class="font-bold text-slate-800">${e.desc}</div>
                    </td>
                    <td class="p-3 text-center border-l">
                        <span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${typeColor}">${typeLabel}</span>
                    </td>
                    <td class="p-3 text-center font-bold text-emerald-600 border-l">${totalDr.toFixed(2)}</td>
                    <td class="p-3 text-center font-bold text-red-600 border-l">${totalCr.toFixed(2)}</td>
                    <td class="p-3 text-center">
                        <button onclick="viewEntry(${e.id})" class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 transition">
                            <i class="fas fa-eye text-sm"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('') : '<tr><td colspan="7" class="p-10 text-center text-slate-400 bg-slate-50/50 italic font-bold">لا توجد عمليات مسجلة تطابق البحث أو السجل فارغ حالياً</td></tr>';
        }

        let currentEntryId = null;
        function viewEntry(id) {
            const entry = db.journal.find(e => e.id == id);
            if (!entry) return;
            currentEntryId = id;

            document.getElementById('view-entry-id').textContent = entry.id;
            document.getElementById('view-entry-date').textContent = entry.date;
            document.getElementById('view-entry-desc').textContent = entry.desc;

            const tbody = document.getElementById('view-entry-lines');
            tbody.innerHTML = entry.lines.map(l => {
                const acc = db.chartOfAccounts.find(a => a.code === l.code);
                return `<tr>
                    <td class="p-3">
                        <div class="font-bold text-slate-800">${acc ? acc.name : 'حساب غير معروف'}</div>
                        <div class="text-[10px] font-mono text-slate-400 tracking-tighter">${l.code}</div>
                    </td>
                    <td class="p-3 text-center font-mono font-bold text-emerald-600 bg-emerald-50/30 border-r">${l.dr ? l.dr.toFixed(2) : '-'}</td>
                    <td class="p-3 text-center font-mono font-bold text-red-600 bg-red-50/30">${l.cr ? l.cr.toFixed(2) : '-'}</td>
                </tr>`;
            }).join('');

            const totalDr = entry.lines.reduce((s, l) => s + (l.dr || 0), 0);
            const totalCr = entry.lines.reduce((s, l) => s + (l.cr || 0), 0);
            document.getElementById('view-total-dr').textContent = totalDr.toFixed(2);
            document.getElementById('view-total-cr').textContent = totalCr.toFixed(2);

            // Update Nav Buttons
            const sorted = [...db.journal].reverse();
            const idx = sorted.findIndex(e => e.id === id);
            document.getElementById('prev-entry-btn').disabled = (idx >= sorted.length - 1);
            document.getElementById('next-entry-btn').disabled = (idx <= 0);
            document.getElementById('prev-entry-btn').style.opacity = (idx >= sorted.length - 1) ? '0.3' : '1';
            document.getElementById('next-entry-btn').style.opacity = (idx <= 0) ? '0.3' : '1';

            openModal('entry-modal');
        }

        function navigateEntry(direction) {
            const sorted = [...db.journal].reverse();
            const idx = sorted.findIndex(e => e.id === currentEntryId);
            const nextIdx = idx + direction;
            if (nextIdx >= 0 && nextIdx < sorted.length) {
                viewEntry(sorted[nextIdx].id);
            }
        }

        function printEntry() {
            if (!currentEntryId) return;
            const entry = db.journal.find(e => e.id == currentEntryId);
            if (!entry) return;

            const printArea = document.getElementById('print-area');
            const totalDr = entry.lines.reduce((s, l) => s + (l.dr || 0), 0);
            const totalCr = entry.lines.reduce((s, l) => s + (l.cr || 0), 0);
            const userName = entry.desc.split(' (بواسطة: ')[1]?.replace(')', '') || 'النظام';

            printArea.innerHTML = `
                <div class="text-center mb-6">
                    ${db.settings.logo ? `<img src="${db.settings.logo}" style="height: 80px; margin: 0 auto 10px auto; display: block;">` : ''}
                    <h1 class="text-2xl font-bold">${db.settings.companyName}</h1>
                    <p class="text-xs text-slate-500">${db.settings.address || ''} - ${db.settings.phone || ''}</p>
                    <div class="mt-4 inline-block border-2 border-slate-800 px-6 py-1 rounded-lg">
                        <h2 class="text-xl font-bold">سند قيد محاسبي</h2>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 border-b-2 border-slate-100 pb-4 mb-4 text-sm">
                    <div class="text-right space-y-1">
                        <p><strong>رقم القيد:</strong> <span class="font-mono text-blue-600">#${entry.id}</span></p>
                        <p><strong>تاريخ القيد:</strong> ${entry.date}</p>
                    </div>
                    <div class="text-left space-y-1">
                        <p><strong>نوع القيد:</strong> ${entry.type === 'Adjustment' ? 'تعديل يدوي' : 'نظام آلي'}</p>
                        <p><strong>بواسطة:</strong> ${userName}</p>
                    </div>
                </div>
                <div class="mb-6 p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <p class="text-sm"><strong>البيان والوصف:</strong> ${entry.desc}</p>
                </div>
                <table class="w-full text-sm mb-8 border-collapse border border-slate-800 text-center">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="border border-slate-800 p-2 w-24">كود الحساب</th>
                            <th class="border border-slate-800 p-2 text-right">اسم الحساب</th>
                            <th class="border border-slate-800 p-2 w-28 bg-emerald-50 text-emerald-700">مدين (DR)</th>
                            <th class="border border-slate-800 p-2 w-28 bg-red-50 text-red-700">دائن (CR)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${entry.lines.map(l => {
                const acc = db.chartOfAccounts.find(a => a.code === l.code);
                return `<tr>
                                <td class="border border-slate-800 p-2 font-mono text-xs">${l.code}</td>
                                <td class="border border-slate-800 p-2 text-right font-bold">${acc ? acc.name : 'حساب غير معروف'}</td>
                                <td class="border border-slate-800 p-2 font-bold text-emerald-600">${l.dr ? l.dr.toFixed(2) : '-'}</td>
                                <td class="border border-slate-800 p-2 font-bold text-red-600">${l.cr ? l.cr.toFixed(2) : '-'}</td>
                            </tr>`;
            }).join('')}
                    </tbody>
                    <tfoot class="bg-slate-800 text-white font-bold">
                        <tr>
                            <td colspan="2" class="p-2 text-left border border-slate-800">الإجمالي النهائي</td>
                            <td class="p-2 border border-slate-800 font-mono">${totalDr.toFixed(2)}</td>
                            <td class="p-2 border border-slate-800 font-mono">${totalCr.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                <div class="grid grid-cols-3 gap-12 mt-16 text-center text-[10px] font-bold uppercase tracking-widest">
                    <div class="border-t border-slate-400 pt-2 text-slate-500">توقيع المحاسب<br><span class="text-[8px] opacity-40">Accountant Signature</span></div>
                    <div class="border-t border-slate-400 pt-2 text-slate-500">المدير المالي<br><span class="text-[8px] opacity-40">Financial Manager</span></div>
                    <div class="border-t border-slate-400 pt-2 text-slate-500">المدير العام<br><span class="text-[8px] opacity-40">General Manager Signature</span></div>
                </div>
            `;

            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
        }

        // --- Sales Invoice List (Individual) ---
        function renderSalesInvoices() {
            const tbody = document.getElementById('recent-inv-body');
            if (!tbody) return;
            const invoices = [...db.sales].reverse();
            tbody.innerHTML = invoices.length ? invoices.map((s, i) => {
                const invNo = s.invoiceNo || ('INV-' + String(invoices.length - i).padStart(4, '0'));
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                return `<tr class="hover:bg-blue-50 cursor-pointer" ondblclick="viewSaleInvoice(${s.id})">
                    <td class="p-1.5 font-mono text-blue-600">${invNo}</td>
                    <td class="p-1.5">${s.date}</td>
                    <td class="p-1.5 font-bold">${s.customer}</td>
                    <td class="p-1.5 font-bold">${(s.total || 0).toFixed(2)}</td>
                    <td class="p-1.5">${status}</td>
                    <td class="p-1.5"><button onclick="viewSaleInvoice(${s.id})" class="text-blue-500 hover:text-blue-700" title="عرض الفاتورة"><i class="fas fa-eye"></i></button></td>
                </tr>`;
            }).join('') : '<tr><td colspan="6" class="p-3 text-center text-slate-400">لا توجد فواتير</td></tr>';
        }

        // --- Purchase Invoice List (Sidebar) ---
        function renderPurchaseInvoices() {
            const tbody = document.getElementById('recent-pur-body');
            if (!tbody) return;
            const purchases = [...db.purchases].reverse();
            tbody.innerHTML = purchases.length ? purchases.map((p, i) => {
                const purNo = p.invoiceNo || ('PUR-' + String(purchases.length - i).padStart(4, '0'));
                const status = (p.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                return `<tr class="hover:bg-orange-50 cursor-pointer" ondblclick="viewPurchaseInvoice(${p.id})">
                    <td class="p-1.5 font-mono text-orange-600">${purNo}</td>
                    <td class="p-1.5">${p.date}</td>
                    <td class="p-1.5 font-bold">${p.supplier}</td>
                    <td class="p-1.5 font-bold">${(p.total || 0).toFixed(2)}</td>
                    <td class="p-1.5">${status}</td>
                    <td class="p-1.5"><button onclick="viewPurchaseInvoice(${p.id})" class="text-blue-500 hover:text-blue-700" title="عرض الفاتورة"><i class="fas fa-eye"></i></button></td>
                </tr>`;
            }).join('') : '<tr><td colspan="6" class="p-3 text-center text-slate-400">لا توجد فواتير</td></tr>';
        }

        function filterSalesInvoiceList(q) {
            document.querySelectorAll('#recent-inv-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        function filterPurchaseInvoiceList(q) {
            document.querySelectorAll('#recent-pur-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // View individual invoice
        function viewSaleInvoice(saleId) {
            const sale = db.sales.find(s => s.id == saleId);
            if (!sale) return showToast('فاتورة غير موجودة', 'error');
            const invNo = sale.invoiceNo || 'INV-' + String(sale.id).slice(-4);
            const w = window.open('', 'invoice', 'width=700,height=800');
            w.document.write(`<html dir="rtl"><head><style>
                body { font-family: 'Cairo', sans-serif; max-width: 650px; margin: 20px auto; padding: 20px; font-size: 13px; }
                .header { text-align: center; margin-bottom: 20px; }
                .header h1 { font-size: 18px; margin: 0; } .header p { color: #666; font-size: 11px; margin: 2px 0; }
                .info { display: flex; justify-content: space-between; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
                .info div { font-size: 12px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                th { background: #1e293b; color: white; padding: 8px; text-align: right; font-size: 12px; }
                td { padding: 8px; border-bottom: 1px solid #e2e8f0; text-align: right; font-size: 12px; }
                .totals { background: #f1f5f9; padding: 12px; border-radius: 8px; }
                .totals .row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; }
                .totals .grand { font-size: 16px; font-weight: bold; color: #059669; border-top: 2px solid #1e293b; padding-top: 8px; margin-top: 8px; }
                .no-print { margin-top: 20px; text-align: center; }
                @media print { .no-print { display: none; } }
            </style></head><body>
            <div class="header">
                ${db.settings.logo ? `<img src="${db.settings.logo}" style="max-height:60px;margin-bottom:5px">` : ''}
                <h1>${db.settings.companyName || 'نظام ERP'}</h1>
                <p>${db.settings.address || ''} ${db.settings.phone ? '| ' + db.settings.phone : ''}</p>
            </div>
            <div class="info">
                <div><strong>فاتورة رقم:</strong> ${invNo}</div>
                <div><strong>التاريخ:</strong> ${sale.date}</div>
                <div><strong>العميل:</strong> ${sale.customer}</div>
            </div>
            <table>
                <thead><tr><th>#</th><th>الصنف</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead>
                <tbody>${(sale.items || []).map((it, i) => `<tr><td>${i + 1}</td><td>${it.name}</td><td>${it.qty}</td><td>${(it.price || 0).toFixed(2)}</td><td>${(it.total || 0).toFixed(2)}</td></tr>`).join('')}</tbody>
            </table>
            <div class="totals">
                ${sale.discount > 0 ? `<div class="row"><span>الخصم:</span><span style="color:#dc2626">-${sale.discount.toFixed(2)}</span></div>` : ''}
                <div class="row"><span>المدفوع:</span><span style="color:#059669">${(sale.paid || 0).toFixed(2)}</span></div>
                ${(sale.remaining || 0) > 0 ? `<div class="row"><span>المتبقي:</span><span style="color:#dc2626">${sale.remaining.toFixed(2)}</span></div>` : ''}
                <div class="row grand"><span>الإجمالي:</span><span>${(sale.total || 0).toFixed(2)}</span></div>
            </div>
            <div class="no-print">
                <button onclick="window.print()" style="padding:10px 30px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin:5px">طباعة</button>
                <button onclick="window.close()" style="padding:10px 30px;background:#64748b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin:5px">إغلاق</button>
            </div>
            </body></html>`);
            w.document.close();
        }

        // Print last invoice
        function printLastSaleInvoice() {
            if (db.sales.length === 0) return showToast('لا توجد فواتير للطباعة', 'error');
            const lastSale = db.sales[db.sales.length - 1];
            viewSaleInvoice(lastSale.id);
        }

        // Export last invoice as PDF (print dialog)
        function exportLastSalePDF() {
            if (db.sales.length === 0) return showToast('لا توجد فواتير', 'error');
            viewSaleInvoice(db.sales[db.sales.length - 1].id);
            showToast('اختر "Save as PDF" من نافذة الطباعة');
        }

        // --- Add Product by Barcode/Code ---
        function addByBarcode(code) {
            if (!code || !code.trim()) return;
            code = code.trim();
            const product = db.products.find(p =>
                String(p.barcode) === code || String(p.id) === code || String(p.code) === code
            );
            if (product) {
                addToPOSCart(product.id);
                showToast(`تم إضافة: ${product.name}`);
            } else {
                showToast('منتج غير موجود بهذا الكود! ❌', 'error');
            }
            // Re-focus scanner
            setTimeout(() => document.getElementById('pos-barcode-input')?.focus(), 50);
        }

        // --- POS Product Management ---
        function savePOSProduct(e) {
            e.preventDefault();
            const id = document.getElementById('pos-prod-id').value;
            const product = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('pos-prod-name').value,
                barcode: document.getElementById('pos-prod-barcode').value || '',
                price: parseFloat(document.getElementById('pos-prod-price').value) || 0,
                cost: parseFloat(document.getElementById('pos-prod-cost').value) || 0,
                stock: parseInt(document.getElementById('pos-prod-stock').value) || 0,
                category: document.getElementById('pos-prod-category').value || 'عام'
            };
            if (id) {
                const idx = db.products.findIndex(p => p.id == id);
                if (idx >= 0) db.products[idx] = { ...db.products[idx], ...product };
            } else {
                db.products.push(product);
            }
            showToast('تم حفظ المنتج ✅');
            resetPOSProductForm();
            renderPOSProductsList();
            save();
        }

        function resetPOSProductForm() {
            document.getElementById('pos-prod-id').value = '';
            document.getElementById('pos-prod-name').value = '';
            document.getElementById('pos-prod-barcode').value = '';
            document.getElementById('pos-prod-price').value = '';
            document.getElementById('pos-prod-cost').value = '';
            document.getElementById('pos-prod-stock').value = '0';
            document.getElementById('pos-prod-category').value = '';
        }

        function renderPOSProductsList() {
            const tbody = document.getElementById('pos-products-body');
            if (!tbody) return;
            tbody.innerHTML = db.products.map((p, i) => `
                <tr class="hover:bg-blue-50 ${i % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                    <td class="p-2 font-mono text-xs text-blue-600">${p.barcode || '-'}</td>
                    <td class="p-2 font-bold">${p.name}</td>
                    <td class="p-2 text-slate-500">${p.category || 'عام'}</td>
                    <td class="p-2 text-emerald-600 font-bold">${(p.price || 0).toFixed(2)}</td>
                    <td class="p-2 text-slate-500">${(p.cost || 0).toFixed(2)}</td>
                    <td class="p-2 ${(p.stock || 0) <= 5 ? 'text-red-600 font-bold' : ''}">${p.stock || 0}</td>
                    <td class="p-2">
                        <button onclick="editPOSProduct(${p.id})" class="text-blue-500 text-xs me-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePOSProduct(${p.id})" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد منتجات</td></tr>';
        }

        function editPOSProduct(id) {
            const p = db.products.find(x => x.id == id);
            if (!p) return;
            document.getElementById('pos-prod-id').value = p.id;
            document.getElementById('pos-prod-name').value = p.name;
            document.getElementById('pos-prod-barcode').value = p.barcode || '';
            document.getElementById('pos-prod-price').value = p.price || '';
            document.getElementById('pos-prod-cost').value = p.cost || '';
            document.getElementById('pos-prod-stock').value = p.stock || 0;
            document.getElementById('pos-prod-category').value = p.category || '';
            window.scrollTo(0, 0);
        }

        function deletePOSProduct(id) {
            if (!confirm('حذف هذا المنتج؟')) return;
            db.products = db.products.filter(p => p.id != id);
            renderPOSProductsList(); save();
        }

        function filterPOSProductsList(q) {
            document.querySelectorAll('#pos-products-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // ===== Universal table filter =====
        function filterInvTable(tbodyId, q) {
            document.querySelectorAll('#' + tbodyId + ' tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }




        // ===== Invoice view helper =====
        function openInvoiceWindow(title, invNo, date, party, items, totals) {
            const w = window.open('', 'invoice', 'width=700,height=800');
            w.document.write(`<html dir="rtl"><head><style>
                body{font-family:'Cairo',sans-serif;max-width:650px;margin:20px auto;padding:20px;font-size:13px}
                .header{text-align:center;margin-bottom:20px}.header h1{font-size:18px;margin:0}.header p{color:#666;font-size:11px}
                .info{display:flex;justify-content:space-between;margin-bottom:15px;background:#f8f9fa;padding:10px;border-radius:8px}.info div{font-size:12px}
                table{width:100%;border-collapse:collapse;margin-bottom:15px}th{background:#1e293b;color:white;padding:8px;text-align:right;font-size:12px}
                td{padding:8px;border-bottom:1px solid #e2e8f0;text-align:right;font-size:12px}
                .totals{background:#f1f5f9;padding:12px;border-radius:8px}.totals .row{display:flex;justify-content:space-between;margin-bottom:4px;font-size:12px}
                .totals .grand{font-size:16px;font-weight:bold;color:#059669;border-top:2px solid #1e293b;padding-top:8px;margin-top:8px}
                .no-print{margin-top:20px;text-align:center}@media print{.no-print{display:none}}
            </style></head><body>
            <div class="header">${db.settings.logo ? `<img src="${db.settings.logo}" style="max-height:60px;margin-bottom:5px">` : ''}<h1>${db.settings.companyName || 'نظام ERP'}</h1><p>${db.settings.address || ''} ${db.settings.phone ? '| ' + db.settings.phone : ''}</p></div>
            <div class="info"><div><strong>${title}:</strong> ${invNo}</div><div><strong>التاريخ:</strong> ${date}</div><div><strong>${party.label}:</strong> ${party.name}</div></div>
            <table><thead><tr><th>#</th><th>الصنف</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead>
            <tbody>${items.map((it, i) => `<tr><td>${i + 1}</td><td>${it.name}</td><td>${it.qty}</td><td>${(it.price || 0).toFixed(2)}</td><td>${(it.total || 0).toFixed(2)}</td></tr>`).join('')}</tbody></table>
            <div class="totals">${totals}</div>
            <div class="no-print"><button onclick="window.print()" style="padding:10px 30px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin:5px">طباعة</button><button onclick="window.close()" style="padding:10px 30px;background:#64748b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin:5px">إغلاق</button></div>
            </body></html>`);
            w.document.close();
        }

        // ===== Render Invoice Sub-Modules =====
        function renderInvPOS() { showSection('inv_sales'); } // Redirect

        // -- POS Receipt Print --
        function printPOSReceipt(sale) {
            const w = window.open('', 'receipt', 'width=350,height=600');
            const itemsHTML = (sale.items || []).map(it => `<tr><td style="padding:3px">${it.name}</td><td style="padding:3px;text-align:center">${it.qty}</td><td style="padding:3px;text-align:left">${(it.total || it.price || 0).toFixed(2)}</td></tr>`).join('');
            w.document.write(`<html dir="rtl"><head><style>body{font-family:monospace,Arial;width:280px;margin:0 auto;padding:10px;font-size:12px}h2{text-align:center;margin:5px 0;font-size:14px}.logo{text-align:center;} p{text-align:center;margin:2px 0;font-size:10px;color:#666}.line{border-top:1px dashed #000;margin:5px 0}table{width:100%;border-collapse:collapse}th{border-bottom:1px solid #000;padding:3px;font-size:11px;text-align:right}td{font-size:11px}.total{font-weight:bold;font-size:14px;text-align:center;margin:5px 0}.footer{text-align:center;font-size:10px;color:#666;margin-top:10px}@media print{.no-print{display:none}}</style></head><body>
            <div class="logo">${db.settings.logo ? `<img src="${db.settings.logo}" style="max-height:50px; margin-bottom:5px;">` : ''}</div>
            <h2>${db.settings.companyName || 'نظام ERP'}</h2>
            <p>${db.settings.address || ''}</p><p>${db.settings.phone || ''}</p>
            <div class="line"></div>
            <p style="text-align:right"><strong>رقم:</strong> ${sale.invoiceNo || sale.id} | <strong>التاريخ:</strong> ${sale.date} ${sale.time || ''}</p>
            <p style="text-align:right"><strong>العميل:</strong> ${sale.customer}</p>
            <div class="line"></div>
            <table><thead><tr><th>الصنف</th><th style="text-align:center">الكمية</th><th style="text-align:left">المبلغ</th></tr></thead><tbody>${itemsHTML}</tbody></table>
            <div class="line"></div>
            ${sale.subtotal !== undefined ? `<p style="text-align:center; font-size:11px; margin:2px 0;">المجموع: ${sale.subtotal.toFixed(2)}</p>` : ''}
            ${sale.discount ? `<p style="text-align:center; font-size:11px; color:red; margin:2px 0;">الخصم: -${sale.discount.toFixed(2)}</p>` : ''}
            ${sale.vat !== undefined ? `<p style="text-align:center; font-size:11px; margin:2px 0;">الضريبة (شامل): ${sale.vat.toFixed(2)}</p>` : ''}
            <div class="total">الإجمالي: ${(sale.total || 0).toFixed(2)}</div>
            <div class="line"></div>
            <div class="footer">شكراً لزيارتكم ❤️</div>
            <div class="no-print" style="text-align:center;margin-top:15px"><button onclick="window.print()" style="padding:8px 25px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer">طباعة</button></div>
            </body></html>`);
            w.document.close();
            setTimeout(() => { try { w.print(); } catch (e) { } }, 300);
        }

        // -- Sales Invoices (includes POS) with date filter + stats + actions --
        function renderInvSales() {
            const tbody = document.getElementById('inv-sales-body'); if (!tbody) return;
            const from = document.getElementById('inv-sales-from')?.value;
            const to = document.getElementById('inv-sales-to')?.value;
            let inv = [...(db.sales || [])].reverse();
            if (from) inv = inv.filter(s => s.date >= from);
            if (to) inv = inv.filter(s => s.date <= to);
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const invNo = s.invoiceNo || 'INV-' + String(s.id).slice(-6);
                totalAll += s.total || 0; paidAll += s.paid || 0; remAll += s.remaining || 0;
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                let actions = `<button onclick="viewSaleInvoice(${s.id})" class="text-blue-500 text-xs me-1" title="عرض"><i class="fas fa-eye"></i></button>`;
                if ((s.remaining || 0) > 0) {
                    actions += `<button onclick="payPartialInvoice('sales',${s.id})" class="text-amber-500 text-xs me-1" title="دفع جزئي"><i class="fas fa-money-bill"></i></button>`;
                    actions += `<button onclick="closeInvoice('sales',${s.id})" class="text-emerald-500 text-xs" title="إقفال كامل"><i class="fas fa-check-circle"></i></button>`;
                }
                return `<tr class="hover:bg-blue-50"><td class="p-2 font-mono text-blue-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${actions}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد فواتير</td></tr>';
            _el('inv-sales-count', inv.length); _el('inv-sales-total', totalAll.toFixed(2)); _el('inv-sales-paid', paidAll.toFixed(2)); _el('inv-sales-rem', remAll.toFixed(2));
        }

        // -- Purchase Invoices with date filter + stats + actions --
        function renderInvPurchases() {
            const tbody = document.getElementById('inv-pur-body'); if (!tbody) return;
            const from = document.getElementById('inv-pur-from')?.value;
            const to = document.getElementById('inv-pur-to')?.value;
            let inv = [...(db.purchases || [])].reverse();
            if (from) inv = inv.filter(s => s.date >= from);
            if (to) inv = inv.filter(s => s.date <= to);
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const invNo = s.invoiceNo || 'PUR-' + String(s.id).slice(-6);
                totalAll += s.total || 0; paidAll += s.paid || 0; remAll += s.remaining || 0;
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">مستحق</span>' : '<span class="text-emerald-600">مدفوع</span>';
                let actions = `<button onclick="viewPurchaseInvoice(${s.id})" class="text-blue-500 text-xs me-1" title="عرض"><i class="fas fa-eye"></i></button>`;
                if ((s.remaining || 0) > 0) {
                    actions += `<button onclick="payPartialInvoice('purchases',${s.id})" class="text-amber-500 text-xs me-1" title="دفع جزئي"><i class="fas fa-money-bill"></i></button>`;
                    actions += `<button onclick="closeInvoice('purchases',${s.id})" class="text-emerald-500 text-xs" title="إقفال كامل"><i class="fas fa-check-circle"></i></button>`;
                }
                return `<tr class="hover:bg-orange-50"><td class="p-2 font-mono text-orange-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.supplier}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${actions}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد فواتير</td></tr>';
            _el('inv-pur-count', inv.length); _el('inv-pur-total', totalAll.toFixed(2)); _el('inv-pur-paid', paidAll.toFixed(2)); _el('inv-pur-rem', remAll.toFixed(2));
        }

        // -- Service Invoices with date filter + stats + actions --
        function renderInvServices() {
            const tbody = document.getElementById('inv-svc-body'); if (!tbody) return;
            if (!db.serviceInvoices) db.serviceInvoices = [];
            const from = document.getElementById('inv-svc-from')?.value;
            const to = document.getElementById('inv-svc-to')?.value;
            let inv = [...db.serviceInvoices].reverse();
            if (from) inv = inv.filter(s => s.date >= from);
            if (to) inv = inv.filter(s => s.date <= to);
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const invNo = s.invoiceNo || 'SVC-' + String(s.id).slice(-6);
                totalAll += s.total || 0; paidAll += s.paid || 0; remAll += s.remaining || 0;
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                let actions = `<button onclick="viewServiceInvoice(${s.id})" class="text-blue-500 text-xs me-1" title="عرض"><i class="fas fa-eye"></i></button>`;
                if ((s.remaining || 0) > 0) {
                    actions += `<button onclick="payPartialInvoice('services',${s.id})" class="text-amber-500 text-xs me-1" title="دفع جزئي"><i class="fas fa-money-bill"></i></button>`;
                    actions += `<button onclick="closeInvoice('services',${s.id})" class="text-emerald-500 text-xs" title="إقفال كامل"><i class="fas fa-check-circle"></i></button>`;
                }
                return `<tr class="hover:bg-teal-50"><td class="p-2 font-mono text-teal-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${actions}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد فواتير</td></tr>';
            _el('inv-svc-count', inv.length); _el('inv-svc-total', totalAll.toFixed(2)); _el('inv-svc-paid', paidAll.toFixed(2)); _el('inv-svc-rem', remAll.toFixed(2));
        }

        // -- Installment Invoices with stats + actions --
        function renderInvInstallments() {
            const tbody = document.getElementById('inv-inst-body'); if (!tbody) return;
            if (!db.installmentInvoices) db.installmentInvoices = [];
            const inv = [...db.installmentInvoices].reverse();
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const paid = (s.schedule || []).filter(p => p.paid).reduce((a, b) => a + b.amount, 0);
                const rem = (s.total || 0) - paid;
                totalAll += s.total || 0; paidAll += paid; remAll += rem;
                const status = rem <= 0 ? '<span class="text-emerald-600">مكتمل</span>' : '<span class="text-amber-600">جاري</span>';
                let actions = `<button onclick="viewInstInvoice(${s.id})" class="text-blue-500 text-xs me-1" title="عرض"><i class="fas fa-eye"></i></button>`;
                if (rem > 0) actions += `<button onclick="payPartialInvoice('installments',${s.id})" class="text-amber-500 text-xs" title="دفع قسط"><i class="fas fa-money-bill"></i></button>`;
                return `<tr class="hover:bg-indigo-50"><td class="p-2 font-mono text-indigo-600">${s.invoiceNo || '-'}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2">${(s.downPayment || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${paid.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${rem.toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${actions}</td></tr>`;
            }).join('') : '<tr><td colspan="9" class="p-4 text-center text-slate-400">لا توجد فواتير</td></tr>';
            _el('inv-inst-count', inv.length); _el('inv-inst-total', totalAll.toFixed(2)); _el('inv-inst-paid', paidAll.toFixed(2)); _el('inv-inst-rem', remAll.toFixed(2));
        }

        // ===== PARTIAL PAY (Universal for all invoice types) =====
        function payPartialInvoice(source, id) {
            let inv;
            if (source === 'sales') inv = (db.sales || []).find(x => x.id == id);
            else if (source === 'purchases') inv = (db.purchases || []).find(x => x.id == id);
            else if (source === 'services') inv = (db.serviceInvoices || []).find(x => x.id == id);
            else if (source === 'installments') {
                inv = (db.installmentInvoices || []).find(x => x.id == id);
                if (inv) { payInstallmentPartial(inv); return; }
            }
            if (!inv) return showToast('لم يتم العثور على الفاتورة', 'error');
            const remaining = (inv.total || 0) - (inv.paid || 0);
            const val = prompt(`المتبقي: ${remaining.toFixed(2)}\nأدخل المبلغ المراد تسديده:`);
            if (val === null) return;
            const amount = parseFloat(val);
            if (isNaN(amount) || amount <= 0) return showToast('مبلغ غير صحيح', 'error');
            if (amount > remaining + 0.01) return showToast('المبلغ أكبر من المتبقي', 'error');
            inv.paid = (inv.paid || 0) + amount;
            inv.remaining = (inv.total || 0) - inv.paid;
            if (inv.remaining < 0.01) inv.remaining = 0;
            const date = new Date().toISOString().split('T')[0];
            if (source === 'purchases') {
                addJournalEntry(date, `سداد فاتورة مشتريات #${inv.invoiceNo || inv.id}`, [{ code: '2101', dr: amount, cr: 0 }, { code: '1101', dr: 0, cr: amount }]);
            } else {
                addJournalEntry(date, `تحصيل فاتورة #${inv.invoiceNo || inv.id}`, [{ code: '1101', dr: amount, cr: 0 }, { code: '1201', dr: 0, cr: amount }]);
            }
            showToast(`تم تسجيل دفعة ${amount.toFixed(2)} ✅`); save();
            if (source === 'sales') renderInvSales();
            else if (source === 'purchases') renderInvPurchases();
            else if (source === 'services') renderInvServices();
            renderCustStatementFull(); renderSuppStatementFull();
        }

        // ===== Pay installment partial =====
        function payInstallmentPartial(inv) {
            const next = (inv.schedule || []).find(p => !p.paid);
            if (!next) return showToast('كل الأقساط مدفوعة', 'error');
            if (confirm(`هل تريد تسجيل دفع القسط #${(inv.schedule || []).indexOf(next) + 1} بمبلغ ${next.amount.toFixed(2)}؟`)) {
                next.paid = true;
                next.paidDate = new Date().toISOString().split('T')[0];
                addJournalEntry(next.paidDate, `تحصيل قسط #${(inv.schedule || []).indexOf(next) + 1} - ${inv.customer}`, [{ code: '1101', dr: next.amount, cr: 0 }, { code: '1201', dr: 0, cr: next.amount }]);
                showToast('تم تسجيل القسط ✅'); save();
                renderInvInstallments(); renderCustStatementFull();
            }
        }

        // ===== CLOSE INVOICE (Mark as fully paid) =====
        function closeInvoice(source, id) {
            let inv;
            if (source === 'sales') inv = (db.sales || []).find(x => x.id == id);
            else if (source === 'purchases') inv = (db.purchases || []).find(x => x.id == id);
            else if (source === 'services') inv = (db.serviceInvoices || []).find(x => x.id == id);
            if (!inv) return showToast('لم يتم العثور على الفاتورة', 'error');
            const remaining = (inv.total || 0) - (inv.paid || 0);
            if (remaining <= 0) return showToast('الفاتورة مقفلة بالفعل');
            if (!confirm(`إقفال الفاتورة وتسجيل المبلغ المتبقي ${remaining.toFixed(2)} في الخزينة؟`)) return;
            inv.paid = inv.total;
            inv.remaining = 0;
            const date = new Date().toISOString().split('T')[0];
            if (source === 'purchases') {
                addJournalEntry(date, `إقفال فاتورة مشتريات #${inv.invoiceNo || inv.id}`, [{ code: '2101', dr: remaining, cr: 0 }, { code: '1101', dr: 0, cr: remaining }]);
            } else {
                addJournalEntry(date, `إقفال فاتورة #${inv.invoiceNo || inv.id} - ${inv.customer || ''}`, [{ code: '1101', dr: remaining, cr: 0 }, { code: '1201', dr: 0, cr: remaining }]);
            }
            showToast('تم إقفال الفاتورة ✅'); save();
            if (source === 'sales') renderInvSales();
            else if (source === 'purchases') renderInvPurchases();
            else if (source === 'services') renderInvServices();
            renderCustStatementFull(); renderSuppStatementFull();
        }

        // ===== View Invoice Full (with print/PDF) =====
        function viewSaleInvoice(id) {
            const s = (db.sales || []).find(x => x.id == id); if (!s) return;
            const invNo = s.invoiceNo || 'INV-' + String(s.id).slice(-6);
            const items = (s.items || []).map(it => ({ name: it.name, qty: it.qty || 1, price: it.price || 0, total: (it.total || it.price || 0) }));
            openInvoiceWindow(s.type === 'pos' ? 'إيصال نقطة بيع' : 'فاتورة مبيعات', invNo, s.date, { label: 'العميل', name: s.customer }, items,
                `${(s.discount || 0) > 0 ? `<div class="row"><span>الخصم:</span><span style="color:#dc2626">-${s.discount.toFixed(2)}</span></div>` : ''}<div class="row"><span>المدفوع:</span><span style="color:#059669">${(s.paid || 0).toFixed(2)}</span></div>${(s.remaining || 0) > 0 ? `<div class="row"><span>المتبقي:</span><span style="color:#dc2626">${s.remaining.toFixed(2)}</span></div>` : ''}<div class="row grand"><span>الإجمالي:</span><span>${(s.total || 0).toFixed(2)}</span></div>`);
        }
        function viewPurchaseInvoice(id) {
            const s = (db.purchases || []).find(x => x.id == id); if (!s) return;
            const invNo = s.invoiceNo || 'PUR-' + String(s.id).slice(-6);
            openInvoiceWindow('فاتورة مشتريات', invNo, s.date, { label: 'المورد', name: s.supplier }, s.items || [],
                `${(s.discount || 0) > 0 ? `<div class="row"><span>الخصم:</span><span style="color:#dc2626">-${s.discount.toFixed(2)}</span></div>` : ''}<div class="row"><span>المدفوع:</span><span style="color:#059669">${(s.paid || 0).toFixed(2)}</span></div>${(s.remaining || 0) > 0 ? `<div class="row"><span>المتبقي:</span><span style="color:#dc2626">${s.remaining.toFixed(2)}</span></div>` : ''}<div class="row grand"><span>الإجمالي:</span><span>${(s.total || 0).toFixed(2)}</span></div>`);
        }

        function viewInstInvoice(id) {
            const s = (db.installmentInvoices || []).find(x => x.id == id); if (!s) return;
            const schedHTML = (s.schedule || []).map((p, i) => `<tr><td>${i + 1}</td><td>${p.dueDate}</td><td>${p.amount.toFixed(2)}</td><td>${p.paid ? '✅ مدفوع' : '⏳ قادم'}</td></tr>`).join('');
            openInvoiceWindow('فاتورة تقسيط', s.invoiceNo, s.date, { label: 'العميل', name: s.customer }, s.items || [],
                `<div class="row grand"><span>الإجمالي:</span><span>${(s.total || 0).toFixed(2)}</span></div>
                <table style="margin-top:15px"><thead><tr><th>#</th><th>تاريخ الاستحقاق</th><th>المبلغ</th><th>الحالة</th></tr></thead><tbody>${schedHTML}</tbody></table>`);
        }

        // Dashboard
        function renderInvoicesDashboard() {
            _el('inv-count-pos', (db.sales || []).filter(s => s.type === 'pos').length);
            _el('inv-count-sales', (db.sales || []).length);
            _el('inv-count-pur', (db.purchases || []).length);
            _el('inv-count-svc', (db.serviceInvoices || []).length);
        }

        // ===== CUSTOMER STATEMENT (Full - All Invoices) =====
        function renderCustStatementFull() {
            const tbody = document.getElementById('cust-stmt-body'); if (!tbody) return;
            const filterCust = document.getElementById('cust-stmt-filter')?.value || '';
            const from = document.getElementById('cust-stmt-from')?.value;
            const to = document.getElementById('cust-stmt-to')?.value;
            // Populate customer dropdown
            const sel = document.getElementById('cust-stmt-filter');
            if (sel && sel.options.length <= 1) {
                const names = new Set();
                (db.sales || []).forEach(s => names.add(s.customer));
                (db.serviceInvoices || []).forEach(s => names.add(s.customer));
                (db.installmentInvoices || []).forEach(s => names.add(s.customer));
                (db.customers || []).forEach(c => names.add(c.name));
                [...names].sort().forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; sel.appendChild(o); });
            }
            // Aggregate all customer invoices
            let rows = [];
            (db.sales || []).forEach(s => rows.push({ src: 'sales', type: 'مبيعات', id: s.id, customer: s.customer, invNo: s.invoiceNo || 'INV-' + String(s.id).slice(-4), date: s.date, total: s.total || 0, paid: s.paid || 0, remaining: s.remaining || 0 }));
            (db.serviceInvoices || []).forEach(s => rows.push({ src: 'services', type: 'خدمات', id: s.id, customer: s.customer, invNo: s.invoiceNo || 'SVC-' + String(s.id).slice(-4), date: s.date, total: s.total || 0, paid: s.paid || 0, remaining: s.remaining || 0 }));
            (db.installmentInvoices || []).forEach(s => {
                const paid = (s.schedule || []).filter(p => p.paid).reduce((a, b) => a + b.amount, 0);
                rows.push({ src: 'installments', type: 'تقسيط', id: s.id, customer: s.customer, invNo: s.invoiceNo || 'INST-' + String(s.id).slice(-4), date: s.date, total: s.total || 0, paid: paid, remaining: (s.total || 0) - paid });
            });
            if (filterCust) rows = rows.filter(r => r.customer === filterCust);
            if (from) rows = rows.filter(r => r.date >= from);
            if (to) rows = rows.filter(r => r.date <= to);
            rows.sort((a, b) => b.date.localeCompare(a.date));
            let totalAll = 0, paidAll = 0, remAll = 0;
            const typeColors = { مبيعات: 'bg-blue-100 text-blue-700', خدمات: 'bg-teal-100 text-teal-700', تقسيط: 'bg-indigo-100 text-indigo-700' };
            tbody.innerHTML = rows.length ? rows.map(r => {
                totalAll += r.total; paidAll += r.paid; remAll += r.remaining;
                const status = r.remaining > 0 ? '<span class="text-red-600 font-bold">مستحق</span>' : '<span class="text-emerald-600">تم السداد</span>';
                const viewFn = r.src === 'sales' ? `viewSaleInvoice(${r.id})` : r.src === 'services' ? `viewServiceInvoice(${r.id})` : `viewInstInvoice(${r.id})`;
                const editBtn = r.remaining > 0 ? `<button onclick="editInvoicePaid('${r.src}',${r.id})" class="text-amber-500 text-xs me-1" title="تعديل المدفوع"><i class="fas fa-edit"></i></button>` : '';
                return `<tr class="hover:bg-blue-50"><td class="p-2 font-bold">${r.customer}</td><td class="p-2"><span class="px-2 py-0.5 rounded text-xs ${typeColors[r.type] || ''}">${r.type}</span></td><td class="p-2 font-mono text-blue-600">${r.invNo}</td><td class="p-2">${r.date}</td><td class="p-2 font-bold">${r.total.toFixed(2)}</td><td class="p-2 text-emerald-600">${r.paid.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${r.remaining.toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${editBtn}<button onclick="${viewFn}" class="text-blue-500 text-xs"><i class="fas fa-eye"></i></button></td></tr>`;
            }).join('') : '<tr><td colspan="9" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('cust-stmt-count', rows.length); _el('cust-stmt-total', totalAll.toFixed(2)); _el('cust-stmt-paid', paidAll.toFixed(2)); _el('cust-stmt-remaining', remAll.toFixed(2));
        }

        // ===== SUPPLIER STATEMENT (Full - All Invoices) =====
        function renderSuppStatementFull() {
            const tbody = document.getElementById('supp-stmt-body'); if (!tbody) return;
            const filterSupp = document.getElementById('supp-stmt-filter')?.value || '';
            const from = document.getElementById('supp-stmt-from')?.value;
            const to = document.getElementById('supp-stmt-to')?.value;
            // Populate supplier dropdown
            const sel = document.getElementById('supp-stmt-filter');
            if (sel && sel.options.length <= 1) {
                const names = new Set();
                (db.purchases || []).forEach(s => names.add(s.supplier));
                (db.suppliers || []).forEach(c => names.add(c.name));
                [...names].sort().forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; sel.appendChild(o); });
            }
            let rows = [];
            (db.purchases || []).forEach(s => rows.push({ src: 'purchases', id: s.id, supplier: s.supplier, invNo: s.invoiceNo || 'PUR-' + String(s.id).slice(-4), date: s.date, total: s.total || 0, paid: s.paid || 0, remaining: s.remaining || 0 }));
            if (filterSupp) rows = rows.filter(r => r.supplier === filterSupp);
            if (from) rows = rows.filter(r => r.date >= from);
            if (to) rows = rows.filter(r => r.date <= to);
            rows.sort((a, b) => b.date.localeCompare(a.date));
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = rows.length ? rows.map(r => {
                totalAll += r.total; paidAll += r.paid; remAll += r.remaining;
                const status = r.remaining > 0 ? '<span class="text-red-600 font-bold">مستحق</span>' : '<span class="text-emerald-600">تم السداد</span>';
                const editBtn = r.remaining > 0 ? `<button onclick="editInvoicePaid('purchases',${r.id})" class="text-amber-500 text-xs me-1" title="تعديل المدفوع"><i class="fas fa-edit"></i></button>` : '';
                return `<tr class="hover:bg-orange-50"><td class="p-2 font-bold">${r.supplier}</td><td class="p-2 font-mono text-orange-600">${r.invNo}</td><td class="p-2">${r.date}</td><td class="p-2 font-bold">${r.total.toFixed(2)}</td><td class="p-2 text-emerald-600">${r.paid.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${r.remaining.toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2">${editBtn}<button onclick="viewPurchaseInvoice(${r.id})" class="text-blue-500 text-xs"><i class="fas fa-eye"></i></button></td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('supp-stmt-count', rows.length); _el('supp-stmt-total', totalAll.toFixed(2)); _el('supp-stmt-paid', paidAll.toFixed(2)); _el('supp-stmt-remaining', remAll.toFixed(2));
        }

        // ===== EDIT INVOICE PAID (Universal) =====
        function editInvoicePaid(source, id) {
            let inv, arr;
            if (source === 'sales') { arr = db.sales || []; inv = arr.find(x => x.id == id); }
            else if (source === 'purchases') { arr = db.purchases || []; inv = arr.find(x => x.id == id); }
            else if (source === 'services') { arr = db.serviceInvoices || []; inv = arr.find(x => x.id == id); }
            else if (source === 'installments') { showToast('التقسيط يُعدَّل من صفحة التقسيط', 'error'); return; }
            if (!inv) return showToast('لم يتم العثور على الفاتورة', 'error');
            const remaining = (inv.total || 0) - (inv.paid || 0);
            const val = prompt(`المتبقي: ${remaining.toFixed(2)}\nأدخل المبلغ المراد تسديده:`);
            if (val === null) return;
            const amount = parseFloat(val);
            if (isNaN(amount) || amount <= 0) return showToast('مبلغ غير صحيح', 'error');
            if (amount > remaining + 0.01) return showToast('المبلغ أكبر من المتبقي', 'error');
            inv.paid = (inv.paid || 0) + amount;
            inv.remaining = (inv.total || 0) - inv.paid;
            if (inv.remaining < 0.01) inv.remaining = 0;
            // Journal entry for payment
            const date = new Date().toISOString().split('T')[0];
            const desc = source === 'purchases' ? `سداد فاتورة مشتريات: ${inv.supplier || ''} #${inv.invoiceNo || inv.id}` : `تحصيل فاتورة: ${inv.customer || ''} #${inv.invoiceNo || inv.id}`;
            if (source === 'purchases') { addJournalEntry(date, desc, [{ code: '2101', dr: amount, cr: 0 }, { code: '1101', dr: 0, cr: amount }]); }
            else { addJournalEntry(date, desc, [{ code: '1101', dr: amount, cr: 0 }, { code: '1201', dr: 0, cr: amount }]); }
            showToast('تم تسجيل الدفعة ✅'); save();
            renderCustStatementFull(); renderSuppStatementFull();
        }

        // ===== SERVICE STATEMENT =====
        function renderSvcStatement() {
            const tbody = document.getElementById('svc-stmt-body'); if (!tbody) return;
            const inv = (db.serviceInvoices || []);
            tbody.innerHTML = inv.length ? inv.map(s => {
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600 font-bold">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                return `<tr class="hover:bg-teal-50"><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-mono text-teal-600">${s.invoiceNo || '-'}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td><td class="p-2"><button onclick="viewServiceInvoice(${s.id})" class="text-blue-500"><i class="fas fa-eye"></i></button></td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
        }

        // ===== INSTALLMENT COLLECTION =====
        function renderInstCollection() {
            const tbody = document.getElementById('inst-collect-body'); if (!tbody) return;
            const inv = db.installmentInvoices || [];
            tbody.innerHTML = inv.length ? inv.map(s => {
                const cust = (db.installmentCustomers || []).find(c => c.name === s.customer) || {};
                const paid = (s.schedule || []).filter(p => p.paid).reduce((a, b) => a + b.amount, 0);
                const rem = (s.total || 0) - paid;
                const next = (s.schedule || []).find(p => !p.paid);
                return `<tr class="hover:bg-indigo-50"><td class="p-2 font-bold">${s.customer}</td><td class="p-2">${cust.phone || '-'}</td><td class="p-2 font-mono text-indigo-600">${s.invoiceNo || '-'}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2">${(s.schedule || []).length}</td><td class="p-2 text-emerald-600">${paid.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${rem.toFixed(2)}</td><td class="p-2 text-amber-600">${next ? next.dueDate : '-'}</td><td class="p-2"><button onclick="viewInstInvoice(${s.id})" class="text-blue-500"><i class="fas fa-eye"></i></button></td></tr>`;
            }).join('') : '<tr><td colspan="9" class="p-4 text-center text-slate-400">لا توجد عقود تقسيط</td></tr>';
        }

        // ===== EXPENSE VOUCHERS =====
        function renderExpenseVouchers() {
            const tbody = document.getElementById('exp-voucher-body'); if (!tbody) return;
            const from = document.getElementById('exp-voucher-from')?.value;
            const to = document.getElementById('exp-voucher-to')?.value;
            let exps = db.expenses || [];
            if (from) exps = exps.filter(e => e.date >= from);
            if (to) exps = exps.filter(e => e.date <= to);
            let total = 0;
            tbody.innerHTML = exps.length ? exps.map((e, i) => {
                total += e.amount || 0;
                return `<tr class="hover:bg-red-50"><td class="p-2">${i + 1}</td><td class="p-2">${e.date}</td><td class="p-2 font-bold">${e.desc || e.description || '-'}</td><td class="p-2">${e.category || '-'}</td><td class="p-2 font-bold text-red-600">${(e.amount || 0).toFixed(2)}</td><td class="p-2">${e.method === '1101' ? 'نقدي' : e.method === '1102' ? 'بنك' : (e.method || 'نقدي')}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد سندات صرف</td></tr>';
            const el = document.getElementById('exp-voucher-total'); if (el) el.textContent = total.toFixed(2);
        }

        // ===== INCOME VOUCHERS =====
        function renderIncomeVouchers() {
            const tbody = document.getElementById('inc-voucher-body'); if (!tbody) return;
            const from = document.getElementById('inc-voucher-from')?.value;
            const to = document.getElementById('inc-voucher-to')?.value;
            let incs = db.incomes || [];
            if (from) incs = incs.filter(e => e.date >= from);
            if (to) incs = incs.filter(e => e.date <= to);
            let total = 0;
            tbody.innerHTML = incs.length ? incs.map((e, i) => {
                total += e.amount || 0;
                return `<tr class="hover:bg-emerald-50"><td class="p-2">${i + 1}</td><td class="p-2">${e.date}</td><td class="p-2 font-bold">${e.desc || e.description || '-'}</td><td class="p-2">${e.categoryName || '-'}</td><td class="p-2 font-bold text-emerald-600">${(e.amount || 0).toFixed(2)}</td><td class="p-2">${e.method === '1101' ? 'نقدي' : e.method === '1102' ? 'بنك' : (e.method || 'نقدي')}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد سندات قبض</td></tr>';
            const el = document.getElementById('inc-voucher-total'); if (el) el.textContent = total.toFixed(2);
        }



        // ===== HR ACTIONS =====
        function populateHRActionEmps() {
            const sel = document.getElementById('hr-action-emp'); if (!sel) return;
            sel.innerHTML = '<option value="">-- اختر --</option>' + (db.employees || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }
        function saveHRAction() {
            const empId = document.getElementById('hr-action-emp').value;
            const emp = (db.employees || []).find(e => e.id == empId);
            if (!empId || !emp) return showToast('اختر الموظف', 'error');
            if (!db.hrActions) db.hrActions = [];
            db.hrActions.push({
                id: Date.now(), date: new Date().toISOString().split('T')[0],
                empId, empName: emp.name,
                type: document.getElementById('hr-action-type').value,
                amount: parseFloat(document.getElementById('hr-action-amount').value) || 0,
                reason: document.getElementById('hr-action-reason').value
            });
            showToast('تم تسجيل الإجراء ✅'); renderHRActions(); save();
            document.getElementById('hr-action-amount').value = '';
            document.getElementById('hr-action-reason').value = '';
        }
        function renderHRActions() {
            const tbody = document.getElementById('hr-action-body'); if (!tbody) return;
            const acts = [...(db.hrActions || [])].reverse();
            const typeMap = { bonus: 'مكافأة', deduction: 'خصم', warning: 'إنذار', leave: 'إجازة', promotion: 'ترقية' };
            tbody.innerHTML = acts.length ? acts.map(a => `<tr class="hover:bg-amber-50"><td class="p-2">${a.date}</td><td class="p-2 font-bold">${a.empName}</td><td class="p-2">${typeMap[a.type] || a.type}</td><td class="p-2 ${a.type === 'deduction' ? 'text-red-600' : 'text-emerald-600'} font-bold">${a.amount > 0 ? a.amount.toFixed(2) : '-'}</td><td class="p-2">${a.reason || '-'}</td></tr>`).join('') : '<tr><td colspan="5" class="p-4 text-center text-slate-400">لا توجد إجراءات</td></tr>';
        }

        // ===== HR LIST =====
        function renderHRList() {
            const tbody = document.getElementById('hr-list-body'); if (!tbody) return;
            const emps = db.employees || [];
            tbody.innerHTML = emps.length ? emps.map((e, i) => `<tr class="hover:bg-blue-50"><td class="p-2">${i + 1}</td><td class="p-2 font-bold">${e.name}</td><td class="p-2">${e.position || '-'}</td><td class="p-2">${e.phone || '-'}</td><td class="p-2 font-bold">${(e.salary || 0).toFixed(2)}</td><td class="p-2">${e.hireDate || '-'}</td><td class="p-2"><span class="px-2 py-0.5 rounded text-xs ${e.status === 'active' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${e.status === 'active' ? 'نشط' : 'متوقف'}</span></td></tr>`).join('') : '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا يوجد موظفين</td></tr>';
        }

        // ===== PAYROLL =====
        function populatePayrollEmps() {
            const sel = document.getElementById('payroll-emp'); if (!sel) return;
            sel.innerHTML = '<option value="">-- اختر --</option>' + (db.employees || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }
        function loadPayrollSalary() {
            const empId = document.getElementById('payroll-emp').value;
            const month = document.getElementById('payroll-month').value; // YYYY-MM
            const emp = (db.employees || []).find(e => e.id == empId);
            if (!emp) return;

            document.getElementById('payroll-basic').value = emp.salary || '';
            document.getElementById('payroll-allowance').value = emp.allowance || 0;

            // Auto sync from HR Actions if month is selected
            let totalBonus = 0, totalDed = 0;
            let syncListHtml = '';
            if (month) {
                (db.hrActions || []).forEach(a => {
                    if (a.empId == empId && a.date.startsWith(month)) {
                        if (a.type === 'bonus') totalBonus += (a.amount || 0);
                        if (a.type === 'deduction') totalDed += (a.amount || 0);
                        syncListHtml += `<div class="flex justify-between border-b border-amber-100 pb-0.5 last:border-0">
                            <span>📅 ${a.date} - ${a.reason || (a.type === 'bonus' ? 'مكافأة' : 'خصم')}</span>
                            <span class="${a.type === 'bonus' ? 'text-emerald-600' : 'text-red-600'} font-bold">${a.type === 'bonus' ? '+' : '-'}${a.amount.toFixed(2)}</span>
                        </div>`;
                    }
                });
            }
            document.getElementById('payroll-bonus').value = totalBonus;
            document.getElementById('payroll-deduction').value = totalDed;

            const detailsDiv = document.getElementById('payroll-actions-details');
            const listDiv = document.getElementById('payroll-actions-list');
            if (detailsDiv && listDiv) {
                if (syncListHtml) {
                    listDiv.innerHTML = syncListHtml;
                    detailsDiv.classList.remove('hidden');
                } else {
                    detailsDiv.classList.add('hidden');
                }
            }

            calcPayrollNet();
        }
        function calcPayrollNet() {
            const basic = parseFloat(document.getElementById('payroll-basic')?.value) || 0;
            const allow = parseFloat(document.getElementById('payroll-allowance')?.value) || 0;
            const ded = parseFloat(document.getElementById('payroll-deduction')?.value) || 0;
            const bonus = parseFloat(document.getElementById('payroll-bonus')?.value) || 0;
            const gross = basic + allow; const net = gross - ded + bonus;
            const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
            el('payroll-gross', gross.toFixed(2)); el('payroll-ded-show', ded.toFixed(2)); el('payroll-net', net.toFixed(2));
        }
        function processPayroll() {
            const empSel = document.getElementById('payroll-emp');
            const empName = empSel.options[empSel.selectedIndex]?.text;
            const empId = empSel.value;
            const month = document.getElementById('payroll-month').value;
            const basic = parseFloat(document.getElementById('payroll-basic').value) || 0;
            const allowance = parseFloat(document.getElementById('payroll-allowance').value) || 0;
            const deduction = parseFloat(document.getElementById('payroll-deduction').value) || 0;
            const bonus = parseFloat(document.getElementById('payroll-bonus').value) || 0;
            const method = document.getElementById('payroll-method').value;
            const notes = document.getElementById('payroll-notes').value;
            if (!empId || basic <= 0) return showToast('اختر الموظف وحدد الراتب', 'error');
            if (!month) return showToast('حدد الشهر', 'error');
            const net = basic + allowance - deduction + bonus;
            if (net <= 0) return showToast('الصافي يجب أن يكون أكبر من صفر', 'error');
            const date = new Date().toISOString().split('T')[0];

            // Ensure necessary accounts exist in COA
            const requiredAccs = [
                { code: '5204', name: 'مصروف رواتب وأجور', type: 'expense', parent: '5' },
                { code: '4201', name: 'إيرادات خصومات وجزاءات', type: 'revenue', parent: '4' }
            ];
            requiredAccs.forEach(r => {
                if (!db.chartOfAccounts.find(a => a.code === r.code)) {
                    db.chartOfAccounts.push({ ...r, level: 3, balance: 0 });
                }
            });

            const gross = basic + allowance + bonus;
            const lines = [
                { code: '5204', dr: gross, cr: 0 }, // Dr Salaries Expense (Gross)
                { code: getMethodAccount(method), dr: 0, cr: net }, // Asset Down
                // Cr Cash/Bank (Net)
            ];
            if (deduction > 0) {
                lines.push({ code: '4201', dr: 0, cr: deduction }); // Cr Fines/Penalties Revenue
            }

            if (addJournalEntry(date, `صرف راتب: ${empName} - شهر ${month} (إجمالي: ${gross}, صافي: ${net})`, lines)) {
                if (!db.salaryHistory) db.salaryHistory = [];

                // Sync and Mark HR actions as processed for this month
                const syncedActions = (db.hrActions || []).filter(a => a.empId == empId && a.date.startsWith(month));
                syncedActions.forEach(a => { a.processed = true; });

                db.salaryHistory.push({
                    id: Date.now(), date, month, empId, empName, basic, allowance, deduction, bonus, net,
                    method: method === '1101' ? 'نقدي' : 'بنك', notes,
                    details: syncedActions.map(a => ({ date: a.date, type: a.type, reason: a.reason, amount: a.amount }))
                });

                showToast('تم صرف الراتب ✅'); renderPayrollHistory(); save();
                document.getElementById('payroll-notes').value = '';
            }
        }
        function renderPayrollHistory() {
            const tbody = document.getElementById('payroll-body'); if (!tbody) return;
            const hist = [...(db.salaryHistory || [])].reverse();
            tbody.innerHTML = hist.length ? hist.map((h, i) => `<tr class="hover:bg-emerald-50"><td class="p-2">${hist.length - i}</td><td class="p-2">${h.date}</td><td class="p-2">${h.month}</td><td class="p-2 font-bold">${h.empName}</td><td class="p-2">${(h.basic || 0).toFixed(2)}</td><td class="p-2">${(h.allowance || 0).toFixed(2)}</td><td class="p-2 text-red-600">${(h.deduction || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(h.bonus || 0).toFixed(2)}</td><td class="p-2 font-bold text-yellow-600">${(h.net || 0).toFixed(2)}</td><td class="p-2">${h.method}</td><td class="p-2 text-xs">${h.notes || '-'}</td></tr>`).join('') : '<tr><td colspan="11" class="p-4 text-center text-slate-400">لا توجد رواتب مسجلة</td></tr>';
        }
        function filterPayrollByMonth() {
            const month = document.getElementById('payroll-filter-month')?.value || '';
            document.querySelectorAll('#payroll-body tr').forEach(r => {
                r.style.display = !month || r.innerText.includes(month) ? '' : 'none';
            });
        }
        function printLastPayroll() {
            if (!(db.salaryHistory || []).length) return showToast('لا توجد رواتب', 'error');
            const h = db.salaryHistory[db.salaryHistory.length - 1];
            const w = window.open('', 'payroll', 'width=500,height=600');
            w.document.write(`<html dir="rtl"><head><style>body{font-family:'Cairo',sans-serif;max-width:450px;margin:20px auto;padding:20px;font-size:13px}.row{display:flex;justify-content:space-between;margin-bottom:5px;padding:5px 0;border-bottom:1px dashed #ddd}.no-print{text-align:center;margin-top:20px}@media print{.no-print{display:none}}</style></head><body>
            <h2 style="text-align:center">إيصال صرف راتب</h2><p style="text-align:center;color:#666">${db.settings.companyName || ''}</p><hr>
            <div class="row"><span>الموظف:</span><strong>${h.empName}</strong></div>
            <div class="row"><span>الشهر:</span><span>${h.month}</span></div>
            <div class="row"><span>التاريخ:</span><span>${h.date}</span></div>
            <div class="row"><span>الأساسي:</span><span>${(h.basic || 0).toFixed(2)}</span></div>
            <div class="row"><span>البدلات:</span><span>${(h.allowance || 0).toFixed(2)}</span></div>
            <div class="row"><span>الخصومات الكلية:</span><span style="color:red">${(h.deduction || 0).toFixed(2)}</span></div>
            <div class="row"><span>الحوافز الكلية:</span><span style="color:green">${(h.bonus || 0).toFixed(2)}</span></div>
            
            ${h.details && h.details.length ? `
                <div style="margin-top:10px;border:1px solid #eee;padding:5px;border-radius:4px">
                    <p style="font-weight:bold;margin-bottom:5px;font-size:11px;background:#f8f9fa;padding:3px">تفاصيل الإجراءات (خصم/مكافأة):</p>
                    ${h.details.map(d => `<div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px">
                        <span>${d.date} - ${d.reason || (d.type === 'bonus' ? 'مكافأة' : 'خصم')}</span>
                        <span style="color:${d.type === 'bonus' ? 'green' : 'red'}">${d.type === 'bonus' ? '+' : '-'}${d.amount.toFixed(2)}</span>
                    </div>`).join('')}
                </div>
            ` : ''}

            <div class="row" style="border-top:2px solid #333;font-size:16px;font-weight:bold;margin-top:10px"><span>الصافي النهائي:</span><span style="color:#059669">${(h.net || 0).toFixed(2)}</span></div>
            <div class="row"><span>طريقة الصرف:</span><span>${h.method}</span></div>
            ${h.notes ? `<div class="row"><span>ملاحظات إضافية:</span><span>${h.notes}</span></div>` : ''}
            <div class="no-print"><button onclick="window.print()" style="padding:8px 25px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer">طباعة</button></div>
            </body></html>`);
            w.document.close();
        }

        // ===== REPORT UTILITY =====
        function _dtFilter(arr, fromId, toId) {
            const from = document.getElementById(fromId)?.value;
            const to = document.getElementById(toId)?.value;
            let r = arr;
            if (from) r = r.filter(x => x.date >= from);
            if (to) r = r.filter(x => x.date <= to);
            return r;
        }
        function _el(id, v) { const e = document.getElementById(id); if (e) e.textContent = v; }

        // ===== RPT: POS =====
        function renderRptPOS() {
            const data = _dtFilter(db.posInvoices || [], 'rpt-pos-from', 'rpt-pos-to');
            let total = 0, items = 0;
            const tbody = document.getElementById('rpt-pos-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map(s => {
                total += s.total || 0; items += (s.items || []).reduce((a, b) => a + (b.qty || 1), 0);
                return `<tr class="hover:bg-purple-50"><td class="p-2 font-mono text-purple-600">${s.invoiceNo || '-'}</td><td class="p-2">${s.date}</td><td class="p-2">${s.time || '-'}</td><td class="p-2">${(s.items || []).length}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="5" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-pos-count', data.length); _el('rpt-pos-total', total.toFixed(2)); _el('rpt-pos-items', items);
        }

        // ===== RPT: Sales =====
        function renderRptSales() {
            const data = _dtFilter(db.sales || [], 'rpt-sales-from', 'rpt-sales-to');
            let total = 0, paid = 0, rem = 0;
            const tbody = document.getElementById('rpt-sales-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map((s, i) => {
                total += s.total || 0; paid += s.paid || 0; rem += s.remaining || 0;
                const invNo = s.invoiceNo || 'INV-' + String(data.length - i).padStart(4, '0');
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600">آجل</span>' : '<span class="text-emerald-600">مدفوع</span>';
                return `<tr class="hover:bg-blue-50"><td class="p-2 font-mono text-blue-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td></tr>`;
            }).join('') : '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-sales-count', data.length); _el('rpt-sales-total', total.toFixed(2)); _el('rpt-sales-paid', paid.toFixed(2)); _el('rpt-sales-remaining', rem.toFixed(2));
        }

        // ===== HR STATEMENT =====
        function populateHRStmtEmps() {
            const sel = document.getElementById('emp-stmt-id'); if (!sel) return;
            sel.innerHTML = '<option value="">-- اختر الموظف --</option>' + (db.employees || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }
        function renderHREmpStatement() {
            const empId = document.getElementById('emp-stmt-id').value;
            const from = document.getElementById('emp-stmt-from').value;
            const to = document.getElementById('emp-stmt-to').value;
            const tbody = document.getElementById('emp-stmt-body');
            if (!tbody || !empId) return;

            const emp = (db.employees || []).find(e => e.id == empId);
            if (emp) {
                document.getElementById('emp-stmt-header').classList.remove('hidden');
                document.getElementById('emp-stmt-name-show').textContent = emp.name;
                document.getElementById('emp-stmt-role-show').textContent = emp.role || emp.position || '-';
                document.getElementById('emp-stmt-phone-show').textContent = emp.phone || '-';
                const totalSalary = (emp.salary || 0) + (emp.allowance || 0);
                document.getElementById('emp-stmt-salary-show').textContent = totalSalary.toFixed(2) + (emp.allowance > 0 ? ` (${emp.salary.toFixed(2)} + ${emp.allowance.toFixed(2)})` : '');
            }

            let transactions = [];
            // Add Salary Payments & Accruals from History
            (db.salaryHistory || []).forEach(h => {
                if (h.empId == empId) {
                    const earnings = (h.basic || 0) + (h.allowance || 0) + (h.bonus || 0);
                    transactions.push({
                        date: h.date, type: 'استحقاق راتب',
                        desc: `إجمالي مستحقات شهر ${h.month} (أساسي + بدلات + حوافز)`,
                        dr: earnings, cr: 0
                    });
                    if (h.deduction > 0) {
                        transactions.push({
                            date: h.date, type: 'خصم راتب',
                            desc: `خصومات مستقطعة من راتب شهر ${h.month}`,
                            dr: 0, cr: h.deduction
                        });
                    }
                    transactions.push({
                        date: h.date, type: 'صرف راتب',
                        desc: `صافي الراتب المحول شهر ${h.month} (${h.method || 'نقدي'})`,
                        dr: 0, cr: h.net
                    });
                }
            });

            // Add HR Actions (Only Unprocessed ones)
            const typeMap = { bonus: 'مكافأة', deduction: 'خصم', warning: 'إنذار', leave: 'إجازة', promotion: 'ترقية' };
            const unprocessedActions = (db.hrActions || []).filter(a => a.empId == empId && !a.processed);
            unprocessedActions.forEach(a => {
                transactions.push({
                    date: a.date, type: typeMap[a.type] || a.type, desc: a.reason || '-',
                    dr: a.type === 'bonus' ? a.amount : 0,
                    cr: a.type === 'deduction' ? a.amount : 0
                });
            });

            // Auto-Add Basic Salary Accrual for the current month if not processed
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const hasPaidThisMonth = (db.salaryHistory || []).some(h => h.empId == empId && h.month === currentMonth);
            if (!hasPaidThisMonth && emp.salary > 0) {
                transactions.push({
                    date: currentMonth + '-01',
                    type: 'استحقاق راتب',
                    desc: `قيمة الراتب المستحق لشهر ${currentMonth} (أساسي + بدلات)`,
                    dr: (emp.salary || 0) + (emp.allowance || 0),
                    cr: 0
                });
            }

            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            if (from) transactions = transactions.filter(t => t.date >= from);
            if (to) transactions = transactions.filter(t => t.date <= to);

            let cumulative = 0;
            tbody.innerHTML = transactions.length ? transactions.map(t => {
                const rowNet = (t.dr || 0) - (t.cr || 0);
                cumulative += rowNet;
                return `<tr>
                    <td class="p-3">${t.date}</td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded text-xs bg-slate-100 text-slate-700">${t.type}</span></td>
                    <td class="p-3">${t.desc}</td>
                    <td class="p-3 text-emerald-600 font-bold">${t.dr > 0 ? t.dr.toFixed(2) : '-'}</td>
                    <td class="p-3 text-red-600 font-bold">${t.cr > 0 ? t.cr.toFixed(2) : '-'}</td>
                    <td class="p-3 font-bold ${cumulative >= 0 ? 'text-emerald-700' : 'text-red-700'}">${cumulative.toFixed(2)}</td>
                </tr>`;
            }).join('') : '<tr><td colspan="6" class="p-8 text-center text-slate-400">لا توجد حركات مسجلة لهذا الموظف في هذه الفترة</td></tr>';
        }
        function renderRptCustomers() {
            const tbody = document.getElementById('rpt-customers-body'); if (!tbody) return;
            const custs = db.customers || [];
            const sales = db.sales || [];
            let totalSales = 0, totalDue = 0;
            tbody.innerHTML = custs.length ? custs.map(c => {
                const custSales = sales.filter(s => s.customer === c.name);
                const t = custSales.reduce((a, s) => a + (s.total || 0), 0);
                const p = custSales.reduce((a, s) => a + (s.paid || 0), 0);
                const d = t - p; totalSales += t; totalDue += d;
                return `<tr class="hover:bg-indigo-50"><td class="p-2 font-bold">${c.name}</td><td class="p-2">${c.phone || '-'}</td><td class="p-2">${custSales.length}</td><td class="p-2 font-bold">${t.toFixed(2)}</td><td class="p-2 text-emerald-600">${p.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${d.toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-cust-count', custs.length); _el('rpt-cust-total-sales', totalSales.toFixed(2)); _el('rpt-cust-total-due', totalDue.toFixed(2));
        }

        // ===== RPT: Purchases =====
        function renderRptPurchases() {
            const data = _dtFilter(db.purchases || [], 'rpt-pur-from', 'rpt-pur-to');
            let total = 0, paid = 0, rem = 0;
            const tbody = document.getElementById('rpt-pur-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map((s, i) => {
                total += s.total || 0; paid += s.paid || 0; rem += s.remaining || 0;
                const invNo = s.invoiceNo || 'PUR-' + String(data.length - i).padStart(4, '0');
                const status = (s.remaining || 0) > 0 ? '<span class="text-red-600">مستحق</span>' : '<span class="text-emerald-600">مدفوع</span>';
                return `<tr class="hover:bg-orange-50"><td class="p-2 font-mono text-orange-600">${invNo}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.supplier}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600">${(s.remaining || 0).toFixed(2)}</td><td class="p-2">${status}</td></tr>`;
            }).join('') : '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-pur-count', data.length); _el('rpt-pur-total', total.toFixed(2)); _el('rpt-pur-paid', paid.toFixed(2)); _el('rpt-pur-remaining', rem.toFixed(2));
        }

        // ===== RPT: Suppliers =====
        function renderRptSuppliers() {
            const tbody = document.getElementById('rpt-supp-body'); if (!tbody) return;
            const supps = db.suppliers || [];
            const purs = db.purchases || [];
            let totalPur = 0, totalDue = 0;
            tbody.innerHTML = supps.length ? supps.map(c => {
                const ss = purs.filter(s => s.supplier === c.name);
                const t = ss.reduce((a, s) => a + (s.total || 0), 0);
                const p = ss.reduce((a, s) => a + (s.paid || 0), 0);
                const d = t - p; totalPur += t; totalDue += d;
                return `<tr class="hover:bg-amber-50"><td class="p-2 font-bold">${c.name}</td><td class="p-2">${c.phone || '-'}</td><td class="p-2">${ss.length}</td><td class="p-2 font-bold">${t.toFixed(2)}</td><td class="p-2 text-emerald-600">${p.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${d.toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-supp-count', supps.length); _el('rpt-supp-total-pur', totalPur.toFixed(2)); _el('rpt-supp-total-due', totalDue.toFixed(2));
        }

        // ===== RPT: Employees =====
        function renderRptEmployees() {
            const tbody = document.getElementById('rpt-emp-body'); if (!tbody) return;
            const emps = db.employees || [];
            const hist = db.salaryHistory || [];
            const acts = db.hrActions || [];
            let totalSalary = 0, totalPaid = 0;
            tbody.innerHTML = emps.length ? emps.map(e => {
                totalSalary += e.salary || 0;
                const empHist = hist.filter(h => h.empId == e.id);
                const empActs = acts.filter(a => a.empId == e.id);
                const paidTotal = empHist.reduce((a, h) => a + (h.net || 0), 0); totalPaid += paidTotal;
                return `<tr class="hover:bg-blue-50"><td class="p-2 font-bold">${e.name}</td><td class="p-2">${e.position || '-'}</td><td class="p-2 font-bold">${(e.salary || 0).toFixed(2)}</td><td class="p-2">${empHist.length}</td><td class="p-2 text-emerald-600">${paidTotal.toFixed(2)}</td><td class="p-2">${empActs.length}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-emp-count', emps.length); _el('rpt-emp-total-salary', totalSalary.toFixed(2)); _el('rpt-emp-total-paid', totalPaid.toFixed(2)); _el('rpt-emp-actions', acts.length);
        }

        // ===== RPT: Inventory =====
        function renderRptInventory() {
            const tbody = document.getElementById('rpt-inv-body'); if (!tbody) return;
            const prods = db.products || [];
            let totalStock = 0, totalValue = 0, lowCount = 0;
            tbody.innerHTML = prods.length ? prods.map(p => {
                const stock = p.stock || 0; const value = stock * (p.price || 0);
                totalStock += stock; totalValue += value; if (stock <= 5) lowCount++;
                const status = stock <= 0 ? '<span class="text-red-600 font-bold">نفد</span>' : stock <= 5 ? '<span class="text-amber-600 font-bold">منخفض</span>' : '<span class="text-emerald-600">متوفر</span>';
                return `<tr class="hover:bg-teal-50"><td class="p-2 font-mono">${p.barcode || p.code || '-'}</td><td class="p-2 font-bold">${p.name}</td><td class="p-2">${p.category || 'عام'}</td><td class="p-2 text-emerald-600">${(p.price || 0).toFixed(2)}</td><td class="p-2 text-slate-500">${(p.cost || 0).toFixed(2)}</td><td class="p-2 ${stock <= 5 ? 'text-red-600 font-bold' : ''}">${stock}</td><td class="p-2 font-bold">${value.toFixed(2)}</td><td class="p-2">${status}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-inv-count', prods.length); _el('rpt-inv-total-stock', totalStock); _el('rpt-inv-total-value', totalValue.toFixed(2)); _el('rpt-inv-low', lowCount);
        }

        // ===== RPT: Services =====
        function renderRptServices() {
            const data = _dtFilter(db.serviceInvoices || [], 'rpt-svc-from', 'rpt-svc-to');
            let total = 0, paid = 0, rem = 0;
            const tbody = document.getElementById('rpt-svc-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map(s => {
                total += s.total || 0; paid += s.paid || 0; rem += s.remaining || 0;
                return `<tr class="hover:bg-cyan-50"><td class="p-2 font-mono text-cyan-600">${s.invoiceNo || '-'}</td><td class="p-2">${s.date}</td><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2 text-emerald-600">${(s.paid || 0).toFixed(2)}</td><td class="p-2 text-red-600">${(s.remaining || 0).toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-svc-count', data.length); _el('rpt-svc-total', total.toFixed(2)); _el('rpt-svc-paid', paid.toFixed(2)); _el('rpt-svc-remaining', rem.toFixed(2));
        }

        // ===== RPT: Installments =====
        function renderRptInstallments() {
            const tbody = document.getElementById('rpt-inst-body'); if (!tbody) return;
            const inv = db.installmentInvoices || [];
            let totalAll = 0, collectedAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const paid = (s.schedule || []).filter(p => p.paid).reduce((a, b) => a + b.amount, 0);
                const rem = (s.total || 0) - paid; totalAll += s.total || 0; collectedAll += paid;
                const status = rem <= 0 ? '<span class="text-emerald-600">مكتمل</span>' : '<span class="text-amber-600">جاري</span>';
                return `<tr class="hover:bg-indigo-50"><td class="p-2 font-bold">${s.customer}</td><td class="p-2 font-mono text-indigo-600">${s.invoiceNo || '-'}</td><td class="p-2 font-bold">${(s.total || 0).toFixed(2)}</td><td class="p-2">${(s.downPayment || 0).toFixed(2)}</td><td class="p-2">${(s.schedule || []).length}</td><td class="p-2 text-emerald-600">${paid.toFixed(2)}</td><td class="p-2 text-red-600">${rem.toFixed(2)}</td><td class="p-2">${status}</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-inst-count', inv.length); _el('rpt-inst-total', totalAll.toFixed(2)); _el('rpt-inst-collected', collectedAll.toFixed(2)); _el('rpt-inst-pending', (totalAll - collectedAll).toFixed(2));
        }

        // ===== RPT: Installment Customers =====
        function renderRptInstCustomers() {
            const tbody = document.getElementById('rpt-instcust-body'); if (!tbody) return;
            const custs = db.installmentCustomers || [];
            const inv = db.installmentInvoices || [];
            tbody.innerHTML = custs.length ? custs.map(c => {
                const custInv = inv.filter(s => s.customer === c.name);
                const totalAmt = custInv.reduce((a, s) => a + (s.total || 0), 0);
                const collected = custInv.reduce((a, s) => a + (s.schedule || []).filter(p => p.paid).reduce((x, y) => x + y.amount, 0), 0);
                return `<tr class="hover:bg-violet-50"><td class="p-2 font-bold">${c.name}</td><td class="p-2">${c.phone || '-'}</td><td class="p-2">${c.address || '-'}</td><td class="p-2">${custInv.length}</td><td class="p-2 font-bold">${totalAmt.toFixed(2)}</td><td class="p-2 text-emerald-600">${collected.toFixed(2)}</td><td class="p-2 text-red-600 font-bold">${(totalAmt - collected).toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
        }

        // ===== RPT: Expenses =====
        function renderRptExpenses() {
            const data = _dtFilter(db.expenses || [], 'rpt-exp-from', 'rpt-exp-to');
            let total = 0;
            const tbody = document.getElementById('rpt-exp-body'); if (!tbody) return;
            tbody.innerHTML = data.length ? data.map((e, i) => {
                total += e.amount || 0;
                return `<tr class="hover:bg-red-50"><td class="p-2">${i + 1}</td><td class="p-2">${e.date}</td><td class="p-2 font-bold">${e.desc || e.description || '-'}</td><td class="p-2">${e.category || '-'}</td><td class="p-2 font-bold text-red-600">${(e.amount || 0).toFixed(2)}</td><td class="p-2">${e.method === '1101' ? 'نقدي' : e.method === '1102' ? 'بنك' : (e.method || 'نقدي')}</td></tr>`;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-exp-total', total.toFixed(2)); _el('rpt-exp-count', data.length); _el('rpt-exp-avg', data.length ? (total / data.length).toFixed(2) : '0.00');
        }

        // ===== RPT: Revenue =====
        function renderRptRevenue() {
            const tbody = document.getElementById('rpt-rev-body'); if (!tbody) return;
            const from = document.getElementById('rpt-rev-from')?.value;
            const to = document.getElementById('rpt-rev-to')?.value;
            let rows = [];
            // Sales revenue
            (db.sales || []).forEach(s => { if ((!from || s.date >= from) && (!to || s.date <= to)) rows.push({ src: 'مبيعات', date: s.date, desc: s.customer + ' - ' + (s.invoiceNo || ''), amount: s.paid || s.total || 0 }); });
            // POS revenue
            (db.posInvoices || []).forEach(s => { if ((!from || s.date >= from) && (!to || s.date <= to)) rows.push({ src: 'POS', date: s.date, desc: s.invoiceNo || 'POS', amount: s.total || 0 }); });
            // Service revenue
            (db.serviceInvoices || []).forEach(s => { if ((!from || s.date >= from) && (!to || s.date <= to)) rows.push({ src: 'خدمات', date: s.date, desc: s.customer + ' - ' + (s.invoiceNo || ''), amount: s.paid || s.total || 0 }); });
            rows.sort((a, b) => b.date.localeCompare(a.date));
            const salesRev = rows.filter(r => r.src === 'مبيعات').reduce((a, r) => a + r.amount, 0);
            const posRev = rows.filter(r => r.src === 'POS').reduce((a, r) => a + r.amount, 0);
            const svcRev = rows.filter(r => r.src === 'خدمات').reduce((a, r) => a + r.amount, 0);
            const totalRev = salesRev + posRev + svcRev;
            tbody.innerHTML = rows.length ? rows.map(r => `<tr class="hover:bg-yellow-50"><td class="p-2">${r.src}</td><td class="p-2">${r.date}</td><td class="p-2">${r.desc}</td><td class="p-2 font-bold text-emerald-600">${r.amount.toFixed(2)}</td></tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            _el('rpt-rev-sales', salesRev.toFixed(2)); _el('rpt-rev-pos', posRev.toFixed(2)); _el('rpt-rev-svc', svcRev.toFixed(2)); _el('rpt-rev-total', totalRev.toFixed(2));
        }

        // ===== RPT: Treasury =====
        function renderRptTreasury() {
            const tbody = document.getElementById('rpt-treasury-body'); if (!tbody) return;
            const journal = db.journal || [];
            let totalIn = 0, totalOut = 0, balance = 0;
            const cashEntries = journal.filter(j => (j.lines || []).some(l => l.code === '1101' || l.code === '1102'));
            tbody.innerHTML = cashEntries.length ? cashEntries.map(j => {
                let dr = 0, cr = 0;
                (j.lines || []).forEach(l => { if (l.code === '1101' || l.code === '1102') { dr += l.dr || 0; cr += l.cr || 0; } });
                totalIn += dr; totalOut += cr; balance += dr - cr;
                return `<tr class="hover:bg-slate-50"><td class="p-2">${j.date}</td><td class="p-2">${j.desc || '-'}</td><td class="p-2 text-emerald-600 font-bold">${dr > 0 ? dr.toFixed(2) : '-'}</td><td class="p-2 text-red-600 font-bold">${cr > 0 ? cr.toFixed(2) : '-'}</td><td class="p-2 font-bold">${balance.toFixed(2)}</td></tr>`;
            }).join('') : '<tr><td colspan="5" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';
            // Calc cash vs bank
            let cash = 0, bank = 0;
            journal.forEach(j => (j.lines || []).forEach(l => { if (l.code === '1101') { cash += (l.dr || 0) - (l.cr || 0); } if (l.code === '1102') { bank += (l.dr || 0) - (l.cr || 0); } }));
            _el('rpt-trs-in', totalIn.toFixed(2)); _el('rpt-trs-out', totalOut.toFixed(2)); _el('rpt-trs-cash', cash.toFixed(2)); _el('rpt-trs-bank', bank.toFixed(2));
        }

        // ===== RPT: Profits =====
        function renderRptProfits() {
            const from = document.getElementById('rpt-profit-from')?.value;
            const to = document.getElementById('rpt-profit-to')?.value;
            const df = (arr) => { let r = arr; if (from) r = r.filter(x => x.date >= from); if (to) r = r.filter(x => x.date <= to); return r; };
            // Revenue
            const salesRev = df(db.sales || []).reduce((a, s) => a + (s.paid || s.total || 0), 0);
            const posRev = df(db.posInvoices || []).reduce((a, s) => a + (s.total || 0), 0);
            const svcRev = df(db.serviceInvoices || []).reduce((a, s) => a + (s.paid || s.total || 0), 0);
            const totalRevenue = salesRev + posRev + svcRev;
            // COGS
            let cogs = 0;
            df(db.sales || []).forEach(s => (s.items || []).forEach(it => { const p = (db.products || []).find(x => x.name === it.name); cogs += (p?.cost || 0) * (it.qty || 1); }));
            df(db.posInvoices || []).forEach(s => (s.items || []).forEach(it => { const p = (db.products || []).find(x => x.name === it.name); cogs += (p?.cost || 0) * (it.qty || 1); }));
            // Expenses
            const expTotal = df(db.expenses || []).reduce((a, e) => a + (e.amount || 0), 0);
            const salaryTotal = df(db.salaryHistory || []).reduce((a, h) => a + (h.net || 0), 0);
            const totalExpenses = expTotal + salaryTotal;
            // Net
            const netProfit = totalRevenue - cogs - totalExpenses;
            _el('rpt-pft-revenue', totalRevenue.toFixed(2));
            _el('rpt-pft-cost', cogs.toFixed(2));
            _el('rpt-pft-expenses', totalExpenses.toFixed(2));
            const netEl = document.getElementById('rpt-pft-net');
            const labelEl = document.getElementById('rpt-pft-label');
            if (netEl) { netEl.textContent = Math.abs(netProfit).toFixed(2); netEl.style.color = netProfit >= 0 ? '#15803d' : '#dc2626'; }
            if (labelEl) { labelEl.textContent = netProfit >= 0 ? 'صافي الربح ✅' : 'صافي الخسارة ❌'; labelEl.style.color = netProfit >= 0 ? '#15803d' : '#dc2626'; }
            // Details
            const revDet = document.getElementById('rpt-pft-rev-details');
            if (revDet) revDet.innerHTML = `<div class="flex justify-between"><span>مبيعات:</span><span class="font-bold">${salesRev.toFixed(2)}</span></div><div class="flex justify-between"><span>POS:</span><span class="font-bold">${posRev.toFixed(2)}</span></div><div class="flex justify-between"><span>خدمات:</span><span class="font-bold">${svcRev.toFixed(2)}</span></div>`;
            const costDet = document.getElementById('rpt-pft-cost-details');
            if (costDet) costDet.innerHTML = `<div class="flex justify-between"><span>تكلفة البضاعة:</span><span class="font-bold text-red-600">${cogs.toFixed(2)}</span></div>`;
            const expDet = document.getElementById('rpt-pft-exp-details');
            if (expDet) expDet.innerHTML = `<div class="flex justify-between"><span>المصروفات:</span><span class="font-bold">${expTotal.toFixed(2)}</span></div><div class="flex justify-between"><span>الرواتب:</span><span class="font-bold">${salaryTotal.toFixed(2)}</span></div>`;
        }

        // ==========================================
        // Quotations & Purchase Orders JS Logic
        // ==========================================
        let currentQuoteCart = [];
        let currentPOCart = [];

        // Quote Logic
        function toggleQuoteMode() {
            const isReturn = document.getElementById('is-return-quote').checked;
            document.getElementById('quote-title').innerText = isReturn ? 'مرتجع عرض سعر' : 'عرض سعر';
            document.getElementById('quote-mode-badge').classList.toggle('hidden', !isReturn);
        }

        function renderQuoteCart() {
            const tbody = document.getElementById('quote-cart-body');
            const empty = document.getElementById('quote-cart-empty');
            if (!tbody) return;
            if (currentQuoteCart.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                document.getElementById('quote-subtotal').innerText = '0.00';
                document.getElementById('quote-vat').innerText = '0.00';
                document.getElementById('quote-total').innerText = '0.00';
                calcQuoteRemaining();
                return;
            }
            empty.style.display = 'none';
            let subtotal = 0;
            tbody.innerHTML = currentQuoteCart.map((item, index) => {
                const total = item.qty * item.price;
                subtotal += total;
                return `<tr class="hover:bg-slate-50 transition"><td class="p-2 font-bold text-slate-700">` + item.name + `</td><td class="p-2"><input type="number" value="` + item.qty + `" class="w-16 p-1 border rounded text-center text-xs" onchange="updateQuoteQty(` + index + `, this.value)" min="1"></td><td class="p-2">` + item.price.toFixed(2) + `</td><td class="p-2 font-bold text-blue-600">` + total.toFixed(2) + `</td><td class="p-2 text-left"><button onclick="removeQuoteItem(` + index + `)" class="text-red-500 hover:bg-red-50 p-1.5 rounded transition"><i class="fas fa-trash"></i></button></td></tr>`;
            }).join('');

            document.getElementById('quote-subtotal').innerText = subtotal.toFixed(2);
            const vatRate = parseFloat(document.getElementById('quote-vat-rate').innerText) || 15;

            let discVal = parseFloat(document.getElementById('quote-discount').value) || 0;
            const discType = document.getElementById('quote-disc-type').value;
            let discountAmount = 0;
            if (discType === 'percent') { discountAmount = subtotal * (discVal / 100); } else { discountAmount = discVal; }

            const netBeforeVat = subtotal - discountAmount;
            const vat = netBeforeVat * (vatRate / 100);
            document.getElementById('quote-vat').innerText = vat.toFixed(2);
            document.getElementById('quote-total').innerText = (netBeforeVat + vat).toFixed(2);
            calcQuoteRemaining();
        }

        function addToQuoteCart() {
            const prodIdVal = document.getElementById('quote-product-id').value;
            const prodName = document.getElementById('quote-product').value.trim();
            const qty = parseFloat(document.getElementById('quote-qty').value) || 1;

            if (!prodName) return showToast('يرجى اختيار صنف', 'error');

            let product;
            if (prodIdVal) {
                // Check in both products and services
                product = db.products.find(p => p.id == prodIdVal) || db.services.find(s => s.id == prodIdVal);
            }

            if (!product) {
                // If not found, it's a one-time product for the quote (don't save to DB yet, or handle as guest product)
                // For simplicity, if not in DB, we just take the name
                currentQuoteCart.push({ id: Date.now(), name: prodName, price: 0, cost: 0, qty: qty });
            } else {
                const existing = currentQuoteCart.find(i => i.id == product.id);
                if (existing) { existing.qty += qty; } else {
                    currentQuoteCart.push({ id: product.id, name: product.name, price: product.price || 0, cost: product.cost || 0, qty: qty });
                }
            }

            document.getElementById('quote-qty').value = 1;
            document.getElementById('quote-product').value = '';
            document.getElementById('quote-product-id').value = '';
            renderQuoteCart();
            showToast('تمت الإضافة لعرض السعر', 'success');
        }

        function updateQuoteQty(index, val) {
            const qty = parseFloat(val);
            if (qty > 0) { currentQuoteCart[index].qty = qty; renderQuoteCart(); }
        }

        function removeQuoteItem(index) {
            currentQuoteCart.splice(index, 1);
            renderQuoteCart();
        }

        function setQuotePayType(type) {
            document.getElementById('quote-pay-cash-btn').className = type === 'cash' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white shadow-lg' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('quote-pay-credit-btn').className = type === 'credit' ? 'flex-1 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white shadow-lg' : 'flex-1 py-1.5 rounded text-xs font-bold bg-slate-700 text-slate-300';
            document.getElementById('quote-credit-area').style.display = type === 'credit' ? 'block' : 'none';
            document.getElementById('quote-remaining-row').style.display = type === 'credit' ? 'flex' : 'none';
            if (type === 'cash') {
                const total = parseFloat(document.getElementById('quote-total').innerText) || 0;
                document.getElementById('quote-paid').value = total > 0 ? total.toFixed(2) : '';
            }
            calcQuoteRemaining();
        }

        function calcQuoteRemaining() {
            const total = parseFloat(document.getElementById('quote-total').innerText) || 0;
            const isCredit = document.getElementById('quote-credit-area').style.display !== 'none';
            let paid = isCredit ? (parseFloat(document.getElementById('quote-paid').value) || 0) : total;
            let rem = total - paid;
            document.getElementById('quote-remaining').innerText = rem > 0 ? rem.toFixed(2) : '0.00';
        }

        function postQuotation() {
            if (currentQuoteCart.length === 0) return showToast('عرض السعر فارغ', 'error');
            const editId = document.getElementById('quote-edit-id').value;
            const custId = document.getElementById('quote-customer-id')?.value;
            let custName = document.getElementById('quote-customer')?.value || 'عميل نقدي';
            const total = parseFloat(document.getElementById('quote-total').innerText) || 0;
            const isCredit = document.getElementById('quote-pay-credit-btn').classList.contains('bg-emerald-600');
            const paid = isCredit ? (parseFloat(document.getElementById('quote-paid').value) || 0) : total;
            const remaining = total - paid;
            const method = document.getElementById('quote-method').value;

            // Handle new customer creation
            if (custId === '__new__') {
                const newId = Date.now();
                db.customers.push({ id: newId, name: custName, phone: '', balance: 0 });
                // We'll update the variable for saving below
            }

            if (editId) {
                const q = db.quotations.find(x => x.id == editId);
                if (q) {
                    q.customer = custName;
                    q.customerId = (custId === '__new__' ? db.customers[db.customers.length - 1].id : custId);
                    q.total = total;
                    q.paid = paid;
                    q.remaining = remaining;
                    q.items = [...currentQuoteCart];
                    q.method = method;
                }
                document.getElementById('quote-edit-id').value = '';
                showToast('تم تحديث عرض السعر');
            } else {
                db.quotations = db.quotations || [];
                db.quotations.push({
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    customer: custName,
                    customerId: (custId === '__new__' ? db.customers[db.customers.length - 1].id : custId),
                    total: total,
                    paid: paid,
                    remaining: remaining,
                    method: method,
                    items: [...currentQuoteCart]
                });
                showToast('تم حفظ عرض السعر');
            }
            currentQuoteCart = [];
            renderQuoteCart();
            save();
        }

        function renderRecentQuotations() {
            const tbody = document.getElementById('recent-QT-body');
            if (!tbody) return;
            const list = (db.quotations || []).slice(-10).reverse();
            tbody.innerHTML = list.map(q => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-2 text-xs font-mono">QT-${String(q.id).slice(-4)}</td>
                    <td class="p-2 text-xs">${q.date}</td>
                    <td class="p-2 text-xs font-bold">${q.customer}</td>
                    <td class="p-2 text-xs font-bold text-blue-600">${q.total.toFixed(2)}</td>
                    <td class="p-2 text-[10px] text-slate-500">${q.status === 'draft' ? 'مسودة' : 'مفعّل'}</td>
                    <td class="p-2 flex gap-1 justify-center">
                        ${q.status === 'draft' ? `
                            <button onclick="activateQuotation(${q.id})" title="تفعيل (تحويل لبيع)" class="text-emerald-500 hover:bg-emerald-50 p-1 rounded"><i class="fas fa-check-circle"></i></button>
                            <button onclick="editQuotation(${q.id})" title="تعديل" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteQuotation(${q.id})" title="حذف" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button>
                        ` : `
                            <button disabled class="text-slate-300 p-1"><i class="fas fa-check-double"></i></button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        function editQuotation(id) {
            const q = db.quotations.find(x => x.id == id);
            if (!q) return;
            document.getElementById('quote-edit-id').value = q.id;
            document.getElementById('quote-customer').value = q.customer || '';
            document.getElementById('quote-customer-id').value = q.customerId || '';
            currentQuoteCart = [...q.items];
            if (q.remaining > 0) setQuotePayType('credit'); else setQuotePayType('cash');
            document.getElementById('quote-paid').value = q.paid;
            document.getElementById('quote-method').value = q.method || '1101';
            renderQuoteCart();
            showToast('تم تحميل بيانات عرض السعر للتعديل', 'info');
        }

        function deleteQuotation(id) {
            if (!confirm('هل أنت متأكد من حذف عرض السعر؟')) return;
            db.quotations = db.quotations.filter(x => x.id !== id);
            renderRecentQuotations();
            save();
            showToast('تم الحذف بنجاح');
        }

        function activateQuotation(id) {
            const q = db.quotations.find(x => x.id == id);
            if (!q || q.status === 'active') return;

            if (!confirm('سيتم تحويل عرض السعر إلى فاتورة مبيعات حقيقية وتسجيلها في الحسابات والمخازن. هل أنت متأكد؟')) return;

            const date = new Date().toISOString().split('T')[0];
            const subtotal = q.items.reduce((s, i) => s + (i.price * i.qty), 0);
            const discount = q.discount || 0;
            const netBeforeVat = subtotal - discount;
            const vatRate = db.settings.vatRate || 15;
            const vatAmount = netBeforeVat * (vatRate / 100);
            const grandTotal = netBeforeVat + vatAmount;
            const paid = q.paid || 0;
            const remaining = grandTotal - paid;
            const method = q.method || '1101';
            const totalCost = q.items.reduce((s, i) => s + (i.cost * i.qty), 0);

            const lines = [
                { code: getMethodAccount(method), dr: paid, cr: 0 },
                { code: '5101', dr: totalCost, cr: 0 },
                { code: '4101', dr: 0, cr: subtotal },
                { code: '2102', dr: 0, cr: vatAmount },
                { code: '1104', dr: 0, cr: totalCost }
            ];
            if (discount > 0) lines.push({ code: '5208', dr: discount, cr: 0 }); // Discount Allowed
            if (remaining > 0.01) lines.push({ code: '1103', dr: remaining, cr: 0 });

            if (addJournalEntry(date, `تفعيل عرض سعر QT-${String(q.id).slice(-4)} - العميل: ${q.customer}`, lines)) {
                q.status = 'active';
                q.items.forEach(i => {
                    const p = db.products.find(x => x.id == i.id);
                    if (p) p.stock -= i.qty;
                });
                const saleId = 'INV-' + String(db.sales.length + 1).padStart(4, '0');
                db.sales.push({
                    id: Date.now(),
                    invoiceNo: saleId,
                    date,
                    customer: q.customer,
                    total: grandTotal,
                    paid,
                    discount,
                    remaining,
                    method,
                    by: db.currentUser,
                    items: [...q.items]
                });

                showToast('تم تفعيل عرض السعر وتحويله بنجاح ✅');
                renderRecentQuotations();
                renderSalesInvoices();
                save();
                renderAll();
            }
        }

        function filterQuotationList(val) {
            const rows = document.querySelectorAll('#recent-QT-body tr');
            rows.forEach(r => r.style.display = r.innerText.includes(val) ? '' : 'none');
        }

        // Purchase Order Logic
        function togglePOMode() {
            const isReturn = document.getElementById('is-return-po').checked;
            document.getElementById('po-title').innerText = isReturn ? 'مرتجع أمر شراء' : 'أمر شراء';
            document.getElementById('po-mode-badge').classList.toggle('hidden', !isReturn);
        }

        function renderPOCart() {
            const tbody = document.getElementById('po-cart-body');
            const empty = document.getElementById('po-cart-empty');
            if (!tbody) return;
            if (currentPOCart.length === 0) {
                tbody.innerHTML = '';
                if (empty) empty.style.display = 'block';
                document.getElementById('po-subtotal').innerText = '0.00';
                document.getElementById('po-vat').innerText = '0.00';
                document.getElementById('po-total').innerText = '0.00';
                calcPORemaining();
                return;
            }
            if (empty) empty.style.display = 'none';
            let subtotal = 0;
            tbody.innerHTML = currentPOCart.map((item, index) => {
                const total = item.qty * item.cost;
                subtotal += total;
                return `<tr class="hover:bg-slate-50 border-b group transition">
                    <td class="p-3 text-right">
                        <div class="font-bold text-slate-700">${item.name}</div>
                        <div class="text-[10px] text-slate-400">سعر الوحدة: ${item.cost.toFixed(2)}</div>
                    </td>
                    <td class="p-3">
                        <input type="number" value="${item.qty}" class="w-16 p-1.5 border border-slate-200 rounded-lg text-center text-xs font-black focus:border-orange-500 outline-none" onchange="updatePOQty(${index}, this.value)" min="1">
                    </td>
                    <td class="p-3 text-xs font-mono">${item.cost.toFixed(2)}</td>
                    <td class="p-3 font-bold text-orange-600">${total.toFixed(2)}</td>
                    <td class="p-3 text-left">
                        <button onclick="removePOItem(${index})" class="text-slate-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('po-subtotal').innerText = subtotal.toFixed(2);
            const vatRate = db.settings.vatRate || 15;

            let discVal = parseFloat(document.getElementById('po-discount').value) || 0;
            const discType = document.getElementById('po-disc-type').value;
            let discountAmount = 0;
            if (discType === 'percent') {
                discountAmount = subtotal * (discVal / 100);
            } else {
                discountAmount = discVal;
            }

            const netBeforeVat = subtotal - discountAmount;
            const vat = netBeforeVat * (vatRate / 100);
            document.getElementById('po-vat').innerText = vat.toFixed(2);
            document.getElementById('po-total').innerText = (netBeforeVat + vat).toFixed(2);
            calcPORemaining();
        }

        function addToPOCart() {
            const prodIdVal = document.getElementById('po-product-id').value;
            const prodName = document.getElementById('po-product-input').value.trim();
            const qty = parseFloat(document.getElementById('po-qty').value);
            const cost = parseFloat(document.getElementById('pur-cost').value);
            const type = document.getElementById('po-product-type').value;

            if (!prodName || !qty || !cost) return showToast('بيانات ناقصة', 'error');

            const item = {
                id: (prodIdVal && !prodIdVal.startsWith('__new')) ? prodIdVal : Date.now() + Math.floor(Math.random() * 1000),
                name: prodName,
                qty: qty,
                cost: cost,
                total: cost * qty,
                type: type,
                isNew: (!prodIdVal || prodIdVal.startsWith('__new'))
            };

            currentPOCart.push(item);

            document.getElementById('po-qty').value = 1;
            document.getElementById('po-product-input').value = '';
            document.getElementById('po-product-id').value = '';
            document.getElementById('pur-cost').value = '';
            renderPOCart();
            showToast('تمت الإضافة لطلب الشراء ✅');
        }

        function updatePOQty(index, val) {
            const qty = parseFloat(val);
            if (qty > 0) { currentPOCart[index].qty = qty; renderPOCart(); }
        }

        function removePOItem(index) {
            currentPOCart.splice(index, 1);
            renderPOCart();
        }

        function setPOPayType(type) {
            const cashBtn = document.getElementById('po-pay-cash-btn');
            const creditBtn = document.getElementById('po-pay-credit-btn');

            if (type === 'cash') {
                cashBtn.className = 'flex-1 py-2 rounded-lg text-[10px] font-black bg-orange-600 text-white shadow-lg transition';
                creditBtn.className = 'flex-1 py-2 rounded-lg text-[10px] font-black text-slate-500 hover:text-slate-300 transition';
                const total = parseFloat(document.getElementById('po-total').innerText) || 0;
                document.getElementById('po-paid').value = total > 0 ? total.toFixed(2) : '';
            } else {
                creditBtn.className = 'flex-1 py-2 rounded-lg text-[10px] font-black bg-orange-600 text-white shadow-lg transition';
                cashBtn.className = 'flex-1 py-2 rounded-lg text-[10px] font-black text-slate-500 hover:text-slate-300 transition';
            }

            document.getElementById('po-credit-area').style.display = type === 'credit' ? 'block' : 'none';
            document.getElementById('po-remaining-row').style.display = type === 'credit' ? 'flex' : 'none';
            calcPORemaining();
        }

        // PO Combobox Logic
        let poComboActive = -1;

        function onPOProductFocus() {
            onPOProductInput(document.getElementById('po-product-input').value);
        }

        function onPOProductInput(query) {
            const container = document.getElementById('po-suggestions');
            const q = query.trim().toLowerCase();
            let html = '';
            poComboActive = -1;

            if (!db.products) db.products = [];
            if (!db.services) db.services = [];

            const filteredProducts = db.products.filter(p => p.name.toLowerCase().includes(q));
            const filteredServices = db.services.filter(s => s.name.toLowerCase().includes(q));

            if (q === '') {
                html = db.products.map((p, i) => `
                    <div class="pur-suggestion-item" data-index="${i}" onclick="selectPOProduct(${p.id}, 'product')">
                        <span class="item-name"><i class="fas fa-box text-blue-500 me-1"></i> ${p.name}</span>
                        <span class="item-meta">تكلفة: ${p.cost || 0}</span>
                    </div>`).join('');
                html += db.services.map((s, i) => `
                    <div class="pur-suggestion-item" data-index="${db.products.length + i}" onclick="selectPOProduct(${s.id}, 'service')">
                        <span class="item-name"><i class="fas fa-concierge-bell text-emerald-500 me-1"></i> ${s.name}</span>
                        <span class="item-meta">سعر: ${s.price || 0}</span>
                    </div>`).join('');
            } else {
                html = filteredProducts.map((p, i) => `
                    <div class="pur-suggestion-item" data-index="${i}" onclick="selectPOProduct(${p.id}, 'product')">
                        <span class="item-name"><i class="fas fa-box text-blue-500 me-1"></i> ${p.name}</span>
                        <span class="item-meta">تكلفة: ${p.cost || 0}</span>
                    </div>`).join('');
                html += filteredServices.map((s, i) => `
                    <div class="pur-suggestion-item" data-index="${filteredProducts.length + i}" onclick="selectPOProduct(${s.id}, 'service')">
                        <span class="item-name"><i class="fas fa-concierge-bell text-emerald-500 me-1"></i> ${s.name}</span>
                        <span class="item-meta">سعر: ${s.price || 0}</span>
                    </div>`).join('');

                const exactMatchProd = db.products.some(p => p.name.toLowerCase() === q);
                const exactMatchServ = db.services.some(s => s.name.toLowerCase() === q);
                if (!exactMatchProd && !exactMatchServ && q.length > 0) {
                    const newIdx = filteredProducts.length + filteredServices.length;
                    html += `
                    <div class="pur-suggestion-item pur-suggestion-new" data-index="${newIdx}" onclick="selectNewPOProduct('${query.replace(/'/g, "\\'")}')"> 
                        <span class="font-bold"><i class="fas fa-plus-circle text-orange-500 me-1"></i> إضافة كمنتج جديد: "${query}"</span>
                    </div>
                    <div class="pur-suggestion-item pur-suggestion-new" data-index="${newIdx + 1}" onclick="selectNewPOService('${query.replace(/'/g, "\\'")}')"> 
                        <span class="font-bold"><i class="fas fa-plus-circle text-emerald-500 me-1"></i> إضافة كخدمة جديدة: "${query}"</span>
                    </div>`;
                }
            }
            container.innerHTML = html;
            container.classList.toggle('open', html.length > 0);
        }

        function selectPOProduct(id, type = 'product') {
            if (type === 'product') {
                const prod = db.products.find(p => p.id == id);
                if (!prod) return;
                document.getElementById('po-product-input').value = prod.name;
                document.getElementById('po-product-id').value = prod.id;
                document.getElementById('po-product-type').value = 'product';
                document.getElementById('pur-cost').value = prod.cost || '';
            } else {
                const serv = db.services.find(s => s.id == id);
                if (!serv) return;
                document.getElementById('po-product-input').value = serv.name;
                document.getElementById('po-product-id').value = serv.id;
                document.getElementById('po-product-type').value = 'service';
                document.getElementById('pur-cost').value = serv.cost || serv.price || '';
            }
            document.getElementById('po-suggestions').classList.remove('open');
        }

        function selectNewPOProduct(name) {
            document.getElementById('po-product-input').value = name;
            document.getElementById('po-product-id').value = '__new__';
            document.getElementById('po-product-type').value = 'product';
            document.getElementById('pur-cost').value = '';
            document.getElementById('pur-cost').focus();
            document.getElementById('po-suggestions').classList.remove('open');
        }

        function selectNewPOService(name) {
            document.getElementById('po-product-input').value = name;
            document.getElementById('po-product-id').value = '__new_service__';
            document.getElementById('po-product-type').value = 'service';
            document.getElementById('pur-cost').value = '';
            document.getElementById('pur-cost').focus();
            document.getElementById('po-suggestions').classList.remove('open');
        }

        function onPOProductKeydown(e) {
            const container = document.getElementById('po-suggestions');
            const items = container.querySelectorAll('.pur-suggestion-item');
            if (!items.length) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                poComboActive = Math.min(poComboActive + 1, items.length - 1);
                updatePOComboHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                poComboActive = Math.max(poComboActive - 1, 0);
                updatePOComboHighlight(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (poComboActive >= 0 && items[poComboActive]) items[poComboActive].click();
            } else if (e.key === 'Escape') {
                container.classList.remove('open');
            }
        }

        function updatePOComboHighlight(items) {
            items.forEach((el, i) => el.classList.toggle('active', i === poComboActive));
            if (items[poComboActive]) items[poComboActive].scrollIntoView({ block: 'nearest' });
        }

        // --- PO Supplier Combobox ---
        let poSuppComboActive = -1;
        function onPOSupplierFocus() { onPOSupplierInput(document.getElementById('po-supplier').value); }
        function onPOSupplierInput(query) {
            const container = document.getElementById('po-supplier-suggestions');
            if (!db.suppliers) db.suppliers = [];
            const q = query.trim().toLowerCase();
            let html = '';
            poSuppComboActive = -1;
            const filtered = db.suppliers.filter(s => (s.name || '').toLowerCase().includes(q));
            if (q === '') {
                html = db.suppliers.map((s, i) => `<div class="pur-suggestion-item" data-index="${i}" onclick="selectPOSupplier(${s.id})"><span class="item-name">${s.name}</span></div>`).join('');
            } else {
                html = filtered.map((s, i) => `<div class="pur-suggestion-item" data-index="${i}" onclick="selectPOSupplier(${s.id})"><span class="item-name">${s.name}</span></div>`).join('');
                if (!db.suppliers.some(s => s.name.toLowerCase() === q) && q.length > 0) {
                    html += `<div class="pur-suggestion-item pur-suggestion-new" data-index="${filtered.length}" onclick="selectNewPOSupplier('${query.replace(/'/g, "\\'")}')"><span><i class="fas fa-plus-circle text-orange-500"></i> إضافة مورد جديد: "${query}"</span></div>`;
                }
            }
            container.innerHTML = html; container.classList.toggle('open', html.length > 0);
        }
        function selectPOSupplier(id) {
            const s = db.suppliers.find(x => x.id == id);
            if (s) { document.getElementById('po-supplier').value = s.name; document.getElementById('po-supplier-id').value = s.id; }
            document.getElementById('po-supplier-suggestions').classList.remove('open');
        }
        function selectNewPOSupplier(name) {
            document.getElementById('po-supplier').value = name;
            document.getElementById('po-supplier-id').value = '__new__';
            document.getElementById('po-supplier-suggestions').classList.remove('open');
        }
        function onPOSupplierKeydown(e) {
            const container = document.getElementById('po-supplier-suggestions'); const items = container.querySelectorAll('.pur-suggestion-item');
            if (!items.length) return;
            if (e.key === 'ArrowDown') { e.preventDefault(); poSuppComboActive = Math.min(poSuppComboActive + 1, items.length - 1); items.forEach((it, i) => it.classList.toggle('active', i === poSuppComboActive)); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); poSuppComboActive = Math.max(poSuppComboActive - 1, 0); items.forEach((it, i) => it.classList.toggle('active', i === poSuppComboActive)); }
            else if (e.key === 'Enter') { e.preventDefault(); if (poSuppComboActive >= 0) items[poSuppComboActive].click(); }
            else if (e.key === 'Escape') { container.classList.remove('open'); }
        }

        // --- Quote Customer Combobox ---
        let quoteCustComboActive = -1;
        function onQuoteCustomerFocus() { onQuoteCustomerInput(document.getElementById('quote-customer').value); }
        function onQuoteCustomerInput(query) {
            const container = document.getElementById('quote-customer-suggestions');
            if (!db.customers) db.customers = [];
            const q = query.trim().toLowerCase();
            let html = '';
            quoteCustComboActive = -1;
            const filtered = db.customers.filter(c => (c.name || '').toLowerCase().includes(q));
            if (q === '') {
                html = db.customers.map((c, i) => `<div class="pur-suggestion-item" data-index="${i}" onclick="selectQuoteCustomer(${c.id})"><span class="item-name">${c.name}</span></div>`).join('');
            } else {
                html = filtered.map((c, i) => `<div class="pur-suggestion-item" data-index="${i}" onclick="selectQuoteCustomer(${c.id})"><span class="item-name">${c.name}</span></div>`).join('');
                if (!db.customers.some(c => c.name.toLowerCase() === q) && q.length > 0) {
                    html += `<div class="pur-suggestion-item pur-suggestion-new" data-index="${filtered.length}" onclick="selectNewQuoteCustomer('${query.replace(/'/g, "\\'")}')"><span><i class="fas fa-plus-circle text-blue-500"></i> إضافة عميل جديد: "${query}"</span></div>`;
                }
            }
            container.innerHTML = html; container.classList.toggle('open', html.length > 0);
        }
        function selectQuoteCustomer(id) {
            const c = db.customers.find(x => x.id == id);
            if (c) { document.getElementById('quote-customer').value = c.name; document.getElementById('quote-customer-id').value = c.id; }
            document.getElementById('quote-customer-suggestions').classList.remove('open');
        }
        function selectNewQuoteCustomer(name) {
            document.getElementById('quote-customer').value = name;
            document.getElementById('quote-customer-id').value = '__new__';
            document.getElementById('quote-customer-suggestions').classList.remove('open');
        }
        function onQuoteCustomerKeydown(e) {
            const container = document.getElementById('quote-customer-suggestions'); const items = container.querySelectorAll('.pur-suggestion-item');
            if (!items.length) return;
            if (e.key === 'ArrowDown') { e.preventDefault(); quoteCustComboActive = Math.min(quoteCustComboActive + 1, items.length - 1); items.forEach((it, i) => it.classList.toggle('active', i === quoteCustComboActive)); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); quoteCustComboActive = Math.max(quoteCustComboActive - 1, 0); items.forEach((it, i) => it.classList.toggle('active', i === quoteCustComboActive)); }
            else if (e.key === 'Enter') { e.preventDefault(); if (quoteCustComboActive >= 0) items[quoteCustComboActive].click(); }
            else if (e.key === 'Escape') { container.classList.remove('open'); }
        }

        // --- Quote Product Combobox ---
        let quoteProdComboActive = -1;
        function onQuoteProductFocus() { onQuoteProductInput(document.getElementById('quote-product').value); }
        function onQuoteProductInput(query) {
            const container = document.getElementById('quote-product-suggestions');
            const q = query.trim().toLowerCase();
            let html = '';
            quoteProdComboActive = -1;
            const filteredProducts = db.products.filter(p => p.name.toLowerCase().includes(q));
            const filteredServices = db.services.filter(s => s.name.toLowerCase().includes(q));
            if (q === '') {
                html = db.products.map((p, i) => `<div class="pur-suggestion-item" data-index="${i}" onclick="selectQuoteProductSearch(${p.id})"><span class="item-name"><i class="fas fa-box text-blue-500"></i> ${p.name}</span><span class="item-meta">سعر: ${p.price || 0}</span></div>`).join('');
                html += db.services.map((s, i) => `<div class="pur-suggestion-item" data-index="${db.products.length + i}" onclick="selectQuoteProductSearch(${s.id}, 'service')"><span class="item-name"><i class="fas fa-concierge-bell text-emerald-500"></i> ${s.name}</span><span class="item-meta">سعر: ${s.price || 0}</span></div>`).join('');
            } else {
                html = filteredProducts.map((p, i) => `<div class="pur-suggestion-item" data-index="${i}" onclick="selectQuoteProductSearch(${p.id})"><span class="item-name"><i class="fas fa-box text-blue-500"></i> ${p.name}</span><span class="item-meta">سعر: ${p.price || 0}</span></div>`).join('');
                html += filteredServices.map((s, i) => `<div class="pur-suggestion-item" data-index="${filteredProducts.length + i}" onclick="selectQuoteProductSearch(${s.id}, 'service')"><span class="item-name"><i class="fas fa-concierge-bell text-emerald-500"></i> ${s.name}</span><span class="item-meta">سعر: ${s.price || 0}</span></div>`).join('');
            }
            container.innerHTML = html; container.classList.toggle('open', html.length > 0);
        }
        function selectQuoteProductSearch(id, type = 'product') {
            const p = (type === 'product' ? db.products.find(x => x.id == id) : db.services.find(x => x.id == id));
            if (p) { document.getElementById('quote-product').value = p.name; document.getElementById('quote-product-id').value = p.id; }
            document.getElementById('quote-product-suggestions').classList.remove('open');
        }
        function onQuoteProductKeydown(e) {
            const container = document.getElementById('quote-product-suggestions'); const items = container.querySelectorAll('.pur-suggestion-item');
            if (!items.length) return;
            if (e.key === 'ArrowDown') { e.preventDefault(); quoteProdComboActive = Math.min(quoteProdComboActive + 1, items.length - 1); items.forEach((it, i) => it.classList.toggle('active', i === quoteProdComboActive)); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); quoteProdComboActive = Math.max(quoteProdComboActive - 1, 0); items.forEach((it, i) => it.classList.toggle('active', i === quoteProdComboActive)); }
            else if (e.key === 'Enter') { e.preventDefault(); if (quoteProdComboActive >= 0) items[quoteProdComboActive].click(); }
            else if (e.key === 'Escape') { container.classList.remove('open'); }
        }

        function postPurchaseOrder() {
            if (currentPOCart.length === 0) return showToast('أمر الشراء فارغ', 'error');
            const editId = document.getElementById('po-edit-id').value;
            const suppId = document.getElementById('po-supplier-id')?.value;
            let suppName = document.getElementById('po-supplier')?.value || 'مورد نقدي';
            const total = parseFloat(document.getElementById('po-total').innerText) || 0;
            const isCredit = document.getElementById('po-pay-credit-btn').classList.contains('bg-orange-600');
            const paid = isCredit ? (parseFloat(document.getElementById('po-paid').value) || 0) : total;
            const remaining = total - paid;
            const date = document.getElementById('po-date').value || new Date().toISOString().split('T')[0];
            const method = document.getElementById('po-method').value || '1101';

            // Handle new supplier creation
            if (suppId === '__new__') {
                const newId = Date.now();
                db.suppliers.push({ id: newId, name: suppName, company: '', phone: '' });
                // Note: we'll use the push to get the id if needed, but the name is used in PO object
            }

            if (editId) {
                const po = db.purchaseOrders.find(x => x.id == editId);
                if (po) {
                    po.supplier = suppName;
                    po.supplierId = (suppId === '__new__' ? db.suppliers[db.suppliers.length - 1].id : suppId);
                    po.total = total;
                    po.paid = paid;
                    po.remaining = remaining;
                    po.items = [...currentPOCart];
                    po.date = date;
                    po.method = method;
                }
                document.getElementById('po-edit-id').value = '';
                showToast('تم تحديث أمر الشراء');
            } else {
                db.purchaseOrders = db.purchaseOrders || [];
                db.purchaseOrders.push({
                    id: Date.now(),
                    date: date,
                    supplier: suppName,
                    supplierId: (suppId === '__new__' ? db.suppliers[db.suppliers.length - 1].id : suppId),
                    total: total,
                    paid: paid,
                    remaining: remaining,
                    items: [...currentPOCart],
                    status: 'draft',
                    method: method
                });
                showToast('تم حفظ أمر الشراء');
            }

            currentPOCart = [];
            renderPOCart();
            renderRecentPurchaseOrders();
            save();
        }

        function renderRecentPurchaseOrders() {
            const tbody = document.getElementById('recent-po-body');
            if (!tbody) return;
            const list = (db.purchaseOrders || []).slice(-20).reverse();
            tbody.innerHTML = list.map(po => `
                <tr class="hover:bg-slate-50 border-b group">
                    <td class="p-2 text-[10px] font-mono whitespace-nowrap">PO-${String(po.id).slice(-4)}</td>
                    <td class="p-2 text-xs font-bold whitespace-nowrap truncate max-w-[100px]" title="${po.supplier}">${po.supplier}</td>
                    <td class="p-2 text-xs font-bold text-orange-600">${po.total.toFixed(2)}</td>
                    <td class="p-2 flex gap-1 justify-center opacity-70 group-hover:opacity-100 transition">
                        ${po.status === 'draft' ? `
                            <button onclick="activatePO(${po.id})" title="تفعيل" class="text-emerald-500 hover:bg-emerald-50 p-1 rounded transition"><i class="fas fa-check-circle"></i></button>
                            <button onclick="editPO(${po.id})" title="تعديل" class="text-blue-500 hover:bg-blue-50 p-1 rounded transition"><i class="fas fa-edit"></i></button>
                            <button onclick="deletePO(${po.id})" title="حذف" class="text-red-500 hover:bg-red-50 p-1 rounded transition"><i class="fas fa-trash"></i></button>
                        ` : `
                            <button class="text-slate-300 p-1 cursor-not-allowed"><i class="fas fa-check-double"></i></button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        function editPO(id) {
            const po = db.purchaseOrders.find(x => x.id == id);
            if (!po) return;
            document.getElementById('po-edit-id').value = po.id;
            document.getElementById('po-supplier').value = po.supplier || '';
            document.getElementById('po-supplier-id').value = po.supplierId || '';
            document.getElementById('po-date').value = po.date;
            currentPOCart = [...po.items];
            if (po.remaining > 0) setPOPayType('credit'); else setPOPayType('cash');
            document.getElementById('po-paid').value = po.paid;
            document.getElementById('po-method').value = po.method || '1101';
            renderPOCart();
            showToast('تم تحميل بيانات أمر الشراء للتعديل', 'info');
        }

        function deletePO(id) {
            if (!confirm('حذف أمر الشراء؟')) return;
            db.purchaseOrders = db.purchaseOrders.filter(x => x.id !== id);
            renderRecentPurchaseOrders();
            save();
        }

        function activatePO(id) {
            const po = db.purchaseOrders.find(x => x.id == id);
            if (!po || po.status === 'active') return;

            if (!confirm('سيتم تحويل أمر الشراء إلى فاتورة مشتريات حقيقية وتسجيلها في الحسابات والمخازن. هل أنت متأكد؟')) return;

            const date = po.date || new Date().toISOString().split('T')[0];
            const subtotal = po.items.reduce((s, i) => s + (i.cost * i.qty), 0);
            const discount = po.discount || 0;
            const netBeforeVat = subtotal - discount;
            const vatRate = db.settings.vatRate || 15;
            const vatAmount = netBeforeVat * (vatRate / 100);
            const grandTotal = netBeforeVat + vatAmount;
            const paid = po.paid || 0;
            const remaining = grandTotal - paid;
            const method = po.method || '1101';

            const lines = [
                { code: '1104', dr: subtotal, cr: 0 },
                { code: '2102', dr: vatAmount, cr: 0 }
            ];
            if (paid > 0) lines.push({ code: getMethodAccount(method), dr: 0, cr: paid });
            if (discount > 0) lines.push({ code: '4201', dr: 0, cr: discount }); // Discount Received
            if (remaining > 0.01) lines.push({ code: '2101', dr: 0, cr: remaining });

            if (addJournalEntry(date, `تفعيل أمر شراء PO-${String(po.id).slice(-4)} - المورد: ${po.supplier}`, lines)) {
                po.status = 'active';
                po.items.forEach(i => {
                    if (i.isNew) {
                        if (i.type === 'service') {
                            if (!db.services) db.services = [];
                            const newSrv = { id: i.id, name: i.name, cost: i.cost, price: i.cost * 1.2, description: '' };
                            db.services.push(newSrv);
                        } else {
                            if (!db.products) db.products = [];
                            const newProd = { id: i.id, name: i.name, cost: i.cost, price: i.cost * 1.5, stock: i.qty, minStock: 0, unit: 'pcs', category: 'General' };
                            db.products.push(newProd);
                        }
                    } else {
                        if (i.type === 'product' || !i.type) {
                            const p = db.products.find(x => x.id == i.id);
                            if (p) {
                                p.stock += i.qty;
                                p.cost = i.cost;
                            }
                        }
                    }
                });
                db.purchases.push({
                    id: Date.now(),
                    date,
                    supplier: po.supplier,
                    total: grandTotal,
                    paid,
                    discount,
                    remaining,
                    method,
                    items: [...po.items]
                });

                showToast('تم تحويل أمر الشراء إلى فاتورة مشتريات بنجاح ✅');
                renderRecentPurchaseOrders();
                save();
                renderAll();
            }
        }

        function filterPOList(val) {
            const rows = document.querySelectorAll('#recent-po-body tr');
            rows.forEach(r => r.style.display = r.innerText.includes(val) ? '' : 'none');
        }

        function filterCustStatement(val) {
            const rows = document.querySelectorAll('#cust-statement-body tr');
            let totalReceivable = 0;
            rows.forEach(r => {
                const match = r.innerText.includes(val);
                r.style.display = match ? '' : 'none';
                if (match) {
                    const cells = r.querySelectorAll('td');
                    const rem = parseFloat(cells[cells.length - 1].innerText) || 0;
                    totalReceivable += rem;
                }
            });
            const totalEl = document.getElementById('total-customer-receivable');
            if (totalEl) totalEl.innerText = totalReceivable.toFixed(2);
        }

        function filterSuppStatement(val) {
            const rows = document.querySelectorAll('#supp-statement-body tr');
            let totalDebt = 0;
            rows.forEach(r => {
                const match = r.innerText.includes(val);
                r.style.display = match ? '' : 'none';
                if (match) {
                    const cells = r.querySelectorAll('td');
                    const rem = parseFloat(cells[cells.length - 1].innerText) || 0;
                    totalDebt += rem;
                }
            });
            const totalEl = document.getElementById('total-supplier-debt');
            if (totalEl) totalEl.innerText = totalDebt.toFixed(2);
        }

        // Reporting Render Functions
        function renderInvQuotations() {
            const tbody = document.getElementById('inv-quotations-body'); if (!tbody) return;
            const from = document.getElementById('inv-quotations-from')?.value;
            const to = document.getElementById('inv-quotations-to')?.value;
            let inv = [...(db.quotations || [])].reverse();
            if (from) inv = inv.filter(s => s.date >= from);
            if (to) inv = inv.filter(s => s.date <= to);
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const invNo = s.invoiceNo || 'QT-' + String(s.id).slice(-4);
                totalAll += s.total || 0; paidAll += s.paid || 0; remAll += s.remaining || 0;
                const status = s.status === 'draft' ? '<span class="text-blue-600 font-bold">مسودة</span>' : '<span class="text-emerald-600">مكتمل</span>';
                let actions = `<button onclick="printQuotation(` + s.id + `)" class="text-blue-500 text-xs me-1"><i class="fas fa-print"></i></button>`;
                return `<tr class="hover:bg-blue-50"><td class="p-2 font-mono text-blue-600">` + invNo + `</td><td class="p-2">` + s.date + `</td><td class="p-2 font-bold">` + s.customer + `</td><td class="p-2 font-bold">` + (s.total || 0).toFixed(2) + `</td><td class="p-2 text-emerald-600">` + (s.paid || 0).toFixed(2) + `</td><td class="p-2 text-red-600 font-bold">` + (s.remaining || 0).toFixed(2) + `</td><td class="p-2">` + status + `</td><td class="p-2">` + actions + `</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';

            const countEl = document.getElementById('inv-quotations-count'); if (countEl) countEl.innerText = inv.length;
            const totalEl = document.getElementById('inv-quotations-total'); if (totalEl) totalEl.innerText = totalAll.toFixed(2);
            const paidEl = document.getElementById('inv-quotations-paid'); if (paidEl) paidEl.innerText = paidAll.toFixed(2);
            const remEl = document.getElementById('inv-quotations-rem'); if (remEl) remEl.innerText = remAll.toFixed(2);
        }

        function renderInvPurchaseOrders() {
            const tbody = document.getElementById('inv-po-body'); if (!tbody) return;
            const from = document.getElementById('inv-po-from')?.value;
            const to = document.getElementById('inv-po-to')?.value;
            let inv = [...(db.purchaseOrders || [])].reverse();
            if (from) inv = inv.filter(s => s.date >= from);
            if (to) inv = inv.filter(s => s.date <= to);
            let totalAll = 0, paidAll = 0, remAll = 0;
            tbody.innerHTML = inv.length ? inv.map(s => {
                const invNo = s.invoiceNo || 'PO-' + String(s.id).slice(-4);
                totalAll += s.total || 0; paidAll += s.paid || 0; remAll += s.remaining || 0;
                const status = s.status === 'draft' ? '<span class="text-blue-600 font-bold">مسودة</span>' : '<span class="text-emerald-600">مكتمل</span>';
                let actions = `<button onclick="printPO(` + s.id + `)" class="text-orange-500 text-xs me-1"><i class="fas fa-print"></i></button>`;
                return `<tr class="hover:bg-orange-50"><td class="p-2 font-mono text-orange-600">` + invNo + `</td><td class="p-2">` + s.date + `</td><td class="p-2 font-bold">` + s.supplier + `</td><td class="p-2 font-bold">` + (s.total || 0).toFixed(2) + `</td><td class="p-2 text-emerald-600">` + (s.paid || 0).toFixed(2) + `</td><td class="p-2 text-red-600 font-bold">` + (s.remaining || 0).toFixed(2) + `</td><td class="p-2">` + status + `</td><td class="p-2">` + actions + `</td></tr>`;
            }).join('') : '<tr><td colspan="8" class="p-4 text-center text-slate-400">لا توجد بيانات</td></tr>';

            const countEl = document.getElementById('inv-po-count'); if (countEl) countEl.innerText = inv.length;
            const totalEl = document.getElementById('inv-po-total'); if (totalEl) totalEl.innerText = totalAll.toFixed(2);
            const paidEl = document.getElementById('inv-po-paid'); if (paidEl) paidEl.innerText = paidAll.toFixed(2);
            const remEl = document.getElementById('inv-po-rem'); if (remEl) remEl.innerText = remAll.toFixed(2);
        }

        function printLastQuotation() {
            if (db.quotations.length === 0) return showToast('لا يوجد عروض أسعار لطباعتها', 'error');
            const q = db.quotations[db.quotations.length - 1];
            printDocument(q, 'عرض سعر');
        }

        function printQuotation(id) {
            const q = db.quotations.find(x => x.id == id);
            if (q) printDocument(q, 'عرض سعر');
        }

        function printLastPO() {
            if (db.purchaseOrders.length === 0) return showToast('لا يوجد أوامر شراء لطباعتها', 'error');
            const p = db.purchaseOrders[db.purchaseOrders.length - 1];
            printDocument(p, 'أمر شراء');
        }

        function printPO(id) {
            const p = db.purchaseOrders.find(x => x.id == id);
            if (p) printDocument(p, 'أمر شراء');
        }

    </script>
</body>

</html>