<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WEBMAX-ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }

        .currency {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
        }

        .section-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        /* Toast & Modal */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 300px;
            justify-content: center;
            font-size: 0.9rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(-10px);
        }

        .toast.success i {
            color: #34d399;
        }

        .toast.error i {
            color: #f87171;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 500px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        /* Tree Indentation */
        .level-1 {
            font-weight: 800;
            background-color: #e2e8f0;
        }

        .level-2 {
            font-weight: 700;
            padding-right: 20px !important;
        }

        .level-3 {
            font-weight: 600;
            padding-right: 35px !important;
            color: #334155;
        }

        /* Simple Bar Chart */
        .chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            padding-top: 20px;
        }

        .chart-bar {
            width: 12%;
            background: #3b82f6;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.5s;
            min-height: 2px;
        }

        .chart-bar:hover {
            background: #2563eb;
        }

        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #64748b;
            width: 100%;
            text-align: center;
        }

        .chart-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #334155;
        }

        /* Print */
        @media print {
            body * {
                visibility: hidden;
            }

            #print-area,
            #print-area * {
                visibility: visible;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                min-height: 100%;
                background: white;
                padding: 0;
                direction: rtl;
                color: black;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex overflow-hidden bg-slate-50">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">تسجيل الدخول</h2>
                <p class="text-slate-500 text-sm mt-1">WEBMAX-ERP</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">اسم المستخدم</label><input type="text"
                        id="login-user" class="w-full p-3 border rounded-lg focus:border-blue-500 outline-none"
                        placeholder="admin"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">كلمة المرور</label><input
                        type="password" id="login-pass"
                        class="w-full p-3 border rounded-lg focus:border-blue-500 outline-none" placeholder="123"></div>
                <button type="submit"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">دخول</button>
                <p id="login-error" class="text-red-500 text-xs text-center hidden"><i
                        class="fas fa-exclamation-circle"></i> بيانات الدخول غير صحيحة</p>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>
    <div id="print-area" class="hidden p-8"></div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity opacity-0"></div>

    <!-- Invoice Details Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-lg">تفاصيل الفاتورة</h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-red-500"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="invoice-modal-body" class="p-6"></div>
            <div class="p-4 border-t bg-slate-50 rounded-b-xl flex justify-end gap-2">
                <button onclick="printCurrentModalInvoice()"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"><i
                        class="fas fa-print"></i> طباعة</button>
                <button onclick="closeModal()"
                    class="bg-slate-200 text-slate-700 px-4 py-2 rounded hover:bg-slate-300">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- القائمة الجانبية -->
    <aside id="sidebar"
        class="fixed inset-y-0 right-0 z-40 w-72 bg-slate-900 text-white flex flex-col shadow-2xl transform translate-x-full md:translate-x-0 md:static md:w-64 transition-transform duration-300 no-print">
        <div class="p-6 border-b border-slate-700 flex flex-col items-center bg-slate-950">
            <div
                class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-2xl mb-3 shadow-lg overflow-hidden relative">
                <i class="fas fa-cubes text-white" id="default-logo-icon"></i>
                <img id="sidebar-logo-img" src="" class="w-full h-full object-cover hidden absolute inset-0">
            </div>
            <h1 class="text-lg font-bold text-white tracking-wide">نظام ERP المتكامل</h1>
            <span class="text-[10px] text-slate-400 mt-1 bg-slate-800 px-2 py-0.5 rounded-full">V10.0 Pro</span>
        </div>

        <nav class="flex-1 p-3 space-y-1 overflow-y-auto text-sm">
            <button onclick="showSection('dashboard')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="dashboard">
                <i class="fas fa-chart-pie w-8 text-center text-lg"></i> لوحة القيادة
            </button>
            <button onclick="showSection('pos')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="pos">
                <i class="fas fa-calculator w-8 text-center text-lg"></i> نقطة بيع (Kiosk)
            </button>

            <button onclick="showSection('sales')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="sales">
                <i class="fas fa-cash-register w-8 text-center text-lg"></i> مبيعات
            </button>
            <button onclick="showSection('customers')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="customers">
                <i class="fas fa-users w-8 text-center text-lg"></i> العملاء
            </button>
            <button onclick="showSection('purchases')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="purchases">
                <i class="fas fa-shopping-cart w-8 text-center text-lg"></i> المشتريات
            </button>
            <button onclick="showSection('suppliers')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="suppliers">
                <i class="fas fa-truck w-8 text-center text-lg"></i> الموردين
            </button>
            <button onclick="showSection('hr')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="hr">
                <i class="fas fa-user-tie w-8 text-center text-lg"></i> الموارد البشرية
            </button>
            <button onclick="showSection('inventory')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="inventory">
                <i class="fas fa-boxes w-8 text-center text-lg"></i> إدارة المخزون
            </button>
            <button onclick="showSection('installments')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="installments">
                <i class="fas fa-calendar-alt w-8 text-center text-lg"></i> التقسيط
            </button>
            <button onclick="showSection('services')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="services">
                <i class="fas fa-tools w-8 text-center text-lg"></i> الخدمات
            </button>
            <button onclick="showSection('expenses')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="expenses">
                <i class="fas fa-money-bill-wave w-8 text-center text-lg"></i> المصروفات
            </button>
            <button onclick="showSection('journal')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="journal">
                <i class="fas fa-book w-8 text-center text-lg"></i> القيود اليومية
            </button>
            <button onclick="showSection('accounts_tree')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="accounts_tree">
                <i class="fas fa-sitemap w-8 text-center text-lg"></i> شجرة الحسابات
            </button>
            <button onclick="showSection('salaries')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="salaries">
                <i class="fas fa-money-bill-wave w-8 text-center text-lg"></i> الرواتب والأجور
            </button>
            <button onclick="showSection('reports')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="reports">
                <i class="fas fa-file-contract w-8 text-center text-lg"></i> التقارير
            </button>

            <div class="my-4 border-t border-slate-700"></div>

            <button onclick="showSection('users')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="users">
                <i class="fas fa-users w-8 text-center text-lg"></i> المستخدمين
            </button>
            <button onclick="showSection('settings')"
                class="nav-btn w-full text-right p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300"
                data-target="settings">
                <i class="fas fa-cogs w-8 text-center text-lg"></i> الإعدادات
            </button>
        </nav>
    </aside>

    <!-- المحتوى -->
    <main class="flex-1 flex flex-col w-full overflow-hidden no-print relative">
        <!-- الهيدر -->
        <header class="bg-white shadow-sm h-16 flex justify-between items-center px-4 z-20 border-b">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()"
                    class="md:hidden text-slate-600 hover:text-blue-600 p-2 rounded-full hover:bg-slate-100 transition"><i
                        class="fas fa-bars text-xl"></i></button>
                <h2 id="page-title" class="text-lg font-bold text-slate-800 hidden md:block">لوحة القيادة</h2>
            </div>

            <div class="flex items-center gap-4">
                <!-- اختيار المستخدم الحالي -->
                <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200">
                    <i class="fas fa-user-circle text-slate-500"></i>
                    <select id="current-user-select" onchange="switchUser(this.value)"
                        class="bg-transparent border-none text-xs font-bold text-slate-700 outline-none cursor-pointer">
                        <!-- Users loaded here -->
                    </select>
                </div>

                <div class="hidden md:flex flex-col items-end border-r pr-4 border-slate-200">
                    <span class="text-xs font-bold text-slate-800" id="header-company-name">اسم الشركة</span>
                    <span class="text-[10px] text-slate-500 font-mono" id="header-date">--/--/----</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50 relative">

            <!-- 1. Dashboard -->
            <section id="dashboard" class="section-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-emerald-500">
                        <div class="text-xs text-slate-500 mb-1">الخزينة (النقدية)</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-cash">0.00</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-blue-500">
                        <div class="text-xs text-slate-500 mb-1">المبيعات</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-sales">0.00</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-red-500">
                        <div class="text-xs text-slate-500 mb-1">المصروفات</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-expenses">0.00</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-b-4 border-purple-500">
                        <div class="text-xs text-slate-500 mb-1">صافي الربح</div>
                        <div class="text-2xl font-bold text-slate-800 currency" id="dash-net-profit">0.00</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-4 border-b pb-3"><i
                                class="fas fa-chart-bar text-blue-500 me-2"></i>المبيعات (آخر 7 أيام)</h3>
                        <div class="chart-container" id="sales-chart">
                            <!-- Bars will be injected here -->
                            <p class="text-sm text-slate-400 self-center">جاري تحميل البيانات...</p>
                        </div>
                    </div>

                    <!-- Recent Journal -->
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-4 border-b pb-3 flex justify-between items-center">
                            <span><i class="fas fa-history text-blue-500 me-2"></i>آخر العمليات</span>
                            <button onclick="showSection('journal')"
                                class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100">عرض
                                الكل</button>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-50 text-slate-600">
                                    <tr>
                                        <th class="p-2">#</th>
                                        <th class="p-2">التاريخ</th>
                                        <th class="p-2">البيان</th>
                                        <th class="p-2">القيمة</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-journal-list" class="divide-y text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- POS (Kiosk) -->
            <section id="pos" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-120px)]">
                    <!-- Products Grid -->
                    <div class="lg:col-span-2 flex flex-col">
                        <div class="flex gap-2 mb-3">
                            <input type="text" placeholder="بحث عن منتج..."
                                class="flex-1 p-2.5 border rounded-lg text-sm outline-none focus:border-blue-500"
                                onkeyup="renderPOSProducts(this.value)">
                        </div>
                        <div id="pos-grid"
                            class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 content-start">
                            <!-- Products rendered by JS -->
                        </div>
                    </div>

                    <!-- Cart -->
                    <div class="bg-white rounded-xl shadow-sm flex flex-col p-4">
                        <h3 class="font-bold text-slate-800 mb-3 border-b pb-2"><i
                                class="fas fa-shopping-basket text-blue-500 me-2"></i>السلة</h3>

                        <!-- Customer -->
                        <div class="flex items-center gap-2 mb-3 text-xs">
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" id="pos-walkin" checked onchange="togglePOSCustomer()">
                                <span>عميل نقدي</span>
                            </label>
                            <select id="pos-customer"
                                class="hidden flex-1 p-1.5 border rounded text-xs outline-none"></select>
                        </div>

                        <!-- Cart Items -->
                        <div class="flex-1 overflow-y-auto border rounded mb-3">
                            <table class="w-full text-xs text-right">
                                <thead class="bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="p-2">الصنف</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">المبلغ</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="pos-cart-body"></tbody>
                            </table>
                        </div>

                        <!-- Discount -->
                        <div class="flex items-center gap-2 mb-2 text-xs">
                            <span class="text-slate-500">خصم:</span>
                            <input type="number" id="pos-discount" value="0" min="0"
                                class="w-20 p-1 border rounded text-center text-xs" onchange="renderPOSCart()">
                        </div>

                        <!-- Totals -->
                        <div class="bg-slate-900 text-white p-3 rounded-lg mb-3">
                            <div class="flex justify-between text-xs text-slate-400 mb-1">
                                <span>المجموع:</span><span id="pos-subtotal">0.00</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold text-emerald-400">
                                <span>الإجمالي:</span><span id="pos-total">0.00</span>
                            </div>
                        </div>

                        <!-- Payment Buttons -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button onclick="checkoutPOS('Cash')"
                                class="bg-emerald-600 text-white py-2.5 rounded-lg font-bold hover:bg-emerald-500 shadow text-sm">
                                <i class="fas fa-money-bill-wave me-1"></i> كاش
                            </button>
                            <button onclick="checkoutPOS('Bank')"
                                class="bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-500 shadow text-sm">
                                <i class="fas fa-credit-card me-1"></i> بنك
                            </button>
                        </div>
                        <div id="pos-other-methods" class="grid grid-cols-2 gap-2 mb-2"></div>
                        <button onclick="clearPOSCart()"
                            class="w-full bg-red-100 text-red-600 py-1.5 rounded text-xs font-bold hover:bg-red-200">
                            <i class="fas fa-trash me-1"></i> مسح السلة
                        </button>
                    </div>
                </div>
            </section>

            <!-- 2. Users Management -->
            <section id="users" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4"><i
                                class="fas fa-user-plus text-blue-500 me-2"></i><span id="user-form-title">إضافة
                                مستخدم</span></h3>
                        <form onsubmit="saveUser(event)" class="space-y-4">
                            <input type="hidden" id="user-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم المستخدم</label><input type="text"
                                    id="user-name" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">الدور (الصلاحية)</label>
                                <select id="user-role"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none bg-white">
                                    <option value="admin">مدير (كامل الصلاحيات)</option>
                                    <option value="cashier">كاشير (مبيعات فقط)</option>
                                    <option value="accountant">محاسب</option>
                                </select>
                            </div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="user-phone"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">حفظ</button>
                                <button type="button" onclick="resetUserForm()"
                                    class="bg-slate-200 text-slate-600 px-4 rounded hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800"><i
                                    class="fas fa-users text-blue-500 me-2"></i>قائمة المستخدمين</h3>
                            <input type="text" placeholder="بحث عن مستخدم..."
                                class="p-2 border rounded text-sm w-48 focus:border-blue-500 outline-none"
                                onkeyup="filterUsers(this.value)">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-50 text-slate-700">
                                    <tr>
                                        <th class="p-3 rounded-tr-lg">الاسم</th>
                                        <th class="p-3">الدور</th>
                                        <th class="p-3">الهاتف</th>
                                        <th class="p-3 rounded-tl-lg">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="users-list" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Settings -->
            <section id="settings" class="section-content">
                <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex items-center gap-3 border-b pb-4 mb-6">
                        <div
                            class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-600">
                            <i class="fas fa-sliders-h"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-slate-800">إعدادات النظام</h3>
                            <p class="text-xs text-slate-500">تحكم في بيانات الشركة والنسخ الاحتياطي</p>
                        </div>
                    </div>

                    <form onsubmit="saveSettings(event)" class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">اسم الشركة</label><input
                                type="text" id="set-name"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">رقم الهاتف</label><input
                                type="text" id="set-phone"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div class="md:col-span-2"><label
                                class="text-xs font-bold text-slate-600 mb-1 block">العنوان</label><input type="text"
                                id="set-address"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">الرقم الضريبي</label><input
                                type="text" id="set-vat-no"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                        </div>
                        <div><label class="text-xs font-bold text-slate-600 mb-1 block">رابط شعار الشركة
                                (URL)</label><input type="text" id="set-logo-url"
                                placeholder="https://example.com/logo.png"
                                class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none"
                                dir="ltr"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">الضريبة %</label><input
                                    type="number" id="set-vat-rate"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                            </div>
                            <div><label class="text-xs font-bold text-slate-600 mb-1 block">العملة</label><input
                                    type="text" id="set-currency"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:border-blue-500 transition outline-none">
                            </div>
                        </div>
                        <div class="md:col-span-2 mt-4 border-t pt-4">
                            <h4 class="font-bold text-slate-700 mb-2 text-sm">طرق الدفع</h4>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="new-pay-method"
                                    placeholder="اسم طريقة الدفع (مثلاً: فودافون كاش)"
                                    class="flex-1 p-2 border rounded text-sm outline-none bg-slate-50 focus:bg-white transition">
                                <button type="button" onclick="addPaymentMethod()"
                                    class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 text-sm">إضافة</button>
                            </div>
                            <div id="payment-methods-list" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="md:col-span-2 text-left pt-2">
                            <button type="submit"
                                class="bg-slate-800 text-white px-8 py-2.5 rounded-lg hover:bg-slate-700 transition shadow-lg font-bold text-sm">حفظ
                                التغييرات</button>
                        </div>
                    </form>

                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <h4 class="font-bold text-slate-700 mb-4 text-sm">إدارة البيانات والنسخ الاحتياطي</h4>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="exportData()"
                                class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-100 transition text-sm flex items-center gap-2"><i
                                    class="fas fa-download"></i> تصدير Backup</button>

                            <div class="relative">
                                <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                                <button onclick="document.getElementById('import-file').click()"
                                    class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-100 transition text-sm flex items-center gap-2"><i
                                        class="fas fa-upload"></i> استعادة Backup</button>
                            </div>

                            <button onclick="resetData()"
                                class="bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition text-sm flex items-center gap-2 mr-auto"><i
                                    class="fas fa-trash-alt"></i> تصفير النظام</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. Sales & POS -->
            <section id="sales" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                    <!-- الفاتورة -->
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <span id="sale-title">فاتورة مبيعات</span>
                                <span id="sale-mode-badge"
                                    class="hidden text-xs bg-red-100 text-red-800 px-2 py-1 rounded border border-red-200">مرتجع</span>
                            </h3>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer text-sm select-none">
                                    <input type="checkbox" id="is-return-sale"
                                        class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                                        onchange="toggleSaleMode()">
                                    <span>وضع المرتجع</span>
                                </label>
                                <div
                                    class="text-xs font-mono bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100">
                                    INV-<span id="inv-num">Auto</span></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <select id="sale-customer"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"></select>
                            <select id="sale-account"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"></select>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <select id="sale-product"
                                class="flex-1 p-2.5 border rounded-lg text-sm bg-white outline-none shadow-sm"></select>
                            <input type="number" id="sale-qty" value="1"
                                class="w-20 p-2.5 border rounded-lg text-center outline-none" min="1">
                            <button onclick="addToCart()"
                                class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 transition shadow"><i
                                    class="fas fa-plus"></i></button>
                        </div>

                        <!-- جدول السلة -->
                        <div class="flex-1 border rounded-lg overflow-y-auto mb-3 bg-slate-50">
                            <table class="w-full text-sm text-center relative">
                                <thead class="bg-slate-200 text-slate-700 sticky top-0">
                                    <tr>
                                        <th class="p-2">الصنف</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">السعر</th>
                                        <th class="p-2">الإجمالي</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="cart-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                            <div id="cart-empty" class="text-center text-slate-400 py-10 text-sm">ابدأ بإضافة المنتجات
                            </div>
                        </div>

                        <div class="bg-slate-900 text-white p-4 rounded-xl shadow-lg">
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>المجموع:</span><span
                                    id="cart-subtotal">0.00</span></div>
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>الضريبة (<span
                                        id="cart-vat-rate">15</span>%):</span><span id="cart-vat">0.00</span></div>
                            <div class="flex justify-between text-xs text-slate-400 mb-2 items-center">
                                <span>خصم:</span>
                                <input type="number" id="sale-discount"
                                    class="w-20 p-1 text-black rounded text-center text-xs font-bold" value="0" min="0"
                                    onchange="renderCart()">
                            </div>
                            <div class="flex justify-between items-center border-t border-slate-700 pt-2 mb-2">
                                <div class="text-xl font-bold text-emerald-400" id="cart-total">0.00</div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="text-[10px] text-slate-400 block mb-1">المدفوع</label><input
                                        type="number" id="sale-paid"
                                        class="w-full p-1.5 text-black rounded text-sm font-bold" placeholder="المبلغ">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 block mb-1">طريقة الدفع</label>
                                    <select id="sale-method" class="w-full p-1.5 text-black rounded text-sm"></select>
                                </div>
                            </div>
                            <button onclick="postSale()"
                                class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg font-bold shadow-lg transition transform active:scale-95">حفظ
                                وطباعة</button>
                        </div>
                    </div>

                    <!-- المنتجات السريعة -->
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-sm text-slate-800">آخر الفواتير</h3>
                            <span class="text-xs text-slate-400">(اضغط للعرض)</span>
                        </div>
                        <div id="recent-invoices" class="overflow-y-auto flex-1 space-y-2 pr-1">
                            <!-- List -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. Journal (Entries) -->
            <section id="journal" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">قيد يومية يدوي</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
                        <div class="md:col-span-3">
                            <input type="text" id="manual-desc" placeholder="شرح القيد (البيان)"
                                class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <input type="date" id="manual-date"
                                class="w-full p-2.5 border rounded-lg outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
                        <div class="grid grid-cols-12 gap-2 text-xs font-bold text-slate-500 mb-2 px-2">
                            <div class="col-span-6">الحساب</div>
                            <div class="col-span-2">مدين</div>
                            <div class="col-span-2">دائن</div>
                            <div class="col-span-2"></div>
                        </div>
                        <div id="journal-lines" class="space-y-2"></div>
                        <button onclick="addJournalLineRow()"
                            class="mt-4 text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full hover:bg-blue-100 font-bold transition flex items-center gap-1 w-fit"><i
                                class="fas fa-plus"></i> طرف جديد</button>
                    </div>

                    <div class="flex justify-between items-center bg-slate-100 p-3 rounded-lg border border-slate-200">
                        <div class="flex gap-4 text-sm font-mono font-bold">
                            <span class="text-emerald-600">مدين: <span id="total-dr">0.00</span></span>
                            <span class="text-slate-300">|</span>
                            <span class="text-red-600">دائن: <span id="total-cr">0.00</span></span>
                            <span id="unbalanced-msg"
                                class="text-red-500 bg-red-50 px-2 rounded text-xs hidden flex items-center gap-1"><i
                                    class="fas fa-exclamation-circle"></i> غير متزن</span>
                        </div>
                        <button onclick="saveManualJournal()"
                            class="bg-slate-800 text-white px-6 py-2 rounded-lg text-sm hover:bg-slate-700 font-bold shadow">ترحيل
                            القيد</button>
                    </div>
                </div>
            </section>

            <!-- 9. Purchases (New) -->
            <section id="purchases" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <span id="pur-title">فاتورة مشتريات</span>
                                <span id="pur-mode-badge"
                                    class="hidden text-xs bg-red-100 text-red-800 px-2 py-1 rounded border border-red-200">مرتجع</span>
                            </h3>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer text-sm select-none">
                                    <input type="checkbox" id="is-return-pur"
                                        class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500"
                                        onchange="togglePurMode()">
                                    <span>وضع المرتجع</span>
                                </label>
                                <div
                                    class="text-xs font-mono bg-orange-50 text-orange-700 px-2 py-1 rounded border border-orange-100">
                                    PUR-<span id="pur-num">Auto</span></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <select id="pur-supplier"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none"></select>
                            <input type="date" id="pur-date"
                                class="p-2.5 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none">
                        </div>
                        <div class="flex gap-2 mb-3">
                            <select id="pur-product"
                                class="flex-1 p-2.5 border rounded-lg text-sm bg-white outline-none shadow-sm"
                                onchange="updatePurCost(this)"></select>
                            <input type="number" id="pur-cost" placeholder="التكلفة"
                                class="w-24 p-2.5 border rounded-lg text-center outline-none">
                            <input type="number" id="pur-qty" value="1"
                                class="w-20 p-2.5 border rounded-lg text-center outline-none" min="1">
                            <button onclick="addToPurCart()"
                                class="bg-orange-600 text-white px-4 rounded-lg hover:bg-orange-700 transition shadow"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div class="flex-1 border rounded-lg overflow-y-auto mb-3 bg-slate-50">
                            <table class="w-full text-sm text-center relative">
                                <thead class="bg-slate-200 text-slate-700 sticky top-0">
                                    <tr>
                                        <th class="p-2">الصنف</th>
                                        <th class="p-2">الكمية</th>
                                        <th class="p-2">التكلفة</th>
                                        <th class="p-2">الإجمالي</th>
                                        <th class="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="pur-cart-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                        <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg">
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>المجموع:</span><span
                                    id="pur-subtotal">0.00</span></div>
                            <div class="flex justify-between text-xs text-slate-400 mb-1"><span>الضريبة
                                    (15%):</span><span id="pur-vat">0.00</span></div>
                            <div class="flex justify-between text-xs text-slate-400 mb-2 items-center">
                                <span>خصم مكتسب:</span>
                                <input type="number" id="pur-discount"
                                    class="w-20 p-1 text-black rounded text-center text-xs font-bold" value="0" min="0"
                                    onchange="renderPurCart()">
                            </div>
                            <div class="flex justify-between items-center border-t border-slate-700 pt-2 mb-2">
                                <div class="text-xl font-bold text-orange-400" id="pur-total">0.00</div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="text-[10px] text-slate-400">المدفوع</label><input type="number"
                                        id="pur-paid" class="w-full p-1 text-black rounded text-sm" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400">طريقة الدفع</label>
                                    <select id="pur-method" class="w-full p-1 text-black rounded text-sm"></select>
                                </div>
                            </div>
                            <button onclick="postPurchase()"
                                class="w-full bg-orange-600 hover:bg-orange-500 text-white py-2 rounded-lg font-bold shadow-lg transition">حفظ
                                الفاتورة</button>
                        </div>
                    </div>
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm">
                        <h3 class="font-bold text-sm text-slate-800 mb-3">آخر المشتريات</h3>
                        <div id="recent-purchases" class="overflow-y-auto h-[400px] space-y-2 pr-1"></div>
                    </div>
                </div>
            </section>

            <!-- 10. Suppliers (New) -->
            <section id="suppliers" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4">إضافة مورد</h3>
                        <form onsubmit="saveSupplier(event)" class="space-y-4">
                            <input type="hidden" id="supp-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم المورد</label><input type="text"
                                    id="supp-name" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">اسم الشركة</label><input type="text"
                                    id="supp-company"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">العنوان</label><input type="text"
                                    id="supp-address"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="supp-phone"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">الرقم الضريبي (اختياري)</label><input
                                    type="text" id="supp-vat"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">حفظ</button>
                                <button type="button" onclick="resetSupplierForm()"
                                    class="bg-slate-200 text-slate-600 px-4 rounded hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة الموردين</h3>
                            <button onclick="exportTableToCSV('suppliers-table', 'suppliers_list')"
                                class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs shadow flex items-center gap-1"><i
                                    class="fas fa-file-excel"></i> تصدير</button>
                        </div>
                        <table id="suppliers-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-50 text-slate-700">
                                <tr>
                                    <th class="p-3">الاسم</th>
                                    <th class="p-3">الهاتف</th>
                                    <th class="p-3">الضريبي</th>
                                    <th class="p-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="suppliers-list" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 14. Services Module (New) -->
            <section id="services" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Service Management -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">إدارة الخدمات</h3>
                            <button
                                onclick="document.getElementById('serv-id').value='';document.getElementById('serv-form').reset();"
                                class="text-blue-600 text-xs"><i class="fas fa-plus"></i> جديد</button>
                        </div>
                        <form id="serv-form" onsubmit="saveService(event)" class="space-y-3 mb-6">
                            <input type="hidden" id="serv-id">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">اسم الخدمة</label><input
                                    type="text" id="serv-name" required class="w-full p-2 border rounded outline-none">
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">السعر</label><input
                                    type="number" id="serv-price" required
                                    class="w-full p-2 border rounded outline-none"></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">الوصف</label><input
                                    type="text" id="serv-desc" class="w-full p-2 border rounded outline-none"></div>
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 shadow">حفظ
                                الخدمة</button>
                        </form>
                        <div class="border-t pt-4">
                            <h4 class="font-bold text-sm text-slate-700 mb-2">قائمة الخدمات</h4>
                            <div class="overflow-y-auto max-h-[300px] border rounded bg-slate-50">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-indigo-50 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">الخدمة</th>
                                            <th class="p-2">السعر</th>
                                            <th class="p-2">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="services-list" class="divide-y divide-slate-200 bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Service Invoice -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">فاتورة خدمات</h3>
                            <div
                                class="text-xs font-mono bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-100">
                                SRV-<span id="srv-num">Auto</span></div>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <select id="srv-list"
                                class="flex-1 p-2 border rounded outline-none bg-slate-50 focus:bg-white"></select>
                            <button onclick="addToServiceCart()"
                                class="bg-purple-600 text-white px-4 rounded hover:bg-purple-700"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto border rounded-lg bg-slate-50 mb-3">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-100 font-bold sticky top-0">
                                    <tr>
                                        <th class="p-2">الخدمة</th>
                                        <th class="p-2">السعر</th>
                                        <th class="p-2">حذف</th>
                                    </tr>
                                </thead>
                                <tbody id="srv-cart-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                        <div class="border-t pt-3 space-y-2">
                            <div class="flex justify-between items-center font-bold text-lg"><span>الإجمالي</span><span
                                    id="srv-total" class="text-purple-700">0.00</span></div>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="srv-method" class="p-2 border rounded outline-none bg-slate-50"></select>
                                <button onclick="postServiceBill()"
                                    class="bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 shadow">حفظ
                                    الفاتورة</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            </section>

            <!-- 15. Expenses Module (New) -->
            <section id="expenses" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Add Expense -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">تسجيل مصروف جديد</h3>
                        <form onsubmit="postExpense(event)" class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">بيان المصروف</label><input
                                    type="text" id="exp-desc" required
                                    class="w-full p-2.5 border rounded-lg outline-none"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">المبلغ</label><input
                                        type="number" id="exp-amount" required step="0.01"
                                        class="w-full p-2.5 border rounded-lg outline-none"></div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">التصنيف</label>
                                    <select id="exp-cat"
                                        class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white">
                                        <!-- Categories -->
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">طريقة الدفع</label>
                                <select id="exp-method"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <button type="submit"
                                class="w-full bg-red-600 text-white py-2 rounded font-bold hover:bg-red-700 shadow">تسجيل
                                المصروف</button>
                        </form>
                    </div>

                    <!-- Expenses List -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">سجل المصروفات</h3>
                            <div class="text-xs bg-red-50 text-red-700 px-2 py-1 rounded">الإجمالي: <span
                                    id="exp-list-total" class="font-bold">0.00</span></div>
                        </div>
                        <div class="flex-1 overflow-y-auto border rounded-lg bg-slate-50 mb-3">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-100 font-bold sticky top-0">
                                    <tr>
                                        <th class="p-2">التاريخ</th>
                                        <th class="p-2">البيان</th>
                                        <th class="p-2">المبلغ</th>
                                        <th class="p-2">التصنيف</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-list" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 17. HR Module (New) -->
            <section id="hr" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- Employee Management -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">إدارة الموظفين</h3>
                            <button
                                onclick="document.getElementById('emp-id').value='';document.getElementById('emp-form').reset();document.getElementById('emp-photo-preview').classList.add('hidden');"
                                class="text-blue-600 text-xs"><i class="fas fa-plus"></i> جديد</button>
                        </div>
                        <form id="emp-form" onsubmit="saveEmployee(event)" class="space-y-3 mb-6">
                            <input type="hidden" id="emp-id">
                            <div class="flex gap-4">
                                <div class="w-24 h-24 bg-slate-100 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center relative overflow-hidden cursor-pointer"
                                    onclick="document.getElementById('emp-photo').click()">
                                    <img id="emp-photo-preview"
                                        class="absolute inset-0 w-full h-full object-cover hidden">
                                    <i class="fas fa-camera text-slate-400"></i>
                                    <input type="file" id="emp-photo" class="hidden" accept="image/*"
                                        onchange="previewEmpPhoto(this)">
                                </div>
                                <div class="flex-1 space-y-2">
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">الاسم</label><input
                                            type="text" id="emp-name" required
                                            class="w-full p-2 border rounded outline-none"></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">الوظيفة /
                                            الرتبة</label><input type="text" id="emp-role" required
                                            class="w-full p-2 border rounded outline-none"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">الراتب
                                        الأساسي</label><input type="number" id="emp-salary" required
                                        class="w-full p-2 border rounded outline-none"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">الهاتف</label><input
                                        type="text" id="emp-phone" class="w-full p-2 border rounded outline-none"></div>
                            </div>
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 shadow">حفظ
                                بيانات الموظف</button>
                        </form>

                        <div class="border-t pt-4">
                            <h4 class="font-bold text-sm text-slate-700 mb-2">قائمة الموظفين</h4>
                            <div class="overflow-y-auto max-h-[250px] border rounded bg-slate-50">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-indigo-50 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">موظف</th>
                                            <th class="p-2">الوظيفة</th>
                                            <th class="p-2">الراتب</th>
                                            <th class="p-2">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employees-list" class="divide-y divide-slate-200 bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Actions & Payroll -->
                    <div class="flex flex-col gap-6 h-full">
                        <!-- Actions -->
                        <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                            <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">الإجراءات (خصم / مكافأة)
                            </h3>
                            <form onsubmit="postPayrollAction(event)" class="grid grid-cols-2 gap-3 mb-4">
                                <select id="act-emp" class="col-span-2 p-2 border rounded outline-none bg-slate-50"
                                    required></select>
                                <select id="act-type" class="p-2 border rounded outline-none bg-slate-50" required>
                                    <option value="bonus">مكافأة / عمولة (+)</option>
                                    <option value="deduction">خصم / جزاء (-)</option>
                                </select>
                                <input type="number" id="act-amount" placeholder="المبلغ" required
                                    class="p-2 border rounded outline-none">
                                <input type="text" id="act-desc" placeholder="السبب" required
                                    class="col-span-2 p-2 border rounded outline-none">
                                <button type="submit"
                                    class="col-span-2 bg-slate-800 text-white py-2 rounded font-bold hover:bg-slate-700">تسجيل
                                    الإجراء</button>
                            </form>
                            <div class="overflow-y-auto max-h-[150px] border rounded bg-slate-50">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-slate-100 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">الاسم</th>
                                            <th class="p-2">النوع</th>
                                            <th class="p-2">المبلغ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="actions-list" class="divide-y bg-white"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Payroll Run -->
                        <div class="bg-white p-6 rounded-xl shadow-sm flex-1">
                            <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">كشف الرواتب</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="month" id="payroll-month" class="flex-1 p-2 border rounded outline-none">
                                <button onclick="generatePayrollPreview()"
                                    class="bg-emerald-600 text-white px-4 rounded font-bold hover:bg-emerald-700">إعداد
                                    الكشف</button>
                            </div>
                            <div id="payroll-preview" class="hidden">
                                <div class="overflow-y-auto max-h-[200px] border rounded mb-3">
                                    <table class="w-full text-xs text-right bg-white">
                                        <thead class="bg-slate-100 font-bold sticky top-0">
                                            <tr>
                                                <th class="p-2">الموظف</th>
                                                <th class="p-2">الراتب</th>
                                                <th class="p-2 text-green-600">(+)</th>
                                                <th class="p-2 text-red-600">(-)</th>
                                                <th class="p-2 font-bold">الصافي</th>
                                            </tr>
                                        </thead>
                                        <tbody id="payroll-table" class="divide-y"></tbody>
                                    </table>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t">
                                    <div class="font-bold text-lg">إجمالي الرواتب: <span id="payroll-total"
                                            class="text-emerald-700">0.00</span></div>
                                    <button onclick="postPayroll()"
                                        class="bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700 shadow">اعتماد
                                        وصرف الرواتب</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 13. Installment Management (New) -->
            <section id="installments" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <!-- New Installment Invoice -->
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">إنشاء فاتورة تقسيط</h3>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">العميل</label><select
                                    id="inst-customer"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">المنتج</label>
                                <select id="inst-product"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"
                                    onchange="updateInstPrice(this)"></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">سعر البيع (يتضمن
                                        الفائدة)</label><input type="number" id="inst-price"
                                        class="w-full p-2.5 border rounded-lg outline-none" onkeyup="calcInst()"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">الدفعة
                                        المقدمة</label><input type="number" id="inst-down"
                                        class="w-full p-2.5 border rounded-lg outline-none" onkeyup="calcInst()"
                                        placeholder="0"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">عدد الأقساط
                                        (شهر)</label><input type="number" id="inst-count"
                                        class="w-full p-2.5 border rounded-lg outline-none" value="12"
                                        onkeyup="calcInst()"></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">قيمة القسط
                                        الشهري</label><input type="number" id="inst-monthly"
                                        class="w-full p-2.5 border rounded-lg bg-slate-100 font-bold text-blue-600 outline-none"
                                        readonly></div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">طريقة دفع المقدم</label>
                                <select id="inst-method"
                                    class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:bg-white"></select>
                            </div>
                            <button onclick="createInstallmentPlan()"
                                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-lg mt-2 transition transform active:scale-95">إنشاء
                                عقد التقسيط</button>
                        </div>
                    </div>

                    <!-- Upcoming Installments -->
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col h-[600px]">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-slate-800">الأقساط والتحصيل</h3>
                            <div class="flex gap-2">
                                <button onclick="renderInstallments()"
                                    class="bg-slate-100 text-slate-600 px-3 py-1 rounded hover:bg-slate-200 text-xs"><i
                                        class="fas fa-sync"></i> تحديث</button>
                                <button onclick="exportTableToCSV('installments-table', 'installments_list')"
                                    class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs shadow flex items-center gap-1"><i
                                        class="fas fa-file-excel"></i> تصدير</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="text" placeholder="بحث باسم العميل..."
                                class="p-2 border rounded text-sm w-full focus:border-blue-500 outline-none bg-slate-50"
                                onkeyup="filterInstallments(this.value)">
                        </div>
                        <div class="flex-1 overflow-y-auto border rounded-lg bg-slate-50">
                            <table id="installments-table" class="w-full text-sm text-right relative border-collapse">
                                <thead class="bg-indigo-100 text-indigo-900 sticky top-0 font-bold">
                                    <tr>
                                        <th class="p-3">العميل</th>
                                        <th class="p-3">المبلغ</th>
                                        <th class="p-3">تاريخ الاستحقاق</th>
                                        <th class="p-3 text-center">الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="installments-list" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 12. Customers (New) -->
            <section id="customers" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-4">إضافة عميل</h3>
                        <form onsubmit="saveCustomer(event)" class="space-y-4">
                            <input type="hidden" id="cust-id">
                            <div><label class="block text-xs text-slate-500 mb-1">اسم العميل</label><input type="text"
                                    id="cust-name" required
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">اسم الشركة</label><input type="text"
                                    id="cust-company"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">العنوان</label><input type="text"
                                    id="cust-address"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">رقم الهاتف</label><input type="text"
                                    id="cust-phone"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-500 mb-1">الرقم الضريبي (اختياري)</label><input
                                    type="text" id="cust-vat"
                                    class="w-full p-2 border rounded focus:border-blue-500 outline-none"></div>
                            <div class="flex gap-2">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">حفظ</button>
                                <button type="button" onclick="resetCustomerForm()"
                                    class="bg-slate-200 text-slate-600 px-4 rounded hover:bg-slate-300">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">قائمة العملاء</h3>
                            <button onclick="exportTableToCSV('customers-table', 'customers_list')"
                                class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-xs shadow flex items-center gap-1"><i
                                    class="fas fa-file-excel"></i> تصدير</button>
                        </div>
                        <table id="customers-table" class="w-full text-sm text-right">
                            <thead class="bg-slate-50 text-slate-700">
                                <tr>
                                    <th class="p-3">الاسم</th>
                                    <th class="p-3">الشركة</th>
                                    <th class="p-3">الهاتف</th>
                                    <th class="p-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="customers-list" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 11. Salaries (New) -->
            <section id="salaries" class="section-content">
                <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg text-slate-800 mb-6 border-b pb-2">صرف الرواتب والأجور</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div><label class="block text-sm font-bold text-slate-700 mb-1">اسم الموظف</label><input
                                type="text" id="sal-emp-name" class="w-full p-3 border rounded-lg outline-none"
                                placeholder="اكتب اسم الموظف"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-bold text-slate-700 mb-1">المبلغ</label><input
                                    type="number" id="sal-amount" class="w-full p-3 border rounded-lg outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">طريقة الصرف</label>
                                <select id="sal-method" class="w-full p-3 border rounded-lg outline-none bg-white">
                                    <option value="1101">نقدي (الخزينة)</option>
                                    <option value="1102">بنك </option>
                                </select>
                            </div>
                        </div>
                        <button onclick="paySalary()"
                            class="bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700 shadow mt-2">تسجيل
                            صرف الراتب</button>
                    </div>
                </div>
            </section>

            <!-- 6. Accounts Tree -->
            <section id="accounts_tree" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800">الدليل المحاسبي</h3>
                        <div class="flex gap-2">
                            <input type="text" placeholder="بحث..."
                                class="p-1.5 border rounded text-xs w-32 focus:border-blue-500 outline-none"
                                onkeyup="filterAccounts(this.value)">
                            <button onclick="alert('لإضافة حساب، يرجى التواصل مع الدعم الفني')"
                                class="bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-xs hover:bg-slate-200"><i
                                    class="fas fa-lock"></i></button>
                        </div>
                    </div>
                    <div class="overflow-y-auto flex-1 border rounded-lg bg-white">
                        <table class="w-full text-sm border-collapse">
                            <thead class="bg-slate-800 text-white sticky top-0 z-10">
                                <tr>
                                    <th class="p-3 text-right w-32 font-mono">الكود</th>
                                    <th class="p-3 text-right">اسم الحساب</th>
                                    <th class="p-3 text-right w-24">النوع</th>
                                    <th class="p-3 text-right w-32">الرصيد</th>
                                </tr>
                            </thead>
                            <tbody id="coa-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 7. Inventory -->
            <section id="inventory" class="section-content">
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <h3 class="font-bold text-lg text-slate-800 mb-4"><span id="prod-form-title">إضافة صنف جديد</span>
                    </h3>
                    <form onsubmit="saveProduct(event)" class="flex flex-wrap gap-3 items-end">
                        <input type="hidden" id="prod-id">
                        <div class="flex-1 min-w-[200px]">
                            <label class="text-xs text-slate-500 mb-1 block">اسم المنتج</label>
                            <input type="text" id="new-prod-name" required
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-slate-500 mb-1 block">سعر البيع</label>
                            <input type="number" id="new-prod-price" required step="0.01"
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-slate-500 mb-1 block">التكلفة</label>
                            <input type="number" id="new-prod-cost" step="0.01"
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-xs text-slate-500 mb-1 block">الرصيد</label>
                            <input type="number" id="new-prod-stock"
                                class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                        </div>
                        <div class="flex gap-1">
                            <button type="submit"
                                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 h-[42px] mb-[1px] shadow">حفظ</button>
                            <button type="button" onclick="resetProductForm()"
                                class="bg-slate-200 text-slate-600 px-3 py-2 rounded hover:bg-slate-300 h-[42px] mb-[1px]">إلغاء</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">قائمة الأصناف</h3>
                        <input type="text" placeholder="بحث عن منتج..."
                            class="p-2 border rounded text-sm w-48 focus:border-blue-500 outline-none"
                            onkeyup="filterInventory(this.value)">
                    </div>
                    <table class="w-full text-sm text-right">
                        <thead class="bg-slate-50 text-slate-700">
                            <tr>
                                <th class="p-3 rounded-tr-lg">المنتج</th>
                                <th class="p-3">سعر البيع</th>
                                <th class="p-3">التكلفة</th>
                                <th class="p-3">الرصيد</th>
                                <th class="p-3 rounded-tl-lg">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- 8. Reports -->
            <section id="reports" class="section-content">
                <div class="max-w-6xl mx-auto">
                    <!-- Filters -->
                    <div
                        class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-wrap gap-4 items-end border border-slate-200">
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">من تاريخ</label>
                            <input type="date" id="rpt-start-date"
                                class="p-2 border rounded text-sm outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">إلى تاريخ</label>
                            <input type="date" id="rpt-end-date"
                                class="p-2 border rounded text-sm outline-none focus:border-blue-500">
                        </div>
                        <button onclick="renderReports()"
                            class="bg-slate-800 text-white px-6 py-2 rounded text-sm hover:bg-slate-700 shadow">تحديث
                            التقرير</button>
                    </div>

                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 col-span-1 md:col-span-2 mb-6">
                        <h3 class="font-bold text-center border-b pb-3 mb-4 text-slate-800 text-lg">ملخص العمليات</h3>
                        <div class="grid grid-cols-3 gap-4 text-center text-sm">
                            <div class="bg-blue-50 p-3 rounded"><strong>إجمالي المبيعات</strong>
                                <div id="rpt-sales-total" class="text-lg text-blue-700 mt-1">0.00</div>
                            </div>
                            <div class="bg-orange-50 p-3 rounded"><strong>إجمالي المشتريات</strong>
                                <div id="rpt-pur-total" class="text-lg text-orange-700 mt-1">0.00</div>
                            </div>
                            <div class="bg-red-50 p-3 rounded"><strong>إجمالي المصروفات</strong>
                                <div id="rpt-exp-total" class="text-lg text-red-700 mt-1">0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-center border-b pb-3 mb-4 text-slate-800 text-lg">قائمة الدخل</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between font-bold text-blue-700 bg-blue-50 p-2 rounded">
                                    <span>إيرادات النشاط</span><span id="is-rev">0.00</span>
                                </div>
                                <div class="flex justify-between text-red-500 px-2"><span>(-) تكلفة النشاط</span><span
                                        id="is-cogs">0.00</span></div>
                                <div class="flex justify-between font-bold border-t pt-2 px-2"><span>مجمل
                                        الربح</span><span id="is-gross">0.00</span></div>
                                <div class="flex justify-between text-red-500 px-2"><span>(-) المصروفات
                                        العمومية</span><span id="is-exp">0.00</span></div>
                                <div
                                    class="bg-slate-900 text-white p-3 rounded-lg flex justify-between text-lg font-bold mt-4">
                                    <span>صافي الربح</span><span id="is-net">0.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-[500px] flex flex-col">
                            <h3 class="font-bold text-center border-b pb-3 mb-4 text-slate-800 text-lg">ميزان المراجعة
                                (تراكمي)</h3>
                            <div class="overflow-y-auto flex-1">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-slate-100 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-2">الحساب</th>
                                            <th class="p-2">مدين</th>
                                            <th class="p-2">دائن</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trial-balance-body" class="divide-y"></tbody>
                                </table>
                            </div>
                            <div class="bg-slate-100 p-2 rounded font-bold text-xs flex justify-between mt-2">
                                <span>الإجمالي</span>
                                <span class="text-emerald-600" id="tb-total-dr">0.00</span>
                                <span class="text-red-600" id="tb-total-cr">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // --- 0. Firebase Config & Login ---
        const firebaseConfig = {
            apiKey: "AIzaSyB6if5oe1FBqJlp-glu2AmRaGKODRo14ck",
            authDomain: "erm1-92e4f.firebaseapp.com",
            projectId: "erm1-92e4f",
            storageBucket: "erm1-92e4f.firebasestorage.app",
            messagingSenderId: "868668789906",
            appId: "1:868668789906:web:a56f9a9c441c66c008024b",
            measurementId: "G-JJ2MHMPX22"
        };
        firebase.initializeApp(firebaseConfig);
        const dbFirestore = firebase.firestore();

        // --- 1. Data Structure ---
        let db = {
            settings: {
                companyName: 'شركتي', logo: '',
                vatRate: 15,
                currency: 'SAR',
                phone: '', address: '', vatNumber: '',
                paymentMethods: ['Cash', 'Bank', 'Wallet', 'InstaPay']
            },
            services: [{ id: 1, name: 'خدمة تركيب', price: 150, description: 'تركيب وصيانة' }],
            expensesCategories: [
                { id: '5201', name: 'مصروفات تشغيلية' },
                { id: '5202', name: 'رواتب وأجور' }, // We'll use this for HR later
                { id: '5203', name: 'مصروفات أخرى (طارئة)' }
            ],
            expenses: [],

            employees: [
                { id: 1, name: 'موظف تجريبي', role: 'مبيعات', salary: 3000, phone: '0500000000', photo: '' }
            ],
            payrollActions: [],
            payrollRuns: [],

            users: [
                { id: 1, name: 'المدير العام', role: 'admin', phone: '0000' }
            ],
            currentUser: 1,
            chartOfAccounts: [
                { code: '1', name: 'الأصول', type: 'asset', level: 1, balance: 0, isGroup: true },
                { code: '11', name: 'أصول متداولة', type: 'asset', level: 2, parent: '1', balance: 0, isGroup: true },
                { code: '1101', name: 'الخزينة الرئيسية', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1102', name: 'البنك ', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1103', name: 'العملاء', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '1104', name: 'المخزون', type: 'asset', level: 3, parent: '11', balance: 0 },
                { code: '2', name: 'الالتزامات', type: 'liability', level: 1, balance: 0, isGroup: true },
                { code: '2101', name: 'الموردين (الدائنون)', type: 'liability', level: 3, parent: '2', balance: 0 },
                { code: '2102', name: 'ضريبة القيمة المضافة', type: 'liability', level: 3, parent: '2', balance: 0 },
                { code: '3', name: 'حقوق الملكية', type: 'equity', level: 1, balance: 0, isGroup: true },
                { code: '3101', name: 'رأس المال', type: 'equity', level: 3, parent: '3', balance: 0 },
                { code: '4', name: 'الإيرادات', type: 'revenue', level: 1, balance: 0, isGroup: true },
                { code: '4101', name: 'إيرادات المبيعات', type: 'revenue', level: 3, parent: '4', balance: 0 },
                { code: '5', name: 'المصروفات', type: 'expense', level: 1, balance: 0, isGroup: true },
                { code: '5101', name: 'تكلفة المبيعات', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5201', name: 'مصروفات تشغيلية', type: 'expense', level: 3, parent: '5', balance: 0 },
                { code: '5202', name: 'الرواتب والأجور', type: 'expense', level: 3, parent: '5', balance: 0 }
            ],
            journal: [],
            products: [{ id: 1, name: 'منتج تجريبي', price: 100, cost: 80, stock: 10 }],
            customers: [{ id: 1, name: 'عميل نقدي', phone: '', address: '', company: '', vat: '' }],
            suppliers: [{ id: 1, name: 'مورد عام', phone: '', address: '', company: '', vat: '' }],
            installments: [],
            returns: [],
            sales: [],
            purchases: []
        };

        let currentCart = [];
        let currentPurCart = [];
        let currentInvoiceToPrint = null;

        // --- 2. Initialization ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            if (u === 'admin' && p === '123') {
                document.getElementById('login-modal').classList.add('hidden');
                init();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        async function init() {
            showSection('dashboard');
            showToast('جاري تحميل البيانات من السيرفر...', 'info');
            try {
                const doc = await dbFirestore.collection('app_data').doc('main_db').get();
                if (doc.exists) {
                    db = doc.data();
                    // Ensure structure integrity if fields are missing
                    if (!db.users) db.users = [{ id: 1, name: 'Admin', role: 'admin' }];
                    if (!db.suppliers) db.suppliers = [{ id: 1, name: 'مورد عام' }];
                    if (!db.products) db.products = [];
                    if (!db.chartOfAccounts) db.chartOfAccounts = []; // Should ideally be full chart, but empty prevents crash
                    if (!db.purchases) db.purchases = [];
                    if (!db.settings.paymentMethods) db.settings.paymentMethods = ['Cash', 'Bank', 'Wallet', 'InstaPay'];
                    if (!db.installments) db.installments = [];
                    if (!db.returns) db.returns = [];
                    if (!db.settings.logo) db.settings.logo = '';
                    if (!db.services) db.services = [];
                    // Structural updates
                    db.customers.forEach(c => { if (c.address === undefined) c.address = ''; if (c.company === undefined) c.company = ''; if (c.vat === undefined) c.vat = ''; });
                    db.suppliers.forEach(s => { if (s.address === undefined) s.address = ''; if (s.company === undefined) s.company = ''; });
                    showToast('تم تحميل البيانات بنجاح');
                } else {
                    // Initialize default data if new
                    addJournalEntry(new Date().toISOString().split('T')[0], 'قيد افتتاحي: رأس المال', [
                        { code: '1101', dr: 50000, cr: 0 },
                        { code: '3101', dr: 0, cr: 50000 }
                    ]);
                    save(); // Save initial state to Firebase
                }
            } catch (error) {
                console.error("Error loading data:", error);
                showToast('خطأ في الاتصال بقاعدة البيانات', 'error');
                // Fallback to local if needed, or just stay empty
            }

            // Set Default Dates for Reports (This Month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            if (document.getElementById('rpt-start-date')) document.getElementById('rpt-start-date').valueAsDate = firstDay;
            if (document.getElementById('rpt-end-date')) document.getElementById('rpt-end-date').valueAsDate = today;
            if (document.getElementById('pur-date')) document.getElementById('pur-date').valueAsDate = today;

            try { loadSettingsToForm(); } catch (e) { console.error('Error loading settings', e); }
            try { populateSelects(); } catch (e) { console.error('Error populating selects', e); }
            try { renderUsersTable(); } catch (e) { console.error('Error rendering users', e); }
            try { renderSuppliersTable(); } catch (e) { console.error('Error rendering suppliers', e); }
            try { renderCustomersTable(); } catch (e) { console.error('Error rendering customers', e); }
            try { updateLogoView(); } catch (e) { console.error('Error updating logo', e); }
            renderAll();

            document.getElementById('journal-lines').innerHTML = '';
            addJournalLineRow(); addJournalLineRow();

            document.getElementById('header-date').innerText = new Date().toLocaleDateString('ar-EG');
            showSection('dashboard');
        }

        async function save() {
            // Save to Firestore
            // localStorage.setItem('erp_pro_v10', JSON.stringify(db)); // Backup local
            await dbFirestore.collection('app_data').doc('main_db').set(db).catch(e => console.error(e));
            renderAll();
        }

        // --- 3. User Management ---
        function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const name = document.getElementById('user-name').value;
            const role = document.getElementById('user-role').value;
            const phone = document.getElementById('user-phone').value;

            if (id) { // Edit
                const user = db.users.find(u => u.id == id);
                if (user) { user.name = name; user.role = role; user.phone = phone; }
                showToast('تم تعديل المستخدم');
            } else { // New
                db.users.push({ id: Date.now(), name, role, phone });
                showToast('تم إضافة المستخدم');
            }
            save(); renderUsersTable(); populateSelects(); resetUserForm();
        }

        function deleteUser(id) {
            if (confirm('حذف المستخدم؟')) {
                db.users = db.users.filter(u => u.id !== id);
                save(); renderUsersTable(); populateSelects();
            }
        }

        function editUser(id) {
            const user = db.users.find(u => u.id == id);
            if (user) {
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-name').value = user.name;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-phone').value = user.phone || '';
                document.getElementById('user-form-title').innerText = 'تعديل مستخدم';
            }
        }

        function resetUserForm() {
            document.getElementById('user-id').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-phone').value = '';
            document.getElementById('user-form-title').innerText = 'إضافة مستخدم';
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = db.users.map(u => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-3 font-bold">${u.name}</td>
                    <td class="p-3"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">${u.role === 'admin' ? 'مدير' : 'موظف'}</span></td>
                    <td class="p-3 text-slate-500 text-xs">${u.phone || '-'}</td>
                    <td class="p-3 flex gap-2">
                        <button onclick="editUser(${u.id})" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteUser(${u.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            const userSelect = document.getElementById('current-user-select');
            userSelect.innerHTML = db.users.map(u => `<option value="${u.id}" ${u.id == db.currentUser ? 'selected' : ''}>${u.name}</option>`).join('');
        }

        function filterUsers(query) {
            const rows = document.querySelectorAll('#users-list tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function switchUser(id) {
            db.currentUser = parseInt(id);
            save();
            showToast(`مرحباً, ${db.users.find(u => u.id == id).name}`);
        }

        // --- 4. Product Management (With Edit) ---
        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('prod-id').value;
            const name = document.getElementById('new-prod-name').value;
            const price = parseFloat(document.getElementById('new-prod-price').value);
            const cost = parseFloat(document.getElementById('new-prod-cost').value) || 0;
            const stock = parseFloat(document.getElementById('new-prod-stock').value) || 0;

            if (id) {
                const prod = db.products.find(p => p.id == id);
                if (prod) { prod.name = name; prod.price = price; prod.cost = cost; prod.stock = stock; }
                showToast('تم تعديل المنتج');
            } else {
                const newId = Date.now();
                db.products.push({ id: newId, name, price, cost, stock });
                if (stock > 0) {
                    addJournalEntry(new Date().toISOString().split('T')[0], `رصيد افتتاحي: ${name}`, [
                        { code: '1104', dr: stock * cost, cr: 0 }, { code: '3101', dr: 0, cr: stock * cost }
                    ]);
                }
                showToast('تم إضافة المنتج');
            }
            save(); populateSelects(); resetProductForm();
        }

        function editProduct(id) {
            const prod = db.products.find(p => p.id == id);
            if (prod) {
                document.getElementById('prod-id').value = prod.id;
                document.getElementById('new-prod-name').value = prod.name;
                document.getElementById('new-prod-price').value = prod.price;
                document.getElementById('new-prod-cost').value = prod.cost;
                document.getElementById('new-prod-stock').value = prod.stock;
                document.getElementById('prod-form-title').innerText = 'تعديل صنف';
            }
        }

        function deleteProduct(id) {
            if (confirm('حذف المنتج؟')) {
                db.products = db.products.filter(p => p.id !== id);
                save(); populateSelects();
            }
        }

        function resetProductForm() {
            document.getElementById('prod-id').value = '';
            document.getElementById('new-prod-name').value = '';
            document.getElementById('new-prod-price').value = '';
            document.getElementById('new-prod-cost').value = '';
            document.getElementById('new-prod-stock').value = '';
            document.getElementById('prod-form-title').innerText = 'إضافة صنف جديد';
        }

        function filterInventory(query) {
            const rows = document.querySelectorAll('#inventory-list tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // --- 5. Invoice Modal & View ---
        function viewInvoice(id) {
            const inv = db.sales.find(s => s.id == id);
            if (!inv) return;
            currentInvoiceToPrint = inv;

            const modal = document.getElementById('invoice-modal');
            const body = document.getElementById('invoice-modal-body');

            body.innerHTML = `
                <div class="text-center mb-4">
                    <h2 class="font-bold text-xl text-slate-800">${db.settings.companyName}</h2>
                    <p class="text-sm text-slate-500">فاتورة #${inv.id}</p>
                    ${db.settings.logo ? `<img src="${db.settings.logo}" class="h-16 mx-auto my-2">` : ''}
                    <p class="text-xs text-slate-400">${inv.date}</p>
                </div>
                <div class="mb-4 text-sm">
                    <p><strong>العميل:</strong> ${inv.customer}</p>
                    <p><strong>الموظف:</strong> ${db.users.find(u => u.id == inv.by)?.name || 'غير معروف'}</p>
                </div>
                <table class="w-full text-sm border-collapse mb-4">
                    <thead class="bg-slate-100"><tr><th class="p-2 text-right">الصنف</th><th class="p-2 text-center">الكمية</th><th class="p-2 text-center">السعر</th><th class="p-2 text-center">الإجمالي</th></tr></thead>
                    <tbody class="divide-y">
                        ${inv.items.map(i => `<tr><td class="p-2">${i.name}</td><td class="p-2 text-center">${i.qty}</td><td class="p-2 text-center">${i.price}</td><td class="p-2 text-center">${i.total.toFixed(2)}</td></tr>`).join('')}
                    </tbody>
                </table>
                <div class="flex justify-between items-center font-bold text-lg border-t pt-2">
                    <span>الإجمالي النهائي:</span>
                    <span>${inv.total.toFixed(2)} ${db.settings.currency}</span>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('invoice-modal').classList.remove('active');
        }

        function printCurrentModalInvoice() {
            if (currentInvoiceToPrint) printInvoice(currentInvoiceToPrint);
        }

        // --- 6. Accounting Engine ---
        function getAccountBalance(code) {
            const acc = db.chartOfAccounts.find(a => a.code === code);
            if (!acc) return 0;
            if (!acc.isGroup) return acc.balance;
            const children = db.chartOfAccounts.filter(a => a.parent === code);
            return children.reduce((sum, child) => sum + getAccountBalance(child.code), 0);
        }

        function addJournalEntry(date, desc, lines) {
            const totalDr = lines.reduce((s, l) => s + (l.dr || 0), 0);
            const totalCr = lines.reduce((s, l) => s + (l.cr || 0), 0);

            if (Math.abs(totalDr - totalCr) > 0.01) {
                showToast(`خطأ: القيد غير متزن`, 'error');
                return false;
            }

            const entryId = db.journal.length + 1;
            const userName = db.users.find(u => u.id == db.currentUser)?.name || 'System';

            db.journal.push({ id: entryId, date, desc: desc + ` (بواسطة: ${userName})`, lines });

            lines.forEach(line => {
                const acc = db.chartOfAccounts.find(a => a.code === line.code);
                if (acc && !acc.isGroup) {
                    if (acc.type === 'asset' || acc.type === 'expense') acc.balance += ((line.dr || 0) - (line.cr || 0));
                    else acc.balance += ((line.cr || 0) - (line.dr || 0));
                }
            });

            save();
            return true;
        }

        // --- 7. Operations ---
        function populateSelects() {
            const accounts = db.chartOfAccounts.filter(a => !a.isGroup);
            const salesAccs = accounts.filter(a => ['1101', '1102'].includes(a.code) || a.parent === '11').map(a => `<option value="${a.code}">${a.name}</option>`).join('');
            document.getElementById('sale-account').innerHTML = salesAccs;
            document.getElementById('sale-method').innerHTML = (db.settings.paymentMethods || ['Cash']).map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('pur-method').innerHTML = (db.settings.paymentMethods || ['Cash']).map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('sale-product').innerHTML = '<option value="">اختر منتج...</option>' + db.products.map(p => `<option value="${p.id}">${p.name} (${p.price})</option>`).join('');
            document.getElementById('sale-customer').innerHTML = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('inst-product').innerHTML = '<option value="">اختر منتج...</option>' + db.products.map(p => `<option value="${p.id}">${p.name} (${p.price})</option>`).join('');
            document.getElementById('inst-customer').innerHTML = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('inst-method').innerHTML = (db.settings.paymentMethods || ['Cash']).map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('pur-supplier').innerHTML = db.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('pur-product').innerHTML = '<option value="">اختر منتج...</option>' + db.products.map(p => `<option value="${p.id}" data-cost="${p.cost}">${p.name}</option>`).join('');
        }

        function addToCart() {
            const prodId = document.getElementById('sale-product').value;
            const qty = parseInt(document.getElementById('sale-qty').value);
            const prod = db.products.find(p => p.id == prodId);

            if (!prod) return showToast('اختر منتجاً', 'error');
            if (prod.stock < qty) return showToast('الرصيد غير كافٍ', 'error');

            const item = { ...prod, qty, total: prod.price * qty };
            currentCart.push(item);
            renderCart();
        }

        function renderCart() {
            const tbody = document.getElementById('cart-body');
            tbody.innerHTML = '';
            let subtotal = 0;
            currentCart.forEach((item, idx) => {
                subtotal += item.total;
                tbody.innerHTML += `
                    <tr class="bg-white"><td class="p-2">${item.name}</td><td class="p-2 font-bold">${item.qty}</td><td class="p-2">${item.price}</td><td class="p-2">${item.total}</td>
                    <td class="p-2"><button onclick="currentCart.splice(${idx},1);renderCart()" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
            });

            if (currentCart.length > 0) document.getElementById('cart-empty').classList.add('hidden');
            else document.getElementById('cart-empty').classList.remove('hidden');

            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const net = Math.max(0, subtotal - discount);
            const vat = net * (db.settings.vatRate / 100);
            const total = net + vat;

            document.getElementById('cart-subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('cart-vat').innerText = vat.toFixed(2);
            document.getElementById('cart-total').innerText = total.toFixed(2);

            if (!document.getElementById('sale-paid').value && total > 0) document.getElementById('sale-paid').value = total.toFixed(2);
        }

        // --- Returns Logic ---
        function toggleSaleMode() {
            const isRet = document.getElementById('is-return-sale').checked;
            document.getElementById('sale-title').innerText = isRet ? 'مرتجع مبيعات' : 'فاتورة مبيعات';
            document.getElementById('sale-mode-badge').classList.toggle('hidden', !isRet);
            document.getElementById('sale-header-sec').classList.toggle('bg-red-50', isRet);
        }
        function togglePurMode() {
            const isRet = document.getElementById('is-return-pur').checked;
            document.getElementById('pur-title').innerText = isRet ? 'مرتجع مشتريات' : 'فاتورة مشتريات';
            document.getElementById('pur-mode-badge').classList.toggle('hidden', !isRet);
        }

        // Updated postSale to handle Returns
        function postSale() {
            if (currentCart.length === 0) return showToast('السلة فارغة', 'error');

            const custId = document.getElementById('sale-customer').value;
            const customer = db.customers.find(c => c.id == custId);
            const date = new Date().toISOString().split('T')[0];
            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const paid = parseFloat(document.getElementById('sale-paid').value) || 0;
            const method = document.getElementById('sale-method').value;
            const isReturn = document.getElementById('is-return-sale').checked;

            let totalSale = 0, totalCost = 0;
            currentCart.forEach(i => { totalSale += i.total; totalCost += (i.cost * i.qty); });

            const netSale = totalSale - discount; // Logic for return? Discount usually 0 in return or proportional.
            const vatAmount = netSale * (db.settings.vatRate / 100);
            const grandTotal = netSale + vatAmount;

            const lines = [];

            if (isReturn) {
                // Return Logic
                // Dr Sales Return / Inventory / VAT
                // Cr Cash / Customer / COGS

                // 1. Refund Cash/Credit Customer
                if (paid > 0) lines.push({ code: method || '1101', dr: 0, cr: paid }); // Cash Cr
                const remaining = grandTotal - paid; // Remaining to credit to customer account
                if (remaining > 0.01) lines.push({ code: '1103', dr: 0, cr: remaining }); // Customer Cr

                // 2. Debit Sales Return & VAT
                lines.push({ code: '4101', dr: netSale, cr: 0 }); // Sales Dr (Contra)
                lines.push({ code: '2102', dr: vatAmount, cr: 0 }); // VAT Dr

                // 3. Inventory & COGS
                lines.push({ code: '1104', dr: totalCost, cr: 0 }); // Inventory Dr (Stock Up)
                lines.push({ code: '5101', dr: 0, cr: totalCost }); // COGS Cr (Expense Down)

                if (addJournalEntry(date, `مرتجع مبيعات - ${customer.name}`, lines)) {
                    currentCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) p.stock += i.qty; }); // Increase Stock
                    db.returns.push({ id: Date.now(), date, type: 'sale', customer: customer.name, total: grandTotal, items: [...currentCart] });
                    showToast('تم حفظ المرتجع');
                }
            } else {
                // ... Existing Sale Logic ...
                const remaining = grandTotal - paid;
                // Assuming '1101' is Cash if method not found
                lines.push({ code: '1101', dr: paid, cr: 0 });

                if (remaining > 0.01) lines.push({ code: '1103', dr: remaining, cr: 0 }); // Customer Account
                if (discount > 0) lines.push({ code: '5201', dr: discount, cr: 0 }); // Discount Allowed
                lines.push({ code: '5101', dr: totalCost, cr: 0 });

                lines.push({ code: '4101', dr: 0, cr: totalSale });
                lines.push({ code: '2102', dr: 0, cr: vatAmount });
                lines.push({ code: '1104', dr: 0, cr: totalCost });

                if (addJournalEntry(date, `فاتورة - ${customer.name}`, lines)) {
                    currentCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) p.stock -= i.qty; });
                    db.sales.push({ id: Date.now(), date, customer: customer.name, total: grandTotal, paid, discount, remaining, method, by: db.currentUser, items: [...currentCart] });
                    printInvoice(db.sales[db.sales.length - 1]);
                    showToast('تم الحفظ بنجاح');
                }
            }
            // Reset
            currentCart = []; renderCart();
            document.getElementById('sale-discount').value = 0;
            document.getElementById('sale-paid').value = '';
            // Don't uncheck return mode automatically? Maybe better to keep it unchecked for safety.
            document.getElementById('is-return-sale').checked = false; toggleSaleMode();
        }

        // Updated postPurchase to handle Returns
        function postPurchase() {
            if (currentPurCart.length === 0) return showToast('السلة فارغة', 'error');

            const suppId = document.getElementById('pur-supplier').value;
            const supplier = db.suppliers.find(s => s.id == suppId);
            const date = document.getElementById('pur-date').value;
            const discount = parseFloat(document.getElementById('pur-discount').value) || 0;
            const method = document.getElementById('pur-method').value;
            const paid = parseFloat(document.getElementById('pur-paid').value) || 0;
            const isReturn = document.getElementById('is-return-pur').checked;

            let totalCost = 0;
            currentPurCart.forEach(i => totalCost += i.total);
            const netCost = totalCost - discount;
            const vatAmount = netCost * 0.15;
            const grandTotal = netCost + vatAmount;

            const lines = [];

            if (isReturn) {
                // Return Logic: Dr Cash/Supplier, Cr Inventory/VAT
                const remaining = grandTotal - paid;
                if (paid > 0) lines.push({ code: '1101', dr: paid, cr: 0 }); // Cash Dr (Refund)
                if (remaining > 0.01) lines.push({ code: '2101', dr: remaining, cr: 0 }); // Supplier Dr (Debit Note)

                lines.push({ code: '1104', dr: 0, cr: totalCost }); // Inventory Cr (Stock Down)
                lines.push({ code: '2102', dr: 0, cr: vatAmount }); // VAT Cr (Liability Up? No, Purchase VAT is Asset. Credit reduces Asset. Correct.)
                // Wait, if VAT Input is Asset (1xxx), Credit reduces it. If 2102 is Liability, Debit reduces it.
                // We used 2102 for Output VAT (Liability).
                // And for Purchase, we Debit 2102 (Reducing Liability... or treating as asset).
                // If we treat 2102 as "Net VAT Liability":
                // Sale: Credit 2102 (Increase Liability).
                // Purchase: Debit 2102 (Decrease Liability).
                // Purchase Return: Credit 2102 (Increase Liability/Reverse Debit). Correct.

                if (addJournalEntry(date, `مرتجع مشتريات - ${supplier.name}`, lines)) {
                    currentPurCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) { p.stock -= i.qty; } });
                    db.returns.push({ id: Date.now(), date, type: 'purchase', supplier: supplier.name, total: grandTotal, items: [...currentPurCart] });
                    showToast('تم حفظ المرتجع');
                }
            } else {
                const remaining = grandTotal - paid;
                lines.push({ code: '1104', dr: totalCost, cr: 0 });
                lines.push({ code: '2102', dr: vatAmount, cr: 0 });

                if (discount > 0) lines.push({ code: '5201', dr: 0, cr: discount });
                if (paid > 0) lines.push({ code: '1101', dr: 0, cr: paid });
                if (remaining > 0.01) lines.push({ code: '2101', dr: 0, cr: remaining });

                if (addJournalEntry(date, `فاتورة مشتريات - ${supplier.name} (${method})`, lines)) {
                    currentPurCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) { p.stock += i.qty; p.cost = i.cost; } });
                    db.purchases.push({ id: Date.now(), date, supplier: supplier.name, total: grandTotal, paid, discount, remaining, method, items: [...currentPurCart] });
                    showToast('تم حفظ المشتريات');
                }
            }

            currentPurCart = []; renderPurCart();
            document.getElementById('pur-paid').value = '';
            document.getElementById('pur-discount').value = '0';
            document.getElementById('is-return-pur').checked = false; togglePurMode();
            renderAll();
        }

        function printInvoice(inv) {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div class="text-center mb-6">
                    ${db.settings.logo ? `<img src="${db.settings.logo}" style="height: 80px; margin: 0 auto 10px auto; display: block;">` : ''}
                    <h1 class="text-2xl font-bold">${db.settings.companyName}</h1>
                    <p class="text-sm">${db.settings.address} - ${db.settings.phone}</p>
                    <p class="text-sm">الرقم الضريبي: ${db.settings.vatNumber}</p>
                </div>
                <div class="flex justify-between border-b pb-4 mb-4">
                    <div class="text-right">
                        <p><strong>فاتورة ضريبية</strong></p>
                        <p>العميل: ${inv.customer}</p>
                    </div>
                    <div class="text-left">
                        <p>التاريخ: ${inv.date}</p>
                        <p>رقم: #${inv.id}</p>
                    </div>
                </div>
                <table class="w-full text-sm mb-6 border-collapse border border-black">
                    <thead><tr class="bg-gray-100"><th class="border border-black p-2">الصنف</th><th class="border border-black p-2">الكمية</th><th class="border border-black p-2">السعر</th><th class="border border-black p-2">الإجمالي</th></tr></thead>
                    <tbody>
                        ${inv.items.map(i => `<tr><td class="border border-black p-2">${i.name}</td><td class="border border-black p-2">${i.qty}</td><td class="border border-black p-2">${i.price}</td><td class="border border-black p-2">${i.total.toFixed(2)}</td></tr>`).join('')}
                    </tbody>
                </table>
                <div class="text-left font-bold text-lg">الإجمالي: ${inv.total.toFixed(2)} ${db.settings.currency}</div>
            `;
            window.print();
        }

        // --- 7.1 Purchases Logic ---
        function updatePurCost(select) {
            const opt = select.options[select.selectedIndex];
            if (opt && opt.dataset.cost) document.getElementById('pur-cost').value = opt.dataset.cost;
        }

        function addToPurCart() {
            const prodId = document.getElementById('pur-product').value;
            const qty = parseFloat(document.getElementById('pur-qty').value);
            const cost = parseFloat(document.getElementById('pur-cost').value);
            const prod = db.products.find(p => p.id == prodId);

            if (!prod || !qty || !cost) return showToast('بيانات ناقصة', 'error');

            const item = { ...prod, qty, cost, total: cost * qty };
            currentPurCart.push(item);
            renderPurCart();
        }

        function renderPurCart() {
            const tbody = document.getElementById('pur-cart-body');
            tbody.innerHTML = '';
            let subtotal = 0;
            currentPurCart.forEach((item, idx) => {
                subtotal += item.total;
                tbody.innerHTML += `
                    <tr class="bg-white"><td class="p-2">${item.name}</td><td class="p-2 font-bold">${item.qty}</td><td class="p-2">${item.cost}</td><td class="p-2">${item.total.toFixed(2)}</td>
                    <td class="p-2"><button onclick="currentPurCart.splice(${idx},1);renderPurCart()" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
            });
            const discount = parseFloat(document.getElementById('pur-discount').value) || 0;
            const net = Math.max(0, subtotal - discount);
            const vat = net * 0.15;
            const total = net + vat;

            document.getElementById('pur-subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('pur-vat').innerText = vat.toFixed(2);
            document.getElementById('pur-total').innerText = total.toFixed(2);

            if (!document.getElementById('pur-paid').value && total > 0) document.getElementById('pur-paid').value = total.toFixed(2);
        }







        // --- 7.1 Inventory Logic ---
        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('prod-id').value;
            const name = document.getElementById('new-prod-name').value;
            const price = parseFloat(document.getElementById('new-prod-price').value);
            const cost = parseFloat(document.getElementById('new-prod-cost').value) || 0;
            const stock = parseFloat(document.getElementById('new-prod-stock').value) || 0;

            if (id) {
                const p = db.products.find(x => x.id == id);
                if (p) { p.name = name; p.price = price; p.cost = cost; p.stock = stock; }
            } else {
                db.products.push({ id: Date.now(), name, price, cost, stock });
            }
            save(); filterInventory(''); resetProductForm(); showToast('تم حفظ المنتج');
        }

        function filterInventory(q) {
            const list = document.getElementById('inventory-list');
            if (!list) return;
            const filtered = db.products.filter(p => p.name.includes(q));
            list.innerHTML = filtered.map(p => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 font-bold">${p.name}</td><td class="p-3 text-emerald-600">${p.price}</td><td class="p-3 text-slate-500">${p.cost}</td><td class="p-3 font-bold">${p.stock}</td>
                    <td class="p-3 flex gap-2"><button onclick="editProduct(${p.id})" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="deleteProduct(${p.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }

        function editProduct(id) {
            const p = db.products.find(x => x.id == id);
            if (p) {
                document.getElementById('prod-id').value = p.id;
                document.getElementById('new-prod-name').value = p.name;
                document.getElementById('new-prod-price').value = p.price;
                document.getElementById('new-prod-cost').value = p.cost;
                document.getElementById('new-prod-stock').value = p.stock;
                document.getElementById('prod-form-title').innerText = 'تعديل منتج';
            }
        }

        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                db.products = db.products.filter(x => x.id != id);
                save(); filterInventory(''); showToast('تم حذف المنتج');
            }
        }

        function resetProductForm() {
            document.getElementById('prod-id').value = '';
            document.getElementById('new-prod-name').value = '';
            document.getElementById('new-prod-price').value = '';
            document.getElementById('new-prod-cost').value = '';
            document.getElementById('new-prod-stock').value = '';
            document.getElementById('prod-form-title').innerText = 'إضافة صنف جديد';
        }

        // --- 7.2 Suppliers Logic ---
        function saveSupplier(e) {
            e.preventDefault();
            const name = document.getElementById('supp-name').value;
            const company = document.getElementById('supp-company').value;
            const address = document.getElementById('supp-address').value;
            const phone = document.getElementById('supp-phone').value;
            const vat = document.getElementById('supp-vat').value;

            if (id) {
                const s = db.suppliers.find(x => x.id == id);
                if (s) { s.name = name; s.company = company; s.address = address; s.phone = phone; s.vat = vat; }
            } else {
                db.suppliers.push({ id: Date.now(), name, company, address, phone, vat });
            }
            save(); renderSuppliersTable(); populateSelects(); resetSupplierForm();
        }
        function renderSuppliersTable() {
            document.getElementById('suppliers-list').innerHTML = db.suppliers.map(s => `
                <tr class="hover:bg-slate-50 border-b"><td class="p-3 font-bold">${s.name}</td><td class="p-3 text-sm text-slate-500">${s.company || '-'}</td><td class="p-3 text-sm">${s.phone || '-'}</td>
                <td class="p-3"><button onclick="editSupplier(${s.id})" class="text-blue-500 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition"><i class="fas fa-edit"></i></button></td></tr>
            `).join('');
        }
        function editSupplier(id) {
            const s = db.suppliers.find(x => x.id == id);
            if (s) {
                document.getElementById('supp-id').value = s.id;
                document.getElementById('supp-name').value = s.name;
                document.getElementById('supp-company').value = s.company || '';
                document.getElementById('supp-address').value = s.address || '';
                document.getElementById('supp-phone').value = s.phone || '';
                document.getElementById('supp-vat').value = s.vat || '';
            }
        }
        function resetSupplierForm() {
            document.getElementById('supp-id').value = '';
            document.getElementById('supp-name').value = '';
            document.getElementById('supp-company').value = '';
            document.getElementById('supp-address').value = '';
            document.getElementById('supp-phone').value = '';
            document.getElementById('supp-vat').value = '';
        }

        // --- 7.4 Customers Logic (New) ---
        function saveCustomer(e) {
            e.preventDefault();
            const id = document.getElementById('cust-id').value;
            const name = document.getElementById('cust-name').value;
            const company = document.getElementById('cust-company').value;
            const address = document.getElementById('cust-address').value;
            const phone = document.getElementById('cust-phone').value;
            const vat = document.getElementById('cust-vat').value;

            if (id) {
                const c = db.customers.find(x => x.id == id);
                if (c) { c.name = name; c.company = company; c.address = address; c.phone = phone; c.vat = vat; }
                showToast('تم تعديل العميل');
            } else {
                db.customers.push({ id: Date.now(), name, company, address, phone, vat });
                showToast('تم إضافة العميل');
            }
            save(); renderCustomersTable(); populateSelects(); resetCustomerForm();
        }

        function renderCustomersTable() {
            document.getElementById('customers-list').innerHTML = db.customers.map(c => `
                <tr class="hover:bg-slate-50 border-b"><td class="p-3 font-bold">${c.name}</td><td class="p-3 text-sm text-slate-500">${c.company || '-'}</td><td class="p-3 text-sm">${c.phone || '-'}</td>
                <td class="p-3"><button onclick="editCustomer(${c.id})" class="text-blue-500 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition"><i class="fas fa-edit"></i></button></td></tr>
            `).join('');
        }

        function editCustomer(id) {
            const c = db.customers.find(x => x.id == id);
            if (c) {
                document.getElementById('cust-id').value = c.id;
                document.getElementById('cust-name').value = c.name;
                document.getElementById('cust-company').value = c.company || '';
                document.getElementById('cust-address').value = c.address || '';
                document.getElementById('cust-phone').value = c.phone || '';
                document.getElementById('cust-vat').value = c.vat || '';
            }
        }

        function resetCustomerForm() {
            document.getElementById('cust-id').value = '';
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-company').value = '';
            document.getElementById('cust-address').value = '';
            document.getElementById('cust-phone').value = '';
            document.getElementById('cust-vat').value = '';
        }

        // --- 7.3 Salaries Logic ---
        function paySalary() {
            const name = document.getElementById('sal-emp-name').value;
            const amount = parseFloat(document.getElementById('sal-amount').value);
            const method = document.getElementById('sal-method').value;

            if (!name || !amount) return showToast('أدخل البيانات', 'error');

            const lines = [
                { code: '5202', dr: amount, cr: 0 }, // Salaries Expense
                { code: method, dr: 0, cr: amount }  // Cash/Bank
            ];
            if (addJournalEntry(new Date().toISOString().split('T')[0], `صرف راتب: ${name}`, lines)) {
                document.getElementById('sal-amount').value = '';
                showToast('تم صرف الراتب');
            }
        }

        // --- 8. Charts & Reports ---
        function renderSalesChart() {
            // Simple bar chart for last 7 days sales
            const container = document.getElementById('sales-chart');
            container.innerHTML = '';
            const last7Days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toISOString().split('T')[0];
            }).reverse();

            const maxSale = Math.max(...last7Days.map(d => db.sales.filter(s => s.date === d).reduce((sum, s) => sum + s.total, 0))) || 100;

            last7Days.forEach(date => {
                const daySales = db.sales.filter(s => s.date === date).reduce((sum, s) => sum + s.total, 0);
                const height = (daySales / maxSale) * 100;

                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${height}%`;
                bar.innerHTML = `
                    <span class="chart-value">${daySales > 0 ? daySales : ''}</span>
                    <span class="chart-label">${date.slice(5)}</span>
                `;
                container.appendChild(bar);
            });
        }

        // --- 9. Manual Journal & Settings UI (Same as before) ---
        function addJournalLineRow() {
            const div = document.createElement('div'); div.className = 'grid grid-cols-12 gap-2 j-row mb-2';
            const opts = db.chartOfAccounts.filter(a => !a.isGroup).map(a => `<option value="${a.code}">${a.code} - ${a.name}</option>`).join('');
            div.innerHTML = `<div class="col-span-6"><select class="w-full p-2 border rounded text-sm j-code">${opts}</select></div><div class="col-span-2"><input type="number" class="w-full p-2 border rounded text-sm j-dr" placeholder="0" onchange="calcJTotals()"></div><div class="col-span-2"><input type="number" class="w-full p-2 border rounded text-sm j-cr" placeholder="0" onchange="calcJTotals()"></div><div class="col-span-2"><button onclick="this.parentElement.remove();calcJTotals()" class="text-red-500 w-full"><i class="fas fa-times"></i></button></div>`;
            document.getElementById('journal-lines').appendChild(div);
        }
        function calcJTotals() {
            let dr = 0, cr = 0; document.querySelectorAll('.j-dr').forEach(i => dr += parseFloat(i.value || 0)); document.querySelectorAll('.j-cr').forEach(i => cr += parseFloat(i.value || 0));
            document.getElementById('total-dr').innerText = dr.toFixed(2); document.getElementById('total-cr').innerText = cr.toFixed(2);
            document.getElementById('unbalanced-msg').classList.toggle('hidden', Math.abs(dr - cr) <= 0.01);
        }
        function saveManualJournal() {
            const desc = document.getElementById('manual-desc').value; const date = document.getElementById('manual-date').value;
            const lines = []; document.querySelectorAll('.j-row').forEach(row => { const c = row.querySelector('.j-code').value, d = parseFloat(row.querySelector('.j-dr').value || 0), r = parseFloat(row.querySelector('.j-cr').value || 0); if (d > 0 || r > 0) lines.push({ code: c, dr: d, cr: r }); });
            if (lines.length < 2 || !desc) return showToast('بيانات ناقصة', 'error');
            if (addJournalEntry(date, desc, lines)) { showToast('تم الترحيل'); document.getElementById('journal-lines').innerHTML = ''; addJournalLineRow(); addJournalLineRow(); document.getElementById('manual-desc').value = ''; calcJTotals(); }
        }

        function saveSettings(e) {
            e.preventDefault();
            db.settings.companyName = document.getElementById('set-name').value;
            db.settings.vatRate = parseFloat(document.getElementById('set-vat-rate').value);
            db.settings.currency = document.getElementById('set-currency').value;
            db.settings.phone = document.getElementById('set-phone').value;
            db.settings.address = document.getElementById('set-address').value;
            db.settings.vatNumber = document.getElementById('set-vat-no').value;
            db.settings.logo = document.getElementById('set-logo-url').value;

            save();
            loadSettingsToForm();
            updateLogoView();
            showToast('تم الحفظ');
        }

        function addPaymentMethod() {
            const val = document.getElementById('new-pay-method').value.trim();
            if (val && !db.settings.paymentMethods.includes(val)) {
                db.settings.paymentMethods.push(val);
                save(); renderPaymentMethods();
                document.getElementById('new-pay-method').value = '';
            }
        }

        function deletePaymentMethod(m) {
            if (confirm('حذف طريقة الدفع؟')) {
                db.settings.paymentMethods = db.settings.paymentMethods.filter(x => x !== m);
                save(); renderPaymentMethods();
            }
        }

        function renderPaymentMethods() {
            if (!db.settings.paymentMethods) db.settings.paymentMethods = ['Cash', 'Bank'];
            const list = document.getElementById('payment-methods-list');
            if (list) {
                list.innerHTML = db.settings.paymentMethods.map(m => `
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs flex items-center gap-1 font-bold">
                        ${m} <button onclick="deletePaymentMethod('${m}')" class="text-red-500 hover:text-red-700 ml-1 bg-white rounded-full w-4 h-4 flex items-center justify-center"><i class="fas fa-times text-[10px]"></i></button>
                    </span>
                `).join('');
            }
        }

        function loadSettingsToForm() { document.getElementById('set-name').value = db.settings.companyName; document.getElementById('set-vat-rate').value = db.settings.vatRate; document.getElementById('set-currency').value = db.settings.currency; document.getElementById('set-phone').value = db.settings.phone; document.getElementById('set-address').value = db.settings.address; document.getElementById('set-vat-no').value = db.settings.vatNumber; document.getElementById('set-logo-url').value = db.settings.logo || ''; document.getElementById('header-company-name').innerText = db.settings.companyName; document.querySelectorAll('.currency').forEach(el => el.setAttribute('data-curr', db.settings.currency)); document.getElementById('cart-vat-rate').innerText = db.settings.vatRate; renderPaymentMethods(); }
        function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); a.download = "erp_backup.json"; document.body.appendChild(a); a.click(); a.remove(); }
        function importData(inp) { const f = inp.files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { try { db = JSON.parse(e.target.result); save(); location.reload() } catch (x) { alert('خطأ') } }; r.readAsText(f); }
        function resetData() { if (confirm('تأكيد التصفير؟')) { localStorage.removeItem('erp_pro_v10'); location.reload(); } }

        function updateLogoView() {
            const logoImg = document.getElementById('sidebar-logo-img');
            const defIcon = document.getElementById('default-logo-icon');
            if (db.settings.logo) {
                logoImg.src = db.settings.logo;
                logoImg.classList.remove('hidden');
                defIcon.classList.add('hidden');
            } else {
                logoImg.classList.add('hidden');
                defIcon.classList.remove('hidden');
            }
        }

        // --- 10. Rendering ---
        function renderAll() {
            // Balances
            const getBal = code => getAccountBalance(code);
            document.getElementById('dash-cash').innerText = (getBal('1101') + getBal('1102')).toFixed(2);
            document.getElementById('dash-sales').innerText = getBal('4101').toFixed(2);
            const exp = getBal('5'), rev = getBal('4');
            document.getElementById('dash-expenses').innerText = exp.toFixed(2);
            document.getElementById('dash-net-profit').innerText = (rev - exp).toFixed(2);

            renderJournal();
            renderInstallments();
            renderInstallments();
            renderServices();
            renderExpenses();
            renderPOSProducts();
            renderEmployees();
            updateChart();
            document.getElementById('dash-net-profit').innerText = (rev - exp).toFixed(2);

            // Lists
            document.getElementById('dash-journal-list').innerHTML = db.journal.slice().reverse().slice(0, 5).map(e => `<tr><td class="p-2">#${e.id}</td><td class="p-2">${e.date}</td><td class="p-2">${e.desc}</td><td class="p-2 font-bold">${(e.lines[0].dr || e.lines[0].cr).toFixed(2)}</td></tr>`).join('');

            document.getElementById('inventory-list').innerHTML = db.products.map(p => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-3 font-bold">${p.name}</td><td class="p-3 text-emerald-600">${p.price}</td><td class="p-3 text-slate-500">${p.cost}</td><td class="p-3 font-bold">${p.stock}</td>
                    <td class="p-3 flex gap-2"><button onclick="editProduct(${p.id})" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="deleteProduct(${p.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');

            document.getElementById('recent-invoices').innerHTML = db.sales.slice().reverse().slice(0, 10).map(inv => `
                <div class="p-2 bg-slate-50 rounded border text-xs cursor-pointer hover:bg-blue-50" onclick="viewInvoice(${inv.id})">
                    <div class="flex justify-between font-bold"><span>#${inv.id}</span><span>${inv.total.toFixed(2)}</span></div>
                    <div class="text-slate-500">${inv.customer}</div>
                </div>`).join('');

            document.getElementById('recent-purchases').innerHTML = db.purchases.slice().reverse().slice(0, 10).map(p => `
                <div class="p-2 bg-slate-50 rounded border text-xs mb-2">
                    <div class="flex justify-between font-bold"><span>${p.supplier}</span><span>${p.total.toFixed(2)}</span></div>
                    <div class="text-slate-400 text-[10px]">${p.date}</div>
                </div>`).join('');

            document.getElementById('coa-body').innerHTML = db.chartOfAccounts.map(a => `<tr class="border-b"><td class="p-3 font-mono level-${a.level}">${a.code}</td><td class="p-3 level-${a.level}">${a.name}</td><td class="p-3 text-xs">${a.type}</td><td class="p-3 font-bold ${getAccountBalance(a.code) < 0 ? 'text-red-500' : 'text-emerald-600'}">${getAccountBalance(a.code).toFixed(2)}</td></tr>`).join('');

            renderSalesChart();
            renderReports(); // Initial render with date filter
        }

        function renderReports() {
            // Apply Date Filter logic here for reports (IS)
            const from = new Date(document.getElementById('rpt-start-date').value);
            const to = new Date(document.getElementById('rpt-end-date').value);
            to.setHours(23, 59, 59); // End of day

            // Filter journal entries by date
            const filteredJournal = db.journal.filter(e => {
                const d = new Date(e.date);
                return d >= from && d <= to;
            });

            // Calculate balances from filtered journal
            let tempBalances = {};
            db.chartOfAccounts.forEach(a => tempBalances[a.code] = 0);

            filteredJournal.forEach(e => {
                e.lines.forEach(l => {
                    const acc = db.chartOfAccounts.find(a => a.code === l.code);
                    if (acc) {
                        if (acc.type === 'asset' || acc.type === 'expense') tempBalances[l.code] += ((l.dr || 0) - (l.cr || 0));
                        else tempBalances[l.code] += ((l.cr || 0) - (l.dr || 0));
                    }
                });
            });

            // Aggregate Groups
            const getFilteredBal = (code) => {
                const acc = db.chartOfAccounts.find(a => a.code === code);
                if (!acc.isGroup) return tempBalances[code] || 0;
                const children = db.chartOfAccounts.filter(a => a.parent === code);
                return children.reduce((sum, child) => sum + getFilteredBal(child.code), 0);
            };

            const rev = getFilteredBal('4');
            const exp = getFilteredBal('5');
            const cogs = getFilteredBal('5101');

            document.getElementById('is-rev').innerText = rev.toFixed(2);
            document.getElementById('is-cogs').innerText = cogs.toFixed(2);
            document.getElementById('is-gross').innerText = (rev - cogs).toFixed(2);
            document.getElementById('is-exp').innerText = (exp - cogs).toFixed(2);
            document.getElementById('is-net').innerText = (rev - exp).toFixed(2);

            document.getElementById('rpt-sales-total').innerText = rev.toFixed(2);
            document.getElementById('rpt-pur-total').innerText = filteredJournal.reduce((sum, e) => sum + (e.desc.includes('فاتورة مشتريات') ? e.lines.find(l => l.code == '1104')?.dr || 0 : 0), 0).toFixed(2);
            document.getElementById('rpt-exp-total').innerText = (exp - cogs).toFixed(2);

            // TB (Cumulative always)
            let tbDr = 0, tbCr = 0;
            document.getElementById('trial-balance-body').innerHTML = db.chartOfAccounts.filter(a => !a.isGroup).map(a => {
                if (a.balance == 0) return '';
                let dr = 0, cr = 0;
                if (['asset', 'expense'].includes(a.type)) { if (a.balance > 0) dr = a.balance; else cr = -a.balance; }
                else { if (a.balance > 0) cr = a.balance; else dr = -a.balance; }
                tbDr += dr; tbCr += cr;
                return `<tr><td class="p-2 border-b">${a.name}</td><td class="p-2 border-b text-emerald-600">${dr ? dr.toFixed(2) : '-'}</td><td class="p-2 border-b text-red-600">${cr ? cr.toFixed(2) : '-'}</td></tr>`;
            }).join('');
            document.getElementById('tb-total-dr').innerText = tbDr.toFixed(2);
            document.getElementById('tb-total-cr').innerText = tbCr.toFixed(2);
        }


        function getAccountBalance(code) {
            const acc = db.chartOfAccounts.find(a => a.code === code);
            if (!acc) return 0;
            if (acc.isGroup) {
                return db.chartOfAccounts.filter(a => a.parent === code).reduce((sum, child) => sum + getAccountBalance(child.code), 0);
            }
            // Calc from Journal
            let bal = 0;
            db.journal.forEach(e => {
                e.lines.forEach(l => {
                    if (l.code === code) {
                        if (acc.type === 'asset' || acc.type === 'expense') bal += ((l.dr || 0) - (l.cr || 0));
                        else bal += ((l.cr || 0) - (l.dr || 0));
                    }
                });
            });
            return bal;
        }

        function renderAll() {
            // Dashboard Counters - always run these first
            try {
                const cash = getAccountBalance('1101') + getAccountBalance('1102');
                if (document.getElementById('dash-cash')) document.getElementById('dash-cash').innerText = cash.toFixed(2);
                const salesTotal = db.sales.reduce((sum, s) => sum + s.total, 0);
                if (document.getElementById('dash-sales')) document.getElementById('dash-sales').innerText = salesTotal.toFixed(2);
                const expTotal = getAccountBalance('5');
                if (document.getElementById('dash-expenses')) document.getElementById('dash-expenses').innerText = expTotal.toFixed(2);
                const income = getAccountBalance('4') - getAccountBalance('5');
                if (document.getElementById('dash-net-profit')) document.getElementById('dash-net-profit').innerText = income.toFixed(2);
            } catch (e) { console.error('Dashboard counter error:', e); }

            // Render each component independently
            try { renderUsersTable(); } catch (e) { console.error('renderUsersTable error:', e); }
            try { renderSuppliersTable(); } catch (e) { console.error('renderSuppliersTable error:', e); }
            try { renderCustomersTable(); } catch (e) { console.error('renderCustomersTable error:', e); }
            try { if (typeof updateLogoView === 'function') updateLogoView(); } catch (e) { console.error('updateLogoView error:', e); }
            try { renderSalesChart(); } catch (e) { console.error('renderSalesChart error:', e); }
            try { renderReports(); } catch (e) { console.error('renderReports error:', e); }
            try { if (typeof renderExpenses === 'function') renderExpenses(); } catch (e) { console.error('renderExpenses error:', e); }
            try { if (typeof filterInventory === 'function') filterInventory(''); } catch (e) { console.error('filterInventory error:', e); }
            try { if (typeof renderPOSProducts === 'function') renderPOSProducts(); } catch (e) { console.error('renderPOSProducts error:', e); }
            try { if (typeof renderServiceCart === 'function') renderServiceCart(); } catch (e) { console.error('renderServiceCart error:', e); }
            try { if (typeof renderServices === 'function') renderServices(); } catch (e) { console.error('renderServices error:', e); }
            try { if (typeof renderEmployees === 'function') renderEmployees(); } catch (e) { console.error('renderEmployees error:', e); }
            try { if (typeof renderPayrollHistory === 'function') renderPayrollHistory(); } catch (e) { console.error('renderPayrollHistory error:', e); }
            try { if (typeof renderInstallments === 'function') renderInstallments(); } catch (e) { console.error('renderInstallments error:', e); }
            try { if (typeof renderPaymentMethods === 'function') renderPaymentMethods(); } catch (e) { console.error('renderPaymentMethods error:', e); }

            // Update header
            try {
                if (document.getElementById('header-company-name')) document.getElementById('header-company-name').innerText = db.settings.companyName;
            } catch (e) { }
        }

        // --- Helpers ---
        function showToast(msg, type = 'success') {
            const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<i class="fas fa-${type == 'success' ? 'check' : 'times'}-circle"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300) }, 3000);
        }
        function toggleSidebar() {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay');
            if (sb.classList.contains('translate-x-full')) { sb.classList.remove('translate-x-full'); ov.classList.remove('hidden'); setTimeout(() => ov.classList.remove('opacity-0'), 10); }
            else { sb.classList.add('translate-x-full'); ov.classList.add('opacity-0'); setTimeout(() => ov.classList.add('hidden'), 300); }
        }
        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(e => e.classList.remove('active'));
            const section = document.getElementById(id);
            if (!section) { console.error('Section not found:', id); return; }
            section.classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-blue-300'));
            const btn = document.querySelector(`button[data-target="${id}"]`); if (btn) btn.classList.add('text-blue-300');
            if (window.innerWidth < 768) toggleSidebar();

            // Trigger section-specific rendering
            try {
                if (id === 'pos') renderPOSProducts();
                if (id === 'accounts_tree') renderAccountsTree();
                if (id === 'reports') renderReports();
                if (id === 'inventory') filterInventory('');
            } catch (e) { console.error('Section render error:', e); }
        }

        function renderAccountsTree() {
            const tbody = document.getElementById('coa-body');
            if (!tbody || !db.chartOfAccounts) return;
            tbody.innerHTML = db.chartOfAccounts.map(a => {
                const bal = getAccountBalance(a.code);
                const isGroup = a.isGroup ? 'font-bold bg-slate-50' : '';
                const indent = (a.level || 0) * 20;
                return `<tr class="border-b hover:bg-blue-50 ${isGroup}">
                    <td class="p-3 font-mono text-xs">${a.code}</td>
                    <td class="p-3" style="padding-right:${indent + 12}px">${a.isGroup ? '<i class="fas fa-folder-open text-yellow-500 me-1"></i>' : '<i class="fas fa-file-alt text-slate-400 me-1"></i>'}${a.name}</td>
                    <td class="p-3 text-xs text-slate-500">${a.type || ''}</td>
                    <td class="p-3 font-bold font-mono ${bal < 0 ? 'text-red-500' : 'text-emerald-600'}">${bal.toFixed(2)}</td>
                </tr>`;
            }).join('');
        }

        function filterAccounts(q) {
            const rows = document.querySelectorAll('#coa-body tr');
            rows.forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;
            let csv = [];
            const rows = table.querySelectorAll('tr');
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
                csv.push(row.join(','));
            }
            const blob = new Blob(["\uFEFF" + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- 11. Installment Module Logic ---
        function updateInstPrice(sel) {
            const opt = sel.options[sel.selectedIndex];
            if (opt) {
                const prod = db.products.find(p => p.id == sel.value);
                if (prod) {
                    document.getElementById('inst-price').value = prod.price;
                    calcInst();
                }
            }
        }

        function calcInst() {
            const price = parseFloat(document.getElementById('inst-price').value) || 0;
            const down = parseFloat(document.getElementById('inst-down').value) || 0;
            const count = parseInt(document.getElementById('inst-count').value) || 1;

            const remaining = Math.max(0, price - down);
            const monthly = count > 0 ? remaining / count : 0;

            document.getElementById('inst-monthly').value = monthly.toFixed(2);
        }

        function createInstallmentPlan() {
            const custId = document.getElementById('inst-customer').value;
            const prodId = document.getElementById('inst-product').value;
            const price = parseFloat(document.getElementById('inst-price').value) || 0;
            const down = parseFloat(document.getElementById('inst-down').value) || 0;
            const count = parseInt(document.getElementById('inst-count').value) || 12;
            const method = document.getElementById('inst-method').value;

            if (!custId || !prodId || !price) return showToast('بيانات ناقصة', 'error');

            const customer = db.customers.find(c => c.id == custId);
            const product = db.products.find(p => p.id == prodId);
            const monthly = parseFloat(document.getElementById('inst-monthly').value);
            const date = new Date();

            // Assume Price is GROSS (Inclusive of VAT)
            const netSale = price / (1 + (db.settings.vatRate / 100));
            const vat = price - netSale;
            const formattedDate = date.toISOString().split('T')[0];
            const remaining = price - down;

            const lines = [];
            if (down > 0) lines.push({ code: method || '1101', dr: down, cr: 0 });
            if (remaining > 0) lines.push({ code: '1103', dr: remaining, cr: 0 });
            lines.push({ code: '4101', dr: 0, cr: netSale });
            lines.push({ code: '2102', dr: 0, cr: vat });
            lines.push({ code: '5101', dr: product.cost, cr: 0 });
            lines.push({ code: '1104', dr: 0, cr: product.cost });

            if (addJournalEntry(formattedDate, `عقد تقسيط - ${customer.name} (${product.name})`, lines)) {
                // Generate Installments
                const saleId = Date.now();
                for (let i = 0; i < count; i++) {
                    const d = new Date(date);
                    d.setMonth(d.getMonth() + i + 1); // Next month
                    db.installments.push({
                        id: Date.now() + i,
                        saleId,
                        customerId: custId,
                        customerName: customer.name,
                        amount: monthly,
                        dueDate: d.toISOString().split('T')[0],
                        status: 'pending'
                    });
                }

                // Reduce Stock
                product.stock -= 1;
                db.sales.push({ id: saleId, date: formattedDate, customer: customer.name, total: price, paid: down, remaining: remaining, type: 'installment', items: [{ ...product, qty: 1, price: price, total: price }] });

                showToast('تم إنشاء عقد التقسيط');
                save(); renderInstallments(); renderAll();
                document.getElementById('inst-price').value = '';
                document.getElementById('inst-down').value = '';
            }
        }

        function renderInstallments() {
            if (!db.installments) db.installments = [];
            const list = document.getElementById('installments-list');
            if (list) list.innerHTML = db.installments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)).map(inst => {
                const isLate = new Date(inst.dueDate) < new Date() && inst.status === 'pending';
                const statusClass = inst.status === 'paid' ? 'text-emerald-600 bg-emerald-50' : (isLate ? 'text-red-600 bg-red-50' : 'text-slate-600');
                const statusText = inst.status === 'paid' ? 'مدفوع' : (isLate ? 'متأخر' : 'مستحق');

                return `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-3 font-bold">${inst.customerName}</td>
                        <td class="p-3 font-mono">${inst.amount.toFixed(2)}</td>
                        <td class="p-3 ${isLate ? 'text-red-600 font-bold' : ''}">${inst.dueDate}</td>
                        <td class="p-3 text-center">
                            ${inst.status === 'pending' ?
                        `<button onclick="payInstallment(${inst.id})" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 shadow">تحصيل</button>` :
                        `<span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${statusText}</span>`
                    }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function payInstallment(id) {
            if (!confirm('تأكيد تحصيل القسط؟')) return;
            const inst = db.installments.find(i => i.id == id);
            if (inst && inst.status === 'pending') {
                const date = new Date().toISOString().split('T')[0];
                const lines = [
                    { code: '1101', dr: inst.amount, cr: 0 },
                    { code: '1103', dr: 0, cr: inst.amount }
                ];
                if (addJournalEntry(date, `تحصيل قسط - ${inst.customerName}`, lines)) {
                    inst.status = 'paid';
                    inst.paidDate = date;
                    save(); renderInstallments(); renderAll();
                    showToast('تم التحصيل');
                }
            }
        }

        function filterInstallments(q) {
            const rows = document.querySelectorAll('#installments-list tr');
            rows.forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        // --- 12. Services Module Logic ---
        let currentSrvCart = [];

        function renderServices() {
            if (!db.services) db.services = [];
            const list = document.getElementById('services-list');
            if (list) list.innerHTML = db.services.map(s => `
                <tr class="hover:bg-slate-50">
                    <td class="p-2 font-bold">${s.name}</td>
                    <td class="p-2 font-mono text-emerald-600">${s.price}</td>
                    <td class="p-2"><button onclick="editService(${s.id})" class="text-blue-500"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');

            const sel = document.getElementById('srv-list');
            if (sel) sel.innerHTML = '<option value="">اختر خدمة...</option>' + db.services.map(s => `<option value="${s.id}">${s.name} (${s.price})</option>`).join('');

            const methodSel = document.getElementById('srv-method');
            if (methodSel && db.settings.paymentMethods) methodSel.innerHTML = db.settings.paymentMethods.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function saveService(e) {
            e.preventDefault();
            const id = document.getElementById('serv-id').value;
            const name = document.getElementById('serv-name').value;
            const price = parseFloat(document.getElementById('serv-price').value);
            const desc = document.getElementById('serv-desc').value;

            if (id) {
                const s = db.services.find(x => x.id == id);
                if (s) { s.name = name; s.price = price; s.description = desc; }
            } else {
                db.services.push({ id: Date.now(), name, price, description: desc });
            }
            save(); renderServices();
            document.getElementById('serv-id').value = '';
            document.getElementById('serv-form').reset();
            showToast('تم حفظ الخدمة');
        }

        function editService(id) {
            const s = db.services.find(x => x.id == id);
            if (s) {
                document.getElementById('serv-id').value = s.id;
                document.getElementById('serv-name').value = s.name;
                document.getElementById('serv-price').value = s.price;
                document.getElementById('serv-desc').value = s.description || '';
            }
        }

        function addToServiceCart() {
            const id = document.getElementById('srv-list').value;
            const serv = db.services.find(x => x.id == id);
            if (serv) {
                currentSrvCart.push({ ...serv });
                renderServiceCart();
            }
        }

        function renderServiceCart() {
            const tbody = document.getElementById('srv-cart-body');
            let total = 0;
            if (tbody) {
                tbody.innerHTML = currentSrvCart.map((item, idx) => {
                    total += item.price;
                    return `<tr><td class="p-2">${item.name}</td><td class="p-2 font-mono">${item.price}</td><td class="p-2"><button onclick="currentSrvCart.splice(${idx},1);renderServiceCart()" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
                }).join('');
                document.getElementById('srv-total').innerText = total.toFixed(2);
            }
        }

        function postServiceBill() {
            if (currentSrvCart.length === 0) return showToast('الفاتورة فارغة', 'error');
            const total = currentSrvCart.reduce((sum, item) => sum + item.price, 0);
            const method = document.getElementById('srv-method').value;
            const date = new Date().toISOString().split('T')[0];

            // Journal: Dr Cash, Cr Services Revenue (4102 maybe? or just 4101)
            // Let's assume generic Revenue 4101 for now, or create new. 
            // Better: Add 4102 Services Revenue dynamically if possible, or just use 4101.
            // Using 4101 for simplicity.

            const lines = [
                { code: method || '1101', dr: total, cr: 0 },
                { code: '4101', dr: 0, cr: total }
            ];

            if (addJournalEntry(date, `فاتورة خدمات - ${method}`, lines)) {
                // We can add a sales record too if we want to track it in sales list, or separate list.
                // For now, just journal is enough for financial. 
                // BUT user might want to see it in a list.
                // Let's add to Sales with type 'service'
                db.sales.push({ id: Date.now(), date, customer: 'عميل خدمات', total, paid: total, remaining: 0, method, type: 'service', items: [...currentSrvCart] });

                showToast('تم حفظ الفاتورة');
                currentSrvCart = []; renderServiceCart(); save(); renderAll();
            }
        }

        // --- 13. Expenses Module Logic ---
        function renderExpenses() {
            if (!db.expensesCategories) db.expensesCategories = [
                { id: '5201', name: 'مصروفات تشغيلية' },
                { id: '5203', name: 'مصروفات أخرى (طارئة)' }
            ];

            const catSel = document.getElementById('exp-cat');
            if (catSel) catSel.innerHTML = db.expensesCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            const methodSel = document.getElementById('exp-method');
            if (methodSel && db.settings.paymentMethods) methodSel.innerHTML = db.settings.paymentMethods.map(m => `<option value="${m}">${m}</option>`).join('');

            if (!db.expenses) db.expenses = [];
            const list = document.getElementById('expenses-list');
            let total = 0;
            if (list) {
                list.innerHTML = db.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 50).map(e => {
                    total += parseFloat(e.amount);
                    return `<tr><td class="p-2 border-l">${e.date}</td><td class="p-2 border-l">${e.description}</td><td class="p-2 font-bold text-red-600 border-l">${parseFloat(e.amount).toFixed(2)}</td><td class="p-2 text-xs">${e.categoryName}</td></tr>`;
                }).join('');
                document.getElementById('exp-list-total').innerText = total.toFixed(2);
            }
        }

        function postExpense(e) {
            e.preventDefault();
            const desc = document.getElementById('exp-desc').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const catId = document.getElementById('exp-cat').value;
            const catName = db.expensesCategories.find(c => c.id == catId)?.name || 'مصروف';
            const method = document.getElementById('exp-method').value;
            const date = new Date().toISOString().split('T')[0];

            if (!amount || !desc) return showToast('بيانات ناقصة', 'error');

            const lines = [
                { code: catId, dr: amount, cr: 0 },
                { code: method || '1101', dr: 0, cr: amount }
            ];

            if (addJournalEntry(date, `مصروف - ${desc}`, lines)) {
                db.expenses.push({ id: Date.now(), date, description: desc, amount, categoryId: catId, categoryName: catName, method });
                showToast('تم تسجيل المصروف Successfully');
                document.getElementById('exp-desc').value = '';
                document.getElementById('exp-amount').value = '';
                save(); renderExpenses(); renderAll();
            }
        }

        // --- 14. POS Module Logic ---
        let posCart = [];

        function renderPOSProducts(q = '', cat = '') {
            const grid = document.getElementById('pos-grid');
            if (!grid) return;
            grid.innerHTML = db.products.filter(p => p.name.includes(q)).map(p => `
                <div class="bg-slate-50 border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition cursor-pointer group" onclick="addToPOSCart(${p.id})">
                    <div class="h-32 bg-slate-200 flex items-center justify-center relative">
                        ${p.image ? `<img src="${p.image}" class="w-full h-full object-cover">` : `<i class="fas fa-box text-4xl text-slate-400"></i>`}
                        <div class="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center text-white font-bold backdrop-blur-sm transition">إضافة للسلة</div>
                    </div>
                    <div class="p-3">
                        <div class="font-bold text-slate-800 text-sm truncate">${p.name}</div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-emerald-600 font-mono font-bold">${p.price}</span>
                            <span class="text-xs text-slate-500 bg-slate-200 px-1.5 py-0.5 rounded">مخزون: ${p.stock}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Populate Customers Select
            const custSel = document.getElementById('pos-customer');
            if (custSel && (!custSel.innerHTML || custSel.innerHTML.length < 10)) {
                custSel.innerHTML = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }

            // Render Other Methods
            const otherDiv = document.getElementById('pos-other-methods');
            if (otherDiv && db.settings.paymentMethods) {
                const others = db.settings.paymentMethods.filter(m => m !== 'Cash' && m !== 'Bank');
                otherDiv.innerHTML = others.map(m => `
                    <button onclick="checkoutPOS('${m}')" class="bg-slate-700 text-white py-2 rounded font-bold hover:bg-slate-600 text-xs shadow">${m}</button>
                `).join('');
            }
        }



        function addToPOSCart(id) {
            const p = db.products.find(x => x.id == id);
            if (!p) return;
            if (p.stock <= 0) return showToast('نافذ من المخزون', 'error');

            const exist = posCart.find(x => x.id == id);
            if (exist) {
                if (exist.qty < p.stock) exist.qty++;
            } else {
                posCart.push({ ...p, qty: 1, total: p.price });
            }
            renderPOSCart();
        }

        function renderPOSCart() {
            const tbody = document.getElementById('pos-cart-body');
            let sub = 0;
            posCart.forEach(i => { i.total = i.price * i.qty; sub += i.total; });

            tbody.innerHTML = posCart.map((i, idx) => `
                <tr class="border-b"><td class="p-2 text-xs font-bold">${i.name}</td>
                <td class="p-2 flex items-center gap-1">
                    <button onclick="updatePOSQty(${idx}, -1)" class="w-5 h-5 bg-red-100 text-red-600 rounded flex items-center justify-center hover:bg-red-200">-</button>
                    <span class="font-mono text-xs w-4 text-center">${i.qty}</span>
                    <button onclick="updatePOSQty(${idx}, 1)" class="w-5 h-5 bg-green-100 text-green-600 rounded flex items-center justify-center hover:bg-green-200">+</button>
                </td>
                <td class="p-2 font-mono text-xs">${i.total.toFixed(2)}</td>
                <td class="p-2"><button onclick="posCart.splice(${idx},1);renderPOSCart()" class="text-red-400 hover:text-red-500"><i class="fas fa-times"></i></button></td></tr>
            `).join('');

            const disc = parseFloat(document.getElementById('pos-discount').value) || 0;
            const final = Math.max(0, sub - disc);
            document.getElementById('pos-subtotal').innerText = sub.toFixed(2);
            document.getElementById('pos-total').innerText = final.toFixed(2);
        }

        function updatePOSQty(idx, change) {
            const item = posCart[idx];
            const p = db.products.find(x => x.id == item.id);
            if (change > 0 && item.qty >= p.stock) return showToast('الكمية غير متاحة', 'error');
            item.qty += change;
            if (item.qty <= 0) posCart.splice(idx, 1);
            renderPOSCart();
        }

        function clearPOSCart() { posCart = []; renderPOSCart(); }

        function checkoutPOS(method) {
            if (posCart.length === 0) return showToast('السلة فارغة', 'error');

            const isWalkIn = document.getElementById('pos-walkin').checked;
            const custId = document.getElementById('pos-customer').value;
            const custName = isWalkIn ? 'عميل نقدي (كاشير)' : (db.customers.find(c => c.id == custId)?.name || 'غير معروف');

            const total = parseFloat(document.getElementById('pos-total').innerText);
            const subtotal = parseFloat(document.getElementById('pos-subtotal').innerText);
            const discount = parseFloat(document.getElementById('pos-discount').value) || 0;

            // Logic similar to Sale
            const date = new Date().toISOString().split('T')[0];
            const saleId = Date.now();

            // Journal
            // Dr Cash/Bank, Dr COGS
            // Cr Sales Rev, Cr VAT, Cr Inventory, Dr Discount Exp

            const vat = total * (db.settings.vatRate / (100 + db.settings.vatRate)); // Inclusive VAT
            const netSale = total - vat;
            let totalCost = 0;
            posCart.forEach(i => { const p = db.products.find(x => x.id == i.id); totalCost += (p?.cost || 0) * i.qty; });

            const lines = [
                { code: method === 'Cash' ? '1101' : '1102', dr: total, cr: 0 }, // Asset Up
                { code: '5101', dr: totalCost, cr: 0 }, // COGS
                { code: '4101', dr: 0, cr: netSale }, // Revenue
                { code: '1104', dr: 0, cr: totalCost }, // Inventory Down
                { code: '2102', dr: 0, cr: vat } // VAT Liab
            ];
            // Discount? If separate line needed: 
            // Currently NetSale is reduced by discount. If we want to track Discount Expense:
            // Dr Cash (Total), Dr Sales Discount (Disc), Cr Sales Revenue (Subtotal - VAT)...
            // For simplicity, sticking to Net methodology.

            if (addJournalEntry(date, `بيع كاشير - ${custName}`, lines)) {
                // Stock Update
                posCart.forEach(i => { const p = db.products.find(x => x.id == i.id); if (p) p.stock -= i.qty; });

                db.sales.push({ id: saleId, date, customer: custName, total, paid: total, remaining: 0, method, type: 'pos', items: [...posCart] });
                showToast('تمت عملية البيع');
                clearPOSCart();
                save(); renderAll();
            }
        }

        // --- 15. HR Module Logic ---
        function previewEmpPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('emp-photo-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('emp-id').value;
            const name = document.getElementById('emp-name').value;
            const role = document.getElementById('emp-role').value;
            const salary = parseFloat(document.getElementById('emp-salary').value);
            const phone = document.getElementById('emp-phone').value;
            const photoSrc = document.getElementById('emp-photo-preview').src || '';

            if (id) {
                const emp = db.employees.find(x => x.id == id);
                if (emp) { emp.name = name; emp.role = role; emp.salary = salary; emp.phone = phone; if (photoSrc.startsWith('data:')) emp.photo = photoSrc; }
            } else {
                db.employees.push({ id: Date.now(), name, role, salary, phone, photo: photoSrc.startsWith('data:') ? photoSrc : '' });
            }
            save(); renderEmployees();
            document.getElementById('emp-id').value = '';
            document.getElementById('emp-form').reset();
            document.getElementById('emp-photo-preview').classList.add('hidden');
            showToast('تم حفظ الموظف');
        }

        function renderEmployees() {
            if (!db.employees) db.employees = [];

            // List
            const list = document.getElementById('employees-list');
            if (list) list.innerHTML = db.employees.map(e => `
                <tr class="hover:bg-slate-50">
                    <td class="p-2 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden"><img src="${e.photo || ''}" class="w-full h-full object-cover"></div>
                        <span class="font-bold">${e.name}</span>
                    </td>
                    <td class="p-2 text-xs">${e.role}</td>
                    <td class="p-2 font-mono">${e.salary}</td>
                    <td class="p-2"><button onclick="editEmployee(${e.id})" class="text-blue-500"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');

            // Select for Actions
            const sel = document.getElementById('act-emp');
            if (sel) sel.innerHTML = '<option value="">اختر موظف...</option>' + db.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');

            // Render Recent Actions
            if (!db.payrollActions) db.payrollActions = [];
            const actList = document.getElementById('actions-list');
            if (actList) actList.innerHTML = db.payrollActions.slice().reverse().slice(0, 20).map(a => `
                <tr><td class="p-2">${a.empName}</td><td class="p-2 text-xs ${a.type === 'bonus' ? 'text-emerald-600' : 'text-red-600'}">${a.type === 'bonus' ? 'مكافأة' : 'خصم'}</td><td class="p-2 font-bold">${a.amount}</td></tr>
            `).join('');
        }

        function editEmployee(id) {
            const e = db.employees.find(x => x.id == id);
            if (e) {
                document.getElementById('emp-id').value = e.id;
                document.getElementById('emp-name').value = e.name;
                document.getElementById('emp-role').value = e.role;
                document.getElementById('emp-salary').value = e.salary;
                document.getElementById('emp-phone').value = e.phone;
                const img = document.getElementById('emp-photo-preview');
                if (e.photo) { img.src = e.photo; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
            }
        }

        function postPayrollAction(e) {
            e.preventDefault();
            const empId = document.getElementById('act-emp').value;
            const type = document.getElementById('act-type').value;
            const amount = parseFloat(document.getElementById('act-amount').value);
            const desc = document.getElementById('act-desc').value;
            const emp = db.employees.find(x => x.id == empId);

            if (!emp || !amount) return showToast('بيانات ناقصة', 'error');

            db.payrollActions.push({
                id: Date.now(),
                empId, empName: emp.name,
                type, amount, description: desc,
                date: new Date().toISOString().split('T')[0]
            });
            save(); renderEmployees(); showToast('تم تسجيل الإجراء');
            document.getElementById('act-amount').value = '';
            document.getElementById('act-desc').value = '';
        }

        function generatePayrollPreview() {
            const month = document.getElementById('payroll-month').value;
            if (!month) return showToast('اختر الشهر', 'error');

            const tbody = document.getElementById('payroll-table');
            let totalNet = 0;

            const rows = db.employees.map(emp => {
                const actions = db.payrollActions.filter(a => a.empId == emp.id && a.date.startsWith(month));
                const bonuses = actions.filter(a => a.type === 'bonus').reduce((sum, a) => sum + a.amount, 0);
                const deductions = actions.filter(a => a.type === 'deduction').reduce((sum, a) => sum + a.amount, 0);
                const net = emp.salary + bonuses - deductions;
                totalNet += net;

                return `<tr>
                    <td class="p-2 font-bold">${emp.name}</td>
                    <td class="p-2">${emp.salary}</td>
                    <td class="p-2 text-green-600">${bonuses}</td>
                    <td class="p-2 text-red-600">${deductions}</td>
                    <td class="p-2 font-bold">${net}</td>
                </tr>`;
            }).join('');

            tbody.innerHTML = rows;
            document.getElementById('payroll-total').innerText = totalNet.toFixed(2);
            document.getElementById('payroll-preview').classList.remove('hidden');
        }

        function postPayroll() {
            if (!confirm('هل أنت متأكد من صرف الرواتب؟ سيتم تسجيل قيد يومي.')) return;
            const total = parseFloat(document.getElementById('payroll-total').innerText);
            const month = document.getElementById('payroll-month').value;
            const date = new Date().toISOString().split('T')[0];

            const lines = [
                { code: '5202', dr: total, cr: 0 },
                { code: '1101', dr: 0, cr: total }
            ];

            if (addJournalEntry(date, `رواتب شهر ${month}`, lines)) {
                showToast('تم صرف الرواتب');
                document.getElementById('payroll-preview').classList.add('hidden');
                save(); renderAll();
            }
        }
    </script>
</body>

</html>